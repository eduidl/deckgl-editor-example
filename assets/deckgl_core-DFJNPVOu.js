var ff=Object.defineProperty;var df=(s,e,t)=>e in s?ff(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var p=(s,e,t)=>df(s,typeof e!="symbol"?e+"":e,t);function pf(s,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const r in n)if(r!=="default"&&!(r in s)){const i=Object.getOwnPropertyDescriptor(n,r);i&&Object.defineProperty(s,r,i.get?i:{enumerable:!0,get:()=>n[r]})}}}return Object.freeze(Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}))}var QA=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function _f(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function Ln(s,e){if(!s)throw new Error(e||"loader assertion failed.")}const ho=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),da=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);da&&parseFloat(da[1]);const gn=globalThis,Ht=globalThis.process||{},gf=globalThis.navigator||{};function pl(s){var n,r;if(typeof window<"u"&&((n=window.process)==null?void 0:n.type)==="renderer"||typeof process<"u"&&((r=process.versions)!=null&&r.electron))return!0;const t=typeof navigator<"u"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function bt(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||pl()}function mf(s){return bt()?pl()?"Electron":(gf.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const _l="4.1.0";function yf(s){try{const e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class Tf{constructor(e,t,n="sessionStorage"){this.storage=yf(n),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function bf(s){let e;return s<10?e=`${s.toFixed(2)}ms`:s<100?e=`${s.toFixed(1)}ms`:s<1e3?e=`${s.toFixed(0)}ms`:e=`${(s/1e3).toFixed(2)}s`,e}function vf(s,e=8){const t=Math.max(e-s.length,0);return`${" ".repeat(t)}${s}`}var Vn;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Vn||(Vn={}));const wf=10;function pa(s){return typeof s!="string"?s:(s=s.toUpperCase(),Vn[s]||Vn.WHITE)}function Af(s,e,t){return!bt&&typeof s=="string"&&(e&&(s=`\x1B[${pa(e)}m${s}\x1B[39m`),t&&(s=`\x1B[${pa(t)+wf}m${s}\x1B[49m`)),s}function Ef(s,e=["constructor"]){const t=Object.getPrototypeOf(s),n=Object.getOwnPropertyNames(t),r=s;for(const i of n){const o=r[i];typeof o=="function"&&(e.find(a=>i===a)||(r[i]=o.bind(s)))}}function fo(s,e){if(!s)throw new Error("Assertion failed")}function jt(){var e,t,n;let s;if(bt()&&gn.performance)s=(t=(e=gn==null?void 0:gn.performance)==null?void 0:e.now)==null?void 0:t.call(e);else if("hrtime"in Ht){const r=(n=Ht==null?void 0:Ht.hrtime)==null?void 0:n.call(Ht);s=r[0]*1e3+r[1]/1e6}else s=Date.now();return s}const Xt={debug:bt()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Sf={enabled:!0,level:0};function Yt(){}const _a={},ga={once:!0};class Gs{constructor({id:e}={id:""}){this.VERSION=_l,this._startTs=jt(),this._deltaTs=jt(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new Tf(`__probe-${this.id}__`,Sf),this.timeStamp(`${this.id} started`),Ef(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((jt()-this._startTs).toPrecision(10))}getDelta(){return Number((jt()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Xt.warn,arguments,ga)}error(e){return this._getLogFunction(0,e,Xt.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,Xt.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Xt.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,Xt.debug||Xt.info,arguments,ga)}table(e,t,n){return t?this._getLogFunction(e,t,console.table||Yt,n&&[n],{tag:Rf(t)}):Yt}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Yt)}group(e,t,n={collapsed:!1}){const r=ma({logLevel:e,message:t,opts:n}),{collapsed:i}=n;return r.method=(i?console.groupCollapsed:console.group)||console.info,this._getLogFunction(r)}groupCollapsed(e,t,n={}){return this.group(e,t,Object.assign({},n,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Yt)}withGroup(e,t,n){this.group(e,t)();try{n()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=gl(e)}_getLogFunction(e,t,n,r,i){if(this._shouldLog(e)){i=ma({logLevel:e,message:t,args:r,opts:i}),n=n||i.method,fo(n),i.total=this.getTotal(),i.delta=this.getDelta(),this._deltaTs=jt();const o=i.tag||i.message;if(i.once&&o)if(!_a[o])_a[o]=jt();else return Yt;return t=xf(this.id,i.message,i),n.bind(console,t,...i.args)}return Yt}}Gs.VERSION=_l;function gl(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return fo(Number.isFinite(e)&&e>=0),e}function ma(s){const{logLevel:e,message:t}=s;s.logLevel=gl(e);const n=s.args?Array.from(s.args):[];for(;n.length&&n.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&n.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break}typeof s.message=="function"&&(s.message=s.message());const r=typeof s.message;return fo(r==="string"||r==="object"),Object.assign(s,{args:n},s.opts)}function xf(s,e,t){if(typeof e=="string"){const n=t.time?vf(bf(t.total)):"";e=t.time?`${s}: ${n}  ${e}`:`${s}: ${e}`,e=Af(e,t.color,t.background)}return e}function Rf(s){for(const e in s)for(const t in s[e])return t||"untitled";return"empty"}const Yr="4.3.2",If=Yr[0]>="0"&&Yr[0]<="9"?`v${Yr}`:"";function Cf(){const s=new Gs({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=s,globalThis.loaders.version=If,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=s,s}const Pf=Cf();function Mf(s,e){return ml(s||{},e)}function ml(s,e,t=0){if(t>3)return e;const n={...s};for(const[r,i]of Object.entries(e))i&&typeof i=="object"&&!Array.isArray(i)?n[r]=ml(n[r]||{},e[r],t+1):n[r]=e[r];return n}const Of="latest";function Nf(){var s;return(s=globalThis._loadersgl_)!=null&&s.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version}const kf=Nf();function mt(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}const Pt=typeof process!="object"||String(process)!=="[object process]"||process.browser,Df=typeof window<"u"&&typeof window.orientation<"u",ya=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);ya&&parseFloat(ya[1]);class Ff{constructor(e,t){p(this,"name");p(this,"workerThread");p(this,"isRunning",!0);p(this,"result");p(this,"_resolve",()=>{});p(this,"_reject",()=>{});this.name=e,this.workerThread=t,this.result=new Promise((n,r)=>{this._resolve=n,this._reject=r})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){mt(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){mt(this.isRunning),this.isRunning=!1,this._reject(e)}}class qr{terminate(){}}const Kr=new Map;function Uf(s){mt(s.source&&!s.url||!s.source&&s.url);let e=Kr.get(s.source||s.url);return e||(s.url&&(e=Bf(s.url),Kr.set(s.url,e)),s.source&&(e=yl(s.source),Kr.set(s.source,e))),mt(e),e}function Bf(s){if(!s.startsWith("http"))return s;const e=Lf(s);return yl(e)}function yl(s){const e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function Lf(s){return`try {
  importScripts('${s}');
} catch (error) {
  console.error(error);
  throw error;
}`}function Tl(s,e=!0,t){const n=t||new Set;if(s){if(Ta(s))n.add(s);else if(Ta(s.buffer))n.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(const r in s)Tl(s[r],e,n)}}return t===void 0?Array.from(n):[]}function Ta(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}const Zr=()=>{};class Si{constructor(e){p(this,"name");p(this,"source");p(this,"url");p(this,"terminated",!1);p(this,"worker");p(this,"onMessage");p(this,"onError");p(this,"_loadableURL","");const{name:t,source:n,url:r}=e;mt(n||r),this.name=t,this.source=n,this.url=r,this.onMessage=Zr,this.onError=i=>console.log(i),this.worker=Pt?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&Pt||typeof qr<"u"&&!Pt}destroy(){this.onMessage=Zr,this.onError=Zr,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||Tl(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=Uf({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const n=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new qr(n,{eval:!1})}else if(this.source)e=new qr(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class Vf{constructor(e){p(this,"name","unnamed");p(this,"source");p(this,"url");p(this,"maxConcurrency",1);p(this,"maxMobileConcurrency",1);p(this,"onDebug",()=>{});p(this,"reuseWorkers",!0);p(this,"props",{});p(this,"jobQueue",[]);p(this,"idleQueue",[]);p(this,"count",0);p(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return Si.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(r,i,o)=>r.done(o),n=(r,i)=>r.error(i)){const r=new Promise(i=>(this.jobQueue.push({name:e,onMessage:t,onError:n,onStart:i}),this));return this._startQueuedJob(),await r}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const n=new Ff(t.name,e);e.onMessage=r=>t.onMessage(n,r.type,r.payload),e.onError=r=>t.onError(n,r),t.onStart(n);try{await n.result}catch(r){console.error(`Worker exception: ${r}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Pt||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Si({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Df?this.maxMobileConcurrency:this.maxConcurrency}}const $f={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},ct=class ct{constructor(e){p(this,"props");p(this,"workerPools",new Map);this.props={...$f},this.setProps(e),this.workerPools=new Map}static isSupported(){return Si.isSupported()}static getWorkerFarm(e={}){return ct._workerFarm=ct._workerFarm||new ct({}),ct._workerFarm.setProps(e),ct._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:n,url:r}=e;let i=this.workerPools.get(t);return i||(i=new Vf({name:t,source:n,url:r}),i.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,i)),i}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};p(ct,"_workerFarm");let $n=ct;function zf(s,e={}){const t=e[s.id]||{},n=Pt?`${s.id}-worker.js`:`${s.id}-worker-node.js`;let r=t.workerUrl;if(!r&&s.id==="compression"&&(r=e.workerUrl),e._workerType==="test"&&(Pt?r=`modules/${s.module}/dist/${n}`:r=`modules/${s.module}/src/workers/${s.id}-worker-node.ts`),!r){let i=s.version;i==="latest"&&(i=Of);const o=i?`@${i}`:"";r=`https://unpkg.com/@loaders.gl/${s.module}${o}/dist/${n}`}return mt(r),r}function Wf(s,e=kf){mt(s,"no worker provided");const t=s.version;return!(!e||!t)}function Hf(s,e){return!$n.isSupported()||!Pt&&!(e!=null&&e._nodeWorkers)?!1:s.worker&&(e==null?void 0:e.worker)}async function jf(s,e,t,n,r){const i=s.id,o=zf(s,t),c=$n.getWorkerFarm(t).getWorkerPool({name:i,url:o});t=JSON.parse(JSON.stringify(t)),n=JSON.parse(JSON.stringify(n||{}));const l=await c.startJob("process-on-worker",Xf.bind(null,r));return l.postMessage("process",{input:e,options:t,context:n}),await(await l.result).result}async function Xf(s,e,t,n){switch(t){case"done":e.done(n);break;case"error":e.error(new Error(n.error));break;case"process":const{id:r,input:i,options:o}=n;try{const a=await s(i,o);e.postMessage("done",{id:r,result:a})}catch(a){const c=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:r,error:c})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function Yf(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;const n=new Uint8Array(s),r=new Uint8Array(e);for(let i=0;i<n.length;++i)if(n[i]!==r[i])return!1;return!0}function qf(...s){return Kf(s)}function Kf(s){const e=s.map(i=>i instanceof ArrayBuffer?new Uint8Array(i):i),t=e.reduce((i,o)=>i+o.byteLength,0),n=new Uint8Array(t);let r=0;for(const i of e)n.set(i,r),r+=i.byteLength;return n.buffer}async function Zf(s){const e=[];for await(const t of s)e.push(t);return qf(...e)}function ba(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}class va{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=ba(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(ba()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class en{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:n}=e;let r=this.stats[t];return r||(e instanceof va?r=e:r=new va(t,n),this.stats[t]=r),r}}const Qf="Queued Requests",Jf="Active Requests",Gf="Cancelled Requests",ed="Queued Requests Ever",td="Active Requests Ever",sd={id:"request-scheduler",throttleRequests:!0,maxRequests:6,debounceTime:0};class JA{constructor(e={}){p(this,"props");p(this,"stats");p(this,"activeRequestCount",0);p(this,"requestQueue",[]);p(this,"requestMap",new Map);p(this,"updateTimer",null);this.props={...sd,...e},this.stats=new en({id:this.props.id}),this.stats.get(Qf),this.stats.get(Jf),this.stats.get(Gf),this.stats.get(ed),this.stats.get(td)}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);const n={handle:e,priority:0,getPriority:t},r=new Promise(i=>(n.resolve=i,n));return this.requestQueue.push(n),this.requestMap.set(e,r),this._issueNewRequests(),r}_issueRequest(e){const{handle:t,resolve:n}=e;let r=!1;const i=()=>{r||(r=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,n?n({done:i}):Promise.resolve({done:i})}_issueNewRequests(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this._issueNewRequestsAsync(),this.props.debounceTime)}_issueNewRequestsAsync(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=null;const e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let t=0;t<e;++t){const n=this.requestQueue.shift();n&&this._issueRequest(n)}}}_updateAllRequests(){const e=this.requestQueue;for(let t=0;t<e.length;++t){const n=e[t];this._updateRequest(n)||(e.splice(t,1),this.requestMap.delete(n.handle),t--)}e.sort((t,n)=>t.priority-n.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}}let nd="";const wa={};function rd(s){for(const e in wa)if(s.startsWith(e)){const t=wa[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s=`${nd}${s}`),s}function id(s){return s&&typeof s=="object"&&s.isBuffer}function bl(s){if(id(s))return s;if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){const e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function vl(s){const e=s?s.lastIndexOf("/"):-1;return e>=0?s.substr(e+1):""}function od(s){const e=s?s.lastIndexOf("/"):-1;return e>=0?s.substr(0,e):""}const ad=s=>typeof s=="boolean",Vs=s=>typeof s=="function",tn=s=>s!==null&&typeof s=="object",Aa=s=>tn(s)&&s.constructor==={}.constructor,cd=s=>!!s&&typeof s[Symbol.iterator]=="function",ld=s=>s&&typeof s[Symbol.asyncIterator]=="function",Vt=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json,$t=s=>typeof Blob<"u"&&s instanceof Blob,ud=s=>s&&typeof s=="object"&&s.isBuffer,hd=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||tn(s)&&Vs(s.tee)&&Vs(s.cancel)&&Vs(s.getReader),fd=s=>tn(s)&&Vs(s.read)&&Vs(s.pipe)&&ad(s.readable),wl=s=>hd(s)||fd(s);class dd extends Error{constructor(t,n){super(t);p(this,"reason");p(this,"url");p(this,"response");this.reason=n.reason,this.url=n.url,this.response=n.response}}const pd=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,_d=/^([-\w.]+\/[-\w.+]+)/;function Ea(s,e){return s.toLowerCase()===e.toLowerCase()}function gd(s){const e=_d.exec(s);return e?e[1]:s}function Sa(s){const e=pd.exec(s);return e?e[1]:""}const Al=/\?.*/;function md(s){const e=s.match(Al);return e&&e[0]}function po(s){return s.replace(Al,"")}function yd(s){if(s.length<50)return s;const e=s.slice(s.length-15);return`${s.substr(0,32)}...${e}`}function Ir(s){return Vt(s)?s.url:$t(s)?s.name||"":typeof s=="string"?s:""}function _o(s){if(Vt(s)){const e=s,t=e.headers.get("content-type")||"",n=po(e.url);return gd(t)||Sa(n)}return $t(s)?s.type||"":typeof s=="string"?Sa(s):""}function Td(s){return Vt(s)?s.headers["content-length"]||-1:$t(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}async function El(s){if(Vt(s))return s;const e={},t=Td(s);t>=0&&(e["content-length"]=String(t));const n=Ir(s),r=_o(s);r&&(e["content-type"]=r);const i=await wd(s);i&&(e["x-first-bytes"]=i),typeof s=="string"&&(s=new TextEncoder().encode(s));const o=new Response(s,{headers:e});return Object.defineProperty(o,"url",{value:n}),o}async function bd(s){if(!s.ok)throw await vd(s)}async function vd(s){const e=yd(s.url);let t=`Failed to fetch resource (${s.status}) ${s.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const n={reason:s.statusText,url:s.url,response:s};try{const r=s.headers.get("Content-Type");n.reason=!s.bodyUsed&&(r!=null&&r.includes("application/json"))?await s.json():await s.text()}catch{}return new dd(t,n)}async function wd(s){if(typeof s=="string")return`data:,${s.slice(0,5)}`;if(s instanceof Blob){const t=s.slice(0,5);return await new Promise(n=>{const r=new FileReader;r.onload=i=>{var o;return n((o=i==null?void 0:i.target)==null?void 0:o.result)},r.readAsDataURL(t)})}if(s instanceof ArrayBuffer){const t=s.slice(0,5);return`data:base64,${Ad(t)}`}return null}function Ad(s){let e="";const t=new Uint8Array(s);for(let n=0;n<t.byteLength;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function Ed(s){return!Sd(s)&&!xd(s)}function Sd(s){return s.startsWith("http:")||s.startsWith("https:")}function xd(s){return s.startsWith("data:")}async function xa(s,e){var t,n;if(typeof s=="string"){const r=rd(s);return Ed(r)&&(t=globalThis.loaders)!=null&&t.fetchNode?(n=globalThis.loaders)==null?void 0:n.fetchNode(r,e):await fetch(r,e)}return await El(s)}const Ra=new Gs({id:"loaders.gl"});class Rd{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class Id{constructor(){p(this,"console");this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const Sl={fetch:null,mimeType:void 0,nothrow:!1,log:new Id,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:ho,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},Cd={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function xl(){globalThis.loaders=globalThis.loaders||{};const{loaders:s}=globalThis;return s._state||(s._state={}),s._state}function Rl(){const s=xl();return s.globalOptions=s.globalOptions||{...Sl},s.globalOptions}function Pd(s,e,t,n){return t=t||[],t=Array.isArray(t)?t:[t],Md(s,t),Nd(e,s,n)}function Md(s,e){Ia(s,null,Sl,Cd,e);for(const t of e){const n=s&&s[t.id]||{},r=t.options&&t.options[t.id]||{},i=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Ia(n,t.id,r,i,e)}}function Ia(s,e,t,n,r){const i=e||"Top level",o=e?`${e}.`:"";for(const a in s){const c=!e&&tn(s[a]),l=a==="baseUri"&&!e,u=a==="workerUrl"&&e;if(!(a in t)&&!l&&!u){if(a in n)Ra.warn(`${i} loader option '${o}${a}' no longer supported, use '${n[a]}'`)();else if(!c){const h=Od(a,r);Ra.warn(`${i} loader option '${o}${a}' not recognized. ${h}`)()}}}}function Od(s,e){const t=s.toLowerCase();let n="";for(const r of e)for(const i in r.options){if(s===i)return`Did you mean '${r.id}.${i}'?`;const o=i.toLowerCase();(t.startsWith(o)||o.startsWith(t))&&(n=n||`Did you mean '${r.id}.${i}'?`)}return n}function Nd(s,e,t){const r={...s.options||{}};return kd(r,t),r.log===null&&(r.log=new Rd),Ca(r,Rl()),Ca(r,e),r}function Ca(s,e){for(const t in e)if(t in e){const n=e[t];Aa(n)&&Aa(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function kd(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function go(s){return s?(Array.isArray(s)&&(s=s[0]),Array.isArray(s==null?void 0:s.extensions)):!1}function mo(s){Ln(s,"null loader"),Ln(go(s),"invalid loader");let e;return Array.isArray(s)&&(e=s[1],s=s[0],s={...s,options:{...s.options,...e}}),(s!=null&&s.parseTextSync||s!=null&&s.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}const Il=()=>{const s=xl();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function Dd(s){const e=Il();s=Array.isArray(s)?s:[s];for(const t of s){const n=mo(t);e.find(r=>n===r)||e.unshift(n)}}function Fd(){return Il()}const Ud=/\.([^.]+)$/;async function Bd(s,e=[],t,n){if(!Cl(s))return null;let r=Pa(s,e,{...t,nothrow:!0},n);if(r)return r;if($t(s)&&(s=await s.slice(0,10).arrayBuffer(),r=Pa(s,e,t,n)),!r&&!(t!=null&&t.nothrow))throw new Error(Pl(s));return r}function Pa(s,e=[],t,n){if(!Cl(s))return null;if(e&&!Array.isArray(e))return mo(e);let r=[];e&&(r=r.concat(e)),t!=null&&t.ignoreRegisteredLoaders||r.push(...Fd()),Vd(r);const i=Ld(s,r,t,n);if(!i&&!(t!=null&&t.nothrow))throw new Error(Pl(s));return i}function Ld(s,e,t,n){const r=Ir(s),i=_o(s),o=po(r)||(n==null?void 0:n.url);let a=null,c="";return t!=null&&t.mimeType&&(a=Qr(e,t==null?void 0:t.mimeType),c=`match forced by supplied MIME type ${t==null?void 0:t.mimeType}`),a=a||$d(e,o),c=c||(a?`matched url ${o}`:""),a=a||Qr(e,i),c=c||(a?`matched MIME type ${i}`:""),a=a||Wd(e,s),c=c||(a?`matched initial data ${Ml(s)}`:""),t!=null&&t.fallbackMimeType&&(a=a||Qr(e,t==null?void 0:t.fallbackMimeType),c=c||(a?`matched fallback MIME type ${i}`:"")),c&&Pf.log(1,`selectLoader selected ${a==null?void 0:a.name}: ${c}.`),a}function Cl(s){return!(s instanceof Response&&s.status===204)}function Pl(s){const e=Ir(s),t=_o(s);let n="No valid loader found (";n+=e?`${vl(e)}, `:"no url provided, ",n+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const r=s?Ml(s):"";return n+=r?` first bytes: "${r}"`:"first bytes: not available",n+=")",n}function Vd(s){for(const e of s)mo(e)}function $d(s,e){const t=e&&Ud.exec(e),n=t&&t[1];return n?zd(s,n):null}function zd(s,e){e=e.toLowerCase();for(const t of s)for(const n of t.extensions)if(n.toLowerCase()===e)return t;return null}function Qr(s,e){var t;for(const n of s)if((t=n.mimeTypes)!=null&&t.some(r=>Ea(e,r))||Ea(e,`application/x.${n.id}`))return n;return null}function Wd(s,e){if(!e)return null;for(const t of s)if(typeof e=="string"){if(Hd(e,t))return t}else if(ArrayBuffer.isView(e)){if(Ma(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&Ma(e,0,t))return t;return null}function Hd(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(n=>s.startsWith(n))}function Ma(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(r=>jd(s,e,t,r))}function jd(s,e,t,n){if(n instanceof ArrayBuffer)return Yf(n,s,n.byteLength);switch(typeof n){case"function":return n(s);case"string":const r=xi(s,e,n.length);return n===r;default:return!1}}function Ml(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?xi(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?xi(s,0,e):""}function xi(s,e,t){if(s.byteLength<e+t)return"";const n=new DataView(s);let r="";for(let i=0;i<t;i++)r+=String.fromCharCode(n.getUint8(e+i));return r}const Xd=256*1024;function*Yd(s,e){const t=(e==null?void 0:e.chunkSize)||Xd;let n=0;const r=new TextEncoder;for(;n<s.length;){const i=Math.min(s.length-n,t),o=s.slice(n,n+i);n+=i,yield r.encode(o)}}const qd=256*1024;function*Kd(s,e={}){const{chunkSize:t=qd}=e;let n=0;for(;n<s.byteLength;){const r=Math.min(s.byteLength-n,t),i=new ArrayBuffer(r),o=new Uint8Array(s,n,r);new Uint8Array(i).set(o),n+=r,yield i}}const Zd=1024*1024;async function*Qd(s,e){const t=(e==null?void 0:e.chunkSize)||Zd;let n=0;for(;n<s.size;){const r=n+t,i=await s.slice(n,r).arrayBuffer();n=r,yield i}}function Oa(s,e){return ho?Jd(s,e):Gd(s)}async function*Jd(s,e){const t=s.getReader();let n;try{for(;;){const r=n||t.read();e!=null&&e._streamReadAhead&&(n=t.read());const{done:i,value:o}=await r;if(i)return;yield bl(o)}}catch{t.releaseLock()}}async function*Gd(s,e){for await(const t of s)yield bl(t)}function ep(s,e){if(typeof s=="string")return Yd(s,e);if(s instanceof ArrayBuffer)return Kd(s,e);if($t(s))return Qd(s,e);if(wl(s))return Oa(s,e);if(Vt(s))return Oa(s.body,e);throw new Error("makeIterator")}const Ol="Cannot convert supplied data type";function tp(s,e,t){if(e.text&&typeof s=="string")return s;if(ud(s)&&(s=s.buffer),s instanceof ArrayBuffer){const n=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let n=s.buffer;const r=s.byteLength||s.length;return(s.byteOffset!==0||r!==n.byteLength)&&(n=n.slice(s.byteOffset,s.byteOffset+r)),n}throw new Error(Ol)}async function sp(s,e,t){const n=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||n)return tp(s,e);if($t(s)&&(s=await El(s)),Vt(s)){const r=s;return await bd(r),e.binary?await r.arrayBuffer():await r.text()}if(wl(s)&&(s=ep(s,t)),cd(s)||ld(s))return Zf(s);throw new Error(Ol)}function Nl(s,e){const t=Rl(),n=s||t;return typeof n.fetch=="function"?n.fetch:tn(n.fetch)?r=>xa(r,n.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:xa}function np(s,e,t){if(t)return t;const n={fetch:Nl(e,s),...s};if(n.url){const r=po(n.url);n.baseUrl=r,n.queryString=md(n.url),n.filename=vl(r),n.baseUrl=od(r)}return Array.isArray(n.loaders)||(n.loaders=null),n}function rp(s,e){if(s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){const n=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...n]:n}return t&&t.length?t:void 0}async function zn(s,e,t,n){e&&!Array.isArray(e)&&!go(e)&&(n=void 0,t=e,e=void 0),s=await s,t=t||{};const r=Ir(s),o=rp(e,n),a=await Bd(s,o,t);return a?(t=Pd(t,a,o,r),n=np({url:r,_parse:zn,loaders:o},t,n||null),await ip(a,s,t,n)):null}async function ip(s,e,t,n){if(Wf(s),t=Mf(s.options,t),Vt(e)){const i=e,{ok:o,redirected:a,status:c,statusText:l,type:u,url:h}=i,f=Object.fromEntries(i.headers.entries());n.response={headers:f,ok:o,redirected:a,status:c,statusText:l,type:u,url:h}}e=await sp(e,s,t);const r=s;if(r.parseTextSync&&typeof e=="string")return r.parseTextSync(e,t,n);if(Hf(s,t))return await jf(s,e,t,n,zn);if(r.parseText&&typeof e=="string")return await r.parseText(e,t,n);if(r.parse)return await r.parse(e,t,n);throw mt(!r.parseSync),new Error(`${s.id} loader - no parser found and worker is disabled`)}async function Ri(s,e,t,n){let r,i;!Array.isArray(e)&&!go(e)?(r=[],i=e):(r=e,i=t);const o=Nl(i);let a=s;return typeof s=="string"&&(a=await o(s)),$t(s)&&(a=await o(s)),Array.isArray(r)?await zn(a,r,i):await zn(a,r,i)}const op="4.3.2";var dl;const ap=(dl=globalThis.loaders)==null?void 0:dl.parseImageNode,Ii=typeof Image<"u",Ci=typeof ImageBitmap<"u",cp=!!ap,Pi=ho?!0:cp;function lp(s){switch(s){case"auto":return Ci||Ii||Pi;case"imagebitmap":return Ci;case"image":return Ii;case"data":return Pi;default:throw new Error(`@loaders.gl/images: image ${s} not supported in this environment`)}}function up(){if(Ci)return"imagebitmap";if(Ii)return"image";if(Pi)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function hp(s){const e=dp(s);if(!e)throw new Error("Not an image");return e}function fp(s){switch(hp(s)){case"data":return s;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function dp(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}const pp=/^data:image\/svg\+xml/,_p=/\.svg((\?|#).*)?$/;function yo(s){return s&&(pp.test(s)||_p.test(s))}function gp(s,e){if(yo(e)){let n=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(n=unescape(encodeURIComponent(n)))}catch(i){throw new Error(i.message)}return`data:image/svg+xml;base64,${btoa(n)}`}return kl(s,e)}function kl(s,e){if(yo(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function Dl(s,e,t){const n=gp(s,t),r=self.URL||self.webkitURL,i=typeof n!="string"&&r.createObjectURL(n);try{return await mp(i||n,e)}finally{i&&r.revokeObjectURL(i)}}async function mp(s,e){const t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((n,r)=>{try{t.onload=()=>n(t),t.onerror=i=>{const o=i instanceof Error?i.message:"error";r(new Error(o))}}catch(i){r(i)}})}const yp={};let Na=!0;async function Tp(s,e,t){let n;yo(t)?n=await Dl(s,e,t):n=kl(s,t);const r=e&&e.imagebitmap;return await bp(n,r)}async function bp(s,e=null){if((vp(e)||!Na)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),Na=!1}return await createImageBitmap(s)}function vp(s){for(const e in s||yp)return!1;return!0}function wp(s){return!xp(s,"ftyp",4)||(s[8]&96)===0?null:Ap(s)}function Ap(s){switch(Ep(s,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function Ep(s,e,t){return String.fromCharCode(...s.slice(e,t))}function Sp(s){return[...s].map(e=>e.charCodeAt(0))}function xp(s,e,t=0){const n=Sp(e);for(let r=0;r<n.length;++r)if(n[r]!==s[r+t])return!1;return!0}const Xe=!1,$s=!0;function Fl(s){const e=sn(s);return Ip(e)||Mp(e)||Cp(e)||Pp(e)||Rp(e)}function Rp(s){const e=new Uint8Array(s instanceof DataView?s.buffer:s),t=wp(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function Ip(s){const e=sn(s);return e.byteLength>=24&&e.getUint32(0,Xe)===2303741511?{mimeType:"image/png",width:e.getUint32(16,Xe),height:e.getUint32(20,Xe)}:null}function Cp(s){const e=sn(s);return e.byteLength>=10&&e.getUint32(0,Xe)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,$s),height:e.getUint16(8,$s)}:null}function Pp(s){const e=sn(s);return e.byteLength>=14&&e.getUint16(0,Xe)===16973&&e.getUint32(2,$s)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,$s),height:e.getUint32(22,$s)}:null}function Mp(s){const e=sn(s);if(!(e.byteLength>=3&&e.getUint16(0,Xe)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:n,sofMarkers:r}=Op();let i=2;for(;i+9<e.byteLength;){const o=e.getUint16(i,Xe);if(r.has(o))return{mimeType:"image/jpeg",height:e.getUint16(i+5,Xe),width:e.getUint16(i+7,Xe)};if(!n.has(o))return null;i+=2,i+=e.getUint16(i,Xe)}return null}function Op(){const s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function sn(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function Np(s,e){var r;const{mimeType:t}=Fl(s)||{},n=(r=globalThis.loaders)==null?void 0:r.parseImageNode;return Ln(n),await n(s,t)}async function kp(s,e,t){e=e||{};const r=(e.image||{}).type||"auto",{url:i}=t||{},o=Dp(r);let a;switch(o){case"imagebitmap":a=await Tp(s,e,i);break;case"image":a=await Dl(s,e,i);break;case"data":a=await Np(s);break;default:Ln(!1)}return r==="data"&&(a=fp(a)),a}function Dp(s){switch(s){case"auto":case"data":return up();default:return lp(s),s}}const Fp=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],Up=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],Bp={image:{type:"auto",decode:!0}},Lp={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:op,mimeTypes:Up,extensions:Fp,parse:kp,tests:[s=>!!Fl(new DataView(s))],options:Bp},G=new Gs({id:"deck"});let Mi={};function Vp(s){Mi=s}function me(s,e,t,n){G.level>0&&Mi[s]&&Mi[s].call(null,e,t,n)}function $p(s){const e=s[0],t=s[s.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const zp={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:$p,parseTextSync:JSON.parse};function Wp(){const s="9.0.40",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==s)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${s}`);return e||(G.log(1,`deck.gl ${s}`)(),globalThis.deck={...globalThis.deck,VERSION:s,version:s,log:G,_registerLoggers:Vp},Dd([zp,[Lp,{imagebitmap:{premultiplyAlpha:"none"}}]])),s}const Hp=Wp();function Rt(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}const Jr={number:{type:"number",validate(s,e){return Number.isFinite(s)&&typeof e=="object"&&(e.max===void 0||s<=e.max)&&(e.min===void 0||s>=e.min)}},array:{type:"array",validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function jp(s){const e={};for(const[t,n]of Object.entries(s))e[t]=Yp(n);return e}function Xp(s,e,t){const n={};for(const[r,i]of Object.entries(e))s&&r in s&&!i.private?(i.validate&&Rt(i.validate(s[r],i),`${t}: invalid ${r}`),n[r]=s[r]):n[r]=i.value;return n}function Yp(s){let e=ka(s);if(e!=="object")return{value:s,...Jr[e],type:e};if(typeof s=="object")return s?s.type!==void 0?{...s,...Jr[s.type],type:s.type}:s.value===void 0?{type:"object",value:s}:(e=ka(s.value),{...s,...Jr[e],type:e}):{type:"object",value:null};throw new Error("props")}function ka(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}const qp=`#ifdef MODULE_LOGDEPTH
logdepth_adjustPosition(gl_Position);
#endif
`,Kp=`#ifdef MODULE_MATERIAL
gl_FragColor = material_filterColor(gl_FragColor);
#endif
#ifdef MODULE_LIGHTING
gl_FragColor = lighting_filterColor(gl_FragColor);
#endif
#ifdef MODULE_FOG
gl_FragColor = fog_filterColor(gl_FragColor);
#endif
#ifdef MODULE_PICKING
gl_FragColor = picking_filterHighlightColor(gl_FragColor);
gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif
#ifdef MODULE_LOGDEPTH
logdepth_setFragDepth();
#endif
`,Zp={vertex:qp,fragment:Kp},Da=/void\s+main\s*\([^)]*\)\s*\{\n?/,Fa=/}\n?[^{}]*$/,Gr=[],On="__LUMA_INJECT_DECLARATIONS__";function Qp(s){const e={vertex:{},fragment:{}};for(const t in s){let n=s[t];const r=Jp(t);typeof n=="string"&&(n={order:0,injection:n}),e[r][t]=n}return e}function Jp(s){const e=s.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Wn(s,e,t,n=!1){const r=e==="vertex";for(const i in t){const o=t[i];o.sort((c,l)=>c.order-l.order),Gr.length=o.length;for(let c=0,l=o.length;c<l;++c)Gr[c]=o[c].injection;const a=`${Gr.join(`
`)}
`;switch(i){case"vs:#decl":r&&(s=s.replace(On,a));break;case"vs:#main-start":r&&(s=s.replace(Da,c=>c+a));break;case"vs:#main-end":r&&(s=s.replace(Fa,c=>a+c));break;case"fs:#decl":r||(s=s.replace(On,a));break;case"fs:#main-start":r||(s=s.replace(Da,c=>c+a));break;case"fs:#main-end":r||(s=s.replace(Fa,c=>a+c));break;default:s=s.replace(i,c=>c+a)}}return s=s.replace(On,""),n&&(s=s.replace(/\}\s*$/,i=>i+Zp[e])),s}let Gp=1;class It{constructor(e){p(this,"name");p(this,"vs");p(this,"fs");p(this,"getModuleUniforms");p(this,"dependencies");p(this,"deprecations");p(this,"defines");p(this,"injections");p(this,"uniforms",{});p(this,"uniformTypes",{});const{name:t,vs:n,fs:r,dependencies:i=[],uniformTypes:o={},uniformPropTypes:a={},getUniforms:c,deprecations:l=[],defines:u={},inject:h={}}=e;Rt(typeof t=="string"),this.name=t,this.vs=n,this.fs=r,this.getModuleUniforms=c,this.dependencies=It.instantiateModules(i),this.deprecations=this._parseDeprecationDefinitions(l),this.defines=u,this.injections=Qp(h),this.uniformTypes=o,a&&(this.uniforms=jp(a))}static instantiateModules(e){return e.map(t=>{if(t instanceof It)return t;Rt(typeof t!="string",`Shader module use by name is deprecated. Import shader module '${JSON.stringify(t)}' and use it directly.`),t.name||(console.warn("shader module has no name"),t.name=`shader-module-${Gp++}`);const n=new It(t);return n.dependencies=It.instantiateModules(t.dependencies||[]),n})}getModuleSource(e){let t;switch(e){case"vertex":t=this.vs||"";break;case"fragment":t=this.fs||"";break;default:Rt(!1)}const n=this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");return`// ----- MODULE ${this.name} ---------------

#define MODULE_${n}
${t}

`}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):Xp(e,this.uniforms,this.name)}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(n=>{var r;(r=n.regex)!=null&&r.test(e)&&(n.deprecated?t.deprecated(n.old,n.new)():t.removed(n.old,n.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp(`\\b${t.old}\\(`);break;default:t.regex=new RegExp(`${t.type} ${t.old};`)}}),e}_defaultGetUniforms(e={}){const t={},n=this.uniforms;for(const r in n){const i=n[r];r in e&&!i.private?(i.validate&&Rt(i.validate(e[r],i),`${this.name}: invalid ${r}`),t[r]=e[r]):t[r]=i.value}return t}}function Ua(s){if(s.source&&s.platformInfo.type==="webgpu")return{...s,vs:void 0,fs:void 0};if(!s.vs)throw new Error("no vertex shader");const e=Ba(s.platformInfo,s.vs);let t;return s.fs&&(t=Ba(s.platformInfo,s.fs)),{...s,vs:e,fs:t}}function Ba(s,e){if(typeof e=="string")return e;switch(s.type){case"webgpu":if(e!=null&&e.wgsl)return e.wgsl;throw new Error("WebGPU does not support GLSL shaders");default:if(e!=null&&e.glsl)return e.glsl;throw new Error("WebGL does not support WGSL shaders")}}function Cr(s){const e=It.instantiateModules(s);return e_(e)}function e_(s){const e={},t={};return Ul({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((n,r)=>t[r]-t[n]).map(n=>e[n])}function Ul(s){const{modules:e,level:t,moduleMap:n,moduleDepth:r}=s;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const i of e)n[i.name]=i,(r[i.name]===void 0||r[i.name]<t)&&(r[i.name]=t);for(const i of e)i.dependencies&&Ul({modules:i.dependencies,level:t+1,moduleMap:n,moduleDepth:r})}function t_(s){switch(s==null?void 0:s.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function s_(s,e){var n;if(Number(((n=s.match(/^#version[ \t]+(\d+)/m))==null?void 0:n[1])||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return s=La(s,n_),s;case"fragment":return s=La(s,r_),s;default:throw new Error(e)}}const Bl=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],n_=[...Bl,[Oi("attribute"),"in $1"],[Oi("varying"),"out $1"]],r_=[...Bl,[Oi("varying"),"in $1"]];function La(s,e){for(const[t,n]of e)s=s.replace(t,n);return s}function Oi(s){return new RegExp(`\\b${s}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function Ll(s,e){let t="";for(const n in s){const r=s[n];if(t+=`void ${r.signature} {
`,r.header&&(t+=`  ${r.header}`),e[n]){const i=e[n];i.sort((o,a)=>o.order-a.order);for(const o of i)t+=`  ${o.injection}
`}r.footer&&(t+=`  ${r.footer}`),t+=`}
`}return t}function Vl(s){const e={vertex:{},fragment:{}};for(const t of s){let n,r;typeof t!="string"?(n=t,r=n.hook):(n={},r=t),r=r.trim();const[i,o]=r.split(":"),a=r.replace(/\(.+/,""),c=Object.assign(n,{signature:o});switch(i){case"vs":e.vertex[a]=c;break;case"fs":e.fragment[a]=c;break;default:throw new Error(i)}}return e}function i_(s,e){return{name:o_(s,e),language:"glsl",version:a_(s)}}function o_(s,e="unnamed"){const n=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(s);return n?n[1]:e}function a_(s){let e=100;const t=s.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const n=parseInt(t[1],10);Number.isFinite(n)&&(e=n)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const $l=`

${On}
`,c_=`precision highp float;
`;function l_(s){const e=Cr(s.modules||[]);return{source:Ni(s.platformInfo,{...s,source:s.source,stage:"vertex",modules:e}),getUniforms:To(e)}}function u_(s){const e=Cr(s.modules||[]);return{vs:Ni(s.platformInfo,{...s,source:s.vs,stage:"vertex",modules:e}),fs:Ni(s.platformInfo,{...s,source:s.fs,stage:"fragment",modules:e}),getUniforms:To(e)}}function h_(s){const{vs:e,fs:t}=s,n=Cr(s.modules||[]);return{vs:Va(s.platformInfo,{...s,source:e,stage:"vertex",modules:n}),fs:Va(s.platformInfo,{...s,source:t,stage:"fragment",modules:n}),getUniforms:To(n)}}function Ni(s,e){const{source:t,stage:n,modules:r,hookFunctions:i=[],inject:o={},log:a}=e;Rt(typeof t=="string","shader source must be a string");const c=t;let l="";const u=Vl(i),h={},f={},_={};for(const v in o){const R=typeof o[v]=="string"?{injection:o[v],order:0}:o[v],C=/^(v|f)s:(#)?([\w-]+)$/.exec(v);if(C){const I=C[2],M=C[3];I?M==="decl"?f[v]=[R]:_[v]=[R]:h[v]=[R]}else _[v]=[R]}const T=s.type!=="webgpu"?r:[];for(const v of T){a&&v.checkDeprecations(c,a);const R=v.getModuleSource(n,"wgsl");l+=R;const C=v.injections[n];for(const I in C){const M=/^(v|f)s:#([\w-]+)$/.exec(I);if(M){const U=M[2]==="decl"?f:_;U[I]=U[I]||[],U[I].push(C[I])}else h[I]=h[I]||[],h[I].push(C[I])}}return l+=$l,l=Wn(l,n,f),l+=Ll(u[n],h),l+=c,l=Wn(l,n,_),l}function Va(s,e){const{id:t,source:n,stage:r,language:i="glsl",modules:o,defines:a={},hookFunctions:c=[],inject:l={},prologue:u=!0,log:h}=e;Rt(typeof n=="string","shader source must be a string");const f=i==="glsl"?i_(n).version:-1,_=s.shaderLanguageVersion,T=f===100?"#version 100":"#version 300 es",R=n.split(`
`).slice(1).join(`
`),C={};o.forEach($=>{Object.assign(C,$.getDefines())}),Object.assign(C,a);let I="";switch(i){case"wgsl":break;case"glsl":I=u?`${T}

// ----- PROLOGUE -------------------------
${f_({id:t,source:n,stage:r})}
${`#define SHADER_TYPE_${r.toUpperCase()}`}
${t_(s)}
${r==="fragment"?c_:""}

// ----- APPLICATION DEFINES -------------------------

${d_(C)}

`:`${T}
`;break}const M=Vl(c),N={},U={},B={};for(const $ in l){const W=typeof l[$]=="string"?{injection:l[$],order:0}:l[$],V=/^(v|f)s:(#)?([\w-]+)$/.exec($);if(V){const z=V[2],H=V[3];z?H==="decl"?U[$]=[W]:B[$]=[W]:N[$]=[W]}else B[$]=[W]}for(const $ of o){h&&$.checkDeprecations(R,h);const W=$.getModuleSource(r);I+=W;const V=$.injections[r];for(const z in V){const H=/^(v|f)s:#([\w-]+)$/.exec(z);if(H){const re=H[2]==="decl"?U:B;re[z]=re[z]||[],re[z].push(V[z])}else N[z]=N[z]||[],N[z].push(V[z])}}return I+="// ----- MAIN SHADER SOURCE -------------------------",I+=$l,I=Wn(I,r,U),I+=Ll(M[r],N),I+=R,I=Wn(I,r,B),i==="glsl"&&f!==_&&(I=s_(I,r)),I.trim()}function To(s){return function(t){const n={};for(const r of s){const i=r.getUniforms(t,n);Object.assign(n,i)}return n}}function f_(s){const{id:e,source:t,stage:n}=s;return e&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${n}

`:""}function d_(s={}){let e="";for(const t in s){const n=s[t];(n||Number.isFinite(n))&&(e+=`#define ${t.toUpperCase()} ${s[t]}
`)}return e}const St=class St{constructor(){p(this,"_hookFunctions",[]);p(this,"_defaultModules",[])}static getDefaultShaderAssembler(){return St.defaultShaderAssembler=St.defaultShaderAssembler||new St,St.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(n=>n.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleShader(e){const t=this._getModuleList(e.modules),n=this._hookFunctions,r=Ua(e);return{...l_({platformInfo:e.platformInfo,...r,modules:t,hookFunctions:n}),modules:t}}assembleShaderPair(e){const t=Ua(e),n=this._getModuleList(e.modules),r=this._hookFunctions,{platformInfo:i}=e;return{...e.platformInfo.shaderLanguage==="wgsl"?u_({platformInfo:i,...t,modules:n,hookFunctions:r}):h_({platformInfo:i,...t,modules:n,hookFunctions:r}),modules:n}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),n={};let r=0;for(let i=0,o=this._defaultModules.length;i<o;++i){const a=this._defaultModules[i],c=a.name;t[r++]=a,n[c]=!0}for(let i=0,o=e.length;i<o;++i){const a=e[i],c=a.name;n[c]||(t[r++]=a,n[c]=!0)}return t.length=r,It.instantiateModules(t)}};p(St,"defaultShaderAssembler");let Hn=St;const p_=`out vec4 transform_output;
void main() {
transform_output = vec4(0);
}`,__=`#version 300 es
${p_}`;function g_(s){const{input:e,inputChannels:t,output:n}={};if(!e)return __;if(!t)throw new Error("inputChannels");const r=m_(t),i=y_(e,t);return`#version 300 es
in ${r} ${e};
out vec4 ${n};
void main() {
  ${n} = ${i};
}`}function m_(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${s}`)}}function y_(s,e){switch(e){case 1:return`vec4(${s}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${s}, 0.0, 1.0)`;case 3:return`vec4(${s}, 1.0)`;case 4:return s;default:throw new Error(`invalid channels: ${e}`)}}const D=new Gs({id:"luma.gl"});class T_{constructor(){p(this,"stats",new Map)}getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new en({id:e})),this.stats.get(e)}}const bo=new T_;function b_(){const s="9.0.28",e="set luma.log.level=1 (or higher) to trace rendering";if(globalThis.luma&&globalThis.luma.VERSION!==s)throw new Error(`luma.gl - multiple VERSIONs detected: ${globalThis.luma.VERSION} vs ${s}`);return globalThis.luma||(bt()&&D.log(1,`${s} - ${e}`)(),globalThis.luma=globalThis.luma||{VERSION:s,version:s,log:D,stats:bo}),s}const v_=b_();function w_(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)?s:null}function Ks(s){return Array.isArray(s)?s.length===0||typeof s[0]=="number"?s:null:w_(s)}const ei={};function zt(s="id"){ei[s]=ei[s]||1;const e=ei[s]++;return`${s}-${e}`}function jn(s){let e=!0;for(const t in s){e=!1;break}return e}var Ei;let Q=(Ei=class{constructor(e,t,n){p(this,"id");p(this,"props");p(this,"userData",{});p(this,"_device");p(this,"destroyed",!1);p(this,"allocatedBytes",0);p(this,"_attachedResources",new Set);if(!e)throw new Error("no device");this._device=e,this.props=A_(t,n);const r=this.props.id!=="undefined"?this.props.id:zt(this[Symbol.toStringTag]);this.props.id=r,this.id=r,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}(${this.id})`}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const n=this._device.statsManager.getStats("Resource Counts");n.get("GPU Memory").addCount(e),n.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}},p(Ei,"defaultProps",{id:"undefined",handle:void 0,userData:void 0}),Ei);function A_(s,e){const t={...e};for(const n in s)s[n]!==void 0&&(t[n]=s[n]);return t}const de=class de extends Q{constructor(t,n){const r={...n};(n.usage||0)&de.INDEX&&!n.indexType&&(n.data instanceof Uint32Array?r.indexType="uint32":n.data instanceof Uint16Array&&(r.indexType="uint16"));super(t,r,de.defaultProps);p(this,"usage");p(this,"indexType");p(this,"updateTimestamp");p(this,"debugData",new ArrayBuffer(0));this.usage=n.usage||0,this.indexType=r.indexType,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Buffer"}readSyncWebGL(t,n){throw new Error("not implemented")}_setDebugData(t,n,r){const i=ArrayBuffer.isView(t)?t.buffer:t,o=Math.min(t?t.byteLength:r,de.DEBUG_DATA_MAX_LENGTH);t===null?this.debugData=new ArrayBuffer(o):n===0&&r===t.byteLength?this.debugData=i.slice(0,o):this.debugData=i.slice(n,n+o)}};p(de,"defaultProps",{...Q.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1}),p(de,"MAP_READ",1),p(de,"MAP_WRITE",2),p(de,"COPY_SRC",4),p(de,"COPY_DST",8),p(de,"INDEX",16),p(de,"VERTEX",32),p(de,"UNIFORM",64),p(de,"STORAGE",128),p(de,"INDIRECT",256),p(de,"QUERY_RESOLVE",512),p(de,"DEBUG_DATA_MAX_LENGTH",32);let se=de;function zl(s){const e=$a[s],t=E_(e),n=s.includes("norm"),r=!n&&!s.startsWith("float"),i=s.startsWith("s");return{dataType:$a[s],byteLength:t,integer:r,signed:i,normalized:n}}function E_(s){return S_[s]}const $a={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},S_={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},x_=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],R_=/^(rg?b?a?)([0-9]*)([a-z]*)(-srgb)?(-webgl|-unsized)?$/;function I_(s){return x_.some(e=>s.startsWith(e))}function Wl(s){const e=R_.exec(s);if(e){const[,t,n,r,i,o]=e;if(t){const a=`${r}${n}`,c=zl(a);return{format:t,components:t.length,srgb:i==="-srgb",unsized:o==="-unsized",webgl:o==="-webgl",...c}}}return P_(s)}const C_={"rgba4unorm-webgl":{format:"rgba",bpp:2},"rgb565unorm-webgl":{format:"rgb",bpp:2},"rgb5a1unorm-webgl":{format:"rgba",bbp:2},rgb9e5ufloat:{format:"rgb",bbp:4},rg11b10ufloat:{format:"rgb",bbp:4},rgb10a2unorm:{format:"rgba",bbp:4},"rgb10a2uint-webgl":{format:"rgba",bbp:4},stencil8:{components:1,bpp:1,a:"stencil"},depth16unorm:{components:1,bpp:2,a:"depth"},depth24plus:{components:1,bpp:3,a:"depth"},depth32float:{components:1,bpp:4,a:"depth"},"depth24plus-stencil8":{components:2,bpp:4,a:"depth-stencil"},"depth24unorm-stencil8":{components:2,bpp:4,a:"depth-stencil"},"depth32float-stencil8":{components:2,bpp:4,a:"depth-stencil"}};function P_(s){var t;const e=C_[s];if(!e)throw new Error(`Unknown format ${s}`);return{format:e.format||"",components:e.components||((t=e.format)==null?void 0:t.length)||1,byteLength:e.bpp||1,srgb:!1,unsized:!1}}class M_{}class O_{constructor(e=[],t){p(this,"features");p(this,"disabledFeatures");this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){return!this.disabledFeatures[e]&&this.features.has(e)}}const Ys=class Ys{constructor(e){p(this,"id");p(this,"props");p(this,"userData",{});p(this,"statsManager",bo);p(this,"_lumaData",{});p(this,"timestamp",0);this.props={...Ys.defaultProps,...e},this.id=this.props.id||zt(this[Symbol.toStringTag].toLowerCase())}get[Symbol.toStringTag](){return"Device"}isTextureFormatCompressed(e){return I_(e)}loseDevice(){return!1}getCanvasContext(){if(!this.canvasContext)throw new Error("Device has no CanvasContext");return this.canvasContext}createTexture(e){return(e instanceof Promise||typeof e=="string")&&(e={data:e}),this._createTexture(e)}createCommandEncoder(e={}){throw new Error("not implemented")}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}_getBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};return(e.usage||0)&se.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array?t.indexType="uint16":D.warn("indices buffer content must be of integer type")()),t}};p(Ys,"defaultProps",{id:null,canvas:null,container:null,manageState:!0,width:800,height:600,requestMaxLimits:!0,debug:!!D.get("debug"),spector:!!(D.get("spector")||D.get("spectorjs")),break:[],initalizeFeatures:!0,disabledFeatures:{"compilation-status-async-webgl":!0},gl:null,onError:e=>D.error(e.message)}),p(Ys,"VERSION",v_);let ls=Ys;function ee(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}const Is=new Map,is=class is{static registerDevices(e){for(const t of e)ee(t.type&&t.isSupported&&t.create),Is.set(t.type,t)}static getAvailableDevices(){return Array.from(Is).map(e=>e.type)}static getSupportedDevices(){return Array.from(Is).filter(e=>e.isSupported()).map(e=>e.type)}static setDefaultDeviceProps(e){Object.assign(ls.defaultProps,e)}static async attachDevice(e){const t=za(e.devices)||Is;if(e.handle instanceof WebGL2RenderingContext){const n=t.get("webgl");if(n)return await n.attach(e.handle)}if(e.handle===null){const n=t.get("unknown");if(n)return await n.attach(null)}throw new Error("Failed to attach device. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.")}static async createDevice(e={}){var i,o;e={...is.defaultProps,...e},e.gl&&(e.type="webgl");const t=za(e.devices)||Is;let n,r;switch(e.type){case"webgpu":if(n=t.get("webgpu"),n)return await n.create(e);break;case"webgl":if(r=t.get("webgl"),r)return await r.create(e);break;case"unknown":const a=t.get("unknown");if(a)return await a.create(e);break;case"best-available":if(n=t.get("webgpu"),(i=n==null?void 0:n.isSupported)!=null&&i.call(n))return await n.create(e);if(r=t.get("webgl"),(o=r==null?void 0:r.isSupported)!=null&&o.call(r))return await r.create(e);break}throw new Error("No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.")}static enforceWebGL2(e=!0){const t=HTMLCanvasElement.prototype;if(!e&&t.originalGetContext){t.getContext=t.originalGetContext,t.originalGetContext=void 0;return}t.originalGetContext=t.getContext,t.getContext=function(n,r){return n==="webgl"||n==="experimental-webgl"?this.originalGetContext("webgl2",r):this.originalGetContext(n,r)}}};p(is,"defaultProps",{...ls.defaultProps,type:"best-available",devices:void 0}),p(is,"stats",bo),p(is,"log",D);let os=is;function za(s){if(!s||(s==null?void 0:s.length)===0)return null;const e=new Map;for(const t of s)e.set(t.type,t);return e}const N_=bt()&&typeof document<"u",Pr=()=>N_&&document.readyState==="complete",k_={canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,colorSpace:"srgb",alphaMode:"opaque"};class vo{constructor(e){p(this,"id");p(this,"props");p(this,"canvas");p(this,"htmlCanvas");p(this,"offscreenCanvas");p(this,"type");p(this,"width",1);p(this,"height",1);p(this,"resizeObserver");p(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});if(this.props={...k_,...e},e=this.props,!bt()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=U_(e.canvas):this.canvas=e.canvas;else{const t=B_(e),n=F_((e==null?void 0:e.container)||null);n.insertBefore(t,n.firstChild),this.canvas=t,e!=null&&e.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(t=>{for(const n of t)n.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}static get isPageLoaded(){return Pr()}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),t=this.canvas;return t.parentElement?[t.clientWidth*e,t.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,t]=this.getPixelSize();return e/t}cssToDeviceRatio(){var e;try{const[t]=this.getDrawingBufferSize(),n=this._canvasSizeInfo.clientWidth||((e=this.htmlCanvas)==null?void 0:e.clientWidth);return n?t/n:1}catch{return 1}}cssToDevicePixels(e,t=!0){const n=this.cssToDeviceRatio(),[r,i]=this.getDrawingBufferSize();return L_(e,n,r,i,t)}setDevicePixelRatio(e,t={}){if(!this.htmlCanvas)return;let n="width"in t?t.width:this.htmlCanvas.clientWidth,r="height"in t?t.height:this.htmlCanvas.clientHeight;(!n||!r)&&(D.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,n=this.htmlCanvas.width||1,r=this.htmlCanvas.height||1);const i=this._canvasSizeInfo;if(i.clientWidth!==n||i.clientHeight!==r||i.devicePixelRatio!==e){let o=e;const a=Math.floor(n*o),c=Math.floor(r*o);this.htmlCanvas.width=a,this.htmlCanvas.height=c;const[l,u]=this.getDrawingBufferSize();(l!==a||u!==c)&&(o=Math.min(l/n,u/r),this.htmlCanvas.width=Math.floor(n*o),this.htmlCanvas.height=Math.floor(r*o),D.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=n,this._canvasSizeInfo.clientHeight=r,this._canvasSizeInfo.devicePixelRatio=e}}getDrawingBufferSize(){const e=this.device.gl;if(!e)throw new Error("canvas size");return[e.drawingBufferWidth,e.drawingBufferHeight]}_setAutoCreatedCanvasId(e){var t;((t=this.htmlCanvas)==null?void 0:t.id)==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}}p(vo,"pageLoaded",D_());function D_(){return Pr()||typeof window>"u"?Promise.resolve():new Promise(s=>{window.addEventListener("load",()=>s())})}function F_(s){if(typeof s=="string"){const e=document.getElementById(s);if(!e&&!Pr())throw new Error(`Accessing '${s}' before page was loaded`);if(!e)throw new Error(`${s} is not an HTML element`);return e}else if(s)return s;return document.body}function U_(s){const e=document.getElementById(s);if(!e&&!Pr())throw new Error(`Accessing '${s}' before page was loaded`);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function B_(s){const{width:e,height:t}=s,n=document.createElement("canvas");return n.id="lumagl-auto-created-canvas",n.width=e||1,n.height=t||1,n.style.width=Number.isFinite(e)?`${e}px`:"100%",n.style.height=Number.isFinite(t)?`${t}px`:"100%",n}function L_(s,e,t,n,r){const i=s,o=Wa(i[0],e,t);let a=Ha(i[1],e,n,r),c=Wa(i[0]+1,e,t);const l=c===t-1?c:c-1;c=Ha(i[1]+1,e,n,r);let u;return r?(c=c===0?c:c+1,u=a,a=c):u=c===n-1?c:c-1,{x:o,y:a,width:Math.max(l-o+1,1),height:Math.max(u-a+1,1)}}function Wa(s,e,t){return Math.min(Math.round(s*e),t-1)}function Ha(s,e,t,n){return n?Math.max(0,t-1-Math.round(s*e)):Math.min(Math.round(s*e),t-1)}const Je=class Je extends Q{constructor(t,n,r=Je.defaultProps){super(t,n,r);p(this,"dimension");p(this,"format");p(this,"width");p(this,"height");p(this,"depth");p(this,"updateTimestamp");this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Texture"}};p(Je,"defaultProps",{...Q.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!0,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,type:void 0,sampler:{},view:void 0}),p(Je,"COPY_SRC",1),p(Je,"COPY_DST",2),p(Je,"TEXTURE_BINDING",4),p(Je,"STORAGE_BINDING",8),p(Je,"RENDER_ATTACHMENT",16);let xe=Je;const dr=class dr extends Q{get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,dr.defaultProps)}};p(dr,"defaultProps",{...Q.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0});let Xn=dr;function V_(s,e,t){let n="";const r=e.split(/\r?\n/),i=s.slice().sort((o,a)=>o.lineNum-a.lineNum);switch((t==null?void 0:t.showSourceCode)||"no"){case"all":let o=0;for(let a=1;a<=r.length;a++)for(n+=Hl(r[a-1],a,t);i.length>o&&i[o].lineNum===a;){const c=i[o++];n+=ja(c,r,c.lineNum,{...t,inlineSource:!1})}return n;case"issues":case"no":for(const a of s)n+=ja(a,r,a.lineNum,{inlineSource:(t==null?void 0:t.showSourceCode)!=="no"});return n}}function ja(s,e,t,n){if(n!=null&&n.inlineSource){const r=$_(e,t),i=s.linePos>0?`${" ".repeat(s.linePos+5)}^^^
`:"";return`
${r}${i}${s.type.toUpperCase()}: ${s.message}

`}return n!=null&&n.html?`<div class='luma-compiler-log-error' style="color:red;"><b> ${s.type.toUpperCase()}: ${s.message}</b></div>`:`${s.type.toUpperCase()}: ${s.message}`}function $_(s,e,t){let n="";for(let r=e-2;r<=e;r++){const i=s[r-1];i!==void 0&&(n+=Hl(i,e,t))}return n}function Hl(s,e,t){const n=t!=null&&t.html?W_(s):s;return`${z_(String(e),4)}: ${n}${t!=null&&t.html?"<br/>":`
`}`}function z_(s,e){let t="";for(let n=s.length;n<e;++n)t+=" ";return t+s}function W_(s){return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function jl(s,e){return{name:H_(s,e),language:"glsl",version:j_(s)}}function H_(s,e="unnamed"){const n=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(s);return n?n[1]:e}function j_(s){let e=100;const t=s.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const n=parseInt(t[1],10);Number.isFinite(n)&&(e=n)}return e}const pr=class pr extends Q{constructor(t,n){super(t,{id:X_(n),...n},pr.defaultProps);p(this,"stage");p(this,"source");p(this,"compilationStatus","pending");this.stage=this.props.stage,this.source=this.props.source}get[Symbol.toStringTag](){return"Shader"}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(t=this.props.debug){switch(t){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const n=await this.getCompilationInfo();this.props.debug==="warnings"&&(n==null?void 0:n.length)===0||this._displayShaderLog(n)}_displayShaderLog(t){var l;if(typeof document>"u"||!(document!=null&&document.createElement))return;const n=jl(this.source).name,r=`${this.stage} ${n}`;let i=V_(t,this.source,{showSourceCode:"all",html:!0});const o=this.getTranslatedSource();o&&(i+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${o}</pre></code>`);const a=document.createElement("Button");a.innerHTML=`
<h1>Shader Compilation Error in ${r}</h1><br /><br />
<code style="user-select:text;"><pre>
${i}
</pre></code>`,a.style.top="10px",a.style.left="10px",a.style.position="absolute",a.style.zIndex="9999",a.style.width="100%",a.style.textAlign="left",document.body.appendChild(a);const c=document.getElementsByClassName("luma-compiler-log-error");(l=c[0])!=null&&l.scrollIntoView&&c[0].scrollIntoView(),a.onclick=()=>{const u=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(u)}}};p(pr,"defaultProps",{...Q.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debug:"errors"});let Yn=pr;function X_(s){return jl(s.source).name||s.id||zt(`unnamed ${s.stage}-shader`)}const _r=class _r extends Q{get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){super(e,t,_r.defaultProps)}};p(_r,"defaultProps",{...Q.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1});let qn=_r;const gr=class gr extends Q{constructor(t,n={}){super(t,n,gr.defaultProps);p(this,"width");p(this,"height");p(this,"colorAttachments",[]);p(this,"depthStencilAttachment",null);this.width=this.props.width,this.height=this.props.height}get[Symbol.toStringTag](){return"Framebuffer"}resize(t){let n=!t;if(t){const[r,i]=Array.isArray(t)?t:[t.width,t.height];n=n||i!==this.height||r!==this.width,this.width=r,this.height=i}n&&(D.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map(n=>{if(typeof n=="string"){const r=this.createColorTexture(n);return this.attachResource(r),r.view}return n instanceof xe?n.view:n});const t=this.props.depthStencilAttachment;if(t)if(typeof t=="string"){const n=this.createDepthStencilTexture(t);this.attachResource(n),this.depthStencilAttachment=n.view}else t instanceof xe?this.depthStencilAttachment=t.view:this.depthStencilAttachment=t}createColorTexture(t){return this.device.createTexture({id:"color-attachment",usage:xe.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height})}createDepthStencilTexture(t){return this.device.createTexture({id:"depth-stencil-attachment",usage:xe.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height})}resizeAttachments(t,n){for(let r=0;r<this.colorAttachments.length;++r)if(this.colorAttachments[r]){const i=this.device._createTexture({...this.colorAttachments[r].props,width:t,height:n});this.destroyAttachedResource(this.colorAttachments[r]),this.colorAttachments[r]=i.view,this.attachResource(i.view)}if(this.depthStencilAttachment){const r=this.device._createTexture({...this.depthStencilAttachment.props,width:t,height:n});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=r.view,this.attachResource(r)}}};p(gr,"defaultProps",{...Q.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null});let Kn=gr;const mr=class mr extends Q{constructor(t,n){super(t,n,mr.defaultProps);p(this,"shaderLayout");p(this,"bufferLayout");p(this,"linkStatus","pending");p(this,"hash","");this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}get[Symbol.toStringTag](){return"RenderPipeline"}setUniformsWebGL(t){throw new Error("Use uniform blocks")}};p(mr,"defaultProps",{...Q.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}});let us=mr;const yr=class yr extends Q{get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){super(e,t,yr.defaultProps)}};p(yr,"defaultProps",{...Q.defaultProps,framebuffer:null,parameters:void 0,clearColor:[0,0,0,0],clearDepth:1,clearStencil:0,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0});let ki=yr;const Tr=class Tr extends Q{constructor(t,n){super(t,n,Tr.defaultProps);p(this,"hash","")}get[Symbol.toStringTag](){return"ComputePipeline"}};p(Tr,"defaultProps",{...Q.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});let Zn=Tr;const br=class br extends Q{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,br.defaultProps)}};p(br,"defaultProps",{...Q.defaultProps,measureExecutionTime:void 0});let Di=br;const vr=class vr extends Q{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,vr.defaultProps)}};p(vr,"defaultProps",{...Q.defaultProps});let Fi=vr;function Y_(s){const[e,t]=K_[s],n=e==="i32"||e==="u32",r=e!=="u32",i=Z_[e]*t,o=q_(e,t);return{dataType:e,components:t,defaultVertexFormat:o,byteLength:i,integer:n,signed:r}}function q_(s,e){let t;switch(s){case"f32":t="float32";break;case"i32":t="sint32";break;case"u32":t="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?t:`${t}x${e}`}const K_={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},Z_={f32:4,f16:2,i32:4,u32:4};function Xl(s){let e;s.endsWith("-webgl")&&(s.replace("-webgl",""),e=!0);const[t,n]=s.split("x"),r=t,i=n?parseInt(n):1,o=zl(r),a={type:r,components:i,byteLength:o.byteLength*i,integer:o.integer,signed:o.signed,normalized:o.normalized};return e&&(a.webglOnly=!0),a}function Yl(s,e){const t={};for(const n of s.attributes)t[n.name]=J_(s,e,n.name);return t}function Q_(s,e,t=16){const n=Yl(s,e),r=new Array(t).fill(null);for(const i of Object.values(n))r[i.location]=i;return r}function J_(s,e,t){const n=G_(s,t),r=eg(e,t);if(!n)return null;const i=Y_(n.type),o=(r==null?void 0:r.vertexFormat)||i.defaultVertexFormat,a=Xl(o);return{attributeName:(r==null?void 0:r.attributeName)||n.name,bufferName:(r==null?void 0:r.bufferName)||n.name,location:n.location,shaderType:n.type,shaderDataType:i.dataType,shaderComponents:i.components,vertexFormat:o,bufferDataType:a.type,bufferComponents:a.components,normalized:a.normalized,integer:i.integer,stepMode:(r==null?void 0:r.stepMode)||n.stepMode,byteOffset:(r==null?void 0:r.byteOffset)||0,byteStride:(r==null?void 0:r.byteStride)||0}}function G_(s,e){const t=s.attributes.find(n=>n.name===e);return t||D.warn(`shader layout attribute "${e}" not present in shader`),t||null}function eg(s,e){tg(s);let t=sg(s,e);return t||(t=ng(s,e),t)?t:(D.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function tg(s){for(const e of s)(e.attributes&&e.format||!e.attributes&&!e.format)&&D.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function sg(s,e){for(const t of s)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function ng(s,e){var t;for(const n of s){let r=n.byteStride;if(typeof n.byteStride!="number")for(const o of n.attributes||[]){const a=Xl(o.format);r+=a.byteLength}const i=(t=n.attributes)==null?void 0:t.find(o=>o.attribute===e);if(i)return{attributeName:i.attribute,bufferName:n.name,stepMode:n.stepMode,vertexFormat:i.format,byteOffset:i.byteOffset,byteStride:r}}return null}function rg(s,e){const t={...s,attributes:s.attributes.map(n=>({...n}))};for(const n of(e==null?void 0:e.attributes)||[]){const r=t.attributes.find(i=>i.name===n.name);r?(r.type=n.type||r.type,r.stepMode=n.stepMode||r.stepMode):D.warn(`shader layout attribute ${n.name} not present in shader`)}return t}const wr=class wr extends Q{constructor(t,n){super(t,n,wr.defaultProps);p(this,"maxVertexAttributes");p(this,"attributeInfos");p(this,"indexBuffer",null);p(this,"attributes");this.maxVertexAttributes=t.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null),this.attributeInfos=Q_(n.renderPipeline.shaderLayout,n.renderPipeline.bufferLayout,this.maxVertexAttributes)}get[Symbol.toStringTag](){return"VertexArray"}setConstantWebGL(t,n){throw new Error("constant attributes not supported")}};p(wr,"defaultProps",{...Q.defaultProps,renderPipeline:null});let Ui=wr;const Ar=class Ar extends Q{get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,Ar.defaultProps)}};p(Ar,"defaultProps",{...Q.defaultProps,layout:void 0,buffers:{}});let Bi=Ar;const Er=class Er extends Q{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,Er.defaultProps)}};p(Er,"defaultProps",{...Q.defaultProps,type:void 0,count:void 0});let Li=Er;const ig={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function og(s){const e=ig[s];return ee(s),e}function ag(s,e){switch(e){case 1:return s;case 2:return s+s%2;default:return s+(4-s%4)%4}}let mn;function ql(s){return(!mn||mn.byteLength<s)&&(mn=new ArrayBuffer(s)),mn}function cg(s,e){const t=ql(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function lg(s){const{target:e,source:t,start:n=0,count:r=1}=s,i=t.length,o=r*i;let a=0;for(let c=n;a<i;a++)e[c++]=t[a];for(;a<o;)a<o-a?(e.copyWithin(n+a,n,n+a),a*=2):(e.copyWithin(n+a,n,n+o-a),a=o);return s.target}const Xa=1024;class ug{constructor(e){p(this,"layout",{});p(this,"byteLength");let t=0;for(const[r,i]of Object.entries(e)){const o=og(i),{type:a,components:c}=o;t=ag(t,c);const l=t;t+=c,this.layout[r]={type:a,size:c,offset:l}}t+=(4-t%4)%4;const n=t*4;this.byteLength=Math.max(n,Xa)}getData(e){const t=Math.max(this.byteLength,Xa),n=ql(t),r={i32:new Int32Array(n),u32:new Uint32Array(n),f32:new Float32Array(n),f16:new Uint16Array(n)};for(const[i,o]of Object.entries(e)){const a=this.layout[i];if(!a){D.warn(`Supplied uniform value ${i} not present in uniform block layout`)();continue}const{type:c,size:l,offset:u}=a,h=r[c];if(l===1){if(typeof o!="number"&&typeof o!="boolean"){D.warn(`Supplied value for single component uniform ${i} is not a number: ${o}`)();continue}h[u]=Number(o)}else{const f=Ks(o);if(!f){D.warn(`Supplied value for multi component / array uniform ${i} is not a numeric array: ${o}`)();continue}h.set(f,u)}}return new Uint8Array(n)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function hg(s,e,t=16){if(s!==e)return!1;const n=Ks(s);if(!n)return!1;const r=Ks(e);if(r&&n.length===r.length){for(let i=0;i<n.length;++i)if(r[i]!==n[i])return!1}return!0}function fg(s){const e=Ks(s);return e?e.slice():s}class dg{constructor(e){p(this,"name");p(this,"uniforms",{});p(this,"modifiedUniforms",{});p(this,"modified",!0);p(this,"bindingLayout",{});p(this,"needsRedraw","initialized");var t;if(this.name=e==null?void 0:e.name,e!=null&&e.name&&(e!=null&&e.shaderLayout)){const n=(t=e==null?void 0:e.shaderLayout.bindings)==null?void 0:t.find(i=>i.type==="uniform"&&i.name===(e==null?void 0:e.name));if(!n)throw new Error(e==null?void 0:e.name);const r=n;for(const i of r.uniforms||[])this.bindingLayout[i.name]=i}}setUniforms(e){for(const[t,n]of Object.entries(e))this._setUniform(t,n),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${n}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){hg(this.uniforms[e],t)||(this.uniforms[e]=fg(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class pg{constructor(e){p(this,"uniformBlocks",new Map);p(this,"uniformBufferLayouts",new Map);p(this,"uniformBuffers",new Map);for(const[t,n]of Object.entries(e)){const r=t,i=new ug(n.uniformTypes||{});this.uniformBufferLayouts.set(r,i);const o=new dg({name:t});o.setUniforms(n.defaultUniforms||{}),this.uniformBlocks.set(r,o)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(const[t,n]of Object.entries(e))this.uniformBlocks.get(t).setUniforms(n);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e).byteLength}getUniformBufferData(e){const t=this.uniformBlocks.get(e).getAllUniforms();return this.uniformBufferLayouts.get(e).getData(t)}createUniformBuffer(e,t,n){n&&this.setUniforms(n);const r=this.getUniformBufferByteLength(t),i=e.createBuffer({usage:se.UNIFORM|se.COPY_DST,byteLength:r}),o=this.getUniformBufferData(t);return i.write(o),i}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const n=this.getUniformBufferByteLength(t),r=e.createBuffer({usage:se.UNIFORM|se.COPY_DST,byteLength:n});this.uniformBuffers.set(t,r)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const n=this.updateUniformBuffer(t);e||(e=n)}return e&&D.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){const t=this.uniformBlocks.get(e),n=this.uniformBuffers.get(e);let r=!1;if(n&&t.needsRedraw){r||(r=t.needsRedraw);const i=this.getUniformBufferData(e);this.uniformBuffers.get(e).write(i);const a=this.uniformBlocks.get(e).getAllUniforms();D.log(4,`Writing to uniform buffer ${String(e)}`,i,a)()}return r}}function Kl(s){const e=ArrayBuffer.isView(s)?s.constructor:s;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function Zl(s){switch(s){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(s)}}function _g(s,e,t){if(!e||e>4)throw new Error(`size ${e}`);const n=e;let r=Kl(s);if(r==="uint8"&&t&&n===1)return"unorm8-webgl";if(r==="uint8"&&t&&n===3)return"unorm8x3-webgl";if(r==="uint8"||r==="sint8"){if(n===1||n===3)throw new Error(`size: ${e}`);return t&&(r=r.replace("int","norm")),`${r}x${n}`}if(r==="uint16"||r==="sint16"){if(n===1||n===3)throw new Error(`size: ${e}`);return t&&(r=r.replace("int","norm")),`${r}x${n}`}return n===1?r:`${r}x${n}`}function gg(s){return Ks(s)!==null||typeof s=="number"||typeof s=="boolean"}function wo(s){const e={bindings:{},uniforms:{}};return Object.keys(s).forEach(t=>{const n=s[t];gg(n)?e.uniforms[t]=n:e.bindings[t]=n}),e}function mg(s,e,t){const{removedProps:n={},deprecatedProps:r={},replacedProps:i={}}=t;for(const a in n)if(a in e){const l=n[a]?`${s}.${n[a]}`:"N/A";D.removed(`${s}.${a}`,l)()}for(const a in r)if(a in e){const c=r[a];D.deprecated(`${s}.${a}`,`${s}.${c}`)()}let o=null;for(const[a,c]of Object.entries(i))a in e&&(D.deprecated(`${s}.${a}`,`${s}.${c}`)(),o=o||Object.assign({},e),o[c]=e[a],delete o[a]);return o||e}let yg="";async function Tg(s,e){return await new Promise((t,n)=>{try{const r=new Image;r.onload=()=>t(r),r.onerror=()=>n(new Error(`Could not load image ${s}.`)),r.crossOrigin=(e==null?void 0:e.crossOrigin)||"anonymous",r.src=s.startsWith("http")?s:yg+s}catch(r){n(r)}})}async function Ql(s,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const n=document.createElement("script");return n.setAttribute("type","text/javascript"),n.setAttribute("src",s),new Promise((r,i)=>{n.onload=r,n.onerror=o=>i(new Error(`Unable to load script '${s}': ${o}`)),t.appendChild(n)})}function Vi(s,e,t){if(s===e)return!0;if(!t||!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let n=0;n<s.length;n++)if(!Vi(s[n],e[n],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){const n=Object.keys(s),r=Object.keys(e);if(n.length!==r.length)return!1;for(const i of n)if(!e.hasOwnProperty(i)||!Vi(s[i],e[i],t-1))return!1;return!0}return!1}function bg(s){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(s):setTimeout(s,1e3/60)}function vg(s){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(s):clearTimeout(s)}class ke{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class Ya{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class ut extends ke{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Mt extends ke{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class yt extends ke{constructor(e,t,n,r){super(e,n),this.format=t,this.access=r}get isTemplate(){return!0}}var ot,Jt,Ds,E,w;(s=>{s[s.Uniform=0]="Uniform",s[s.Storage=1]="Storage",s[s.Texture=2]="Texture",s[s.Sampler=3]="Sampler",s[s.StorageTexture=4]="StorageTexture"})(ot||(ot={}));class yn{constructor(e,t,n,r,i,o,a){this.name=e,this.type=t,this.group=n,this.binding=r,this.attributes=i,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class wg{constructor(e,t){this.name=e,this.type=t}}class Ag{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r,this.interpolation=null}}class qa{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r}}class Eg{constructor(e,t,n,r){this.name=e,this.type=t,this.attributes=n,this.id=r}}class Sg{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}}class xg{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}}class Rg{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class Ig{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class Ie{constructor(){this.id=Ie._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}search(e){}searchBlock(e,t){if(e){t(Qn.instance);for(const n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(Jn.instance)}}}Ie._id=0;class Qn extends Ie{}Qn.instance=new Qn;class Jn extends Ie{}Jn.instance=new Jn;class ne extends Ie{constructor(){super()}}class Gn extends ne{constructor(e,t,n,r,i,o){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=r,this.startLine=i,this.endLine=o}get astNodeType(){return"function"}search(e){this.searchBlock(this.body,e)}}class Cg extends ne{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Jl extends ne{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class $i extends ne{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Gl extends ne{constructor(e,t,n,r){super(),this.init=e,this.condition=t,this.increment=n,this.body=r}get astNodeType(){return"for"}search(e){var t,n,r;(t=this.init)===null||t===void 0||t.search(e),(n=this.condition)===null||n===void 0||n.search(e),(r=this.increment)===null||r===void 0||r.search(e),this.searchBlock(this.body,e)}}class lt extends ne{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Ao extends ne{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class er extends ne{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class zi extends ne{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}(s=>{s.increment="++",s.decrement="--"})(Jt||(Jt={})),(s=>{s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return s[t]}})(Jt||(Jt={}));class eu extends ne{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(s=>{s.assign="=",s.addAssign="+=",s.subtractAssin="-=",s.multiplyAssign="*=",s.divideAssign="/=",s.moduloAssign="%=",s.andAssign="&=",s.orAssign="|=",s.xorAssign="^=",s.shiftLeftAssign="<<=",s.shiftRightAssign=">>="})(Ds||(Ds={})),(s=>{s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(Ds||(Ds={}));class tu extends ne{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Eo extends ne{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}search(e){for(const t of this.args)t.search(e);e(this)}}class su extends ne{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class nu extends ne{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}}class ru extends ne{constructor(e,t,n,r){super(),this.condition=e,this.body=t,this.elseif=n,this.else=r}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class iu extends ne{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Pg extends ne{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Mg extends ne{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class ou extends ne{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class So extends ne{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Og extends ne{constructor(){super()}get astNodeType(){return"discard"}}class au extends ne{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class cu extends ne{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class k extends ne{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let n=1;n<e.length;++n){const r=k._priority.get(t.name);k._priority.get(e[n].name)<r&&(t=e[n])}return t.name==="x32"?k.i32:t}}k.x32=new k("x32"),k.f32=new k("f32"),k.i32=new k("i32"),k.u32=new k("u32"),k.f16=new k("f16"),k.bool=new k("bool"),k._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class at extends k{constructor(e,t,n,r){super(e),this.members=t,this.startLine=n,this.endLine=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}}class P extends k{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"template"}}P.vec2f=new P("vec2",k.f32,null),P.vec3f=new P("vec3",k.f32,null),P.vec4f=new P("vec4",k.f32,null),P.vec2i=new P("vec2",k.i32,null),P.vec3i=new P("vec3",k.i32,null),P.vec4i=new P("vec4",k.i32,null),P.vec2u=new P("vec2",k.u32,null),P.vec3u=new P("vec3",k.u32,null),P.vec4u=new P("vec4",k.u32,null),P.vec2h=new P("vec2",k.f16,null),P.vec3h=new P("vec3",k.f16,null),P.vec4h=new P("vec4",k.f16,null),P.vec2b=new P("vec2",k.bool,null),P.vec3b=new P("vec3",k.bool,null),P.vec4b=new P("vec4",k.bool,null),P.mat2x2f=new P("mat2x2",k.f32,null),P.mat2x3f=new P("mat2x3",k.f32,null),P.mat2x4f=new P("mat2x4",k.f32,null),P.mat3x2f=new P("mat3x2",k.f32,null),P.mat3x3f=new P("mat3x3",k.f32,null),P.mat3x4f=new P("mat3x4",k.f32,null),P.mat4x2f=new P("mat4x2",k.f32,null),P.mat4x3f=new P("mat4x3",k.f32,null),P.mat4x4f=new P("mat4x4",k.f32,null),P.mat2x2h=new P("mat2x2",k.f16,null),P.mat2x3h=new P("mat2x3",k.f16,null),P.mat2x4h=new P("mat2x4",k.f16,null),P.mat3x2h=new P("mat3x2",k.f16,null),P.mat3x3h=new P("mat3x3",k.f16,null),P.mat3x4h=new P("mat3x4",k.f16,null),P.mat4x2h=new P("mat4x2",k.f16,null),P.mat4x3h=new P("mat4x3",k.f16,null),P.mat4x4h=new P("mat4x4",k.f16,null);class Ng extends k{constructor(e,t,n,r){super(e),this.storage=t,this.type=n,this.access=r}get astNodeType(){return"pointer"}}class lu extends k{constructor(e,t,n,r){super(e),this.attributes=t,this.format=n,this.count=r}get astNodeType(){return"array"}get isArray(){return!0}}class Fs extends k{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"sampler"}}class Ue extends Ie{constructor(){super(),this.postfix=null}}class Dt extends Ue{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class Ot extends Ue{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class gs extends Ue{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return gs.builtinFunctionNames.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}gs.builtinFunctionNames=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class pt extends Ue{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class uu extends Ue{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const n=e.evalExpression(this.initializer,e.context);return n!==null&&this.postfix?n.getDataValue(e,this.postfix,e.context):n}return null}search(e){this.initializer.search(e)}}class oe extends Ue{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof S}get isVector(){return this.value instanceof y||this.value instanceof Y}get scalarValue(){return this.value instanceof S?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof y||this.value instanceof Y?this.value.value:(console.error("Value is not a vector or matrix."),[])}}class hu extends Ue{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class Nn extends Ue{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}constEvaluate(e,t){return this.contents[0].constEvaluate(e,t)}search(e){this.searchBlock(this.contents,e)}}class hs extends Ue{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class fu extends Ue{constructor(){super()}}class Ae extends fu{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Pe extends fu{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?k.f32:e.name==="u32"||t.name==="u32"?k.u32:k.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class du extends Ie{constructor(e){super(),this.body=e}}class kn extends Ue{constructor(){super()}get astNodeType(){return"default"}}class pu extends du{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class _u extends du{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class kg extends Ie{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"argument"}}class Dg extends Ie{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Fg extends Ie{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"member"}}class Ug extends Ie{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class Ft{constructor(e){this.typeInfo=e}setDataValue(e,t,n,r){console.error("SetDataValue: Not implemented",t,n)}getDataValue(e,t,n){return console.error("GetDataValue: Not implemented",t),null}toString(){return`<${this.typeInfo.name}>`}}class Wi extends Ft{constructor(){super(new ke("void",null))}toString(){return"void"}}Wi.void=new Wi;class S extends Ft{constructor(e,t){super(t),this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?e=Math.floor(e):this.typeInfo.name==="bool"&&(e=e?1:0),this.value=e}setDataValue(e,t,n,r){n?console.error("SetDataValue: Scalar data does not support postfix",n):t instanceof S?(t.value,this.typeInfo.name==="i32"||this.typeInfo.name==="u32"||this.typeInfo.name,this.value=t.value):console.error("SetDataValue: Invalid value",t)}getDataValue(e,t,n){return t?(console.error("GetDataValue: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function gu(s,e,t){const n=e.length;return n===2?t==="f32"?new y(e,s.getTypeInfo("vec2f")):t==="i32"?new y(e,s.getTypeInfo("vec2i")):t==="u32"?new y(e,s.getTypeInfo("vec2u")):t==="f16"?new y(e,s.getTypeInfo("vec2h")):(console.error(`GetDataValue: Unknown format ${t}`),null):n===3?t==="f32"?new y(e,s.getTypeInfo("vec3f")):t==="i32"?new y(e,s.getTypeInfo("vec3i")):t==="u32"?new y(e,s.getTypeInfo("vec3u")):t==="f16"?new y(e,s.getTypeInfo("vec3h")):(console.error(`GetDataValue: Unknown format ${t}`),null):n===4?t==="f32"?new y(e,s.getTypeInfo("vec4f")):t==="i32"?new y(e,s.getTypeInfo("vec4i")):t==="u32"?new y(e,s.getTypeInfo("vec4u")):t==="f16"?new y(e,s.getTypeInfo("vec4h")):(console.error(`GetDataValue: Unknown format ${t}`),null):(console.error(`GetDataValue: Invalid vector size ${e.length}`),null)}class y extends Ft{constructor(e,t){super(t),Array.isArray(e)?this.value=e:this.value=Array.from(e)}setDataValue(e,t,n,r){n instanceof Dt?console.error("TODO: Set vector postfix"):t instanceof y?this.value=t.value:console.error("SetDataValue: Invalid value",t)}getDataValue(e,t,n){let r=e.getTypeInfo("f32");if(this.typeInfo instanceof yt)r=this.typeInfo.format;else{const i=this.typeInfo.name;i==="vec2f"||i==="vec3f"||i==="vec4f"?r=e.getTypeInfo("f32"):i==="vec2i"||i==="vec3i"||i==="vec4i"?r=e.getTypeInfo("i32"):i==="vec2u"||i==="vec3u"||i==="vec4u"?r=e.getTypeInfo("u32"):i==="vec2h"||i==="vec3h"||i==="vec4h"?r=e.getTypeInfo("f16"):console.error(`GetDataValue: Unknown type ${i}`)}if(t instanceof hs){const i=t.index;let o=-1;if(i instanceof oe){if(!(i.value instanceof S))return console.error(`GetValueData: Invalid array index ${i.value}`),null;o=i.value.value}else{const a=e.evalExpression(i,n);if(!(a instanceof S))return console.error("GetDataValue: Unknown index type",i),null;o=a.value}return o<0||o>=this.value.length?(console.error("GetDataValue: Index out of range",o),null):new S(this.value[o],r)}if(t instanceof Dt){const i=t.value,o=[];for(const a of i)a==="x"||a==="r"?o.push(this.value[0]):a==="y"||a==="g"?o.push(this.value[1]):a==="z"||a==="b"?o.push(this.value[2]):a==="w"||a==="a"?o.push(this.value[3]):console.error(`GetDataValue: Unknown member ${a}`);return o.length===1?new S(o[0],r):gu(e,o,r.name)}return this}toString(){let e=`${this.value[0]}`;for(let t=1;t<this.value.length;++t)e+=`, ${this.value[t]}`;return e}}class Y extends Ft{constructor(e,t){super(t),this.value=e}setDataValue(e,t,n,r){n instanceof Dt?console.error("TODO: Set matrix postfix"):t instanceof Y?this.value=t.value:console.error("SetDataValue: Invalid value",t)}getDataValue(e,t,n){const r=this.typeInfo.name;let i=e.getTypeInfo("f32");if(this.typeInfo instanceof yt)i=this.typeInfo.format;else if(r.endsWith("f"))i=e.getTypeInfo("f32");else if(r.endsWith("i"))i=e.getTypeInfo("i32");else if(r.endsWith("u"))i=e.getTypeInfo("u32");else{if(!r.endsWith("h"))return console.error(`GetDataValue: Unknown type ${r}`),null;i=e.getTypeInfo("f16")}if(t instanceof hs){const o=t.index;let a,c=-1;if(o instanceof oe){if(!(o.value instanceof S))return console.error(`GetDataValue: Invalid array index ${o.value}`),null;c=o.value.value}else{const u=e.evalExpression(o,n);if(!(u instanceof S))return console.error("GetDataValue: Unknown index type",o),null;c=u.value}if(c<0||c>=this.value.length)return console.error("GetDataValue: Index out of range",c),null;if(r==="mat2x2"||r==="mat2x2f"||r==="mat2x2h")a=this.value.slice(2*c,2*c+2);else if(r==="mat2x3"||r==="mat2x3f"||r==="mat2x3h")a=this.value.slice(3*c,3*c+3);else if(r==="mat2x4"||r==="mat2x4f"||r==="mat2x4h")a=this.value.slice(4*c,4*c+4);else if(r==="mat3x2"||r==="mat3x2f"||r==="mat3x2h")a=this.value.slice(2*c,2*c+2);else if(r==="mat3x3"||r==="mat3x3f"||r==="mat3x3h")a=this.value.slice(3*c,3*c+3);else if(r==="mat3x4"||r==="mat3x4f"||r==="mat3x4h")a=this.value.slice(4*c,4*c+4);else if(r==="mat4x2"||r==="mat4x2f"||r==="mat4x2h")a=this.value.slice(2*c,2*c+2);else if(r==="mat4x3"||r==="mat4x3f"||r==="mat4x3h")a=this.value.slice(3*c,3*c+3);else{if(r!=="mat4x4"&&r!=="mat4x4f"&&r!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${r}`),null;a=this.value.slice(4*c,4*c+4)}const l=gu(e,a,i.name);if(t.postfix)return l.getDataValue(e,t.postfix,n)}return this}toString(){let e=`${this.value[0]}`;for(let t=1;t<this.value.length;++t)e+=`, ${this.value[t]}`;return e}}class ae extends Ft{constructor(e,t,n=0,r){super(t),this.textureSize=[0,0,0],this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n,r!==void 0&&(this.textureSize=r)}setDataValue(e,t,n,r){if(t===null)return void console.log("setDataValue: NULL data.");let i=this.offset,o=this.typeInfo;for(;n;){if(n instanceof hs)if(o instanceof Mt){const a=n.index;if(a instanceof oe){if(!(a.value instanceof S))return void console.error(`SetDataValue: Invalid index type ${a.value}`);i+=a.value.value*o.stride}else{const c=e.evalExpression(a,r);if(!(c instanceof S))return void console.error("SetDataValue: Unknown index type",a);i+=c.value*o.stride}o=o.format}else console.error(`SetDataValue: Type ${e.getTypeName(o)} is not an array`);else{if(!(n instanceof Dt))return void console.error("SetDataValue: Unknown postfix type",n);{const a=n.value;if(o instanceof ut){let c=!1;for(const l of o.members)if(l.name===a){i+=l.offset,o=l.type,c=!0;break}if(!c)return void console.error(`SetDataValue: Member ${a} not found`)}else if(o instanceof ke){const c=e.getTypeName(o);let l=0;if(a==="x"||a==="r")l=0;else if(a==="y"||a==="g")l=1;else if(a==="z"||a==="b")l=2;else{if(a!=="w"&&a!=="a")return void console.error(`SetDataValue: Unknown member ${a}`);l=3}if(!(t instanceof S))return void console.error("SetDataValue: Invalid value",t);const u=t.value;return c==="vec2f"?void(new Float32Array(this.buffer,i,2)[l]=u):c==="vec3f"?void(new Float32Array(this.buffer,i,3)[l]=u):c==="vec4f"?void(new Float32Array(this.buffer,i,4)[l]=u):c==="vec2i"?void(new Int32Array(this.buffer,i,2)[l]=u):c==="vec3i"?void(new Int32Array(this.buffer,i,3)[l]=u):c==="vec4i"?void(new Int32Array(this.buffer,i,4)[l]=u):c==="vec2u"?void(new Uint32Array(this.buffer,i,2)[l]=u):c==="vec3u"?void(new Uint32Array(this.buffer,i,3)[l]=u):c==="vec4u"?void(new Uint32Array(this.buffer,i,4)[l]=u):void console.error(`SetDataValue: Type ${c} is not a struct`)}}}n=n.postfix}this.setData(e,t,o,i,r)}setData(e,t,n,r,i){const o=e.getTypeName(n);if(o!=="f32"&&o!=="f16")if(o!=="i32"&&o!=="atomic<i32>"&&o!=="x32")if(o!=="u32"&&o!=="atomic<u32>")if(o!=="bool")if(o!=="vec2f"&&o!=="vec2h")if(o!=="vec3f"&&o!=="vec3h")if(o!=="vec4f"&&o!=="vec4h")if(o!=="vec2i")if(o!=="vec3i")if(o!=="vec4i")if(o!=="vec2u")if(o!=="vec3u")if(o!=="vec4u")if(o!=="vec2b")if(o!=="vec3b")if(o!=="vec4b")if(o!=="mat2x2f"&&o!=="mat2x2h")if(o!=="mat2x3f"&&o!=="mat2x3h")if(o!=="mat2x4f"&&o!=="mat2x4h")if(o!=="mat3x2f"&&o!=="mat3x2h")if(o!=="mat3x3f"&&o!=="mat3x3h")if(o!=="mat3x4f"&&o!=="mat3x4h")if(o!=="mat4x2f"&&o!=="mat4x2h")if(o!=="mat4x3f"&&o!=="mat4x3h")if(o!=="mat4x4f"&&o!=="mat4x4h")if(t instanceof ae){if(n===t.typeInfo)return void new Uint8Array(this.buffer,r,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",o,e.getTypeName(t.typeInfo))}else console.error(`SetData: Unknown type ${o}`);else{const a=new Float32Array(this.buffer,r,16);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5],a[6]=t.value[6],a[7]=t.value[7],a[8]=t.value[8],a[9]=t.value[9],a[10]=t.value[10],a[11]=t.value[11],a[12]=t.value[12],a[13]=t.value[13],a[14]=t.value[14],a[15]=t.value[15]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11],a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15])}else{const a=new Float32Array(this.buffer,r,12);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5],a[6]=t.value[6],a[7]=t.value[7],a[8]=t.value[8],a[9]=t.value[9],a[10]=t.value[10],a[11]=t.value[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11])}else{const a=new Float32Array(this.buffer,r,8);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5],a[6]=t.value[6],a[7]=t.value[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7])}else{const a=new Float32Array(this.buffer,r,12);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5],a[6]=t.value[6],a[7]=t.value[7],a[8]=t.value[8],a[9]=t.value[9],a[10]=t.value[10],a[11]=t.value[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11])}else{const a=new Float32Array(this.buffer,r,9);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5],a[6]=t.value[6],a[7]=t.value[7],a[8]=t.value[8]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8])}else{const a=new Float32Array(this.buffer,r,6);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5])}else{const a=new Float32Array(this.buffer,r,8);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5],a[6]=t.value[6],a[7]=t.value[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7])}else{const a=new Float32Array(this.buffer,r,6);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3],a[4]=t.value[4],a[5]=t.value[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5])}else{const a=new Float32Array(this.buffer,r,4);t instanceof Y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Uint32Array(this.buffer,r,4);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Uint32Array(this.buffer,r,3);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Uint32Array(this.buffer,r,2);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1]):(a[0]=t[0],a[1]=t[1])}else{const a=new Uint32Array(this.buffer,r,4);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Uint32Array(this.buffer,r,3);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Uint32Array(this.buffer,r,2);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1]):(a[0]=t[0],a[1]=t[1])}else{const a=new Int32Array(this.buffer,r,4);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Int32Array(this.buffer,r,3);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Int32Array(this.buffer,r,2);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1]):(a[0]=t[0],a[1]=t[1])}else{const a=new Float32Array(this.buffer,r,4);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2],a[3]=t.value[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Float32Array(this.buffer,r,3);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1],a[2]=t.value[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Float32Array(this.buffer,r,2);t instanceof y?(a[0]=t.value[0],a[1]=t.value[1]):(a[0]=t[0],a[1]=t[1])}else t instanceof S&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof S&&(new Uint32Array(this.buffer,r,1)[0]=t.value);else t instanceof S&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof S&&(new Float32Array(this.buffer,r,1)[0]=t.value)}getDataValue(e,t,n){let r=this.offset,i=this.typeInfo;for(;t;){if(t instanceof hs){const a=t.index,c=e.evalExpression(a,n);let l=0;if(c instanceof S?l=c.value:console.error("GetDataValue: Invalid index type",a),i instanceof Mt)r+=l*i.stride,i=i.format;else{const u=e.getTypeName(i);u==="mat4x4"||u==="mat4x4f"||u==="mat4x4h"?(r+=16*l,i=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${e.getTypeName(i)} is not an array`)}}else{if(!(t instanceof Dt))return console.error("GetDataValue: Unknown postfix type",t),null;{const a=t.value;if(i instanceof ut){let c=!1;for(const l of i.members)if(l.name===a){r+=l.offset,i=l.type,c=!0;break}if(!c)return console.error(`GetDataValue: Member ${a} not found`),null}else if(i instanceof ke){const c=e.getTypeName(i);if(c==="vec2f"||c==="vec3f"||c==="vec4f"||c==="vec2i"||c==="vec3i"||c==="vec4i"||c==="vec2u"||c==="vec3u"||c==="vec4u"||c==="vec2b"||c==="vec3b"||c==="vec4b"||c==="vec2h"||c==="vec3h"||c==="vec4h"||c==="vec2"||c==="vec3"||c==="vec4"){if(a.length>0&&a.length<5){let l="f32",u="f";const h=[];for(let f=0;f<a.length;++f){const _=a[f].toLocaleLowerCase();let T=0;if(_==="x"||_==="r")T=0;else if(_==="y"||_==="g")T=1;else if(_==="z"||_==="b")T=2;else{if(_!=="w"&&_!=="a")return console.error(`Unknown member ${a}`),null;T=3}if(c==="vec2f")h.push(new Float32Array(this.buffer,r,2)[T]);else if(c==="vec3f"){if(r+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const v=new Float32Array(this.buffer,r,3);h.push(v[T])}else if(c==="vec4f")h.push(new Float32Array(this.buffer,r,4)[T]);else if(c==="vec2i")l="i32",u="i",h.push(new Int32Array(this.buffer,r,2)[T]);else if(c==="vec3i")l="i32",u="i",h.push(new Int32Array(this.buffer,r,3)[T]);else if(c==="vec4i")l="i32",u="i",h.push(new Int32Array(this.buffer,r,4)[T]);else if(c==="vec2u"){l="u32",u="u";const v=new Uint32Array(this.buffer,r,2);h.push(v[T])}else c==="vec3u"?(l="u32",u="u",h.push(new Uint32Array(this.buffer,r,3)[T])):c==="vec4u"&&(l="u32",u="u",h.push(new Uint32Array(this.buffer,r,4)[T]))}return h.length===1?new S(h[0],e.getTypeInfo(l)):(h.length===2?i=e.getTypeInfo(`vec2${u}`):h.length===3?i=e.getTypeInfo(`vec3${u}`):h.length===4?i=e.getTypeInfo(`vec4${u}`):console.error(`GetDataValue: Invalid vector length ${h.length}`),new y(h,i))}return console.error(`GetDataValue: Unknown member ${a}`),null}return console.error(`GetDataValue: Type ${c} is not a struct`),null}}}t=t.postfix}const o=e.getTypeName(i);return o==="f32"?new S(new Float32Array(this.buffer,r,1)[0],i):o==="i32"?new S(new Int32Array(this.buffer,r,1)[0],i):o==="u32"?new S(new Uint32Array(this.buffer,r,1)[0],i):o==="vec2f"?new y(new Float32Array(this.buffer,r,2),i):o==="vec3f"?new y(new Float32Array(this.buffer,r,3),i):o==="vec4f"?new y(new Float32Array(this.buffer,r,4),i):o==="vec2i"?new y(new Int32Array(this.buffer,r,2),i):o==="vec3i"?new y(new Int32Array(this.buffer,r,3),i):o==="vec4i"?new y(new Int32Array(this.buffer,r,4),i):o==="vec2u"?new y(new Uint32Array(this.buffer,r,2),i):o==="vec3u"?new y(new Uint32Array(this.buffer,r,3),i):o==="vec4u"?new y(new Uint32Array(this.buffer,r,4),i):i instanceof yt&&i.name==="atomic"?i.format.name==="u32"?new S(new Uint32Array(this.buffer,r,1)[0],i.format):i.format.name==="i32"?new S(new Int32Array(this.buffer,r,1)[0],i.format):(console.error(`GetDataValue: Invalid atomic format ${i.format.name}`),null):new ae(this.buffer,i,r)}toString(){let e="";if(this.typeInfo instanceof Mt)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e="[...]";else this.typeInfo instanceof ut?e+="{...}":e="[...]";return e}}(s=>{s[s.token=0]="token",s[s.keyword=1]="keyword",s[s.reserved=2]="reserved"})(w||(w={}));class A{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}}class g{}E=g,g.none=new A("",w.reserved,""),g.eof=new A("EOF",w.token,""),g.reserved={asm:new A("asm",w.reserved,"asm"),bf16:new A("bf16",w.reserved,"bf16"),do:new A("do",w.reserved,"do"),enum:new A("enum",w.reserved,"enum"),f16:new A("f16",w.reserved,"f16"),f64:new A("f64",w.reserved,"f64"),handle:new A("handle",w.reserved,"handle"),i8:new A("i8",w.reserved,"i8"),i16:new A("i16",w.reserved,"i16"),i64:new A("i64",w.reserved,"i64"),mat:new A("mat",w.reserved,"mat"),premerge:new A("premerge",w.reserved,"premerge"),regardless:new A("regardless",w.reserved,"regardless"),typedef:new A("typedef",w.reserved,"typedef"),u8:new A("u8",w.reserved,"u8"),u16:new A("u16",w.reserved,"u16"),u64:new A("u64",w.reserved,"u64"),unless:new A("unless",w.reserved,"unless"),using:new A("using",w.reserved,"using"),vec:new A("vec",w.reserved,"vec"),void:new A("void",w.reserved,"void")},g.keywords={array:new A("array",w.keyword,"array"),atomic:new A("atomic",w.keyword,"atomic"),bool:new A("bool",w.keyword,"bool"),f32:new A("f32",w.keyword,"f32"),i32:new A("i32",w.keyword,"i32"),mat2x2:new A("mat2x2",w.keyword,"mat2x2"),mat2x3:new A("mat2x3",w.keyword,"mat2x3"),mat2x4:new A("mat2x4",w.keyword,"mat2x4"),mat3x2:new A("mat3x2",w.keyword,"mat3x2"),mat3x3:new A("mat3x3",w.keyword,"mat3x3"),mat3x4:new A("mat3x4",w.keyword,"mat3x4"),mat4x2:new A("mat4x2",w.keyword,"mat4x2"),mat4x3:new A("mat4x3",w.keyword,"mat4x3"),mat4x4:new A("mat4x4",w.keyword,"mat4x4"),ptr:new A("ptr",w.keyword,"ptr"),sampler:new A("sampler",w.keyword,"sampler"),sampler_comparison:new A("sampler_comparison",w.keyword,"sampler_comparison"),struct:new A("struct",w.keyword,"struct"),texture_1d:new A("texture_1d",w.keyword,"texture_1d"),texture_2d:new A("texture_2d",w.keyword,"texture_2d"),texture_2d_array:new A("texture_2d_array",w.keyword,"texture_2d_array"),texture_3d:new A("texture_3d",w.keyword,"texture_3d"),texture_cube:new A("texture_cube",w.keyword,"texture_cube"),texture_cube_array:new A("texture_cube_array",w.keyword,"texture_cube_array"),texture_multisampled_2d:new A("texture_multisampled_2d",w.keyword,"texture_multisampled_2d"),texture_storage_1d:new A("texture_storage_1d",w.keyword,"texture_storage_1d"),texture_storage_2d:new A("texture_storage_2d",w.keyword,"texture_storage_2d"),texture_storage_2d_array:new A("texture_storage_2d_array",w.keyword,"texture_storage_2d_array"),texture_storage_3d:new A("texture_storage_3d",w.keyword,"texture_storage_3d"),texture_depth_2d:new A("texture_depth_2d",w.keyword,"texture_depth_2d"),texture_depth_2d_array:new A("texture_depth_2d_array",w.keyword,"texture_depth_2d_array"),texture_depth_cube:new A("texture_depth_cube",w.keyword,"texture_depth_cube"),texture_depth_cube_array:new A("texture_depth_cube_array",w.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new A("texture_depth_multisampled_2d",w.keyword,"texture_depth_multisampled_2d"),texture_external:new A("texture_external",w.keyword,"texture_external"),u32:new A("u32",w.keyword,"u32"),vec2:new A("vec2",w.keyword,"vec2"),vec3:new A("vec3",w.keyword,"vec3"),vec4:new A("vec4",w.keyword,"vec4"),bitcast:new A("bitcast",w.keyword,"bitcast"),block:new A("block",w.keyword,"block"),break:new A("break",w.keyword,"break"),case:new A("case",w.keyword,"case"),continue:new A("continue",w.keyword,"continue"),continuing:new A("continuing",w.keyword,"continuing"),default:new A("default",w.keyword,"default"),diagnostic:new A("diagnostic",w.keyword,"diagnostic"),discard:new A("discard",w.keyword,"discard"),else:new A("else",w.keyword,"else"),enable:new A("enable",w.keyword,"enable"),fallthrough:new A("fallthrough",w.keyword,"fallthrough"),false:new A("false",w.keyword,"false"),fn:new A("fn",w.keyword,"fn"),for:new A("for",w.keyword,"for"),function:new A("function",w.keyword,"function"),if:new A("if",w.keyword,"if"),let:new A("let",w.keyword,"let"),const:new A("const",w.keyword,"const"),loop:new A("loop",w.keyword,"loop"),while:new A("while",w.keyword,"while"),private:new A("private",w.keyword,"private"),read:new A("read",w.keyword,"read"),read_write:new A("read_write",w.keyword,"read_write"),return:new A("return",w.keyword,"return"),requires:new A("requires",w.keyword,"requires"),storage:new A("storage",w.keyword,"storage"),switch:new A("switch",w.keyword,"switch"),true:new A("true",w.keyword,"true"),alias:new A("alias",w.keyword,"alias"),type:new A("type",w.keyword,"type"),uniform:new A("uniform",w.keyword,"uniform"),var:new A("var",w.keyword,"var"),override:new A("override",w.keyword,"override"),workgroup:new A("workgroup",w.keyword,"workgroup"),write:new A("write",w.keyword,"write"),r8unorm:new A("r8unorm",w.keyword,"r8unorm"),r8snorm:new A("r8snorm",w.keyword,"r8snorm"),r8uint:new A("r8uint",w.keyword,"r8uint"),r8sint:new A("r8sint",w.keyword,"r8sint"),r16uint:new A("r16uint",w.keyword,"r16uint"),r16sint:new A("r16sint",w.keyword,"r16sint"),r16float:new A("r16float",w.keyword,"r16float"),rg8unorm:new A("rg8unorm",w.keyword,"rg8unorm"),rg8snorm:new A("rg8snorm",w.keyword,"rg8snorm"),rg8uint:new A("rg8uint",w.keyword,"rg8uint"),rg8sint:new A("rg8sint",w.keyword,"rg8sint"),r32uint:new A("r32uint",w.keyword,"r32uint"),r32sint:new A("r32sint",w.keyword,"r32sint"),r32float:new A("r32float",w.keyword,"r32float"),rg16uint:new A("rg16uint",w.keyword,"rg16uint"),rg16sint:new A("rg16sint",w.keyword,"rg16sint"),rg16float:new A("rg16float",w.keyword,"rg16float"),rgba8unorm:new A("rgba8unorm",w.keyword,"rgba8unorm"),rgba8unorm_srgb:new A("rgba8unorm_srgb",w.keyword,"rgba8unorm_srgb"),rgba8snorm:new A("rgba8snorm",w.keyword,"rgba8snorm"),rgba8uint:new A("rgba8uint",w.keyword,"rgba8uint"),rgba8sint:new A("rgba8sint",w.keyword,"rgba8sint"),bgra8unorm:new A("bgra8unorm",w.keyword,"bgra8unorm"),bgra8unorm_srgb:new A("bgra8unorm_srgb",w.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new A("rgb10a2unorm",w.keyword,"rgb10a2unorm"),rg11b10float:new A("rg11b10float",w.keyword,"rg11b10float"),rg32uint:new A("rg32uint",w.keyword,"rg32uint"),rg32sint:new A("rg32sint",w.keyword,"rg32sint"),rg32float:new A("rg32float",w.keyword,"rg32float"),rgba16uint:new A("rgba16uint",w.keyword,"rgba16uint"),rgba16sint:new A("rgba16sint",w.keyword,"rgba16sint"),rgba16float:new A("rgba16float",w.keyword,"rgba16float"),rgba32uint:new A("rgba32uint",w.keyword,"rgba32uint"),rgba32sint:new A("rgba32sint",w.keyword,"rgba32sint"),rgba32float:new A("rgba32float",w.keyword,"rgba32float"),static_assert:new A("static_assert",w.keyword,"static_assert")},g.tokens={decimal_float_literal:new A("decimal_float_literal",w.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new A("hex_float_literal",w.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new A("int_literal",w.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new A("uint_literal",w.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new A("name",w.token,/[_a-zA-Z][0-9a-zA-Z_]*/),ident:new A("ident",w.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new A("and",w.token,"&"),and_and:new A("and_and",w.token,"&&"),arrow:new A("arrow ",w.token,"->"),attr:new A("attr",w.token,"@"),forward_slash:new A("forward_slash",w.token,"/"),bang:new A("bang",w.token,"!"),bracket_left:new A("bracket_left",w.token,"["),bracket_right:new A("bracket_right",w.token,"]"),brace_left:new A("brace_left",w.token,"{"),brace_right:new A("brace_right",w.token,"}"),colon:new A("colon",w.token,":"),comma:new A("comma",w.token,","),equal:new A("equal",w.token,"="),equal_equal:new A("equal_equal",w.token,"=="),not_equal:new A("not_equal",w.token,"!="),greater_than:new A("greater_than",w.token,">"),greater_than_equal:new A("greater_than_equal",w.token,">="),shift_right:new A("shift_right",w.token,">>"),less_than:new A("less_than",w.token,"<"),less_than_equal:new A("less_than_equal",w.token,"<="),shift_left:new A("shift_left",w.token,"<<"),modulo:new A("modulo",w.token,"%"),minus:new A("minus",w.token,"-"),minus_minus:new A("minus_minus",w.token,"--"),period:new A("period",w.token,"."),plus:new A("plus",w.token,"+"),plus_plus:new A("plus_plus",w.token,"++"),or:new A("or",w.token,"|"),or_or:new A("or_or",w.token,"||"),paren_left:new A("paren_left",w.token,"("),paren_right:new A("paren_right",w.token,")"),semicolon:new A("semicolon",w.token,";"),star:new A("star",w.token,"*"),tilde:new A("tilde",w.token,"~"),underscore:new A("underscore",w.token,"_"),xor:new A("xor",w.token,"^"),plus_equal:new A("plus_equal",w.token,"+="),minus_equal:new A("minus_equal",w.token,"-="),times_equal:new A("times_equal",w.token,"*="),division_equal:new A("division_equal",w.token,"/="),modulo_equal:new A("modulo_equal",w.token,"%="),and_equal:new A("and_equal",w.token,"&="),or_equal:new A("or_equal",w.token,"|="),xor_equal:new A("xor_equal",w.token,"^="),shift_right_equal:new A("shift_right_equal",w.token,">>="),shift_left_equal:new A("shift_left_equal",w.token,"<<=")},g.simpleTokens={"@":E.tokens.attr,"{":E.tokens.brace_left,"}":E.tokens.brace_right,":":E.tokens.colon,",":E.tokens.comma,"(":E.tokens.paren_left,")":E.tokens.paren_right,";":E.tokens.semicolon},g.literalTokens={"&":E.tokens.and,"&&":E.tokens.and_and,"->":E.tokens.arrow,"/":E.tokens.forward_slash,"!":E.tokens.bang,"[":E.tokens.bracket_left,"]":E.tokens.bracket_right,"=":E.tokens.equal,"==":E.tokens.equal_equal,"!=":E.tokens.not_equal,">":E.tokens.greater_than,">=":E.tokens.greater_than_equal,">>":E.tokens.shift_right,"<":E.tokens.less_than,"<=":E.tokens.less_than_equal,"<<":E.tokens.shift_left,"%":E.tokens.modulo,"-":E.tokens.minus,"--":E.tokens.minus_minus,".":E.tokens.period,"+":E.tokens.plus,"++":E.tokens.plus_plus,"|":E.tokens.or,"||":E.tokens.or_or,"*":E.tokens.star,"~":E.tokens.tilde,_:E.tokens.underscore,"^":E.tokens.xor,"+=":E.tokens.plus_equal,"-=":E.tokens.minus_equal,"*=":E.tokens.times_equal,"/=":E.tokens.division_equal,"%=":E.tokens.modulo_equal,"&=":E.tokens.and_equal,"|=":E.tokens.or_equal,"^=":E.tokens.xor_equal,">>=":E.tokens.shift_right_equal,"<<=":E.tokens.shift_left_equal},g.regexTokens={decimal_float_literal:E.tokens.decimal_float_literal,hex_float_literal:E.tokens.hex_float_literal,int_literal:E.tokens.int_literal,uint_literal:E.tokens.uint_literal,ident:E.tokens.ident},g.storage_class=[E.keywords.function,E.keywords.private,E.keywords.workgroup,E.keywords.uniform,E.keywords.storage],g.access_mode=[E.keywords.read,E.keywords.write,E.keywords.read_write],g.sampler_type=[E.keywords.sampler,E.keywords.sampler_comparison],g.sampled_texture_type=[E.keywords.texture_1d,E.keywords.texture_2d,E.keywords.texture_2d_array,E.keywords.texture_3d,E.keywords.texture_cube,E.keywords.texture_cube_array],g.multisampled_texture_type=[E.keywords.texture_multisampled_2d],g.storage_texture_type=[E.keywords.texture_storage_1d,E.keywords.texture_storage_2d,E.keywords.texture_storage_2d_array,E.keywords.texture_storage_3d],g.depth_texture_type=[E.keywords.texture_depth_2d,E.keywords.texture_depth_2d_array,E.keywords.texture_depth_cube,E.keywords.texture_depth_cube_array,E.keywords.texture_depth_multisampled_2d],g.texture_external_type=[E.keywords.texture_external],g.any_texture_type=[...E.sampled_texture_type,...E.multisampled_texture_type,...E.storage_texture_type,...E.depth_texture_type,...E.texture_external_type],g.texel_format=[E.keywords.r8unorm,E.keywords.r8snorm,E.keywords.r8uint,E.keywords.r8sint,E.keywords.r16uint,E.keywords.r16sint,E.keywords.r16float,E.keywords.rg8unorm,E.keywords.rg8snorm,E.keywords.rg8uint,E.keywords.rg8sint,E.keywords.r32uint,E.keywords.r32sint,E.keywords.r32float,E.keywords.rg16uint,E.keywords.rg16sint,E.keywords.rg16float,E.keywords.rgba8unorm,E.keywords.rgba8unorm_srgb,E.keywords.rgba8snorm,E.keywords.rgba8uint,E.keywords.rgba8sint,E.keywords.bgra8unorm,E.keywords.bgra8unorm_srgb,E.keywords.rgb10a2unorm,E.keywords.rg11b10float,E.keywords.rg32uint,E.keywords.rg32sint,E.keywords.rg32float,E.keywords.rgba16uint,E.keywords.rgba16sint,E.keywords.rgba16float,E.keywords.rgba32uint,E.keywords.rgba32sint,E.keywords.rgba32float],g.const_literal=[E.tokens.int_literal,E.tokens.uint_literal,E.tokens.decimal_float_literal,E.tokens.hex_float_literal,E.keywords.true,E.keywords.false],g.literal_or_ident=[E.tokens.ident,E.tokens.int_literal,E.tokens.uint_literal,E.tokens.decimal_float_literal,E.tokens.hex_float_literal,E.tokens.name],g.element_count_expression=[E.tokens.int_literal,E.tokens.uint_literal,E.tokens.ident],g.template_types=[E.keywords.vec2,E.keywords.vec3,E.keywords.vec4,E.keywords.mat2x2,E.keywords.mat2x3,E.keywords.mat2x4,E.keywords.mat3x2,E.keywords.mat3x3,E.keywords.mat3x4,E.keywords.mat4x2,E.keywords.mat4x3,E.keywords.mat4x4,E.keywords.atomic,E.keywords.bitcast,...E.any_texture_type],g.attribute_name=[E.tokens.ident,E.keywords.block,E.keywords.diagnostic],g.assignment_operators=[E.tokens.equal,E.tokens.plus_equal,E.tokens.minus_equal,E.tokens.times_equal,E.tokens.division_equal,E.tokens.modulo_equal,E.tokens.and_equal,E.tokens.or_equal,E.tokens.xor_equal,E.tokens.shift_right_equal,E.tokens.shift_left_equal],g.increment_operators=[E.tokens.plus_plus,E.tokens.minus_minus];class Ka{constructor(e,t,n){this.type=e,this.lexeme=t,this.line=n}toString(){return this.lexeme}isTemplateType(){return g.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==g.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class Bg{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Ka(g.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const t=g.simpleTokens[e];if(t)return this._addToken(t),!0;let n=g.none;const r=this._isAlpha(e),i=e==="_";if(this._isAlphaNumeric(e)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)e+=this._advance(),o=this._peekAhead()}if(r){const o=g.keywords[e];if(o)return this._addToken(o),!0}if(r||i)return this._addToken(g.tokens.ident),!0;for(;;){let o=this._findType(e);const a=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(a=="=")return this._current++,e+=a,this._addToken(g.tokens.minus_equal),!0;if(a=="-")return this._current++,e+=a,this._addToken(g.tokens.minus_minus),!0;const c=this._tokens.length-1;if((g.literal_or_ident.indexOf(this._tokens[c].type)!=-1||this._tokens[c].type==g.tokens.paren_right)&&a!=">")return this._addToken(o),!0}if(e==">"&&(a==">"||a=="=")){let c=!1,l=this._tokens.length-1;for(let u=0;u<5&&l>=0&&g.assignment_operators.indexOf(this._tokens[l].type)===-1;++u,--l)if(this._tokens[l].type===g.tokens.less_than){l>0&&this._tokens[l-1].isArrayOrTemplateType()&&(c=!0);break}if(c)return this._addToken(o),!0}if(o===g.none){let c=e,l=0;const u=2;for(let h=0;h<u;++h)if(c+=this._peekAhead(h),o=this._findType(c),o!==g.none){l=h;break}if(o===g.none)return n!==g.none&&(this._current--,this._addToken(n),!0);e=c,this._current+=l+1}if(n=o,this._isAtEnd())break;e+=this._advance()}return n!==g.none&&(this._addToken(n),!0)}_findType(e){for(const n in g.regexTokens){const r=g.regexTokens[n];if(this._match(e,r.rule))return r}return g.literalTokens[e]||g.none}_match(e,t){const n=t.exec(e);return n&&n.index==0&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e=="_"||e>="0"&&e<="9"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Ka(e,t,this._line))}}class Lg{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Tn{constructor(e,t){this.align=e,this.size=t}}class Ye{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new Rg,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof Gn&&this._functions.set(t.name,new Lg(t));for(const t of e)if(t instanceof at){const n=this.getTypeInfo(t,null);n instanceof ut&&this.structs.push(n)}for(const t of e)if(t instanceof So)this.aliases.push(this._getAliasInfo(t));else if(t instanceof Ao){const n=t,r=this._getAttributeNum(n.attributes,"id",0),i=n.type!=null?this.getTypeInfo(n.type,n.attributes):null;this.overrides.push(new Eg(n.name,i,n.attributes,r))}else if(this._isUniformVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=new yn(n.name,o,r,i,n.attributes,ot.Uniform,n.access);this.uniforms.push(a)}else if(this._isStorageVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=this._isStorageTexture(o),c=new yn(n.name,o,r,i,n.attributes,a?ot.StorageTexture:ot.Storage,n.access);this.storage.push(c)}else if(this._isTextureVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=this._isStorageTexture(o),c=new yn(n.name,o,r,i,n.attributes,a?ot.StorageTexture:ot.Texture,n.access);a?this.storage.push(c):this.textures.push(c)}else if(this._isSamplerVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=new yn(n.name,o,r,i,n.attributes,ot.Sampler,n.access);this.samplers.push(a)}else if(t instanceof Gn){const n=this._getAttribute(t,"vertex"),r=this._getAttribute(t,"fragment"),i=this._getAttribute(t,"compute"),o=n||r||i,a=new xg(t.name,o==null?void 0:o.name,t.attributes);a.attributes=t.attributes,a.startLine=t.startLine,a.endLine=t.endLine,this.functions.push(a),this._functions.get(t.name).info=a,o&&(this._functions.get(t.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(t,!!o),a.inputs=this._getInputs(t.args),a.outputs=this._getOutputs(t.returnType),this.entry[o.name].push(a)),a.arguments=t.args.map(c=>new Sg(c.name,this.getTypeInfo(c.type,c.attributes),c.attributes)),a.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(n=>{var r;if(n.astNodeType==="varExpr"){const i=n;for(const o of this.overrides)i.name==o.name&&((r=t.info)===null||r===void 0||r.overrides.push(o))}});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var n;for(const r of e.calls){const i=(n=this._functions.get(r.name))===null||n===void 0?void 0:n.info;i&&t.add(i)}}findResource(e,t){for(const n of this.uniforms)if(n.group==e&&n.binding==t)return n;for(const n of this.storage)if(n.group==e&&n.binding==t)return n;for(const n of this.textures)if(n.group==e&&n.binding==t)return n;for(const n of this.samplers)if(n.group==e&&n.binding==t)return n;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const n=[],r=this,i=[];return e.search(o=>{if(o instanceof Qn)i.push({});else if(o instanceof Jn)i.pop();else if(o instanceof lt){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof Ot){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type)}else if(o instanceof er){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof pt){const a=o;if(i.length>0&&i[i.length-1][a.name])return;const c=r._findResource(a.name);c&&n.push(c)}else if(o instanceof gs){const a=o,c=r._functions.get(a.name);c&&(t&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=r._findResources(c.node,t)),n.push(...c.resources))}else if(o instanceof Eo){const a=o,c=r._functions.get(a.name);c&&(t&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=r._findResources(c.node,t)),n.push(...c.resources))}}),[...new Map(n.map(o=>[o.name,o])).values()]}getBindGroups(){const e=[];function t(n,r){n>=e.length&&(e.length=n+1),e[n]===void 0&&(e[n]=[]),r>=e[n].length&&(e[n].length=r+1)}for(const n of this.uniforms)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.storage)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.textures)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.samplers)t(n.group,n.binding),e[n.group][n.binding]=n;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof at)this._getStructOutputs(e,t);else{const n=this._getOutputInfo(e);n!==null&&t.push(n)}return t}_getStructOutputs(e,t){for(const n of e.members)if(n.type instanceof at)this._getStructOutputs(n.type,t);else{const r=this._getAttribute(n,"location")||this._getAttribute(n,"builtin");if(r!==null){const i=this.getTypeInfo(n.type,n.type.attributes),o=this._parseInt(r.value),a=new qa(n.name,i,r.name,o);t.push(a)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const n=this.getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new qa("",n,t.name,r)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const n of e)if(n.type instanceof at)this._getStructInputs(n.type,t);else{const r=this._getInputInfo(n);r!==null&&t.push(r)}return t}_getStructInputs(e,t){for(const n of e.members)if(n.type instanceof at)this._getStructInputs(n.type,t);else{const r=this._getInputInfo(n);r!==null&&t.push(r)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const n=this._getAttribute(e,"interpolation"),r=this.getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),o=new Ag(e.name,r,t.name,i);return n!==null&&(o.interpolation=this._parseString(n.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new wg(e.name,this.getTypeInfo(e.type,null))}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof lu){const r=e,i=r.format?this.getTypeInfo(r.format,r.attributes):null,o=new Mt(r.name,t);return o.format=i,o.count=r.count,this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof at){const r=e,i=new ut(r.name,t);i.startLine=r.startLine,i.endLine=r.endLine;for(const o of r.members){const a=this.getTypeInfo(o.type,o.attributes);i.members.push(new Ya(o.name,a,o.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Fs){const r=e,i=r.format instanceof k,o=r.format?i?this.getTypeInfo(r.format,null):new ke(r.format,null):null,a=new yt(r.name,o,t,r.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof P){const r=e,i=r.format?this.getTypeInfo(r.format,null):null,o=new yt(r.name,i,t,r.access);return this._types.set(e,o),this._updateTypeInfo(o),o}const n=new ke(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var t,n,r;const i=this._getTypeSize(e);if(e.size=(t=i==null?void 0:i.size)!==null&&t!==void 0?t:0,e instanceof Mt&&e.format){const o=this._getTypeSize(e.format);e.stride=Math.max((n=o==null?void 0:o.size)!==null&&n!==void 0?n:0,(r=o==null?void 0:o.align)!==null&&r!==void 0?r:0),this._updateTypeInfo(e.format)}e instanceof ut&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let n=0,r=0,i=0,o=0;for(let a=0,c=e.members.length;a<c;++a){const l=e.members[a],u=this._getTypeSize(l);if(!u)continue;(t=this._getAlias(l.type.name))!==null&&t!==void 0||l.type;const h=u.align,f=u.size;n=this._roundUp(h,n+r),r=f,i=n,o=Math.max(o,h),l.offset=n,l.size=f,this._updateTypeInfo(l.type)}e.size=this._roundUp(o,i+r),e.align=o}_getTypeSize(e){var t,n;if(e==null)return null;const r=this._getAttributeNum(e.attributes,"size",0),i=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Ya&&(e=e.type),e instanceof ke){const o=this._getAlias(e.name);o!==null&&(e=o)}{const o=Ye._typeInfo[e.name];if(o!==void 0){const a=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new Tn(Math.max(i,o.align/a),Math.max(r,o.size/a))}}{const o=Ye._typeInfo[e.name.substring(0,e.name.length-1)];if(o){const a=e.name[e.name.length-1]==="h"?2:1;return new Tn(Math.max(i,o.align/a),Math.max(r,o.size/a))}}if(e instanceof Mt){let o=e,a=8,c=8;const l=this._getTypeSize(o.format);return l!==null&&(c=l.size,a=l.align),c=o.count*this._getAttributeNum((n=e==null?void 0:e.attributes)!==null&&n!==void 0?n:null,"stride",this._roundUp(a,c)),r&&(c=r),new Tn(Math.max(i,a),Math.max(r,c))}if(e instanceof ut){let o=0,a=0,c=0,l=0,u=0;for(const h of e.members){const f=this._getTypeSize(h.type);f!==null&&(o=Math.max(f.align,o),c=this._roundUp(f.align,c+l),l=f.size,u=c)}return a=this._roundUp(o,u+l),new Tn(Math.max(i,o),Math.max(r,a))}return null}_isUniformVar(e){return e instanceof lt&&e.storage=="uniform"}_isStorageVar(e){return e instanceof lt&&e.storage=="storage"}_isTextureVar(e){return e instanceof lt&&e.type!==null&&Ye._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof lt&&e.type!==null&&Ye._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const n=e;if(!n||!n.attributes)return null;const r=n.attributes;for(let i of r)if(i.name==t)return i;return null}_getAttributeNum(e,t,n){if(e===null)return n;for(let r of e)if(r.name==t){let i=r!==null&&r.value!==null?r.value:n;return i instanceof Array&&(i=i[0]),typeof i=="number"?i:typeof i=="string"?parseInt(i):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}}Ye._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Ye._textureTypes=g.any_texture_type.map(s=>s.name),Ye._samplerTypes=g.sampler_type.map(s=>s.name);class xo{constructor(e,t,n){this.name=e,this.value=t,this.node=n}clone(){return new xo(this.name,this.value,this.node)}}class Ro{constructor(e){this.name=e.name,this.node=e}clone(){return new Ro(this.node)}}class Io{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new xo(e,t,n??null))}setVariable(e,t,n){const r=this.getVariable(e);r!==null?r.value=t:this.createVariable(e,t,n)}getVariableValue(e){var t;const n=this.getVariable(e);return(t=n==null?void 0:n.value)!==null&&t!==void 0?t:null}clone(){return new Io(this)}}class Vg{evalExpression(e,t){return null}getTypeName(e){return""}getTypeInfo(e){return null}getVariableName(e,t){return""}}class $g{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const n=this.exec.evalExpression(e.args[0],t);let r=!0;if(n instanceof y)return n.value.forEach(i=>{i||(r=!1)}),new S(r?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y){const r=n.value.some(i=>i);return new S(r?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof S))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.evalExpression(n,t);if(r instanceof ae&&r.typeInfo.size===0){const i=r.typeInfo,o=r.buffer.byteLength/i.stride;return new S(o,this.getTypeInfo("u32"))}return new S(r.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.abs(i)),n.typeInfo);const r=n;return new S(Math.abs(r.value),r.typeInfo)}Acos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.acos(i)),n.typeInfo);const r=n;return new S(Math.acos(r.value),n.typeInfo)}Acosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.acosh(i)),n.typeInfo);const r=n;return new S(Math.acosh(r.value),n.typeInfo)}Asin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.asin(i)),n.typeInfo);const r=n;return new S(Math.asin(r.value),n.typeInfo)}Asinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.asinh(i)),n.typeInfo);const r=n;return new S(Math.asinh(r.value),n.typeInfo)}Atan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.atan(i)),n.typeInfo);const r=n;return new S(Math.atan(r.value),n.typeInfo)}Atanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.atanh(i)),n.typeInfo);const r=n;return new S(Math.atanh(r.value),n.typeInfo)}Atan2(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y)return new y(n.value.map((a,c)=>Math.atan2(a,r.value[c])),n.typeInfo);const i=n,o=r;return new S(Math.atan2(i.value,o.value),n.typeInfo)}Ceil(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.ceil(i)),n.typeInfo);const r=n;return new S(Math.ceil(r.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof y&&r instanceof y&&i instanceof y)return new y(n.value.map((l,u)=>this._clamp(l,r.value[u],i.value[u])),n.typeInfo);const o=n,a=r,c=i;return new S(this._clamp(o.value,a.value,c.value),n.typeInfo)}Cos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.cos(i)),n.typeInfo);const r=n;return new S(Math.cos(r.value),n.typeInfo)}Cosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.cosh(i)),n.typeInfo);const r=n;return new S(Math.cos(r.value),n.typeInfo)}CountLeadingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.clz32(i)),n.typeInfo);const r=n;return new S(Math.clz32(r.value),n.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>this._countOneBits(i)),n.typeInfo);const r=n;return new S(this._countOneBits(r.value),n.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>this._countTrailingZeros(i)),n.typeInfo);const r=n;return new S(this._countTrailingZeros(r.value),n.typeInfo)}Cross(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y){if(n.value.length!==3||r.value.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const i=n.value,o=r.value;return new y([i[1]*o[2]-o[1]*i[2],i[2]*o[0]-o[2]*i[0],i[0]*o[1]-o[0]*i[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const n=this.exec.evalExpression(e.args[0],t),r=180/Math.PI;return n instanceof y?new y(n.value.map(i=>i*r),n.typeInfo):new S(n.value*r,n.typeInfo)}Determinant(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Y){const r=n.value,i=this.exec.getTypeName(n.typeInfo),o=i.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(i==="mat2x2"||i==="mat2x2f"||i==="mat2x2h")return new S(r[0]*r[3]-r[1]*r[2],o);if(i==="mat2x3"||i==="mat2x3f"||i==="mat2x3h")return new S(r[0]*(r[4]*r[8]-r[5]*r[7])-r[1]*(r[3]*r[8]-r[5]*r[6])+r[2]*(r[3]*r[7]-r[4]*r[6]),o);if(i==="mat2x4"||i==="mat2x4f"||i==="mat2x4h")console.error(`TODO: Determinant for ${i}`);else if(i==="mat3x2"||i==="mat3x2f"||i==="mat3x2h")console.error(`TODO: Determinant for ${i}`);else{if(i==="mat3x3"||i==="mat3x3f"||i==="mat3x3h")return new S(r[0]*(r[4]*r[8]-r[5]*r[7])-r[1]*(r[3]*r[8]-r[5]*r[6])+r[2]*(r[3]*r[7]-r[4]*r[6]),o);i==="mat3x4"||i==="mat3x4f"||i==="mat3x4h"||i==="mat4x2"||i==="mat4x2f"||i==="mat4x2h"||i==="mat4x3"||i==="mat4x3f"||i==="mat4x3h"?console.error(`TODO: Determinant for ${i}`):i!=="mat4x4"&&i!=="mat4x4f"&&i!=="mat4x4h"||console.error(`TODO: Determinant for ${i}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y){let a=0;for(let c=0;c<n.value.length;++c)a+=(n.value[c]-r.value[c])*(n.value[c]-r.value[c]);return new S(Math.sqrt(a),this.getTypeInfo("f32"))}const i=n,o=r;return new S(Math.abs(i.value-o.value),n.typeInfo)}_dot(e,t){let n=0;for(let r=0;r<e.length;++r)n+=t[r]*e[r];return n}Dot(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return n instanceof y&&r instanceof y?new S(this._dot(n.value,r.value),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.exp(i)),n.typeInfo);const r=n;return new S(Math.exp(r.value),n.typeInfo)}Exp2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.pow(2,i)),n.typeInfo);const r=n;return new S(Math.pow(2,r.value),n.typeInfo)}ExtractBits(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(r.typeInfo.name!=="u32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(i.typeInfo.name!=="u32"&&i.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const o=r.value,a=i.value;if(n instanceof y)return new y(n.value.map(l=>l>>o&(1<<a)-1),n.typeInfo);if(n.typeInfo.name!=="i32"&&n.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const c=n.value;return new S(c>>o&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof y&&r instanceof y&&i instanceof y){const o=this._dot(r.value,i.value);return new y(o<0?n.value:n.value.map(a=>-a),n.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>this._firstLeadingBit(i)),n.typeInfo);const r=n;return new S(this._firstLeadingBit(r.value),n.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>this._firstTrailingBit(i)),n.typeInfo);const r=n;return new S(this._firstTrailingBit(r.value),n.typeInfo)}Floor(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.floor(i)),n.typeInfo);const r=n;return new S(Math.floor(r.value),n.typeInfo)}Fma(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof y&&r instanceof y&&i instanceof y)return n.value.length!==r.value.length||n.value.length!==i.value.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new y(n.value.map((l,u)=>l*r.value[u]+i.value[u]),n.typeInfo);const o=n,a=r,c=i;return new S(o.value*a.value+c.value,o.typeInfo)}Fract(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>i-Math.floor(i)),n.typeInfo);const r=n;return new S(r.value-Math.floor(r.value),n.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t),o=this.exec.evalExpression(e.args[3],t);if(i.typeInfo.name!=="u32"&&i.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const a=i.value,c=(1<<o.value)-1<<a,l=~c;if(n instanceof y&&r instanceof y)return new y(n.value.map((f,_)=>f&l|r.value[_]<<a&c),n.typeInfo);const u=n.value,h=r.value;return new S(u&l|h<<a&c,n.typeInfo)}InverseSqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>1/Math.sqrt(i)),n.typeInfo);const r=n;return new S(1/Math.sqrt(r.value),n.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y){let i=0;return n.value.forEach(o=>{i+=o*o}),new S(Math.sqrt(i),this.getTypeInfo("f32"))}const r=n;return new S(Math.abs(r.value),n.typeInfo)}Log(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.log(i)),n.typeInfo);const r=n;return new S(Math.log(r.value),n.typeInfo)}Log2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.log2(i)),n.typeInfo);const r=n;return new S(Math.log2(r.value),n.typeInfo)}Max(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y)return new y(n.value.map((a,c)=>Math.max(a,r.value[c])),n.typeInfo);const i=n,o=r;return new S(Math.max(i.value,o.value),n.typeInfo)}Min(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y)return new y(n.value.map((a,c)=>Math.min(a,r.value[c])),n.typeInfo);const i=n,o=r;return new S(Math.min(i.value,o.value),n.typeInfo)}Mix(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof y&&r instanceof y&&i instanceof y)return new y(n.value.map((c,l)=>n.value[l]*(1-i.value[l])+r.value[l]*i.value[l]),n.typeInfo);const o=r,a=i;return new S(n.value*(1-a.value)+o.value*a.value,n.typeInfo)}Modf(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y)return new y(n.value.map((o,a)=>o%r.value[a]),n.typeInfo);const i=r;return new S(n.value%i.value,n.typeInfo)}Normalize(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y){const r=this.Length(e,t).value;return new y(n.value.map(i=>i/r),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y)return new y(n.value.map((a,c)=>Math.pow(a,r.value[c])),n.typeInfo);const i=n,o=r;return new S(Math.pow(i.value,o.value),n.typeInfo)}QuantizeToF16(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof y?new y(n.value.map(r=>r),n.typeInfo):new S(n.value,n.typeInfo)}Radians(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof y?new y(n.value.map(r=>r*Math.PI/180),n.typeInfo):new S(n.value*Math.PI/180,n.typeInfo)}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof y&&r instanceof y){const i=this._dot(n.value,r.value);return new y(n.value.map((o,a)=>o-2*i*r.value[a]),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof y&&r instanceof y&&i instanceof S){const o=this._dot(r.value,n.value);return new y(n.value.map((a,c)=>{const l=1-i.value*i.value*(1-o*o);if(l<0)return 0;const u=Math.sqrt(l);return i.value*a-(i.value*o+u)*r.value[c]}),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.round(i)),n.typeInfo);const r=n;return new S(Math.round(r.value),n.typeInfo)}Saturate(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.min(Math.max(i,0),1)),n.typeInfo);const r=n;return new S(Math.min(Math.max(r.value,0),1),n.typeInfo)}Sign(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.sign(i)),n.typeInfo);const r=n;return new S(Math.sign(r.value),n.typeInfo)}Sin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.sin(i)),n.typeInfo);const r=n;return new S(Math.sin(r.value),n.typeInfo)}Sinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.sinh(i)),n.typeInfo);const r=n;return new S(Math.sinh(r.value),n.typeInfo)}_smoothstep(e,t,n){const r=Math.min(Math.max((n-e)/(t-e),0),1);return r*r*(3-2*r)}SmoothStep(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(i instanceof y&&n instanceof y&&r instanceof y)return new y(i.value.map((l,u)=>this._smoothstep(n.value[u],r.value[u],l)),i.typeInfo);const o=n,a=r,c=i;return new S(this._smoothstep(o.value,a.value,c.value),i.typeInfo)}Sqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.sqrt(i)),n.typeInfo);const r=n;return new S(Math.sqrt(r.value),n.typeInfo)}Step(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(r instanceof y&&n instanceof y)return new y(r.value.map((o,a)=>o<n.value[a]?0:1),r.typeInfo);const i=n;return new S(r.value<i.value?0:1,i.typeInfo)}Tan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.tan(i)),n.typeInfo);const r=n;return new S(Math.tan(r.value),n.typeInfo)}Tanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.tanh(i)),n.typeInfo);const r=n;return new S(Math.tanh(r.value),n.typeInfo)}_getTransposeType(e){const t=this.exec.getTypeName(e);return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof Y))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const r=this._getTransposeType(n.typeInfo);if(n.typeInfo.name==="mat2x2"||n.typeInfo.name==="mat2x2f"||n.typeInfo.name==="mat2x2h"){const i=n.value;return new Y([i[0],i[2],i[1],i[3]],r)}if(n.typeInfo.name==="mat2x3"||n.typeInfo.name==="mat2x3f"||n.typeInfo.name==="mat2x3h"){const i=n.value;return new Y([i[0],i[3],i[6],i[1],i[4],i[7]],r)}if(n.typeInfo.name==="mat2x4"||n.typeInfo.name==="mat2x4f"||n.typeInfo.name==="mat2x4h"){const i=n.value;return new Y([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13]],r)}if(n.typeInfo.name==="mat3x2"||n.typeInfo.name==="mat3x2f"||n.typeInfo.name==="mat3x2h"){const i=n.value;return new Y([i[0],i[3],i[1],i[4],i[2],i[5]],r)}if(n.typeInfo.name==="mat3x3"||n.typeInfo.name==="mat3x3f"||n.typeInfo.name==="mat3x3h"){const i=n.value;return new Y([i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]],r)}if(n.typeInfo.name==="mat3x4"||n.typeInfo.name==="mat3x4f"||n.typeInfo.name==="mat3x4h"){const i=n.value;return new Y([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14]],r)}if(n.typeInfo.name==="mat4x2"||n.typeInfo.name==="mat4x2f"||n.typeInfo.name==="mat4x2h"){const i=n.value;return new Y([i[0],i[4],i[1],i[5],i[2],i[6]],r)}if(n.typeInfo.name==="mat4x3"||n.typeInfo.name==="mat4x3f"||n.typeInfo.name==="mat4x3h"){const i=n.value;return new Y([i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]],r)}if(n.typeInfo.name==="mat4x4"||n.typeInfo.name==="mat4x4f"||n.typeInfo.name==="mat4x4h"){const i=n.value;return new Y([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14],i[3],i[7],i[11],i[15]],r)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof y)return new y(n.value.map(i=>Math.trunc(i)),n.typeInfo);const r=n;return new S(Math.trunc(r.value),n.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const n=e.args[0];if((e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0)>0)return console.error(`TODO: Mip levels. Line ${e.line}`),null;if(n instanceof pt){const r=n.name,i=t.getVariableValue(r);return i instanceof ae?new y(i.textureSize,this.getTypeInfo("vec2u")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const n=e.args[0],r=this.exec.evalExpression(e.args[1],t);if((e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0)>0)return console.error(`TODO: Mip levels. Line ${e.line}`),null;if(!(r instanceof y)||r.value.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(n instanceof pt){const i=n.name,o=t.getVariableValue(i);if(o instanceof ae){const a=o.textureSize,c=Math.floor(r.value[0]),l=Math.floor(r.value[1]);if(c<0||c>=a[0]||l<0||l>=a[1])return console.error(`Texture ${i} out of bounds. Line ${e.line}`),null;const u=4*(l*a[0]+c),h=new Uint8Array(o.buffer,u,4);return new y([h[0]/255,h[1]/255,h[2]/255,h[3]/255],this.getTypeInfo("vec4f"))}return console.error(`Texture ${i} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){return console.error("TODO: textureNumLayers"),null}TextureNumLevels(e,t){return console.error("TODO: textureNumLevels"),null}TextureNumSamples(e,t){return console.error("TODO: textureNumSamples"),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const n=e.args[0],r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t).value;if(i.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(r instanceof y)||r.value.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(n instanceof pt){const o=n.name,a=t.getVariableValue(o);if(a instanceof ae){const c=a.textureSize,l=Math.floor(r.value[0]),u=Math.floor(r.value[1]);if(l<0||l>=c[0]||u<0||u>=c[1])return console.error(`Texture ${o} out of bounds. Line ${e.line}`),null;const h=4*(u*c[0]+l),f=new Uint8Array(a.buffer,h,4);return f[0]=255*i[0],f[1]=255*i[1],f[2]=255*i[2],f[3]=255*i[3],null}return console.error(`Texture ${o} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t);return t.getVariable(r).value.getDataValue(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t);return c instanceof S&&a instanceof S&&(c.value=a.value),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t);return c instanceof S&&a instanceof S&&(c.value+=a.value),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),null}AtomicSub(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t);return c instanceof S&&a instanceof S&&(c.value-=a.value),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),null}AtomicMax(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t),l=new S(c.value,c.typeInfo);return c instanceof S&&a instanceof S&&(c.value=Math.max(c.value,a.value)),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicMin(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t),l=new S(c.value,c.typeInfo);return c instanceof S&&a instanceof S&&(c.value=Math.min(c.value,a.value)),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicAnd(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t),l=new S(c.value,c.typeInfo);return c instanceof S&&a instanceof S&&(c.value=c.value&a.value),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicOr(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t),l=new S(c.value,c.typeInfo);return c instanceof S&&a instanceof S&&(c.value=c.value|a.value),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicXor(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t),l=new S(c.value,c.typeInfo);return c instanceof S&&a instanceof S&&(c.value=c.value^a.value),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicExchange(e,t){let n=e.args[0];n instanceof Ae&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getDataValue(this.exec,n.postfix,t),l=new S(c.value,c.typeInfo);return c instanceof S&&a instanceof S&&(c.value=a.value),i.value instanceof ae&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}function F(s){return Array.isArray(s)||(s==null?void 0:s.buffer)instanceof ArrayBuffer}const tr=new Float32Array(1),zg=new Uint32Array(tr.buffer),Wg=new Uint32Array(tr.buffer),sr=new Int32Array(1),Hg=new Float32Array(sr.buffer),jg=new Uint32Array(sr.buffer),nr=new Uint32Array(1),Xg=new Float32Array(nr.buffer),Yg=new Int32Array(nr.buffer);function Za(s,e,t){if(e===t)return s;if(e==="f32"){if(t==="i32"||t==="x32")return tr[0]=s,zg[0];if(t==="u32")return tr[0]=s,Wg[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return sr[0]=s,Hg[0];if(t==="u32")return sr[0]=s,jg[0]}else if(e==="u32"){if(t==="f32")return nr[0]=s,Xg[0];if(t==="i32"||t==="x32")return nr[0]=s,Yg[0]}return console.error(`Unsupported cast from ${e} to ${t}`),s}class ge extends Vg{constructor(e,t){var n;super(),this.ast=e??[],this.reflection=new Ye,this.reflection.updateAST(this.ast),this.context=(n=t==null?void 0:t.clone())!==null&&n!==void 0?n:new Io,this.builtins=new $g(this),this.typeInfo={bool:this.getTypeInfo(k.bool),i32:this.getTypeInfo(k.i32),u32:this.getTypeInfo(k.u32),f32:this.getTypeInfo(k.f32),f16:this.getTypeInfo(k.f16),vec2f:this.getTypeInfo(P.vec2f),vec2u:this.getTypeInfo(P.vec2u),vec2i:this.getTypeInfo(P.vec2i),vec2h:this.getTypeInfo(P.vec2h),vec3f:this.getTypeInfo(P.vec3f),vec3u:this.getTypeInfo(P.vec3u),vec3i:this.getTypeInfo(P.vec3i),vec3h:this.getTypeInfo(P.vec3h),vec4f:this.getTypeInfo(P.vec4f),vec4u:this.getTypeInfo(P.vec4u),vec4i:this.getTypeInfo(P.vec4i),vec4h:this.getTypeInfo(P.vec4h),mat2x2f:this.getTypeInfo(P.mat2x2f),mat2x3f:this.getTypeInfo(P.mat2x3f),mat2x4f:this.getTypeInfo(P.mat2x4f),mat3x2f:this.getTypeInfo(P.mat3x2f),mat3x3f:this.getTypeInfo(P.mat3x3f),mat3x4f:this.getTypeInfo(P.mat3x4f),mat4x2f:this.getTypeInfo(P.mat4x2f),mat4x3f:this.getTypeInfo(P.mat4x3f),mat4x4f:this.getTypeInfo(P.mat4x4f)}}getVariableValue(e){var t,n;const r=(n=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&n!==void 0?n:null;return r===null?null:r instanceof S||r instanceof y||r instanceof Y?r.value:(console.error(`Unsupported return variable type ${r.typeInfo.name}`),null)}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,r){const i=this.context.clone();(r=r??{}).constants&&this._setOverrides(r.constants,i),this._execStatements(this.ast,i);const o=i.getFunction(e);if(!o)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const a=t[0],c=t[1],l=t[2],u=this.getTypeInfo("vec3u");i.setVariable("@num_workgroups",new y(t,u));for(const h in n)for(const f in n[h]){const _=n[h][f];i.variables.forEach(T=>{const v=T.node;if(v!=null&&v.attributes){let R=null,C=null;for(const I of v.attributes)I.name==="binding"?R=I.value:I.name==="group"&&(C=I.value);f==R&&h==C&&(_.texture!==void 0&&_.size!==void 0?T.value=new ae(_.texture,this.getTypeInfo(v.type),0,_.size):_.uniform!==void 0?T.value=new ae(_.uniform,this.getTypeInfo(v.type)):T.value=new ae(_,this.getTypeInfo(v.type)))}})}for(let h=0;h<l;++h)for(let f=0;f<c;++f)for(let _=0;_<a;++_)i.setVariable("@workgroup_id",new y([_,f,h],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(o,[_,f,h],i)}execStatement(e,t){if(e instanceof iu)return this.evalExpression(e.value,t);if(e instanceof au){if(e.condition){const n=this.evalExpression(e.condition,t);if(!(n instanceof S))throw new Error("Invalid break-if condition");if(!n.value)return null}return ge._breakObj}if(e instanceof cu)return ge._continueObj;if(e instanceof er)this._let(e,t);else if(e instanceof lt)this._var(e,t);else if(e instanceof zi)this._const(e,t);else if(e instanceof Gn)this._function(e,t);else{if(e instanceof ru)return this._if(e,t);if(e instanceof nu)return this._switch(e,t);if(e instanceof Gl)return this._for(e,t);if(e instanceof Jl)return this._while(e,t);if(e instanceof su)return this._loop(e,t);if(e instanceof $i){const n=t.clone();return n.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,n)}if(e instanceof tu)this._assign(e,t);else if(e instanceof eu)this._increment(e,t);else{if(e instanceof at)return null;if(e instanceof Ao){const n=e.name;t.getVariable(n)===null&&t.setVariable(n,new S(0,this.getTypeInfo("u32")))}else if(e instanceof Eo)this._call(e,t);else{if(e instanceof ou||e instanceof So)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){for(;e instanceof Nn;)e=e.contents[0];return e instanceof Pe?this._evalBinaryOp(e,t):e instanceof oe?this._evalLiteral(e,t):e instanceof pt?this._evalVariable(e,t):e instanceof gs?this._evalCall(e,t):e instanceof Ot?this._evalCreate(e,t):e instanceof uu?this._evalConst(e,t):e instanceof hu?this._evalBitcast(e,t):e instanceof Ae?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof k){const r=this.reflection.getTypeInfo(e);if(r!==null)return r}const n=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return n!==null?n:null}getTypeName(e){if(e===null)return console.error("Type is null."),"unknown";let t=e.name;if(e instanceof yt||e instanceof P){if(e.format!==null){if(t==="vec2"||t==="vec3"||t==="vec4"||t==="mat2x2"||t==="mat2x3"||t==="mat2x4"||t==="mat3x2"||t==="mat3x3"||t==="mat3x4"||t==="mat4x2"||t==="mat4x3"||t==="mat4x4"){if(e.format.name==="f32")return t+="f",t;if(e.format.name==="i32")return t+="i",t;if(e.format.name==="u32")return t+="u",t;if(e.format.name==="bool")return t+="b",t;if(e.format.name==="f16")return t+="h",t}t+=`<${e.format.name}>`}else if(t==="vec2"||t==="vec3"||t==="vec4")return t}return t}_setOverrides(e,t){for(const n in e){const r=e[n],i=this.reflection.getOverrideInfo(n);i!==null?i.type.name==="u32"||i.type.name==="i32"||i.type.name==="f32"||i.type.name==="f16"?t.setVariable(n,new S(r,i.type)):i.type.name==="bool"?t.setVariable(n,new S(r?1:0,i.type)):i.type.name==="vec2"||i.type.name==="vec3"||i.type.name==="vec4"||i.type.name==="vec2f"||i.type.name==="vec3f"||i.type.name==="vec4f"||i.type.name==="vec2i"||i.type.name==="vec3i"||i.type.name==="vec4i"||i.type.name==="vec2u"||i.type.name==="vec3u"||i.type.name==="vec4u"||i.type.name==="vec2h"||i.type.name==="vec3h"||i.type.name==="vec4h"?t.setVariable(n,new y(r,i.type)):console.error(`Invalid constant type for ${n}`):console.error(`Override ${n} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,n){const r=[1,1,1];for(const u of e.node.attributes)if(u.name==="workgroup_size"){if(u.value.length>0){const h=n.getVariableValue(u.value[0]);r[0]=h instanceof S?h.value:parseInt(u.value[0])}if(u.value.length>1){const h=n.getVariableValue(u.value[1]);r[1]=h instanceof S?h.value:parseInt(u.value[1])}if(u.value.length>2){const h=n.getVariableValue(u.value[2]);r[2]=h instanceof S?h.value:parseInt(u.value[2])}}const i=this.getTypeInfo("vec3u"),o=this.getTypeInfo("u32");n.setVariable("@workgroup_size",new y(r,i));const a=r[0],c=r[1],l=r[2];for(let u=0,h=0;u<l;++u)for(let f=0;f<c;++f)for(let _=0;_<a;++_,++h){const T=[_,f,u],v=[_+t[0]*r[0],f+t[1]*r[1],u+t[2]*r[2]];n.setVariable("@local_invocation_id",new y(T,i)),n.setVariable("@global_invocation_id",new y(v,i)),n.setVariable("@local_invocation_index",new S(h,o)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(const n of e.node.args)for(const r of n.attributes)if(r.name==="builtin"){const i=`@${r.value}`,o=t.getVariable(i);o!==void 0&&t.variables.set(n.name,o)}this._execStatements(e.node.body,t)}getVariableName(e,t){return e instanceof pt?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const n of e){if(n instanceof Array){const i=t.clone(),o=this._execStatements(n,i);if(o)return o;continue}const r=this.execStatement(n,t);if(r)return r}return null}_call(e,t){const n=t.clone();n.currentFunctionName=e.name;const r=t.getFunction(e.name);if(r){for(let i=0;i<r.node.args.length;++i){const o=r.node.args[i],a=this.evalExpression(e.args[i],n);n.setVariable(o.name,a,o)}this._execStatements(r.node.body,n)}else this._callBuiltinFunction(e,n)}_increment(e,t){const n=this.getVariableName(e.variable,t),r=t.getVariable(n);r?e.operator==="++"?r.value instanceof S?r.value.value++:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):e.operator==="--"?r.value instanceof S?r.value.value--:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${n} not found. Line ${e.line}`)}_assign(e,t){const n=this.getVariableName(e.variable,t),r=t.getVariable(n);if(r===null)return void console.error(`Variable ${n} not found. Line ${e.line}`);const i=this.evalExpression(e.value,t),o=e.operator;if(o==="=")if(r.value instanceof ae)r.value.setDataValue(this,i,e.variable.postfix,t);else if(e.variable.postfix){if(!(r.value instanceof y||r.value instanceof Y))return void console.error(`Variable ${r.name} is not a vector or matrix. Line ${e.line}`);if(e.variable.postfix instanceof hs){const a=this.evalExpression(e.variable.postfix.index,t).value;if(r.value instanceof y){if(!(i instanceof S))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[a]=i.value}else{if(!(r.value instanceof Y))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);{const c=this.evalExpression(e.variable.postfix.index,t).value;if(c<0)return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);if(!(i instanceof y))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);{const l=this.getTypeName(r.value.typeInfo);if(l==="mat2x2"||l==="mat2x2f"||l==="mat2x2h"){if(!(c<2&&i.value.length===2))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[2*c]=i.value[0],r.value.value[2*c+1]=i.value[1]}else if(l==="mat2x3"||l==="mat2x3f"||l==="mat2x3h"){if(!(c<2&&i.value.length===3))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[3*c]=i.value[0],r.value.value[3*c+1]=i.value[1],r.value.value[3*c+2]=i.value[2]}else if(l==="mat2x4"||l==="mat2x4f"||l==="mat2x4h"){if(!(c<2&&i.value.length===4))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[4*c]=i.value[0],r.value.value[4*c+1]=i.value[1],r.value.value[4*c+2]=i.value[2],r.value.value[4*c+3]=i.value[3]}else if(l==="mat3x2"||l==="mat3x2f"||l==="mat3x2h"){if(!(c<3&&i.value.length===2))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[2*c]=i.value[0],r.value.value[2*c+1]=i.value[1]}else if(l==="mat3x3"||l==="mat3x3f"||l==="mat3x3h"){if(!(c<3&&i.value.length===3))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[3*c]=i.value[0],r.value.value[3*c+1]=i.value[1],r.value.value[3*c+2]=i.value[2]}else if(l==="mat3x4"||l==="mat3x4f"||l==="mat3x4h"){if(!(c<3&&i.value.length===4))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[4*c]=i.value[0],r.value.value[4*c+1]=i.value[1],r.value.value[4*c+2]=i.value[2],r.value.value[4*c+3]=i.value[3]}else if(l==="mat4x2"||l==="mat4x2f"||l==="mat4x2h"){if(!(c<4&&i.value.length===2))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[2*c]=i.value[0],r.value.value[2*c+1]=i.value[1]}else if(l==="mat4x3"||l==="mat4x3f"||l==="mat4x3h"){if(!(c<4&&i.value.length===3))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[3*c]=i.value[0],r.value.value[3*c+1]=i.value[1],r.value.value[3*c+2]=i.value[2]}else{if(l!=="mat4x4"&&l!=="mat4x4f"&&l!=="mat4x4h")return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);if(!(c<4&&i.value.length===4))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);r.value.value[4*c]=i.value[0],r.value.value[4*c+1]=i.value[1],r.value.value[4*c+2]=i.value[2],r.value.value[4*c+3]=i.value[3]}}}}}else if(e.variable.postfix instanceof Dt){const a=e.variable.postfix.value;if(!(r.value instanceof y))return void console.error(`Invalid assignment to ${a}. Variable ${r.name} is not a vector. Line ${e.line}`);if(i instanceof S){if(a.length>1)return void console.error(`Invalid assignment to ${a} for variable ${r.name}. Line ${e.line}`);if(a==="x")r.value.value[0]=i.value;else if(a==="y"){if(r.value.value.length<2)return void console.error(`Invalid assignment to ${a} for variable ${r.name}. Line ${e.line}`);r.value.value[1]=i.value}else if(a==="z"){if(r.value.value.length<3)return void console.error(`Invalid assignment to ${a} for variable ${r.name}. Line ${e.line}`);r.value.value[2]=i.value}else if(a==="w"){if(r.value.value.length<4)return void console.error(`Invalid assignment to ${a} for variable ${r.name}. Line ${e.line}`);r.value.value[3]=i.value}}else{if(!(i instanceof y))return void console.error(`Invalid assignment to ${r.name}. Line ${e.line}`);if(a.length!==i.value.length)return void console.error(`Invalid assignment to ${a} for variable ${r.name}. Line ${e.line}`);for(let c=0;c<a.length;++c){const l=a[c];if(l==="x"||l==="r")r.value.value[0]=i.value[c];else if(l==="y"||l==="g"){if(i.value.length<2)return void console.error(`Invalid assignment to ${l} for variable ${r.name}. Line ${e.line}`);r.value.value[1]=i.value[c]}else if(l==="z"||l==="b"){if(i.value.length<3)return void console.error(`Invalid assignment to ${l} for variable ${r.name}. Line ${e.line}`);r.value.value[2]=i.value[c]}else{if(l!=="w"&&l!=="a")return void console.error(`Invalid assignment to ${l} for variable ${r.name}. Line ${e.line}`);if(i.value.length<4)return void console.error(`Invalid assignment to ${l} for variable ${r.name}. Line ${e.line}`);r.value.value[3]=i.value[c]}}}}}else r.value=i;else{const a=r.value.getDataValue(this,e.variable.postfix,t);if(a instanceof y&&i instanceof S){const c=a.value,l=i.value;if(o==="+=")for(let u=0;u<c.length;++u)c[u]+=l;else if(o==="-=")for(let u=0;u<c.length;++u)c[u]-=l;else if(o==="*=")for(let u=0;u<c.length;++u)c[u]*=l;else if(o==="/=")for(let u=0;u<c.length;++u)c[u]/=l;else if(o==="%=")for(let u=0;u<c.length;++u)c[u]%=l;else if(o==="&=")for(let u=0;u<c.length;++u)c[u]&=l;else if(o==="|=")for(let u=0;u<c.length;++u)c[u]|=l;else if(o==="^=")for(let u=0;u<c.length;++u)c[u]^=l;else if(o==="<<=")for(let u=0;u<c.length;++u)c[u]<<=l;else if(o===">>=")for(let u=0;u<c.length;++u)c[u]>>=l;else console.error(`Invalid operator ${o}. Line ${e.line}`)}else if(a instanceof y&&i instanceof y){const c=a.value,l=i.value;if(c.length!==l.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(o==="+=")for(let u=0;u<c.length;++u)c[u]+=l[u];else if(o==="-=")for(let u=0;u<c.length;++u)c[u]-=l[u];else if(o==="*=")for(let u=0;u<c.length;++u)c[u]*=l[u];else if(o==="/=")for(let u=0;u<c.length;++u)c[u]/=l[u];else if(o==="%=")for(let u=0;u<c.length;++u)c[u]%=l[u];else if(o==="&=")for(let u=0;u<c.length;++u)c[u]&=l[u];else if(o==="|=")for(let u=0;u<c.length;++u)c[u]|=l[u];else if(o==="^=")for(let u=0;u<c.length;++u)c[u]^=l[u];else if(o==="<<=")for(let u=0;u<c.length;++u)c[u]<<=l[u];else if(o===">>=")for(let u=0;u<c.length;++u)c[u]>>=l[u];else console.error(`Invalid operator ${o}. Line ${e.line}`)}else{if(!(a instanceof S&&i instanceof S))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);o==="+="?a.value+=i.value:o==="-="?a.value-=i.value:o==="*="?a.value*=i.value:o==="/="?a.value/=i.value:o==="%="?a.value%=i.value:o==="&="?a.value&=i.value:o==="|="?a.value|=i.value:o==="^="?a.value^=i.value:o==="<<="?a.value<<=i.value:o===">>="?a.value>>=i.value:console.error(`Invalid operator ${o}. Line ${e.line}`)}r.value instanceof ae&&r.value.setDataValue(this,a,e.variable.postfix,t)}}_function(e,t){const n=new Ro(e);t.functions.set(e.name,n)}_const(e,t){let n=null;e.value!=null&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;e.value!=null&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(e.value!==null)n=this.evalExpression(e.value,t);else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);if(e.type.name==="f32"||e.type.name==="i32"||e.type.name==="u32"||e.type.name==="bool"||e.type.name==="f16"||e.type.name==="vec2"||e.type.name==="vec3"||e.type.name==="vec4"||e.type.name==="vec2f"||e.type.name==="vec3f"||e.type.name==="vec4f"||e.type.name==="vec2i"||e.type.name==="vec3i"||e.type.name==="vec4i"||e.type.name==="vec2u"||e.type.name==="vec3u"||e.type.name==="vec4u"||e.type.name==="vec2h"||e.type.name==="vec3h"||e.type.name==="vec4h"||e.type.name==="mat2x2"||e.type.name==="mat2x3"||e.type.name==="mat2x4"||e.type.name==="mat3x2"||e.type.name==="mat3x3"||e.type.name==="mat3x4"||e.type.name==="mat4x2"||e.type.name==="mat4x3"||e.type.name==="mat4x4"||e.type.name==="mat2x2f"||e.type.name==="mat2x3f"||e.type.name==="mat2x4f"||e.type.name==="mat3x2f"||e.type.name==="mat3x3f"||e.type.name==="mat3x4f"||e.type.name==="mat4x2f"||e.type.name==="mat4x3f"||e.type.name==="mat4x4f"||e.type.name==="mat2x2h"||e.type.name==="mat2x3h"||e.type.name==="mat2x4h"||e.type.name==="mat3x2h"||e.type.name==="mat3x3h"||e.type.name==="mat3x4h"||e.type.name==="mat4x2h"||e.type.name==="mat4x3h"||e.type.name==="mat4x4h"){const r=new Ot(e.type,[]);n=this._evalCreate(r,t)}if(e.type.name==="array"){const r=new Ot(e.type,[]);n=this._evalCreate(r,t)}}t.createVariable(e.name,n,e)}_switch(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof S))return console.error(`Invalid if condition. Line ${e.line}`),null;let r=null;for(const i of e.cases)if(i instanceof pu)for(const o of i.selectors){if(o instanceof kn){r=i;continue}const a=this.evalExpression(o,t);if(!(a instanceof S))return console.error(`Invalid case selector. Line ${e.line}`),null;if(a.value===n.value)return this._execStatements(i.body,t)}else i instanceof _u&&(r=i);return r?this._execStatements(r.body,t):null}_if(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof S))return console.error(`Invalid if condition. Line ${e.line}`),null;if(n.value)return this._execStatements(e.body,t);for(const r of e.elseif){const i=this.evalExpression(r.condition,t);if(!(i instanceof S))return console.error(`Invalid if condition. Line ${e.line}`),null;if(i.value)return this._execStatements(r.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof S?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===ge._breakObj)break;if(n!==null&&n!==ge._continueObj)return n;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const n=this._execStatements(e.body,t);if(n===ge._breakObj)break;if(n===ge._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===ge._breakObj)break}else if(n!==null)return n}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===ge._breakObj)break;if(n!==ge._continueObj&&n!==null)return n}return null}_evalBitcast(e,t){const n=this.evalExpression(e.value,t),r=e.type;if(n instanceof S){const i=Za(n.value,n.typeInfo.name,r.name);return new S(i,this.getTypeInfo(r))}if(n instanceof y){const i=this.getTypeName(n.typeInfo);let o="";if(i.endsWith("f"))o="f32";else if(i.endsWith("i"))o="i32";else if(i.endsWith("u"))o="u32";else if(i.endsWith("b"))o="bool";else{if(!i.endsWith("h"))return console.error(`Unknown vector type ${i}. Line ${e.line}`),null;o="f16"}const a=this.getTypeName(r);let c="";if(a.endsWith("f"))c="f32";else if(a.endsWith("i"))c="i32";else if(a.endsWith("u"))c="u32";else if(a.endsWith("b"))c="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${c}. Line ${e.line}`),null;c="f16"}const l=function(u,h,f){if(h===f)return u;const _=new Array(u.length);for(let T=0;T<u.length;T++)_[T]=Za(u[T],h,f);return _}(n.value,o,c);return new y(l,this.getTypeInfo(r))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){const n=t.getVariableValue(e.name);return e.postfix?n.getDataValue(this,e.postfix,t):n}_evalCreate(e,t){var n;if(e.type===null)return Wi.void;const r=this.getTypeName(e.type);switch(r){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}const i=this.getTypeInfo(e.type);if(i===null)return console.error(`Unknown type ${r}. Line ${e.line}`),null;if(i.size===0)return null;const o=new ae(new ArrayBuffer(i.size),i,0);if(i instanceof ut){if(e.args)for(let a=0;a<e.args.length;++a){const c=i.members[a],l=e.args[a],u=this.evalExpression(l,t);o.setData(this,u,c.type,c.offset,t)}}else if(i instanceof Mt){let a=0;if(e.args)for(let c=0;c<e.args.length;++c){const l=e.args[c],u=this.evalExpression(l,t);i.format===null&&(((n=u.typeInfo)===null||n===void 0?void 0:n.name)==="x32"?i.format=this.getTypeInfo("i32"):i.format=u.typeInfo),o.setData(this,u,i.format,a,t),a+=i.stride}}else console.error(`Unknown type "${r}". Line ${e.line}`);return o}_evalLiteral(e,t){const n=this.getTypeInfo(e.type),r=n.name;return r==="x32"||r==="u32"||r==="f32"||r==="f16"||r==="i32"||r==="bool"?new S(e.scalarValue,n):r==="vec2"||r==="vec3"||r==="vec4"||r==="vec2f"||r==="vec3f"||r==="vec4f"||r==="vec2h"||r==="vec3h"||r==="vec4h"||r==="vec2i"||r==="vec3i"||r==="vec4i"||r==="vec2u"||r==="vec3u"||r==="vec4u"?this._callConstructorVec(e,t):r==="mat2x2"||r==="mat2x3"||r==="mat2x4"||r==="mat3x2"||r==="mat3x3"||r==="mat3x4"||r==="mat4x2"||r==="mat4x3"||r==="mat4x4"||r==="mat2x2f"||r==="mat2x3f"||r==="mat2x4f"||r==="mat3x2f"||r==="mat3x3f"||r==="mat3x4f"||r==="mat4x2f"||r==="mat4x3f"||r==="mat4x4f"||r==="mat2x2h"||r==="mat2x3h"||r==="mat2x4h"||r==="mat3x2h"||r==="mat3x3h"||r==="mat3x4h"||r==="mat4x2h"||r==="mat4x3h"||r==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const n=t.getVariableValue(e.name);return n===null?n:e!=null&&e.postfix?n.getDataValue(this,e.postfix,t):n}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let n=1;n<e.length;++n){const r=ge._priority.get(t.name);ge._priority.get(e[n].name)<r&&(t=e[n])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const n=this.evalExpression(e.right,t),r=n instanceof S||n instanceof y?n.value:null;switch(e.operator){case"+":{if(F(r)){const a=r.map((c,l)=>+c);return new y(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new S(+i,o)}case"-":{if(F(r)){const a=r.map((c,l)=>-c);return new y(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new S(-i,o)}case"!":{if(F(r)){const a=r.map((c,l)=>c?0:1);return new y(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new S(i?0:1,o)}case"~":{if(F(r)){const a=r.map((c,l)=>~c);return new y(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new S(~i,o)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const n=this.evalExpression(e.left,t),r=this.evalExpression(e.right,t),i=n instanceof S||n instanceof y||n instanceof Y?n.value:null,o=r instanceof S||r instanceof y||r instanceof Y?r.value:null;switch(e.operator){case"+":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_+h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f+u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u+f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a+c,l)}case"-":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_-h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f-u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u-f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a-c,l)}case"*":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_*h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f*u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u*f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a*c,l)}case"%":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_%h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f%u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u%f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a%c,l)}case"/":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_/h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f/u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u/f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a/c,l)}case"&":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_&h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f&u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u&f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a&c,l)}case"|":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_|h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f|u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u|f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a|c,l)}case"^":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_^h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f^u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u^f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a^c,l)}case"<<":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_<<h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f<<u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u<<f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a<<c,l)}case">>":{if(F(i)&&F(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((_,T)=>_>>h[T]);return new y(f,n.typeInfo)}if(F(i)){const u=o,h=i.map((f,_)=>f>>u);return new y(h,n.typeInfo)}if(F(o)){const u=i,h=o.map((f,_)=>u>>f);return new y(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new S(a>>c,l)}case">":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u>c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l>a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a>l?1:0);return new y(c,r.typeInfo)}return new S(i>o?1:0,this.getTypeInfo("bool"));case"<":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u<c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l<a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a<l?1:0);return new y(c,r.typeInfo)}return new S(i<o?1:0,this.getTypeInfo("bool"));case"==":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u===c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l==a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a==l?1:0);return new y(c,r.typeInfo)}return new S(i===o?1:0,this.getTypeInfo("bool"));case"!=":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u!==c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l!==a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a!==l?1:0);return new y(c,r.typeInfo)}return new S(i!==o?1:0,this.getTypeInfo("bool"));case">=":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u>=c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l>=a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a>=l?1:0);return new y(c,r.typeInfo)}return new S(i>=o?1:0,this.getTypeInfo("bool"));case"<=":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u<=c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l<=a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a<=l?1:0);return new y(c,r.typeInfo)}return new S(i<=o?1:0,this.getTypeInfo("bool"));case"&&":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u&&c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l&&a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a&&l?1:0);return new y(c,r.typeInfo)}return new S(i&&o?1:0,this.getTypeInfo("bool"));case"||":if(F(i)&&F(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u||c[h]?1:0);return new y(l,n.typeInfo)}if(F(i)){const a=o,c=i.map((l,u)=>l||a?1:0);return new y(c,n.typeInfo)}if(F(o)){const a=i,c=o.map((l,u)=>a||l?1:0);return new y(c,r.typeInfo)}return new S(i||o?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const n=t.clone();n.currentFunctionName=e.name;const r=t.getFunction(e.name);if(!r)return this._callBuiltinFunction(e,n);for(let i=0;i<r.node.args.length;++i){const o=r.node.args[i],a=this.evalExpression(e.args[i],n);n.createVariable(o.name,a,o)}return this._execStatements(r.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothStep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const n=t.getFunction(e.name);if(n){const r=t.clone();for(let i=0;i<n.node.args.length;++i){const o=n.node.args[i],a=this.evalExpression(e.args[i],r);r.setVariable(o.name,a,o)}return this._execStatements(n.node.body,r)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new S(0,this.getTypeInfo(e.type));const n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n}_callConstructorVec(e,t){const n=this.getTypeInfo(e.type),r=this.getTypeName(e.type),i={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4}[r];if(i===void 0)return console.error(`Invalid vec constructor ${r}. Line ${e.line}`),null;const o=r.endsWith("i")||r.endsWith("u"),a=[];if(e instanceof oe)if(e.isVector){const c=e.vectorValue;for(const l of c)a.push(l)}else a.push(e.scalarValue);else if(e.args)for(const c of e.args){const l=this.evalExpression(c,t);if(l instanceof y){const u=l.value;for(let h=0;h<u.length;++h){let f=u[h];o&&(f=Math.floor(f)),a.push(f)}}else if(l instanceof S){let u=l.value;o&&(u=Math.floor(u)),a.push(u)}}if(e.type instanceof P&&e.type.format===null&&(e.type.format=P.f32),a.length===0){const c=new Array(i).fill(0);return new y(c,n)}if(a.length===1)for(;a.length<i;)a.push(a[0]);return a.length<i?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new y(a.length>i?a.slice(0,i):a,n)}_callConstructorMatrix(e,t){const n=this.getTypeInfo(e.type),r=this.getTypeName(e.type),i={mat2x2:4,mat2x2f:4,mat2x2h:4,mat2x3:6,mat2x3f:6,mat2x3h:6,mat2x4:8,mat2x4f:8,mat2x4h:8,mat3x2:6,mat3x2f:6,mat3x2h:6,mat3x3:9,mat3x3f:9,mat3x3h:9,mat3x4:12,mat3x4f:12,mat3x4h:12,mat4x2:8,mat4x2f:8,mat4x2h:8,mat4x3:12,mat4x3f:12,mat4x3h:12,mat4x4:16,mat4x4f:16,mat4x4h:16}[r];if(i===void 0)return console.error(`Invalid matrix constructor ${r}. Line ${e.line}`),null;const o=[];if(e instanceof oe)if(e.isVector){const a=e.vectorValue;for(const c of a)o.push(c)}else o.push(e.scalarValue);else if(e.args)for(const a of e.args){const c=this.evalExpression(a,t);if(c instanceof y){const l=c.value;for(let u=0;u<l.length;++u)o.push(l[u])}else c instanceof S?o.push(c.value):c instanceof Y&&o.push(...c.value)}if(n instanceof yt&&n.format===null&&(n.format=this.getTypeInfo("f32")),o.length===0){const a=new Array(i).fill(0);return new Y(a,n)}return o.length!==i?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new Y(o,n)}}ge._breakObj=new Ft(new ke("BREAK",null)),ge._continueObj=new Ft(new ke("CONTINUE",null)),ge._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class qg{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new Ig,this._exec=new ge}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const n=this._global_decl_or_directive();if(!n)break;t.push(n)}if(this._deferArrayCountEval.length>0){for(const n of this._deferArrayCountEval){const r=n.arrayType,i=n.countNode;if(i instanceof pt){const o=i.name,a=this._context.constants.get(o);if(a)try{const c=a.constEvaluate(this._exec);r.count=c}catch{}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e)if(typeof e=="string"){const t=new Bg(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==g.eof}_match(e){if(e instanceof A)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){const r=e[t];if(this._check(r))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const n=t.type;let r=!1;for(const i of e){if(n===i)return!0;i===g.tokens.name&&(r=!0)}if(r){const i=g.tokens.name.rule.exec(t.lexeme);if(i&&i.index==0&&i[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===g.tokens.name){const n=g.tokens.name.rule.exec(t.lexeme);return n&&n.index==0&&n[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(g.tokens.semicolon)&&!this._isAtEnd(););if(this._match(g.keywords.alias)){const t=this._type_alias();return this._consume(g.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(g.keywords.diagnostic)){const t=this._diagnostic();return this._consume(g.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(g.keywords.requires)){const t=this._requires_directive();return this._consume(g.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(g.keywords.enable)){const t=this._enable_directive();return this._consume(g.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(g.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(g.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(g.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(g.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(g.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(g.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(g.keywords.fn))return null;const e=this._currentLine,t=this._consume(g.tokens.ident,"Expected function name.").toString();this._consume(g.tokens.paren_left,"Expected '(' for function arguments.");const n=[];if(!this._check(g.tokens.paren_right))do{if(this._check(g.tokens.paren_right))break;const a=this._attribute(),c=this._consume(g.tokens.name,"Expected argument name.").toString();this._consume(g.tokens.colon,"Expected ':' for argument type.");const l=this._attribute(),u=this._type_decl();u!=null&&(u.attributes=l,n.push(this._updateNode(new kg(c,u,a))))}while(this._match(g.tokens.comma));this._consume(g.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(g.tokens.arrow)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}const i=this._compound_statement(),o=this._currentLine;return this._updateNode(new Gn(t,n,r,i,e,o),e)}_compound_statement(){const e=[];for(this._consume(g.tokens.brace_left,"Expected '{' for block.");!this._check(g.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(g.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(g.tokens.semicolon)&&!this._isAtEnd(););if(this._check(g.tokens.attr)&&this._attribute(),this._check(g.keywords.if))return this._if_statement();if(this._check(g.keywords.switch))return this._switch_statement();if(this._check(g.keywords.loop))return this._loop_statement();if(this._check(g.keywords.for))return this._for_statement();if(this._check(g.keywords.while))return this._while_statement();if(this._check(g.keywords.continuing))return this._continuing_statement();if(this._check(g.keywords.static_assert))return this._static_assert_statement();if(this._check(g.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(g.keywords.return))e=this._return_statement();else if(this._check([g.keywords.var,g.keywords.let,g.keywords.const]))e=this._variable_statement();else if(this._match(g.keywords.discard))e=this._updateNode(new Og);else if(this._match(g.keywords.break)){const t=this._updateNode(new au);if(this._currentLoop.length>0){const n=this._currentLoop[this._currentLoop.length-1];t.loopId=n.id}e=t,this._check(g.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression(),t.condition instanceof Nn&&t.condition.contents.length===1&&(t.condition=t.condition.contents[0]))}else if(this._match(g.keywords.continue)){const t=this._updateNode(new cu);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const n=this._currentLoop[this._currentLoop.length-1];t.loopId=n.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(g.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(g.keywords.static_assert))return null;const e=this._optional_paren_expression();return this._updateNode(new Cg(e))}_while_statement(){if(!this._match(g.keywords.while))return null;const e=this._updateNode(new Jl(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(g.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){if(!this._match(g.keywords.continuing))return null;const e=this._compound_statement();return this._updateNode(new $i(e))}_for_statement(){if(!this._match(g.keywords.for))return null;this._consume(g.tokens.paren_left,"Expected '('.");const e=this._updateNode(new Gl(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(g.tokens.semicolon)?null:this._for_init(),this._consume(g.tokens.semicolon,"Expected ';'."),e.condition=this._check(g.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(g.tokens.semicolon,"Expected ';'."),e.increment=this._check(g.tokens.paren_right)?null:this._for_increment(),this._consume(g.tokens.paren_right,"Expected ')'."),this._check(g.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(g.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(g.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new lt(e.name,e.type,e.storage,e.access,t))}if(this._match(g.keywords.let)){const e=this._consume(g.tokens.name,"Expected name for let.").toString();let t=null;if(this._match(g.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}this._consume(g.tokens.equal,"Expected '=' for let.");const n=this._short_circuit_or_expression();return this._updateNode(new er(e,t,null,null,n))}if(this._match(g.keywords.const)){const e=this._consume(g.tokens.name,"Expected name for const.").toString();let t=null;if(this._match(g.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}this._consume(g.tokens.equal,"Expected '=' for const.");const n=this._short_circuit_or_expression();return t===null&&n instanceof oe&&(t=n.type),this._updateNode(new zi(e,t,null,null,n))}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(g.increment_operators))return this._current=e,null;const n=this._consume(g.increment_operators,"Expected increment operator");return this._updateNode(new eu(n.type===g.tokens.plus_plus?Jt.increment:Jt.decrement,t))}_assignment_statement(){let e=null;if(this._check(g.tokens.brace_right))return null;let t=this._match(g.tokens.underscore);if(t||(e=this._unary_expression()),!t&&e==null)return null;const n=this._consume(g.assignment_operators,"Expected assignment operator."),r=this._short_circuit_or_expression();return this._updateNode(new tu(Ds.parse(n.lexeme),e,r))}_func_call_statement(){if(!this._check(g.tokens.ident))return null;const e=this._current,t=this._consume(g.tokens.ident,"Expected function name."),n=this._argument_expression_list();return n===null?(this._current=e,null):this._updateNode(new Eo(t.lexeme,n))}_loop_statement(){if(!this._match(g.keywords.loop))return null;this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new su([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof $i){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(g.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(g.keywords.switch))return null;const e=this._updateNode(new nu(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(g.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([g.keywords.default,g.keywords.case]);){if(this._match(g.keywords.case)){const n=this._case_selectors();for(const i of n)if(i instanceof kn){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(g.tokens.colon),this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Exected '{' for switch case.");const r=this._case_body();this._consume(g.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new pu(n,r)))}if(this._match(g.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(g.tokens.colon),this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Exected '{' for switch default.");const n=this._case_body();this._consume(g.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new _u(n)))}}return e}_case_selectors(){const e=[];for(this._match(g.keywords.default)?e.push(this._updateNode(new kn)):e.push(this._shift_expression());this._match(g.tokens.comma);)this._match(g.keywords.default)?e.push(this._updateNode(new kn)):e.push(this._shift_expression());return e}_case_body(){if(this._match(g.keywords.fallthrough))return this._consume(g.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(g.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(g.tokens.attr)&&this._attribute();const n=this._compound_statement();let r=[];this._match_elseif()&&(this._check(g.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let i=null;return this._match(g.keywords.else)&&(this._check(g.tokens.attr)&&this._attribute(),i=this._compound_statement()),this._updateNode(new ru(t,n,r,i),e)}_match_elseif(){return this._tokens[this._current].type===g.keywords.else&&this._tokens[this._current+1].type===g.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new Dg(t,n))),this._match_elseif()&&(this._check(g.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(g.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new iu(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(g.tokens.or_or);)e=this._updateNode(new Pe(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(g.tokens.and_and);)e=this._updateNode(new Pe(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(g.tokens.or);)e=this._updateNode(new Pe(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(g.tokens.xor);)e=this._updateNode(new Pe(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(g.tokens.and);)e=this._updateNode(new Pe(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([g.tokens.equal_equal,g.tokens.not_equal])?this._updateNode(new Pe(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([g.tokens.less_than,g.tokens.greater_than,g.tokens.less_than_equal,g.tokens.greater_than_equal]);)e=this._updateNode(new Pe(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([g.tokens.shift_left,g.tokens.shift_right]);)e=this._updateNode(new Pe(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([g.tokens.plus,g.tokens.minus]);)e=this._updateNode(new Pe(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([g.tokens.star,g.tokens.forward_slash,g.tokens.modulo]);)e=this._updateNode(new Pe(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([g.tokens.minus,g.tokens.bang,g.tokens.tilde,g.tokens.star,g.tokens.and])?this._updateNode(new Ae(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(g.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(g.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new hs(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(g.tokens.period)){const e=this._consume(g.tokens.name,"Expected member name."),t=this._postfix_expression(),n=this._updateNode(new Dt(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"bool":return k.bool;case"i32":return k.i32;case"u32":return k.u32;case"f32":return k.f32;case"f16":return k.f16;case"vec2f":return P.vec2f;case"vec3f":return P.vec3f;case"vec4f":return P.vec4f;case"vec2i":return P.vec2i;case"vec3i":return P.vec3i;case"vec4i":return P.vec4i;case"vec2u":return P.vec2u;case"vec3u":return P.vec3u;case"vec4u":return P.vec4u;case"vec2h":return P.vec2h;case"vec3h":return P.vec3h;case"vec4h":return P.vec4h;case"mat2x2f":return P.mat2x2f;case"mat2x3f":return P.mat2x3f;case"mat2x4f":return P.mat2x4f;case"mat3x2f":return P.mat3x2f;case"mat3x3f":return P.mat3x3f;case"mat3x4f":return P.mat3x4f;case"mat4x2f":return P.mat4x2f;case"mat4x3f":return P.mat4x3f;case"mat4x4f":return P.mat4x4f;case"mat2x2h":return P.mat2x2h;case"mat2x3h":return P.mat2x3h;case"mat2x4h":return P.mat2x4h;case"mat3x2h":return P.mat3x2h;case"mat3x3h":return P.mat3x3h;case"mat3x4h":return P.mat3x4h;case"mat4x2h":return P.mat4x2h;case"mat4x3h":return P.mat4x3h;case"mat4x4h":return P.mat4x4h}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(g.tokens.ident)){const n=this._previous().toString();if(this._check(g.tokens.paren_left)){const r=this._argument_expression_list(),i=this._getType(n);return i!==null?this._updateNode(new Ot(i,r)):this._updateNode(new gs(n,r))}if(this._context.constants.has(n)){const r=this._context.constants.get(n);return this._updateNode(new uu(n,r.value))}return this._updateNode(new pt(n))}if(this._match(g.tokens.int_literal)){const n=this._previous().toString();let r=n.endsWith("i")||n.endsWith("i")?k.i32:n.endsWith("u")||n.endsWith("U")?k.u32:k.x32;const i=parseInt(n);return this._validateTypeRange(i,r),this._updateNode(new oe(new S(i,this._exec.getTypeInfo(r)),r))}if(this._match(g.tokens.uint_literal)){const n=parseInt(this._previous().toString());return this._validateTypeRange(n,k.u32),this._updateNode(new oe(new S(n,this._exec.getTypeInfo(k.u32)),k.u32))}if(this._match([g.tokens.decimal_float_literal,g.tokens.hex_float_literal])){let n=this._previous().toString(),r=n.endsWith("h");r&&(n=n.substring(0,n.length-1));const i=parseFloat(n);this._validateTypeRange(i,r?k.f16:k.f32);const o=r?k.f16:k.f32;return this._updateNode(new oe(new S(i,this._exec.getTypeInfo(o)),o))}if(this._match([g.keywords.true,g.keywords.false])){let n=this._previous().toString()===g.keywords.true.rule;return this._updateNode(new oe(new S(n?1:0,this._exec.getTypeInfo(k.bool)),k.bool))}if(this._check(g.tokens.paren_left))return this._paren_expression();if(this._match(g.keywords.bitcast)){this._consume(g.tokens.less_than,"Expected '<'.");const n=this._type_decl();this._consume(g.tokens.greater_than,"Expected '>'.");const r=this._paren_expression();return this._updateNode(new hu(n,r))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new Ot(e,t))}_argument_expression_list(){if(!this._match(g.tokens.paren_left))return null;const e=[];do{if(this._check(g.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(g.tokens.comma));return this._consume(g.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(g.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(g.tokens.paren_right),this._updateNode(new Nn([e]))}_paren_expression(){this._consume(g.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(g.tokens.paren_right,"Expected ')'."),this._updateNode(new Nn([e]))}_struct_decl(){if(!this._match(g.keywords.struct))return null;const e=this._currentLine,t=this._consume(g.tokens.ident,"Expected name for struct.").toString();this._consume(g.tokens.brace_left,"Expected '{' for struct body.");const n=[];for(;!this._check(g.tokens.brace_right);){const o=this._attribute(),a=this._consume(g.tokens.name,"Expected variable name.").toString();this._consume(g.tokens.colon,"Expected ':' for struct member type.");const c=this._attribute(),l=this._type_decl();l!=null&&(l.attributes=c),this._check(g.tokens.brace_right)?this._match(g.tokens.comma):this._consume(g.tokens.comma,"Expected ',' for struct member."),n.push(this._updateNode(new Fg(a,l,o)))}this._consume(g.tokens.brace_right,"Expected '}' after struct body.");const r=this._currentLine,i=this._updateNode(new at(t,n,e,r),e);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(g.tokens.equal)){const t=this._const_expression(),n=[k.f32];try{const r=t.constEvaluate(this._exec,n);e.value=new oe(r,n[0]),this._exec.context.setVariable(e.name,r)}catch{e.value=t}}else{const t=new Ot(e.type,null),n=this._exec.evalExpression(t,this._exec.context);n!==null&&(e.value=new oe(n,e.type),this._exec.context.setVariable(e.name,n))}if(e.type!==null&&e.value instanceof oe){if(e.value.type.name!=="x32"&&this._exec.getTypeName(e.type)!==this._exec.getTypeName(e.value.type))throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof oe&&(e.type=e.value.type.name==="x32"?k.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(g.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(g.keywords.const))return null;const t=this._consume(g.tokens.name,"Expected variable name");let n=null;if(this._match(g.tokens.colon)){const a=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=a)}let r=null;this._consume(g.tokens.equal,"const declarations require an assignment");const i=this._short_circuit_or_expression();try{let a=[k.f32];const c=i.constEvaluate(this._exec,a);c instanceof S&&this._validateTypeRange(c.value,a[0]),a[0]instanceof P&&a[0].format===null&&c.typeInfo instanceof yt&&c.typeInfo.format!==null&&(c.typeInfo.format.name==="f16"?a[0].format=k.f16:c.typeInfo.format.name==="f32"?a[0].format=k.f32:c.typeInfo.format.name==="i32"?a[0].format=k.i32:c.typeInfo.format.name==="u32"?a[0].format=k.u32:c.typeInfo.format.name==="bool"?a[0].format=k.bool:console.error(`TODO: impelement template format type ${c.typeInfo.format.name}`)),r=this._updateNode(new oe(c,a[0])),this._exec.context.setVariable(t.toString(),c)}catch{r=i}if(n!==null&&r instanceof oe){if(r.type.name!=="x32"&&this._exec.getTypeName(n)!==this._exec.getTypeName(r.type))throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${n.name}. Line:${this._currentLine}`);r.type=n,r.isScalar&&this._validateTypeRange(r.scalarValue,r.type)}else n===null&&r instanceof oe&&(n=(e=r==null?void 0:r.type)!==null&&e!==void 0?e:k.f32,n===k.x32&&(n=k.i32));const o=this._updateNode(new zi(t.toString(),n,"","",r));return this._context.constants.set(o.name,o),o}_global_let_decl(){if(!this._match(g.keywords.let))return null;const e=this._consume(g.tokens.name,"Expected variable name");let t=null;if(this._match(g.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}let n=null;if(this._match(g.tokens.equal)){n=this._const_expression();const r=[k.f32];try{const i=n.constEvaluate(this._exec,r);i!==null&&(n=new oe(i,r[0]))}catch{}}if(t!==null&&n instanceof oe){if(n.type.name!=="x32"&&this._exec.getTypeName(t)!==this._exec.getTypeName(n.type))throw this._error(this._peek(),`Invalid cast from ${n.type.name} to ${t.name}. Line:${this._currentLine}`);n.type=t}else t===null&&n instanceof oe&&(t=n.type.name==="x32"?k.i32:n.type);return n instanceof oe&&n.isScalar&&this._validateTypeRange(n.scalarValue,t),this._updateNode(new er(e.toString(),t,"","",n))}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(g.keywords.var))return null;let e="",t="";this._match(g.tokens.less_than)&&(e=this._consume(g.storage_class,"Expected storage_class.").toString(),this._match(g.tokens.comma)&&(t=this._consume(g.access_mode,"Expected access_mode.").toString()),this._consume(g.tokens.greater_than,"Expected '>'."));const n=this._consume(g.tokens.name,"Expected variable name");let r=null;if(this._match(g.tokens.colon)){const i=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=i)}return this._updateNode(new lt(n.toString(),r,e,t,null))}_override_decl(){if(!this._match(g.keywords.override))return null;const e=this._consume(g.tokens.name,"Expected variable name");let t=null;if(this._match(g.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}return this._updateNode(new Ao(e.toString(),t,null))}_diagnostic(){this._consume(g.tokens.paren_left,"Expected '('");const e=this._consume(g.tokens.ident,"Expected severity control name.");this._consume(g.tokens.comma,"Expected ','");let t=this._consume(g.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(g.tokens.period)&&(t+=`.${this._consume(g.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(g.tokens.paren_right,"Expected ')'"),this._updateNode(new ou(e.toString(),t))}_enable_directive(){const e=this._consume(g.tokens.ident,"identity expected.");return this._updateNode(new Pg(e.toString()))}_requires_directive(){const e=[this._consume(g.tokens.ident,"identity expected.").toString()];for(;this._match(g.tokens.comma);){const t=this._consume(g.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new Mg(e))}_type_alias(){const e=this._consume(g.tokens.ident,"identity expected.");this._consume(g.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const n=this._updateNode(new So(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([g.tokens.ident,...g.texel_format,g.keywords.bool,g.keywords.f32,g.keywords.i32,g.keywords.u32])){const n=this._advance(),r=n.toString();return this._context.structs.has(r)?this._context.structs.get(r):this._context.aliases.has(r)?this._context.aliases.get(r).type:this._updateNode(new k(n.toString()))}let e=this._texture_sampler_types();if(e)return e;if(this._check(g.template_types)){let n=this._advance().toString(),r=null,i=null;return this._match(g.tokens.less_than)&&(r=this._type_decl(),i=null,this._match(g.tokens.comma)&&(i=this._consume(g.access_mode,"Expected access_mode for pointer").toString()),this._consume(g.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new P(n,r,i))}if(this._match(g.keywords.ptr)){let n=this._previous().toString();this._consume(g.tokens.less_than,"Expected '<' for pointer.");const r=this._consume(g.storage_class,"Expected storage_class for pointer");this._consume(g.tokens.comma,"Expected ',' for pointer.");const i=this._type_decl();let o=null;return this._match(g.tokens.comma)&&(o=this._consume(g.access_mode,"Expected access_mode for pointer").toString()),this._consume(g.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Ng(n,r.toString(),i,o))}const t=this._attribute();if(this._match(g.keywords.array)){let n=null,r=-1;const i=this._previous();let o=null;if(this._match(g.tokens.less_than)){n=this._type_decl(),this._context.aliases.has(n.name)&&(n=this._context.aliases.get(n.name).type);let c="";if(this._match(g.tokens.comma)){o=this._shift_expression();try{c=o.constEvaluate(this._exec).toString(),o=null}catch{c="1"}}this._consume(g.tokens.greater_than,"Expected '>' for array."),r=c?parseInt(c):0}const a=this._updateNode(new lu(i.toString(),t,n,r));return o&&this._deferArrayCountEval.push({arrayType:a,countNode:o}),a}return null}_texture_sampler_types(){if(this._match(g.sampler_type))return this._updateNode(new Fs(this._previous().toString(),null,null));if(this._match(g.depth_texture_type))return this._updateNode(new Fs(this._previous().toString(),null,null));if(this._match(g.sampled_texture_type)||this._match(g.multisampled_texture_type)){const e=this._previous();this._consume(g.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(g.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Fs(e.toString(),t,null))}if(this._match(g.storage_texture_type)){const e=this._previous();this._consume(g.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(g.texel_format,"Invalid texel format.").toString();this._consume(g.tokens.comma,"Expected ',' after texel format.");const n=this._consume(g.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(g.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Fs(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(g.tokens.attr);){const t=this._consume(g.attribute_name,"Expected attribute name"),n=this._updateNode(new Ug(t.toString(),null));if(this._match(g.tokens.paren_left)){if(n.value=this._consume(g.literal_or_ident,"Expected attribute value").toString(),this._check(g.tokens.comma)){this._advance();do{const r=this._consume(g.literal_or_ident,"Expected attribute value").toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(r)}while(this._match(g.tokens.comma))}this._consume(g.tokens.paren_right,"Expected ')'")}e.push(n)}return e.length==0?null:e}}class Kg extends Ye{constructor(e){super(),e&&this.update(e)}update(e){const t=new qg().parse(e);this.updateAST(t)}}function Zg(s){var i;const e={attributes:[],bindings:[]};let t;try{t=Qg(s)}catch(o){return D.error(o.message)(),e}for(const o of t.uniforms){const a=[];for(const c of((i=o.type)==null?void 0:i.members)||[])a.push({name:c.name,type:Qa(c.type)});e.bindings.push({type:"uniform",name:o.name,location:o.binding,group:o.group,members:a})}const n=t.entry.vertex[0],r=(n==null?void 0:n.inputs.length)||0;for(let o=0;o<r;o++){const a=n.inputs[o];if(a.locationType==="location"){const c=Qa(a.type);e.attributes.push({name:a.name,location:Number(a.location),type:c})}}return e}function Qa(s){return s.format?`${s.name}<${s.format.name}>`:s.name}function Qg(s){try{return new Kg(s)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&(e!=null&&e.message)&&(t+=`: ${e.message} `),typeof e=="object"&&(e!=null&&e.token)&&(t+=e.token.line||""),new Error(t,{cause:e})}}const Jg=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;
const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;
const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;
const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;
float sin_taylor_fp32(float a) {
float r, s, t, x;
if (a == 0.0) {
return 0.0;
}
x = -a * a;
s = a;
r = a;
r = r * x;
t = r * INVERSE_FACTORIAL_3;
s = s + t;
r = r * x;
t = r * INVERSE_FACTORIAL_5;
s = s + t;
r = r * x;
t = r * INVERSE_FACTORIAL_7;
s = s + t;
r = r * x;
t = r * INVERSE_FACTORIAL_9;
s = s + t;
return s;
}
void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
if (a == 0.0) {
sin_t = 0.0;
cos_t = 1.0;
}
sin_t = sin_taylor_fp32(a);
cos_t = sqrt(1.0 - sin_t * sin_t);
}
float tan_taylor_fp32(float a) {
float sin_a;
float cos_a;
if (a == 0.0) {
return 0.0;
}
float z = floor(a / TWO_PI);
float r = a - TWO_PI * z;
float t;
float q = floor(r / PI_2 + 0.5);
int j = int(q);
if (j < -2 || j > 2) {
return 1.0 / 0.0;
}
t = r - PI_2 * q;
q = floor(t / PI_16 + 0.5);
int k = int(q);
int abs_k = int(abs(float(k)));
if (abs_k > 4) {
return 1.0 / 0.0;
} else {
t = t - PI_16 * q;
}
float u = 0.0;
float v = 0.0;
float sin_t, cos_t;
float s, c;
sincos_taylor_fp32(t, sin_t, cos_t);
if (k == 0) {
s = sin_t;
c = cos_t;
} else {
if (abs(float(abs_k) - 1.0) < 0.5) {
u = COS_TABLE_0;
v = SIN_TABLE_0;
} else if (abs(float(abs_k) - 2.0) < 0.5) {
u = COS_TABLE_1;
v = SIN_TABLE_1;
} else if (abs(float(abs_k) - 3.0) < 0.5) {
u = COS_TABLE_2;
v = SIN_TABLE_2;
} else if (abs(float(abs_k) - 4.0) < 0.5) {
u = COS_TABLE_3;
v = SIN_TABLE_3;
}
if (k > 0) {
s = u * sin_t + v * cos_t;
c = u * cos_t - v * sin_t;
} else {
s = u * sin_t - v * cos_t;
c = u * cos_t + v * sin_t;
}
}
if (j == 0) {
sin_a = s;
cos_a = c;
} else if (j == 1) {
sin_a = c;
cos_a = -s;
} else if (j == -1) {
sin_a = -c;
cos_a = s;
} else {
sin_a = -s;
cos_a = -c;
}
return sin_a / cos_a;
}
#endif
float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
return tan_taylor_fp32(a);
#else
return tan(a);
#endif
}
`,Gg={name:"fp32",vs:Jg},em=[0,1,1,1],tm=`uniform pickingUniforms {
float isActive;
float isAttribute;
float isHighlightActive;
float useFloatColors;
vec3 highlightedObjectColor;
vec4 highlightColor;
} picking;
out vec4 picking_vRGBcolor_Avalid;
vec3 picking_normalizeColor(vec3 color) {
return picking.useFloatColors > 0.5 ? color : color / 255.0;
}
vec4 picking_normalizeColor(vec4 color) {
return picking.useFloatColors > 0.5 ? color : color / 255.0;
}
bool picking_isColorZero(vec3 color) {
return dot(color, vec3(1.0)) < 0.00001;
}
bool picking_isColorValid(vec3 color) {
return dot(color, vec3(1.0)) > 0.00001;
}
bool isVertexHighlighted(vec3 vertexColor) {
vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
return
bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}
void picking_setPickingColor(vec3 pickingColor) {
pickingColor = picking_normalizeColor(pickingColor);
if (bool(picking.isActive)) {
picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));
if (!bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rgb = pickingColor;
}
} else {
picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
}
}
void picking_setPickingAttribute(float value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.r = value;
}
}
void picking_setPickingAttribute(vec2 value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rg = value;
}
}
void picking_setPickingAttribute(vec3 value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rgb = value;
}
}
`,sm=`uniform pickingUniforms {
float isActive;
float isAttribute;
float isHighlightActive;
float useFloatColors;
vec3 highlightedObjectColor;
vec4 highlightColor;
} picking;
in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
if (picking.isActive > 0.5) {
return color;
}
bool selected = bool(picking_vRGBcolor_Avalid.a);
if (selected) {
float highLightAlpha = picking.highlightColor.a;
float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
float highLightRatio = highLightAlpha / blendedAlpha;
vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
return vec4(blendedRGB, blendedAlpha);
} else {
return color;
}
}
vec4 picking_filterPickingColor(vec4 color) {
if (bool(picking.isActive)) {
if (picking_vRGBcolor_Avalid.a == 0.0) {
discard;
}
return picking_vRGBcolor_Avalid;
}
return color;
}
vec4 picking_filterColor(vec4 color) {
vec4 highlightColor = picking_filterHighlightColor(color);
return picking_filterPickingColor(highlightColor);
}
`,Ja={name:"picking",vs:tm,fs:sm,uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:em},getUniforms:nm};function nm(s={},e){const t={};if(s.highlightedObjectColor!==void 0)if(s.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const n=s.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=n}if(s.highlightColor){const n=Array.from(s.highlightColor,r=>r/255);Number.isFinite(n[3])||(n[3]=1),t.highlightColor=n}return s.isActive!==void 0&&(t.isActive=!!s.isActive,t.isAttribute=!!s.isAttribute),s.useFloatColors!==void 0&&(t.useFloatColors=!!s.useFloatColors),t}function mu(s,e=[],t=0){const n=Math.fround(s),r=s-n;return e[t]=n,e[t+1]=r,e}function rm(s){return s-Math.fround(s)}function im(s){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let n=0;n<4;++n){const r=t*4+n;mu(s[n*4+t],e,r*2)}return e}const om=`uniform float ONE;
vec2 split(float a) {
const float SPLIT = 4097.0;
float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float a_hi = t * ONE - (t - a);
float a_lo = a * ONE - a_hi;
#else
float a_hi = t - (t - a);
float a_lo = a - a_hi;
#endif
return vec2(a_hi, a_lo);
}
vec2 split2(vec2 a) {
vec2 b = split(a.x);
b.y += a.y;
return b;
}
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float sum = (a + b) * ONE;
float err = b - (sum - a) * ONE;
#else
float sum = a + b;
float err = b - (sum - a);
#endif
return vec2(sum, err);
}
vec2 twoSum(float a, float b) {
float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float v = (s * ONE - a) * ONE;
float err = (a - (s - v) * ONE) * ONE * ONE * ONE + (b - v);
#else
float v = s - a;
float err = (a - (s - v)) + (b - v);
#endif
return vec2(s, err);
}
vec2 twoSub(float a, float b) {
float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float v = (s * ONE - a) * ONE;
float err = (a - (s - v) * ONE) * ONE * ONE * ONE - (b + v);
#else
float v = s - a;
float err = (a - (s - v)) - (b + v);
#endif
return vec2(s, err);
}
vec2 twoSqr(float a) {
float prod = a * a;
vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float err = ((a_fp64.x * a_fp64.x - prod) * ONE + 2.0 * a_fp64.x *
a_fp64.y * ONE * ONE) + a_fp64.y * a_fp64.y * ONE * ONE * ONE;
#else
float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
return vec2(prod, err);
}
vec2 twoProd(float a, float b) {
float prod = a * b;
vec2 a_fp64 = split(a);
vec2 b_fp64 = split(b);
float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
return vec2(prod, err);
}
vec2 sum_fp64(vec2 a, vec2 b) {
vec2 s, t;
s = twoSum(a.x, b.x);
t = twoSum(a.y, b.y);
s.y += t.x;
s = quickTwoSum(s.x, s.y);
s.y += t.y;
s = quickTwoSum(s.x, s.y);
return s;
}
vec2 sub_fp64(vec2 a, vec2 b) {
vec2 s, t;
s = twoSub(a.x, b.x);
t = twoSub(a.y, b.y);
s.y += t.x;
s = quickTwoSum(s.x, s.y);
s.y += t.y;
s = quickTwoSum(s.x, s.y);
return s;
}
vec2 mul_fp64(vec2 a, vec2 b) {
vec2 prod = twoProd(a.x, b.x);
prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
prod = split2(prod);
#endif
prod = quickTwoSum(prod.x, prod.y);
prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
prod = split2(prod);
#endif
prod = quickTwoSum(prod.x, prod.y);
return prod;
}
vec2 div_fp64(vec2 a, vec2 b) {
float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
vec2 yn = a * xn;
#endif
float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
vec2 prod = twoProd(xn, diff);
return sum_fp64(yn, prod);
}
vec2 sqrt_fp64(vec2 a) {
if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);
float x = 1.0 / sqrt(a.x);
float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
vec2 yn_sqr = twoSqr(yn) * ONE;
#else
vec2 yn_sqr = twoSqr(yn);
#endif
float diff = sub_fp64(a, yn_sqr).x;
vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
return sum_fp64(split(yn), prod);
#else
return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,am={ONE:1};function cm(){return am}const lm={name:"fp64-arithmetic",vs:om,getUniforms:cm,fp64ify:mu,fp64LowPart:rm,fp64ifyMatrix4:im},um={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...um}};const ve=globalThis.mathgl.config;function hm(s,{precision:e=ve.precision}={}){return s=fm(s),`${parseFloat(s.toPrecision(e))}`}function Ut(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function ht(s,e,t){return pm(s,n=>Math.max(e,Math.min(t,n)))}function rr(s,e,t){return Ut(s)?s.map((n,r)=>rr(n,e[r],t)):t*e+(1-t)*s}function Zs(s,e,t){const n=ve.EPSILON;try{if(s===e)return!0;if(Ut(s)&&Ut(e)){if(s.length!==e.length)return!1;for(let r=0;r<s.length;++r)if(!Zs(s[r],e[r]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"?Math.abs(s-e)<=ve.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{ve.EPSILON=n}}function fm(s){return Math.round(s/ve.EPSILON)*ve.EPSILON}function dm(s){return s.clone?s.clone():new Array(s.length)}function pm(s,e,t){if(Ut(s)){const n=s;t=t||dm(n);for(let r=0;r<t.length&&r<n.length;++r){const i=typeof s=="number"?s:s[r];t[r]=e(i,r,t)}return t}return e(s)}class Co extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}toArray(e=[],t=0){for(let n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Ut(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ve)}formatString(e){let t="";for(let n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+hm(this[n],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!Zs(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,n){if(n===void 0)return this.lerp(this,e,t);for(let r=0;r<this.ELEMENTS;++r){const i=e[r],o=typeof t=="number"?t:t[r];this[r]=i+n*(o-i)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}add(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]+=t[n];return this.check()}subtract(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]-=t[n];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(ve.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}get elements(){return this}}function _m(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function J(s){if(!Number.isFinite(s))throw new Error(`Invalid number ${JSON.stringify(s)}`);return s}function zs(s,e,t=""){if(ve.debug&&!_m(s,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return s}function Ga(s,e){if(!s)throw new Error(`math.gl assertion ${e}`)}class yu extends Co{get x(){return this[0]}set x(e){this[0]=J(e)}get y(){return this[1]}set y(e){this[1]=J(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let n=0;n<this.ELEMENTS;++n){const r=this[n]-e[n];t+=r*r}return J(t)}dot(e){let t=0;for(let n=0;n<this.ELEMENTS;++n)t+=this[n]*e[n];return J(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]*=t[n];return this.check()}divide(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]/=t[n];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Ga(e>=0&&e<this.ELEMENTS,"index is out of range"),J(this[e])}setComponent(e,t){return Ga(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const Ws=1e-6;let De=typeof Float32Array<"u"?Float32Array:Array;function gm(){const s=new De(2);return De!=Float32Array&&(s[0]=0,s[1]=0),s}function ec(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function mm(s,e){return s[0]=-e[0],s[1]=-e[1],s}function Tu(s,e,t,n){const r=e[0],i=e[1];return s[0]=r+n*(t[0]-r),s[1]=i+n*(t[1]-i),s}function ym(s,e,t){const n=e[0],r=e[1];return s[0]=t[0]*n+t[3]*r+t[6],s[1]=t[1]*n+t[4]*r+t[7],s}function Tm(s,e,t){const n=e[0],r=e[1];return s[0]=t[0]*n+t[4]*r+t[12],s[1]=t[1]*n+t[5]*r+t[13],s}(function(){const s=gm();return function(e,t,n,r,i,o){let a,c;for(t||(t=2),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,a=n;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],i(s,s,o),e[a]=s[0],e[a+1]=s[1];return e}})();function bm(s,e,t){const n=e[0],r=e[1],i=t[3]*n+t[7]*r||1;return s[0]=(t[0]*n+t[4]*r)/i,s[1]=(t[1]*n+t[5]*r)/i,s}function bu(s,e,t){const n=e[0],r=e[1],i=e[2],o=t[3]*n+t[7]*r+t[11]*i||1;return s[0]=(t[0]*n+t[4]*r+t[8]*i)/o,s[1]=(t[1]*n+t[5]*r+t[9]*i)/o,s[2]=(t[2]*n+t[6]*r+t[10]*i)/o,s}function vm(s,e,t){const n=e[0],r=e[1];return s[0]=t[0]*n+t[2]*r,s[1]=t[1]*n+t[3]*r,s[2]=e[2],s}function wm(s,e,t){const n=e[0],r=e[1];return s[0]=t[0]*n+t[2]*r,s[1]=t[1]*n+t[3]*r,s[2]=e[2],s[3]=e[3],s}function vu(s,e,t){const n=e[0],r=e[1],i=e[2];return s[0]=t[0]*n+t[3]*r+t[6]*i,s[1]=t[1]*n+t[4]*r+t[7]*i,s[2]=t[2]*n+t[5]*r+t[8]*i,s[3]=e[3],s}function wu(){const s=new De(3);return De!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function Am(s){const e=s[0],t=s[1],n=s[2];return Math.sqrt(e*e+t*t+n*n)}function tc(s,e,t){const n=new De(3);return n[0]=s,n[1]=e,n[2]=t,n}function Em(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function Sm(s){const e=s[0],t=s[1],n=s[2];return e*e+t*t+n*n}function xm(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function Rm(s,e){const t=e[0],n=e[1],r=e[2];let i=t*t+n*n+r*r;return i>0&&(i=1/Math.sqrt(i)),s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s}function Au(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function Dn(s,e,t){const n=e[0],r=e[1],i=e[2],o=t[0],a=t[1],c=t[2];return s[0]=r*c-i*a,s[1]=i*o-n*c,s[2]=n*a-r*o,s}function Im(s,e,t,n){const r=e[0],i=e[1],o=e[2];return s[0]=r+n*(t[0]-r),s[1]=i+n*(t[1]-i),s[2]=o+n*(t[2]-o),s}function Po(s,e,t){const n=e[0],r=e[1],i=e[2];let o=t[3]*n+t[7]*r+t[11]*i+t[15];return o=o||1,s[0]=(t[0]*n+t[4]*r+t[8]*i+t[12])/o,s[1]=(t[1]*n+t[5]*r+t[9]*i+t[13])/o,s[2]=(t[2]*n+t[6]*r+t[10]*i+t[14])/o,s}function Eu(s,e,t){const n=e[0],r=e[1],i=e[2];return s[0]=n*t[0]+r*t[3]+i*t[6],s[1]=n*t[1]+r*t[4]+i*t[7],s[2]=n*t[2]+r*t[5]+i*t[8],s}function Su(s,e,t){const n=t[0],r=t[1],i=t[2],o=t[3],a=e[0],c=e[1],l=e[2];let u=r*l-i*c,h=i*a-n*l,f=n*c-r*a,_=r*f-i*h,T=i*u-n*f,v=n*h-r*u;const R=o*2;return u*=R,h*=R,f*=R,_*=2,T*=2,v*=2,s[0]=a+u+_,s[1]=c+h+T,s[2]=l+f+v,s}function Cm(s,e,t,n){const r=[],i=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],i[0]=r[0],i[1]=r[1]*Math.cos(n)-r[2]*Math.sin(n),i[2]=r[1]*Math.sin(n)+r[2]*Math.cos(n),s[0]=i[0]+t[0],s[1]=i[1]+t[1],s[2]=i[2]+t[2],s}function Pm(s,e,t,n){const r=[],i=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],i[0]=r[2]*Math.sin(n)+r[0]*Math.cos(n),i[1]=r[1],i[2]=r[2]*Math.cos(n)-r[0]*Math.sin(n),s[0]=i[0]+t[0],s[1]=i[1]+t[1],s[2]=i[2]+t[2],s}function Mm(s,e,t,n){const r=[],i=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],i[0]=r[0]*Math.cos(n)-r[1]*Math.sin(n),i[1]=r[0]*Math.sin(n)+r[1]*Math.cos(n),i[2]=r[2],s[0]=i[0]+t[0],s[1]=i[1]+t[1],s[2]=i[2]+t[2],s}function Om(s,e){const t=s[0],n=s[1],r=s[2],i=e[0],o=e[1],a=e[2],c=Math.sqrt((t*t+n*n+r*r)*(i*i+o*o+a*a)),l=c&&Au(s,e)/c;return Math.acos(Math.min(Math.max(l,-1),1))}const xu=Em,Ru=Am,ti=Sm;(function(){const s=wu();return function(e,t,n,r,i,o){let a,c;for(t||(t=3),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,a=n;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2];return e}})();const si=[0,0,0];let bn;class Ke extends yu{static get ZERO(){return bn||(bn=new Ke(0,0,0),Object.freeze(bn)),bn}constructor(e=0,t=0,n=0){super(-0,-0,-0),arguments.length===1&&Ut(e)?this.copy(e):(ve.debug&&(J(e),J(t),J(n)),this[0]=e,this[1]=t,this[2]=n)}set(e,t,n){return this[0]=e,this[1]=t,this[2]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return ve.debug&&(J(e.x),J(e.y),J(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=J(e)}angle(e){return Om(this,e)}cross(e){return Dn(this,this,e),this.check()}rotateX({radians:e,origin:t=si}){return Cm(this,this,t,e),this.check()}rotateY({radians:e,origin:t=si}){return Pm(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=si}){return Mm(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Po(this,this,e),this.check()}transformAsVector(e){return bu(this,this,e),this.check()}transformByMatrix3(e){return Eu(this,this,e),this.check()}transformByMatrix2(e){return vm(this,this,e),this.check()}transformByQuaternion(e){return Su(this,this,e),this.check()}}let vn;class Mo extends yu{static get ZERO(){return vn||(vn=new Mo(0,0,0,0),Object.freeze(vn)),vn}constructor(e=0,t=0,n=0,r=0){super(-0,-0,-0,-0),Ut(e)&&arguments.length===1?this.copy(e):(ve.debug&&(J(e),J(t),J(n),J(r)),this[0]=e,this[1]=t,this[2]=n,this[3]=r)}set(e,t,n,r){return this[0]=e,this[1]=t,this[2]=n,this[3]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return ve.debug&&(J(e.x),J(e.y),J(e.z),J(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=J(e)}get w(){return this[3]}set w(e){this[3]=J(e)}transform(e){return Po(this,this,e),this.check()}transformByMatrix3(e){return vu(this,this,e),this.check()}transformByMatrix2(e){return wm(this,this,e),this.check()}transformByQuaternion(e){return Su(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}}class Iu extends Co{toString(){let e="[";if(ve.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let n=0;n<this.RANK;++n)e+=` ${this[n*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,n){return this[t*this.RANK+e]=J(n),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const n=e*this.RANK;for(let r=0;r<this.RANK;++r)t[r]=this[n+r];return t}setColumn(e,t){const n=e*this.RANK;for(let r=0;r<this.RANK;++r)this[n+r]=t[r];return this}}function Nm(){const s=new De(9);return De!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function km(s,e){if(s===e){const t=e[1],n=e[2],r=e[5];s[1]=e[3],s[2]=e[6],s[3]=t,s[5]=e[7],s[6]=n,s[7]=r}else s[0]=e[0],s[1]=e[3],s[2]=e[6],s[3]=e[1],s[4]=e[4],s[5]=e[7],s[6]=e[2],s[7]=e[5],s[8]=e[8];return s}function Dm(s,e){const t=e[0],n=e[1],r=e[2],i=e[3],o=e[4],a=e[5],c=e[6],l=e[7],u=e[8],h=u*o-a*l,f=-u*i+a*c,_=l*i-o*c;let T=t*h+n*f+r*_;return T?(T=1/T,s[0]=h*T,s[1]=(-u*n+r*l)*T,s[2]=(a*n-r*o)*T,s[3]=f*T,s[4]=(u*t-r*c)*T,s[5]=(-a*t+r*i)*T,s[6]=_*T,s[7]=(-l*t+n*c)*T,s[8]=(o*t-n*i)*T,s):null}function Fm(s){const e=s[0],t=s[1],n=s[2],r=s[3],i=s[4],o=s[5],a=s[6],c=s[7],l=s[8];return e*(l*i-o*c)+t*(-l*r+o*a)+n*(c*r-i*a)}function sc(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8],f=t[0],_=t[1],T=t[2],v=t[3],R=t[4],C=t[5],I=t[6],M=t[7],N=t[8];return s[0]=f*n+_*o+T*l,s[1]=f*r+_*a+T*u,s[2]=f*i+_*c+T*h,s[3]=v*n+R*o+C*l,s[4]=v*r+R*a+C*u,s[5]=v*i+R*c+C*h,s[6]=I*n+M*o+N*l,s[7]=I*r+M*a+N*u,s[8]=I*i+M*c+N*h,s}function Um(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8],f=t[0],_=t[1];return s[0]=n,s[1]=r,s[2]=i,s[3]=o,s[4]=a,s[5]=c,s[6]=f*n+_*o+l,s[7]=f*r+_*a+u,s[8]=f*i+_*c+h,s}function Bm(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8],f=Math.sin(t),_=Math.cos(t);return s[0]=_*n+f*o,s[1]=_*r+f*a,s[2]=_*i+f*c,s[3]=_*o-f*n,s[4]=_*a-f*r,s[5]=_*c-f*i,s[6]=l,s[7]=u,s[8]=h,s}function nc(s,e,t){const n=t[0],r=t[1];return s[0]=n*e[0],s[1]=n*e[1],s[2]=n*e[2],s[3]=r*e[3],s[4]=r*e[4],s[5]=r*e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s}function Lm(s,e){const t=e[0],n=e[1],r=e[2],i=e[3],o=t+t,a=n+n,c=r+r,l=t*o,u=n*o,h=n*a,f=r*o,_=r*a,T=r*c,v=i*o,R=i*a,C=i*c;return s[0]=1-h-T,s[3]=u-C,s[6]=f+R,s[1]=u+C,s[4]=1-l-T,s[7]=_-v,s[2]=f-R,s[5]=_+v,s[8]=1-l-h,s}var Hi;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL1ROW0=3]="COL1ROW0",s[s.COL1ROW1=4]="COL1ROW1",s[s.COL1ROW2=5]="COL1ROW2",s[s.COL2ROW0=6]="COL2ROW0",s[s.COL2ROW1=7]="COL2ROW1",s[s.COL2ROW2=8]="COL2ROW2"})(Hi||(Hi={}));const Vm=Object.freeze([1,0,0,0,1,0,0,0,1]);class Cu extends Iu{static get IDENTITY(){return zm()}static get ZERO(){return $m()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return Hi}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(Vm)}fromObject(e){return this.check()}fromQuaternion(e){return Lm(this,e),this.check()}set(e,t,n,r,i,o,a,c,l){return this[0]=e,this[1]=t,this[2]=n,this[3]=r,this[4]=i,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this.check()}setRowMajor(e,t,n,r,i,o,a,c,l){return this[0]=e,this[1]=r,this[2]=a,this[3]=t,this[4]=i,this[5]=c,this[6]=n,this[7]=o,this[8]=l,this.check()}determinant(){return Fm(this)}transpose(){return km(this,this),this.check()}invert(){return Dm(this,this),this.check()}multiplyLeft(e){return sc(this,e,this),this.check()}multiplyRight(e){return sc(this,this,e),this.check()}rotate(e){return Bm(this,this,e),this.check()}scale(e){return Array.isArray(e)?nc(this,this,e):nc(this,this,[e,e]),this.check()}translate(e){return Um(this,this,e),this.check()}transform(e,t){let n;switch(e.length){case 2:n=ym(t||[-0,-0],e,this);break;case 3:n=Eu(t||[-0,-0,-0],e,this);break;case 4:n=vu(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return zs(n,e.length),n}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let wn,An=null;function $m(){return wn||(wn=new Cu([0,0,0,0,0,0,0,0,0]),Object.freeze(wn)),wn}function zm(){return An||(An=new Cu,Object.freeze(An)),An}function Wm(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Hm(s,e){if(s===e){const t=e[1],n=e[2],r=e[3],i=e[6],o=e[7],a=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=n,s[9]=i,s[11]=e[14],s[12]=r,s[13]=o,s[14]=a}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function ji(s,e){const t=e[0],n=e[1],r=e[2],i=e[3],o=e[4],a=e[5],c=e[6],l=e[7],u=e[8],h=e[9],f=e[10],_=e[11],T=e[12],v=e[13],R=e[14],C=e[15],I=t*a-n*o,M=t*c-r*o,N=t*l-i*o,U=n*c-r*a,B=n*l-i*a,$=r*l-i*c,W=u*v-h*T,V=u*R-f*T,z=u*C-_*T,H=h*R-f*v,te=h*C-_*v,re=f*C-_*R;let X=I*re-M*te+N*H+U*z-B*V+$*W;return X?(X=1/X,s[0]=(a*re-c*te+l*H)*X,s[1]=(r*te-n*re-i*H)*X,s[2]=(v*$-R*B+C*U)*X,s[3]=(f*B-h*$-_*U)*X,s[4]=(c*z-o*re-l*V)*X,s[5]=(t*re-r*z+i*V)*X,s[6]=(R*N-T*$-C*M)*X,s[7]=(u*$-f*N+_*M)*X,s[8]=(o*te-a*z+l*W)*X,s[9]=(n*z-t*te-i*W)*X,s[10]=(T*B-v*N+C*I)*X,s[11]=(h*N-u*B-_*I)*X,s[12]=(a*V-o*H-c*W)*X,s[13]=(t*H-n*V+r*W)*X,s[14]=(v*M-T*U-R*I)*X,s[15]=(u*U-h*M+f*I)*X,s):null}function jm(s){const e=s[0],t=s[1],n=s[2],r=s[3],i=s[4],o=s[5],a=s[6],c=s[7],l=s[8],u=s[9],h=s[10],f=s[11],_=s[12],T=s[13],v=s[14],R=s[15],C=e*o-t*i,I=e*a-n*i,M=t*a-n*o,N=l*T-u*_,U=l*v-h*_,B=u*v-h*T,$=e*B-t*U+n*N,W=i*B-o*U+a*N,V=l*M-u*I+h*C,z=_*M-T*I+v*C;return c*$-r*W+R*V-f*z}function Nt(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8],f=e[9],_=e[10],T=e[11],v=e[12],R=e[13],C=e[14],I=e[15];let M=t[0],N=t[1],U=t[2],B=t[3];return s[0]=M*n+N*a+U*h+B*v,s[1]=M*r+N*c+U*f+B*R,s[2]=M*i+N*l+U*_+B*C,s[3]=M*o+N*u+U*T+B*I,M=t[4],N=t[5],U=t[6],B=t[7],s[4]=M*n+N*a+U*h+B*v,s[5]=M*r+N*c+U*f+B*R,s[6]=M*i+N*l+U*_+B*C,s[7]=M*o+N*u+U*T+B*I,M=t[8],N=t[9],U=t[10],B=t[11],s[8]=M*n+N*a+U*h+B*v,s[9]=M*r+N*c+U*f+B*R,s[10]=M*i+N*l+U*_+B*C,s[11]=M*o+N*u+U*T+B*I,M=t[12],N=t[13],U=t[14],B=t[15],s[12]=M*n+N*a+U*h+B*v,s[13]=M*r+N*c+U*f+B*R,s[14]=M*i+N*l+U*_+B*C,s[15]=M*o+N*u+U*T+B*I,s}function ir(s,e,t){const n=t[0],r=t[1],i=t[2];let o,a,c,l,u,h,f,_,T,v,R,C;return e===s?(s[12]=e[0]*n+e[4]*r+e[8]*i+e[12],s[13]=e[1]*n+e[5]*r+e[9]*i+e[13],s[14]=e[2]*n+e[6]*r+e[10]*i+e[14],s[15]=e[3]*n+e[7]*r+e[11]*i+e[15]):(o=e[0],a=e[1],c=e[2],l=e[3],u=e[4],h=e[5],f=e[6],_=e[7],T=e[8],v=e[9],R=e[10],C=e[11],s[0]=o,s[1]=a,s[2]=c,s[3]=l,s[4]=u,s[5]=h,s[6]=f,s[7]=_,s[8]=T,s[9]=v,s[10]=R,s[11]=C,s[12]=o*n+u*r+T*i+e[12],s[13]=a*n+h*r+v*i+e[13],s[14]=c*n+f*r+R*i+e[14],s[15]=l*n+_*r+C*i+e[15]),s}function Oo(s,e,t){const n=t[0],r=t[1],i=t[2];return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s[3]=e[3]*n,s[4]=e[4]*r,s[5]=e[5]*r,s[6]=e[6]*r,s[7]=e[7]*r,s[8]=e[8]*i,s[9]=e[9]*i,s[10]=e[10]*i,s[11]=e[11]*i,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function Xm(s,e,t,n){let r=n[0],i=n[1],o=n[2],a=Math.sqrt(r*r+i*i+o*o),c,l,u,h,f,_,T,v,R,C,I,M,N,U,B,$,W,V,z,H,te,re,X,Be;return a<Ws?null:(a=1/a,r*=a,i*=a,o*=a,l=Math.sin(t),c=Math.cos(t),u=1-c,h=e[0],f=e[1],_=e[2],T=e[3],v=e[4],R=e[5],C=e[6],I=e[7],M=e[8],N=e[9],U=e[10],B=e[11],$=r*r*u+c,W=i*r*u+o*l,V=o*r*u-i*l,z=r*i*u-o*l,H=i*i*u+c,te=o*i*u+r*l,re=r*o*u+i*l,X=i*o*u-r*l,Be=o*o*u+c,s[0]=h*$+v*W+M*V,s[1]=f*$+R*W+N*V,s[2]=_*$+C*W+U*V,s[3]=T*$+I*W+B*V,s[4]=h*z+v*H+M*te,s[5]=f*z+R*H+N*te,s[6]=_*z+C*H+U*te,s[7]=T*z+I*H+B*te,s[8]=h*re+v*X+M*Be,s[9]=f*re+R*X+N*Be,s[10]=_*re+C*X+U*Be,s[11]=T*re+I*X+B*Be,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function Pu(s,e,t){const n=Math.sin(t),r=Math.cos(t),i=e[4],o=e[5],a=e[6],c=e[7],l=e[8],u=e[9],h=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=i*r+l*n,s[5]=o*r+u*n,s[6]=a*r+h*n,s[7]=c*r+f*n,s[8]=l*r-i*n,s[9]=u*r-o*n,s[10]=h*r-a*n,s[11]=f*r-c*n,s}function Ym(s,e,t){const n=Math.sin(t),r=Math.cos(t),i=e[0],o=e[1],a=e[2],c=e[3],l=e[8],u=e[9],h=e[10],f=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=i*r-l*n,s[1]=o*r-u*n,s[2]=a*r-h*n,s[3]=c*r-f*n,s[8]=i*n+l*r,s[9]=o*n+u*r,s[10]=a*n+h*r,s[11]=c*n+f*r,s}function Mu(s,e,t){const n=Math.sin(t),r=Math.cos(t),i=e[0],o=e[1],a=e[2],c=e[3],l=e[4],u=e[5],h=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=i*r+l*n,s[1]=o*r+u*n,s[2]=a*r+h*n,s[3]=c*r+f*n,s[4]=l*r-i*n,s[5]=u*r-o*n,s[6]=h*r-a*n,s[7]=f*r-c*n,s}function e3(s,e){const t=e[0],n=e[1],r=e[2],i=e[4],o=e[5],a=e[6],c=e[8],l=e[9],u=e[10];return s[0]=Math.sqrt(t*t+n*n+r*r),s[1]=Math.sqrt(i*i+o*o+a*a),s[2]=Math.sqrt(c*c+l*l+u*u),s}function qm(s,e){const t=e[0],n=e[1],r=e[2],i=e[3],o=t+t,a=n+n,c=r+r,l=t*o,u=n*o,h=n*a,f=r*o,_=r*a,T=r*c,v=i*o,R=i*a,C=i*c;return s[0]=1-h-T,s[1]=u+C,s[2]=f-R,s[3]=0,s[4]=u-C,s[5]=1-l-T,s[6]=_+v,s[7]=0,s[8]=f+R,s[9]=_-v,s[10]=1-l-h,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Km(s,e,t,n,r,i,o){const a=1/(t-e),c=1/(r-n),l=1/(i-o);return s[0]=i*2*a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=i*2*c,s[6]=0,s[7]=0,s[8]=(t+e)*a,s[9]=(r+n)*c,s[10]=(o+i)*l,s[11]=-1,s[12]=0,s[13]=0,s[14]=o*i*2*l,s[15]=0,s}function Zm(s,e,t,n,r){const i=1/Math.tan(e/2);if(s[0]=i/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=i,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,r!=null&&r!==1/0){const o=1/(n-r);s[10]=(r+n)*o,s[14]=2*r*n*o}else s[10]=-1,s[14]=-2*n;return s}const Qm=Zm;function Jm(s,e,t,n,r,i,o){const a=1/(e-t),c=1/(n-r),l=1/(i-o);return s[0]=-2*a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*l,s[11]=0,s[12]=(e+t)*a,s[13]=(r+n)*c,s[14]=(o+i)*l,s[15]=1,s}const Gm=Jm;function ey(s,e,t,n){let r,i,o,a,c,l,u,h,f,_;const T=e[0],v=e[1],R=e[2],C=n[0],I=n[1],M=n[2],N=t[0],U=t[1],B=t[2];return Math.abs(T-N)<Ws&&Math.abs(v-U)<Ws&&Math.abs(R-B)<Ws?Wm(s):(h=T-N,f=v-U,_=R-B,r=1/Math.sqrt(h*h+f*f+_*_),h*=r,f*=r,_*=r,i=I*_-M*f,o=M*h-C*_,a=C*f-I*h,r=Math.sqrt(i*i+o*o+a*a),r?(r=1/r,i*=r,o*=r,a*=r):(i=0,o=0,a=0),c=f*a-_*o,l=_*i-h*a,u=h*o-f*i,r=Math.sqrt(c*c+l*l+u*u),r?(r=1/r,c*=r,l*=r,u*=r):(c=0,l=0,u=0),s[0]=i,s[1]=c,s[2]=h,s[3]=0,s[4]=o,s[5]=l,s[6]=f,s[7]=0,s[8]=a,s[9]=u,s[10]=_,s[11]=0,s[12]=-(i*T+o*v+a*R),s[13]=-(c*T+l*v+u*R),s[14]=-(h*T+f*v+_*R),s[15]=1,s)}function ty(){const s=new De(4);return De!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function sy(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s}function No(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function ny(s){const e=s[0],t=s[1],n=s[2],r=s[3];return Math.sqrt(e*e+t*t+n*n+r*r)}function ry(s){const e=s[0],t=s[1],n=s[2],r=s[3];return e*e+t*t+n*n+r*r}function iy(s,e){const t=e[0],n=e[1],r=e[2],i=e[3];let o=t*t+n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o)),s[0]=t*o,s[1]=n*o,s[2]=r*o,s[3]=i*o,s}function oy(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]+s[3]*e[3]}function ay(s,e,t,n){const r=e[0],i=e[1],o=e[2],a=e[3];return s[0]=r+n*(t[0]-r),s[1]=i+n*(t[1]-i),s[2]=o+n*(t[2]-o),s[3]=a+n*(t[3]-a),s}function ms(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3];return s[0]=t[0]*n+t[4]*r+t[8]*i+t[12]*o,s[1]=t[1]*n+t[5]*r+t[9]*i+t[13]*o,s[2]=t[2]*n+t[6]*r+t[10]*i+t[14]*o,s[3]=t[3]*n+t[7]*r+t[11]*i+t[15]*o,s}function cy(s,e,t){const n=e[0],r=e[1],i=e[2],o=t[0],a=t[1],c=t[2],l=t[3],u=l*n+a*i-c*r,h=l*r+c*n-o*i,f=l*i+o*r-a*n,_=-o*n-a*r-c*i;return s[0]=u*l+_*-o+h*-c-f*-a,s[1]=h*l+_*-a+f*-o-u*-c,s[2]=f*l+_*-c+u*-a-h*-o,s[3]=e[3],s}(function(){const s=ty();return function(e,t,n,r,i,o){let a,c;for(t||(t=4),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,a=n;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],s[3]=e[a+3],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2],e[a+3]=s[3];return e}})();var Xi;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL0ROW3=3]="COL0ROW3",s[s.COL1ROW0=4]="COL1ROW0",s[s.COL1ROW1=5]="COL1ROW1",s[s.COL1ROW2=6]="COL1ROW2",s[s.COL1ROW3=7]="COL1ROW3",s[s.COL2ROW0=8]="COL2ROW0",s[s.COL2ROW1=9]="COL2ROW1",s[s.COL2ROW2=10]="COL2ROW2",s[s.COL2ROW3=11]="COL2ROW3",s[s.COL3ROW0=12]="COL3ROW0",s[s.COL3ROW1=13]="COL3ROW1",s[s.COL3ROW2=14]="COL3ROW2",s[s.COL3ROW3=15]="COL3ROW3"})(Xi||(Xi={}));const ly=45*Math.PI/180,uy=1,ni=.1,ri=500,hy=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Fe extends Iu{static get IDENTITY(){return dy()}static get ZERO(){return fy()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return Xi}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,n,r,i,o,a,c,l,u,h,f,_,T,v,R){return this[0]=e,this[1]=t,this[2]=n,this[3]=r,this[4]=i,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this[9]=u,this[10]=h,this[11]=f,this[12]=_,this[13]=T,this[14]=v,this[15]=R,this.check()}setRowMajor(e,t,n,r,i,o,a,c,l,u,h,f,_,T,v,R){return this[0]=e,this[1]=i,this[2]=l,this[3]=_,this[4]=t,this[5]=o,this[6]=u,this[7]=T,this[8]=n,this[9]=a,this[10]=h,this[11]=v,this[12]=r,this[13]=c,this[14]=f,this[15]=R,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(hy)}fromObject(e){return this.check()}fromQuaternion(e){return qm(this,e),this.check()}frustum(e){const{left:t,right:n,bottom:r,top:i,near:o=ni,far:a=ri}=e;return a===1/0?py(this,t,n,r,i,o):Km(this,t,n,r,i,o,a),this.check()}lookAt(e){const{eye:t,center:n=[0,0,0],up:r=[0,1,0]}=e;return ey(this,t,n,r),this.check()}ortho(e){const{left:t,right:n,bottom:r,top:i,near:o=ni,far:a=ri}=e;return Gm(this,t,n,r,i,o,a),this.check()}orthographic(e){const{fovy:t=ly,aspect:n=uy,focalDistance:r=1,near:i=ni,far:o=ri}=e;rc(t);const a=t/2,c=r*Math.tan(a),l=c*n;return this.ortho({left:-l,right:l,bottom:-c,top:c,near:i,far:o})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:n=1,near:r=.1,far:i=500}=e;return rc(t),Qm(this,t,n,r,i),this.check()}determinant(){return jm(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const n=this.getScale(t),r=1/n[0],i=1/n[1],o=1/n[2];return e[0]=this[0]*r,e[1]=this[1]*i,e[2]=this[2]*o,e[3]=0,e[4]=this[4]*r,e[5]=this[5]*i,e[6]=this[6]*o,e[7]=0,e[8]=this[8]*r,e[9]=this[9]*i,e[10]=this[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const n=this.getScale(t),r=1/n[0],i=1/n[1],o=1/n[2];return e[0]=this[0]*r,e[1]=this[1]*i,e[2]=this[2]*o,e[3]=this[4]*r,e[4]=this[5]*i,e[5]=this[6]*o,e[6]=this[8]*r,e[7]=this[9]*i,e[8]=this[10]*o,e}transpose(){return Hm(this,this),this.check()}invert(){return ji(this,this),this.check()}multiplyLeft(e){return Nt(this,e,this),this.check()}multiplyRight(e){return Nt(this,this,e),this.check()}rotateX(e){return Pu(this,this,e),this.check()}rotateY(e){return Ym(this,this,e),this.check()}rotateZ(e){return Mu(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return Xm(this,this,e,t),this.check()}scale(e){return Oo(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return ir(this,this,e),this.check()}transform(e,t){return e.length===4?(t=ms(t||[-0,-0,-0,-0],e,this),zs(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:n}=e;let r;switch(n){case 2:r=Tm(t||[-0,-0],e,this);break;case 3:r=Po(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return zs(r,e.length),r}transformAsVector(e,t){let n;switch(e.length){case 2:n=bm(t||[-0,-0],e,this);break;case 3:n=bu(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return zs(n,e.length),n}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,n){return this.identity().translate([e,t,n])}}let En,Sn;function fy(){return En||(En=new Fe([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(En)),En}function dy(){return Sn||(Sn=new Fe,Object.freeze(Sn)),Sn}function rc(s){if(s>Math.PI*2)throw Error("expected radians")}function py(s,e,t,n,r,i){const o=2*i/(t-e),a=2*i/(r-n),c=(t+e)/(t-e),l=(r+n)/(r-n),u=-1,h=-1,f=-2*i;return s[0]=o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=a,s[6]=0,s[7]=0,s[8]=c,s[9]=l,s[10]=u,s[11]=h,s[12]=0,s[13]=0,s[14]=f,s[15]=0,s}function ic(){const s=new De(4);return De!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s[3]=1,s}function _y(s){return s[0]=0,s[1]=0,s[2]=0,s[3]=1,s}function Ou(s,e,t){t=t*.5;const n=Math.sin(t);return s[0]=n*e[0],s[1]=n*e[1],s[2]=n*e[2],s[3]=Math.cos(t),s}function oc(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3],a=t[0],c=t[1],l=t[2],u=t[3];return s[0]=n*u+o*a+r*l-i*c,s[1]=r*u+o*c+i*a-n*l,s[2]=i*u+o*l+n*c-r*a,s[3]=o*u-n*a-r*c-i*l,s}function gy(s,e,t){t*=.5;const n=e[0],r=e[1],i=e[2],o=e[3],a=Math.sin(t),c=Math.cos(t);return s[0]=n*c+o*a,s[1]=r*c+i*a,s[2]=i*c-r*a,s[3]=o*c-n*a,s}function my(s,e,t){t*=.5;const n=e[0],r=e[1],i=e[2],o=e[3],a=Math.sin(t),c=Math.cos(t);return s[0]=n*c-i*a,s[1]=r*c+o*a,s[2]=i*c+n*a,s[3]=o*c-r*a,s}function yy(s,e,t){t*=.5;const n=e[0],r=e[1],i=e[2],o=e[3],a=Math.sin(t),c=Math.cos(t);return s[0]=n*c+r*a,s[1]=r*c-n*a,s[2]=i*c+o*a,s[3]=o*c-i*a,s}function Ty(s,e){const t=e[0],n=e[1],r=e[2];return s[0]=t,s[1]=n,s[2]=r,s[3]=Math.sqrt(Math.abs(1-t*t-n*n-r*r)),s}function Fn(s,e,t,n){const r=e[0],i=e[1],o=e[2],a=e[3];let c=t[0],l=t[1],u=t[2],h=t[3],f,_,T,v,R;return f=r*c+i*l+o*u+a*h,f<0&&(f=-f,c=-c,l=-l,u=-u,h=-h),1-f>Ws?(_=Math.acos(f),R=Math.sin(_),T=Math.sin((1-n)*_)/R,v=Math.sin(n*_)/R):(T=1-n,v=n),s[0]=T*r+v*c,s[1]=T*i+v*l,s[2]=T*o+v*u,s[3]=T*a+v*h,s}function by(s,e){const t=e[0],n=e[1],r=e[2],i=e[3],o=t*t+n*n+r*r+i*i,a=o?1/o:0;return s[0]=-t*a,s[1]=-n*a,s[2]=-r*a,s[3]=i*a,s}function vy(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s[3]=e[3],s}function Nu(s,e){const t=e[0]+e[4]+e[8];let n;if(t>0)n=Math.sqrt(t+1),s[3]=.5*n,n=.5/n,s[0]=(e[5]-e[7])*n,s[1]=(e[6]-e[2])*n,s[2]=(e[1]-e[3])*n;else{let r=0;e[4]>e[0]&&(r=1),e[8]>e[r*3+r]&&(r=2);const i=(r+1)%3,o=(r+2)%3;n=Math.sqrt(e[r*3+r]-e[i*3+i]-e[o*3+o]+1),s[r]=.5*n,n=.5/n,s[3]=(e[i*3+o]-e[o*3+i])*n,s[i]=(e[i*3+r]+e[r*3+i])*n,s[o]=(e[o*3+r]+e[r*3+o])*n}return s}const wy=sy,Ay=No,Ey=oy,Sy=ay,xy=ny,Ry=ry,ku=iy,Iy=function(){const s=wu(),e=tc(1,0,0),t=tc(0,1,0);return function(n,r,i){const o=Au(r,i);return o<-.999999?(Dn(s,e,r),Ru(s)<1e-6&&Dn(s,t,r),Rm(s,s),Ou(n,s,Math.PI),n):o>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(Dn(s,r,i),n[0]=s[0],n[1]=s[1],n[2]=s[2],n[3]=1+o,ku(n,n))}}();(function(){const s=ic(),e=ic();return function(t,n,r,i,o,a){return Fn(s,n,o,a),Fn(e,r,i,a),Fn(t,s,e,2*a*(1-a)),t}})();(function(){const s=Nm();return function(e,t,n,r){return s[0]=n[0],s[3]=n[1],s[6]=n[2],s[1]=r[0],s[4]=r[1],s[7]=r[2],s[2]=-t[0],s[5]=-t[1],s[8]=-t[2],ku(e,Nu(e,s))}})();const Cy=[0,0,0,1];class t3 extends Co{constructor(e=0,t=0,n=0,r=1){super(-0,-0,-0,-0),Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,t,n,r)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,n,r){return this[0]=e,this[1]=t,this[2]=n,this[3]=r,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return Nu(this,e),this.check()}fromAxisRotation(e,t){return Ou(this,e,t),this.check()}identity(){return _y(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=J(e)}get y(){return this[1]}set y(e){this[1]=J(e)}get z(){return this[2]}set z(e){this[2]=J(e)}get w(){return this[3]}set w(e){this[3]=J(e)}len(){return xy(this)}lengthSquared(){return Ry(this)}dot(e){return Ey(this,e)}rotationTo(e,t){return Iy(this,e,t),this.check()}add(e){return wy(this,this,e),this.check()}calculateW(){return Ty(this,this),this.check()}conjugate(){return vy(this,this),this.check()}invert(){return by(this,this),this.check()}lerp(e,t,n){return n===void 0?this.lerp(this,e,t):(Sy(this,e,t,n),this.check())}multiplyRight(e){return oc(this,this,e),this.check()}multiplyLeft(e){return oc(this,e,this),this.check()}normalize(){const e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,e===0&&(this[3]=1),this.check()}rotateX(e){return gy(this,this,e),this.check()}rotateY(e){return my(this,this,e),this.check()}rotateZ(e){return yy(this,this,e),this.check()}scale(e){return Ay(this,this,e),this.check()}slerp(e,t,n){let r,i,o;switch(arguments.length){case 1:({start:r=Cy,target:i,ratio:o}=e);break;case 2:r=this,i=e,o=t;break;default:r=e,i=t,o=n}return Fn(this,r,i,o),this.check()}transformVector4(e,t=new Mo){return cy(t,e,this),zs(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}}const s3=1e-15,n3=1e-20,ac=`#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
vec3 color;
};
struct PointLight {
vec3 color;
vec3 position;
vec3 attenuation;
};
struct DirectionalLight {
vec3 color;
vec3 direction;
};
uniform AmbientLight lighting_uAmbientLight;
uniform PointLight lighting_uPointLight[MAX_LIGHTS];
uniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];
uniform int lighting_uPointLightCount;
uniform int lighting_uDirectionalLightCount;
uniform bool lighting_uEnabled;
float getPointLightAttenuation(PointLight pointLight, float distance) {
return pointLight.attenuation.x
+ pointLight.attenuation.y * distance
+ pointLight.attenuation.z * distance * distance;
}
#endif
`,Py={lightSources:{}};function ii(s={}){const{color:e=[0,0,0],intensity:t=1}=s;return e.map(n=>n*t/255)}function My({ambientLight:s,pointLights:e=[],directionalLights:t=[]}){const n={};return s?n["lighting_uAmbientLight.color"]=ii(s):n["lighting_uAmbientLight.color"]=[0,0,0],e.forEach((r,i)=>{n[`lighting_uPointLight[${i}].color`]=ii(r),n[`lighting_uPointLight[${i}].position`]=r.position,n[`lighting_uPointLight[${i}].attenuation`]=r.attenuation||[1,0,0]}),n.lighting_uPointLightCount=e.length,t.forEach((r,i)=>{n[`lighting_uDirectionalLight[${i}].color`]=ii(r),n[`lighting_uDirectionalLight[${i}].direction`]=r.direction}),n.lighting_uDirectionalLightCount=t.length,n}function Du(s=Py){var e,t;if("lightSources"in s){const{ambientLight:n,pointLights:r,directionalLights:i}=s.lightSources||{};return n||r&&r.length>0||i&&i.length>0?Object.assign({},My({ambientLight:n,pointLights:r,directionalLights:i}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in s){const n={pointLights:[],directionalLights:[]};for(const r of s.lights||[])switch(r.type){case"ambient":n.ambientLight=r;break;case"directional":(e=n.directionalLights)==null||e.push(r);break;case"point":(t=n.pointLights)==null||t.push(r);break}return Du({lightSources:n})}return{}}const Oy={name:"lights",vs:ac,fs:ac,getUniforms:Du,defines:{MAX_LIGHTS:3}},Ny=`uniform float lighting_uAmbient;
uniform float lighting_uDiffuse;
uniform float lighting_uShininess;
uniform vec3  lighting_uSpecularColor;
vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
vec3 halfway_direction = normalize(light_direction + view_direction);
float lambertian = dot(light_direction, normal_worldspace);
float specular = 0.0;
if (lambertian > 0.0) {
float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
specular = pow(specular_angle, lighting_uShininess);
}
lambertian = max(lambertian, 0.0);
return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;
}
vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
vec3 lightColor = surfaceColor;
if (lighting_uEnabled) {
vec3 view_direction = normalize(cameraPosition - position_worldspace);
lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uPointLightCount) {
break;
}
PointLight pointLight = lighting_uPointLight[i];
vec3 light_position_worldspace = pointLight.position;
vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
}
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uDirectionalLightCount) {
break;
}
DirectionalLight directionalLight = lighting_uDirectionalLight[i];
lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
}
}
return lightColor;
}
vec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
vec3 lightColor = vec3(0, 0, 0);
vec3 surfaceColor = vec3(0, 0, 0);
if (lighting_uEnabled) {
vec3 view_direction = normalize(cameraPosition - position_worldspace);
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uPointLightCount) {
break;
}
PointLight pointLight = lighting_uPointLight[i];
vec3 light_position_worldspace = pointLight.position;
vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
}
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uDirectionalLightCount) {
break;
}
DirectionalLight directionalLight = lighting_uDirectionalLight[i];
lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
}
}
return lightColor;
}
`,ky={};function Dy(s){const{ambient:e=.35,diffuse:t=.6,shininess:n=32,specularColor:r=[30,30,30]}=s;return{lighting_uAmbient:e,lighting_uDiffuse:t,lighting_uShininess:n,lighting_uSpecularColor:r.map(i=>i/255)}}function Fy(s=ky){if(!("material"in s))return{};const{material:e}=s;return e?Dy(e):{lighting_uEnabled:!1}}const r3={name:"gouraud-lighting",dependencies:[Oy],vs:Ny,defines:{LIGHTING_VERTEX:1},getUniforms:Fy},Fu="#define SMOOTH_EDGE_RADIUS 0.5",Uy=`
${Fu}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,By=`
${Fu}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Ly={name:"geometry",vs:Uy,fs:By},q={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(q,"IDENTITY",{get:()=>(G.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const Me={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},cc={common:0,meters:1,pixels:2},Yi={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},Vy=Object.keys(q).map(s=>`const int COORDINATE_SYSTEM_${s} = ${q[s]};`).join(""),$y=Object.keys(Me).map(s=>`const int PROJECTION_MODE_${s} = ${Me[s]};`).join(""),zy=Object.keys(cc).map(s=>`const int UNIT_${s.toUpperCase()} = ${cc[s]};`).join(""),Wy=`${Vy}
${$y}
${zy}
uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project_uPseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project_uCommonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project_uCommonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project_uCommonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project_uWrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project_uModelMatrix * position;
if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project_uCoordinateOrigin;
}
}
if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
(project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project_uCoordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project_uModelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
return offset * project_uFocalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project_uScale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project_uScale;
}
`;function Hy(s,e){if(s===e)return!0;if(Array.isArray(s)){const t=s.length;if(!e||e.length!==t)return!1;for(let n=0;n<t;n++)if(s[n]!==e[n])return!1;return!0}return!1}function nn(s){let e={},t;return n=>{for(const r in n)if(!Hy(n[r],e[r])){t=s(n),e=n;break}return t}}const lc=[0,0,0,0],jy=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],Uu=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Xy=[0,0,0],Bu=[0,0,0],Yy=nn(Zy);function Lu(s,e,t=Bu){t.length<3&&(t=[t[0],t[1],0]);let n=t,r,i=!0;switch(e===q.LNGLAT_OFFSETS||e===q.METER_OFFSETS?r=t:r=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case Me.WEB_MERCATOR:(e===q.LNGLAT||e===q.CARTESIAN)&&(r=[0,0,0],i=!1);break;case Me.WEB_MERCATOR_AUTO_OFFSET:e===q.LNGLAT?n=r:e===q.CARTESIAN&&(n=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],r=s.unprojectPosition(n),n[0]-=t[0],n[1]-=t[1],n[2]-=t[2]);break;case Me.IDENTITY:n=s.position.map(Math.fround),n[2]=n[2]||0;break;case Me.GLOBE:i=!1,r=null;break;default:i=!1}return{geospatialOrigin:r,shaderCoordinateOrigin:n,offsetMode:i}}function qy(s,e,t){const{viewMatrixUncentered:n,projectionMatrix:r}=s;let{viewMatrix:i,viewProjectionMatrix:o}=s,a=lc,c=lc,l=s.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:f}=Lu(s,e,t);return f&&(c=s.projectPosition(u||h),l=[l[0]-c[0],l[1]-c[1],l[2]-c[2]],c[3]=1,a=ms([],c,o),i=n||i,o=Nt([],r,i),o=Nt([],o,jy)),{viewMatrix:i,viewProjectionMatrix:o,projectionCenter:a,originCommon:c,cameraPosCommon:l,shaderCoordinateOrigin:h,geospatialOrigin:u}}function Ky({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:n=q.DEFAULT,coordinateOrigin:r=Bu,autoWrapLongitude:i=!1}){n===q.DEFAULT&&(n=s.isGeospatial?q.LNGLAT:q.CARTESIAN);const o=Yy({viewport:s,devicePixelRatio:e,coordinateSystem:n,coordinateOrigin:r});return o.project_uWrapLongitude=i,o.project_uModelMatrix=t||Uu,o}function Zy({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:n}){const{projectionCenter:r,viewProjectionMatrix:i,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:c,geospatialOrigin:l}=qy(s,t,n),u=s.getDistanceScales(),h=[s.width*e,s.height*e],f=ms([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,_={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:c,project_uCommonOrigin:o.slice(0,3),project_uCenter:r,project_uPseudoMeters:!!s._pseudoMeters,project_uViewportSize:h,project_uDevicePixelRatio:e,project_uFocalDistance:f,project_uCommonUnitsPerMeter:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:Xy,project_uScale:s.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:i,project_uModelMatrix:Uu,project_uCameraPosition:a};if(l){const T=s.getDistanceScales(l);switch(t){case q.METER_OFFSETS:_.project_uCommonUnitsPerWorldUnit=T.unitsPerMeter,_.project_uCommonUnitsPerWorldUnit2=T.unitsPerMeter2;break;case q.LNGLAT:case q.LNGLAT_OFFSETS:s._pseudoMeters||(_.project_uCommonUnitsPerMeter=T.unitsPerMeter),_.project_uCommonUnitsPerWorldUnit=T.unitsPerDegree,_.project_uCommonUnitsPerWorldUnit2=T.unitsPerDegree2;break;case q.CARTESIAN:_.project_uCommonUnitsPerWorldUnit=[1,1,T.unitsPerMeter[2]],_.project_uCommonUnitsPerWorldUnit2=[0,0,T.unitsPerMeter2[2]];break}}return _}const Qy={};function Jy(s=Qy){return"viewport"in s?Ky(s):{}}const ko={name:"project",dependencies:[Gg,Ly],vs:Wy,getUniforms:Jy},Gy=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,i3={name:"project32",dependencies:[ko],vs:Gy};function eT(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function as(s,e){const t=ms([],e,s);return No(t,t,1/t[3]),t}function uc(s,e){const t=s%e;return t<0?e+t:t}function qi(s,e,t){return s<e?e:s>t?t:s}function tT(s){return Math.log(s)*Math.LOG2E}const Do=Math.log2||tT;function Ge(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const Oe=Math.PI,Vu=Oe/4,Re=Oe/180,Ki=180/Oe,fs=512,or=4003e4,hc=85.051129,sT=1.5;function nT(s){return Do(s)}function ar(s){const[e,t]=s;Ge(Number.isFinite(e)),Ge(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const n=e*Re,r=t*Re,i=fs*(n+Oe)/(2*Oe),o=fs*(Oe+Math.log(Math.tan(Vu+r*.5)))/(2*Oe);return[i,o]}function ds(s){const[e,t]=s,n=e/fs*(2*Oe)-Oe,r=2*(Math.atan(Math.exp(t/fs*(2*Oe)-Oe))-Vu);return[n*Ki,r*Ki]}function rT(s){const{latitude:e}=s;Ge(Number.isFinite(e));const t=Math.cos(e*Re);return nT(or*t)-9}function oi(s){const e=Math.cos(s*Re);return fs/or/e}function Zi(s){const{latitude:e,longitude:t,highPrecision:n=!1}=s;Ge(Number.isFinite(e)&&Number.isFinite(t));const r=fs,i=Math.cos(e*Re),o=r/360,a=o/i,c=r/or/i,l={unitsPerMeter:[c,c,c],metersPerUnit:[1/c,1/c,1/c],unitsPerDegree:[o,a,c],degreesPerUnit:[1/o,1/a,1/c]};if(n){const u=Re*Math.tan(e*Re)/i,h=o*u/2,f=r/or*u,_=f/a*c;l.unitsPerDegree2=[0,h,f],l.unitsPerMeter2=[_,0,_]}return l}function $u(s,e){const[t,n,r]=s,[i,o,a]=e,{unitsPerMeter:c,unitsPerMeter2:l}=Zi({longitude:t,latitude:n,highPrecision:!0}),u=ar(s);u[0]+=i*(c[0]+l[0]*o),u[1]+=o*(c[1]+l[1]*o);const h=ds(u),f=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[h[0],h[1],f]:h}function iT(s){const{height:e,pitch:t,bearing:n,altitude:r,scale:i,center:o}=s,a=eT();ir(a,a,[0,0,-r]),Pu(a,a,-t*Re),Mu(a,a,n*Re);const c=i/e;return Oo(a,a,[c,c,c]),o&&ir(a,a,xm([],o)),a}function oT(s){const{width:e,height:t,altitude:n,pitch:r=0,offset:i,center:o,scale:a,nearZMultiplier:c=1,farZMultiplier:l=1}=s;let{fovy:u=cr(sT)}=s;n!==void 0&&(u=cr(n));const h=u*Re,f=r*Re,_=zu(u);let T=_;o&&(T+=o[2]*a/Math.cos(f)/t);const v=h*(.5+(i?i[1]:0)/t),R=Math.sin(v)*T/Math.sin(qi(Math.PI/2-f-v,.01,Math.PI-.01)),C=Math.sin(f)*R+T,I=T*10,M=Math.min(C*l,I);return{fov:h,aspect:e/t,focalDistance:_,near:c,far:M}}function cr(s){return 2*Math.atan(.5/s)*Ki}function zu(s){return .5/Math.tan(.5*s*Re)}function Wu(s,e){const[t,n,r=0]=s;return Ge(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(r)),as(e,[t,n,r,1])}function Fo(s,e,t=0){const[n,r,i]=s;if(Ge(Number.isFinite(n)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(i))return as(e,[n,r,i,1]);const o=as(e,[n,r,0,1]),a=as(e,[n,r,1,1]),c=o[2],l=a[2],u=c===l?0:((t||0)-c)/(l-c);return Tu([],o,a,u)}function aT(s){const{width:e,height:t,bounds:n,minExtent:r=0,maxZoom:i=24,offset:o=[0,0]}=s,[[a,c],[l,u]]=n,h=cT(s.padding),f=ar([a,qi(u,-85.051129,hc)]),_=ar([l,qi(c,-85.051129,hc)]),T=[Math.max(Math.abs(_[0]-f[0]),r),Math.max(Math.abs(_[1]-f[1]),r)],v=[e-h.left-h.right-Math.abs(o[0])*2,t-h.top-h.bottom-Math.abs(o[1])*2];Ge(v[0]>0&&v[1]>0);const R=v[0]/T[0],C=v[1]/T[1],I=(h.right-h.left)/2/R,M=(h.top-h.bottom)/2/C,N=[(_[0]+f[0])/2+I,(_[1]+f[1])/2+M],U=ds(N),B=Math.min(i,Do(Math.abs(Math.min(R,C))));return Ge(Number.isFinite(B)),{longitude:U[0],latitude:U[1],zoom:B}}function cT(s=0){return typeof s=="number"?{top:s,bottom:s,left:s,right:s}:(Ge(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right)),s)}const fc=Math.PI/180;function lT(s,e=0){const{width:t,height:n,unproject:r}=s,i={targetZ:e},o=r([0,n],i),a=r([t,n],i);let c,l;const u=s.fovy?.5*s.fovy*fc:Math.atan(.5/s.altitude),h=(90-s.pitch)*fc;return u>h-.01?(c=dc(s,0,e),l=dc(s,t,e)):(c=r([0,0],i),l=r([t,0],i)),[o,a,l,c]}function dc(s,e,t){const{pixelUnprojectionMatrix:n}=s,r=as(n,[e,0,1,1]),i=as(n,[e,s.height,1,1]),a=(t*s.distanceScales.unitsPerMeter[2]-r[2])/(i[2]-r[2]),c=Tu([],r,i,a),l=ds(c);return l.push(t),l}const pc=512;function uT(s){const{width:e,height:t,pitch:n=0}=s;let{longitude:r,latitude:i,zoom:o,bearing:a=0}=s;(r<-180||r>180)&&(r=uc(r+180,360)-180),(a<-180||a>180)&&(a=uc(a+180,360)-180);const c=Do(t/pc);if(o<=c)o=c,i=0;else{const l=t/2/Math.pow(2,o),u=ds([0,l])[1];if(i<u)i=u;else{const h=ds([0,pc-l])[1];i>h&&(i=h)}}return{width:e,height:t,longitude:r,latitude:i,zoom:o,pitch:n,bearing:a}}const hT=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,fT=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,dT=nn(yT),pT=nn(TT),_T=[0,0,0,1],gT=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function mT(s,e){const[t,n,r]=s,i=Fo([t,n,r],e);return Number.isFinite(r)?i:[i[0],i[1],0]}function yT({viewport:s,center:e}){return new Fe(s.viewProjectionMatrix).invert().transform(e)}function TT({viewport:s,shadowMatrices:e}){const t=[],n=s.pixelUnprojectionMatrix,r=s.isGeospatial?void 0:1,i=[[0,0,r],[s.width,0,r],[0,s.height,r],[s.width,s.height,r],[0,0,-1],[s.width,0,-1],[0,s.height,-1],[s.width,s.height,-1]].map(o=>mT(o,n));for(const o of e){const a=o.clone().translate(new Ke(s.center).negate()),c=i.map(u=>a.transform(u)),l=new Fe().ortho({left:Math.min(...c.map(u=>u[0])),right:Math.max(...c.map(u=>u[0])),bottom:Math.min(...c.map(u=>u[1])),top:Math.max(...c.map(u=>u[1])),near:Math.min(...c.map(u=>-u[2])),far:Math.max(...c.map(u=>-u[2]))});t.push(l.multiplyRight(o))}return t}function bT(s,e){const{shadowEnabled:t=!0}=s;if(!t||!s.shadowMatrices||!s.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1,shadow_uShadowMap0:s.dummyShadowMap,shadow_uShadowMap1:s.dummyShadowMap};const n={shadow_uDrawShadowMap:!!s.drawToShadowMap,shadow_uUseShadowMap:s.shadowMaps?s.shadowMaps.length>0:!1,shadow_uColor:s.shadowColor||_T,shadow_uLightId:s.shadowLightId||0,shadow_uLightCount:s.shadowMatrices.length},r=dT({viewport:s.viewport,center:e.project_uCenter}),i=[],o=pT({shadowMatrices:s.shadowMatrices,viewport:s.viewport}).slice();for(let a=0;a<s.shadowMatrices.length;a++){const c=o[a],l=c.clone().translate(new Ke(s.viewport.center).negate());e.project_uCoordinateSystem===q.LNGLAT&&e.project_uProjectionMode===Me.WEB_MERCATOR?(o[a]=l,i[a]=r):(o[a]=c.clone().multiplyRight(gT),i[a]=l.transform(r))}for(let a=0;a<o.length;a++)n[`shadow_uViewProjectionMatrices[${a}]`]=o[a],n[`shadow_uProjectCenters[${a}]`]=i[a];for(let a=0;a<2;a++)n[`shadow_uShadowMap${a}`]=s.shadowMaps&&s.shadowMaps[a]||s.dummyShadowMap;return n}const _c={name:"shadow",dependencies:[ko],vs:hT,fs:fT,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(s={},e={})=>"viewport"in s&&(s.drawToShadowMap||s.shadowMaps&&s.shadowMaps.length>0)?bT(s,e):{}},o3={...Ja,defaultUniforms:{...Ja.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},vT=[ko],wT=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function AT(){const s=Hn.getDefaultShaderAssembler();for(const e of vT)s.addDefaultModule(e);for(const e of wT)s.addShaderHook(e);return s}const ET=[255,255,255],ST=1;let xT=0;class RT{constructor(e={}){this.type="ambient";const{color:t=ET}=e,{intensity:n=ST}=e;this.id=e.id||`ambient-${xT++}`,this.color=t,this.intensity=n}}const IT=[255,255,255],CT=1,PT=[0,0,-1];let MT=0;class gc{constructor(e={}){this.type="directional";const{color:t=IT}=e,{intensity:n=CT}=e,{direction:r=PT}=e,{_shadow:i=!1}=e;this.id=e.id||`directional-${MT++}`,this.color=t,this.intensity=n,this.type="directional",this.direction=new Ke(r).normalize().toArray(),this.shadow=i}getProjectedLight(e){return this}}class OT{constructor(e,t={id:"pass"}){const{id:n}=t;this.id=n,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Uo extends OT{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,n]=this.device.canvasContext.getDrawingBufferSize(),r=e.clearCanvas??!0,i=e.clearColor??(r?[0,0,0,0]:!1),o=r?1:!1,a=r?0:!1,c=e.colorMask??15,l={viewport:[0,0,t,n]};e.colorMask&&(l.colorMask=c),e.scissorRect&&(l.scissorRect=e.scissorRect);const u=this.device.beginRenderPass({framebuffer:e.target,parameters:l,clearColor:i,clearDepth:o,clearStencil:a});try{return this._drawLayers(u,e)}finally{u.end()}}_drawLayers(e,t){const{target:n,moduleParameters:r,viewports:i,views:o,onViewportActive:a,clearStack:c=!0}=t;t.pass=t.pass||"unknown",c&&(this._lastRenderIndex=-1);const l=[];for(const u of i){const h=o&&o[u.id];a==null||a(u);const f=this._getDrawLayerParams(u,t),_=u.subViewports||[u];for(const T of _){const v=this._drawLayersInViewport(e,{target:n,moduleParameters:r,viewport:T,view:h,pass:t.pass,layers:t.layers},f);l.push(v)}}return l}_getDrawLayerParams(e,{layers:t,pass:n,isPicking:r=!1,layerFilter:i,cullRect:o,effects:a,moduleParameters:c},l=!1){var T;const u=[],h=Hu(this._lastRenderIndex+1),f={layer:t[0],viewport:e,isPicking:r,renderPass:n,cullRect:o},_={};for(let v=0;v<t.length;v++){const R=t[v],C=this._shouldDrawLayer(R,f,i,_),I={shouldDrawLayer:C};C&&!l&&(I.layerRenderIndex=h(R,C),I.moduleParameters=this._getModuleParameters(R,a,n,c),I.layerParameters={...(T=R.context.deck)==null?void 0:T.props.parameters,...this.getLayerParameters(R,v,e)}),u[v]=I}return u}_drawLayersInViewport(e,{layers:t,moduleParameters:n,pass:r,target:i,viewport:o,view:a},c){const l=NT(this.device,{moduleParameters:n,target:i,viewport:o});if(a&&a.props.clear){const h=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;this.device.withParametersWebGL({scissorTest:!0,scissor:l},()=>this.device.clearWebGL(h))}const u={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:l});for(let h=0;h<t.length;h++){const f=t[h],{shouldDrawLayer:_,layerRenderIndex:T,moduleParameters:v,layerParameters:R}=c[h];if(_&&f.props.pickable&&u.pickableCount++,f.isComposite)u.compositeCount++;else if(_){u.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,T),v.viewport=o,f.context.renderPass=e;try{f._drawLayer({renderPass:e,moduleParameters:v,uniforms:{layerIndex:T},parameters:R})}catch(C){f.raiseError(C,`drawing ${f} to ${r}`)}}}return u}shouldDrawLayer(e){return!0}getModuleParameters(e,t){return null}getLayerParameters(e,t,n){return e.props.parameters}_shouldDrawLayer(e,t,n,r){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let o=e.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(t))return!1;t.layer=o,o=o.parent}if(n){const a=t.layer.id;if(a in r||(r[a]=n(t)),!r[a])return!1}return e.activateViewport(t.viewport),!0}_getModuleParameters(e,t,n,r){var a,c;const i=this.device.canvasContext.cssToDeviceRatio(),o=Object.assign(Object.create(((a=e.internalState)==null?void 0:a.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,picking:{isActive:0},devicePixelRatio:i});if(t)for(const l of t)Object.assign(o,(c=l.getModuleParameters)==null?void 0:c.call(l,e));return Object.assign(o,this.getModuleParameters(e,t),r)}}function Hu(s=0,e={}){const t={},n=(r,i)=>{const o=r.props._offset,a=r.id,c=r.parent&&r.parent.id;let l;if(c&&!(c in e)&&n(r.parent,!1),c in t){const u=t[c]=t[c]||Hu(e[c],e);l=u(r,i),t[a]=u}else Number.isFinite(o)?(l=o+(e[c]||0),t[a]=null):l=s;return i&&l>=s&&(s=l+1),e[a]=l,l};return n}function NT(s,{moduleParameters:e,target:t,viewport:n}){const r=e&&e.devicePixelRatio||s.canvasContext.cssToDeviceRatio(),[,i]=s.canvasContext.getDrawingBufferSize(),o=t?t.height:i,a=n;return[a.x*r,o-(a.y+a.height)*r,a.width*r,a.height*r]}class kT extends Uo{constructor(e,t){super(e,t),this.shadowMap=e.createTexture({width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}}),this.depthBuffer=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1,dataFormat:6402,type:5125}),this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[this.shadowMap],depthStencilAttachment:this.depthBuffer})}render(e){const t=this.fbo,n=this.device.canvasContext.cssToDeviceRatio(),r=e.viewports[0],i=r.width*n,o=r.height*n,a=[1,1,1,1];(i!==t.width||o!==t.height)&&t.resize({width:i,height:o}),super.render({...e,clearColor:a,target:t,pass:"shadow"})}getLayerParameters(e,t,n){return{...e.props.parameters,blend:!1,depthRange:[0,1],depthTest:!0}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null),this.shadowMap&&(this.shadowMap.destroy(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.destroy(),this.depthBuffer=null)}}const DT={color:[255,255,255],intensity:1},mc=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],FT=[0,0,0,200/255];class ju{constructor(e={}){this.id="lighting-effect",this.shadowColor=FT,this.shadow=!1,this.ambientLight=null,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.shadowMaps=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:n}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),n._addDefaultShaderModule(_c),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=null,this.directionalLights=[],this.pointLights=[];for(const t in e){const n=e[t];switch(n.type){case"ambient":this.ambientLight=n;break;case"directional":this.directionalLights.push(n);break;case"point":this.pointLights.push(n);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:n,onViewportActive:r,views:i}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:e,layerFilter:t,viewports:n,onViewportActive:r,views:i,moduleParameters:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){const t=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return t.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(n=>n.getProjectedLight({layer:e})),pointLights:this.pointLights.map(n=>n.getProjectedLight({layer:e}))},t}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(_c))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const n=new Fe().lookAt({eye:new Ke(t.direction).negate()});e.push(n)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const n=new kT(e);this.shadowPasses[t]=n,this.shadowMaps[t]=n.shadowMap}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:n}=this;!e&&t.length===0&&n.length===0&&(this.ambientLight=new RT(DT),this.directionalLights.push(new gc(mc[0]),new gc(mc[1])))}}class UT{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:n=1,type:r,padding:i=0,copy:o=!1,initialize:a=!1,maxCount:c}){const l=r||e&&e.constructor||Float32Array,u=t*n+i;if(ArrayBuffer.isView(e)){if(u<=e.length)return e;if(u*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new l(e.buffer,0,u)}let h=1/0;c&&(h=c*n+i);const f=this._allocate(l,u,a,h);return e&&o?f.set(e):a||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,t,n,r){let i=Math.max(Math.ceil(t*this.opts.overAlloc),1);i>r&&(i=r);const o=this._pool,a=e.BYTES_PER_ELEMENT*i,c=o.findIndex(l=>l.byteLength>=a);if(c>=0){const l=new e(o.splice(c,1)[0],0,i);return n&&l.fill(0),l}return new e(i)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:n}=e,{byteLength:r}=n,i=t.findIndex(o=>o.byteLength>=r);i<0?t.push(n):(i>0||t.length<this.opts.poolSize)&&t.splice(i,0,n),t.length>this.opts.poolSize&&t.shift()}}const ps=new UT;function Us(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function BT(s){return[s[12],s[13],s[14]]}function LT(s){return{left:qt(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:qt(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:qt(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:qt(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:qt(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:qt(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}const yc=new Ke;function qt(s,e,t,n){yc.set(s,e,t);const r=yc.len();return{distance:n/r,normal:new Ke(-s/r,-e/r,-t/r)}}function VT(s){return s-Math.fround(s)}let Cs;function ai(s,e){const{size:t=1,startIndex:n=0}=e,r=e.endIndex!==void 0?e.endIndex:s.length,i=(r-n)/t;Cs=ps.allocate(Cs,i,{type:Float32Array,size:t*2});let o=n,a=0;for(;o<r;){for(let c=0;c<t;c++){const l=s[o++];Cs[a+c]=l,Cs[a+c+t]=VT(l)}a+=t*2}return Cs.subarray(0,i*t*2)}function $T(s){let e=null,t=!1;for(const n of s)n&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],n[0][0]),e[0][1]=Math.min(e[0][1],n[0][1]),e[1][0]=Math.max(e[1][0],n[1][0]),e[1][1]=Math.max(e[1][1],n[1][1])):e=n);return e}const zT=Math.PI/180,WT=Us(),Tc=[0,0,0],HT={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function jT({width:s,height:e,orthographic:t,fovyRadians:n,focalDistance:r,padding:i,near:o,far:a}){const c=s/e,l=t?new Fe().orthographic({fovy:n,aspect:c,focalDistance:r,near:o,far:a}):new Fe().perspective({fovy:n,aspect:c,near:o,far:a});if(i){const{left:u=0,right:h=0,top:f=0,bottom:_=0}=i,T=ht((u+s-h)/2,0,s)-s/2,v=ht((f+e-_)/2,0,e)-e/2;l[8]-=T*2/s,l[9]+=v*2/e}return l}class ys{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||HT,this.focalDistance=e.focalDistance||1,this.position=e.position||Tc,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:n}=e;this.isGeospatial=Number.isFinite(n)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Me.WEB_MERCATOR:Me.WEB_MERCATOR_AUTO_OFFSET:Me.IDENTITY}equals(e){return e instanceof ys?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&Zs(e.projectionMatrix,this.projectionMatrix)&&Zs(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const n=this.projectPosition(e),r=Wu(n,this.pixelProjectionMatrix),[i,o]=r,a=t?o:this.height-o;return e.length===2?[i,a]:[i,a,r[2]]}unproject(e,{topLeft:t=!0,targetZ:n}={}){const[r,i,o]=e,a=t?i:this.height-i,c=n&&n*this.distanceScales.unitsPerMeter[2],l=Fo([r,a,o],this.pixelUnprojectionMatrix,c),[u,h,f]=this.unprojectPosition(l);return Number.isFinite(o)?[u,h,f]:Number.isFinite(n)?[u,h,n]:[u,h]}projectPosition(e){const[t,n]=this.projectFlat(e),r=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,n,r]}unprojectPosition(e){const[t,n]=this.unprojectFlat(e),r=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,n,r]}projectFlat(e){if(this.isGeospatial){const t=ar(e);return t[1]=ht(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?ds(e):e}getBounds(e={}){const t={targetZ:e.z||0},n=this.unproject([0,0],t),r=this.unproject([this.width,0],t),i=this.unproject([0,this.height],t),o=this.unproject([this.width,this.height],t);return[Math.min(n[0],r[0],i[0],o[0]),Math.min(n[1],r[1],i[1],o[1]),Math.max(n[0],r[0],i[0],o[0]),Math.max(n[1],r[1],i[1],o[1])]}getDistanceScales(e){return e?Zi({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:n=1,height:r=1}){return e<this.x+this.width&&this.x<e+n&&t<this.y+this.height&&this.y<t+r}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,LT(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,n=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=rT({latitude:n})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Zi({latitude:n,longitude:t}));const r=Math.pow(2,this.zoom);this.scale=r;const{position:i,modelMatrix:o}=e;let a=Tc;if(i&&(a=o?new Fe(o).transformAsVector(i,[]):i),this.isGeospatial){const c=this.projectPosition([t,n,0]);this.center=new Ke(a).scale(this.distanceScales.unitsPerMeter).add(c)}else this.center=this.projectPosition(a)}_initMatrices(e){const{viewMatrix:t=WT,projectionMatrix:n=null,orthographic:r=!1,fovyRadians:i,fovy:o=75,near:a=.1,far:c=1e3,padding:l=null,focalDistance:u=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new Fe().multiplyRight(t).translate(new Ke(this.center).negate()),this.projectionMatrix=n||jT({width:this.width,height:this.height,orthographic:r,fovyRadians:i||o*zT,focalDistance:u,padding:l,near:a,far:c});const h=Us();Nt(h,h,this.projectionMatrix),Nt(h,h,this.viewMatrix),this.viewProjectionMatrix=h,this.viewMatrixInverse=ji([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=BT(this.viewMatrixInverse);const f=Us(),_=Us();Oo(f,f,[this.width/2,-this.height/2,1]),ir(f,f,[1,-1,0]),Nt(_,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=_,this.pixelUnprojectionMatrix=ji(Us(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||G.warn("Pixel project matrix not invertible")()}}ys.displayName="Viewport";class _s extends ys{constructor(e={}){const{latitude:t=0,longitude:n=0,zoom:r=0,pitch:i=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:c=1.01,nearZ:l,farZ:u,orthographic:h=!1,projectionMatrix:f,repeat:_=!1,worldOffset:T=0,position:v,padding:R,legacyMeterSizes:C=!1}=e;let{width:I,height:M,altitude:N=1.5}=e;const U=Math.pow(2,r);I=I||1,M=M||1;let B,$=null;if(f)N=f[5]/2,B=cr(N);else{e.fovy?(B=e.fovy,N=zu(B)):B=cr(N);let V;if(R){const{top:z=0,bottom:H=0}=R;V=[0,ht((z+M-H)/2,0,M)-M/2]}$=oT({width:I,height:M,scale:U,center:v&&[0,0,v[2]*oi(t)],offset:V,pitch:i,fovy:B,nearZMultiplier:a,farZMultiplier:c}),Number.isFinite(l)&&($.near=l),Number.isFinite(u)&&($.far=u)}let W=iT({height:M,pitch:i,bearing:o,scale:U,altitude:N});T&&(W=new Fe().translate([512*T,0,0]).multiplyLeft(W)),super({...e,width:I,height:M,viewMatrix:W,longitude:n,latitude:t,zoom:r,...$,fovy:B,focalDistance:N}),this.latitude=t,this.longitude=n,this.zoom=r,this.pitch=i,this.bearing=o,this.altitude=N,this.fovy=B,this.orthographic=h,this._subViewports=_?[]:null,this._pseudoMeters=C,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),n=Math.ceil((e[2]-180)/360);for(let r=t;r<=n;r++){const i=r?new _s({...this,worldOffset:r}):this;this._subViewports.push(i)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,n]=this.projectFlat(e),r=(e[2]||0)*oi(e[1]);return[t,n,r]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,n]=this.unprojectFlat(e),r=(e[2]||0)/oi(n);return[t,n,r]}addMetersToLngLat(e,t){return $u(e,t)}panByPosition(e,t){const n=Fo(t,this.pixelUnprojectionMatrix),r=this.projectFlat(e),i=ec([],r,mm([],n)),o=ec([],this.center,i),[a,c]=this.unprojectFlat(o);return{longitude:a,latitude:c}}getBounds(e={}){const t=lT(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:n,height:r}=this,{longitude:i,latitude:o,zoom:a}=aT({width:n,height:r,bounds:e,...t});return new _s({width:n,height:r,longitude:i,latitude:o,zoom:a})}}_s.displayName="WebMercatorViewport";const bc=[0,0,0];function ci(s,e,t=!1){const n=e.projectPosition(s);if(t&&e instanceof _s){const[r,i,o=0]=s,a=e.getDistanceScales([r,i]);n[2]=o*a.unitsPerMeter[2]}return n}function XT(s){const{viewport:e,modelMatrix:t,coordinateOrigin:n}=s;let{coordinateSystem:r,fromCoordinateSystem:i,fromCoordinateOrigin:o}=s;return r===q.DEFAULT&&(r=e.isGeospatial?q.LNGLAT:q.CARTESIAN),i===void 0&&(i=r),o===void 0&&(o=n),{viewport:e,coordinateSystem:r,coordinateOrigin:n,modelMatrix:t,fromCoordinateSystem:i,fromCoordinateOrigin:o}}function Xu(s,{viewport:e,modelMatrix:t,coordinateSystem:n,coordinateOrigin:r,offsetMode:i}){let[o,a,c=0]=s;switch(t&&([o,a,c]=ms([],[o,a,c,1],t)),n){case q.LNGLAT:return ci([o,a,c],e,i);case q.LNGLAT_OFFSETS:return ci([o+r[0],a+r[1],c+(r[2]||0)],e,i);case q.METER_OFFSETS:return ci($u(r,[o,a,c]),e,i);case q.CARTESIAN:default:return e.isGeospatial?[o+r[0],a+r[1],c+r[2]]:e.projectPosition([o,a,c])}}function YT(s,e){const{viewport:t,coordinateSystem:n,coordinateOrigin:r,modelMatrix:i,fromCoordinateSystem:o,fromCoordinateOrigin:a}=XT(e),{autoOffset:c=!0}=e,{geospatialOrigin:l=bc,shaderCoordinateOrigin:u=bc,offsetMode:h=!1}=c?Lu(t,n,r):{},f=Xu(s,{viewport:t,modelMatrix:i,coordinateSystem:o,coordinateOrigin:a,offsetMode:h});if(h){const _=t.projectPosition(l||u);xu(f,f,_)}return f}let qT=1,KT=1;class Yu{constructor(){p(this,"time",0);p(this,"channels",new Map);p(this,"animations",new Map);p(this,"playing",!1);p(this,"lastEngineTime",-1)}addChannel(e){const{delay:t=0,duration:n=Number.POSITIVE_INFINITY,rate:r=1,repeat:i=1}=e,o=qT++,a={time:0,delay:t,duration:n,rate:r,repeat:i};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(e){this.channels.delete(e);for(const[t,n]of this.animations)n.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const r of t)this._setChannelTime(r,this.time);const n=this.animations.values();for(const r of n){const{animation:i,channel:o}=r;i.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const n=KT++;return this.animations.set(n,{animation:e,channel:t}),e.setTime(this.getTime(t)),n}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const n=t-e.delay,r=e.duration*e.repeat;n>=r?e.time=e.duration*e.rate:(e.time=Math.max(0,n)%e.duration,e.time*=e.rate)}}let ZT=0;const QT={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:s=>console.error(s),stats:os.stats.get(`animation-loop-${ZT++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class JT{constructor(e){p(this,"device",null);p(this,"canvas",null);p(this,"props");p(this,"animationProps",null);p(this,"timeline",null);p(this,"stats");p(this,"cpuTime");p(this,"gpuTime");p(this,"frameRate");p(this,"display");p(this,"needsRedraw","initialized");p(this,"_initialized",!1);p(this,"_running",!1);p(this,"_animationFrameId",null);p(this,"_nextFramePromise",null);p(this,"_resolveNextFrame",null);p(this,"_cpuStartTime",0);if(this.props={...QT,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new en({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(e=this.device)!=null&&e.isLost?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=bg(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(vg(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),this.device.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var e,t;if(!this.device)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:(t=(e=this.device)==null?void 0:e.canvasContext)==null?void 0:t.canvas,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:n}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),n!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=n,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=((e=this.device.canvasContext)==null?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const n=this.props.onAddHTML(t);n&&(t.innerHTML=n)}}_getSizeAndAspect(){var i,o,a,c;if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=((o=(i=this.device)==null?void 0:i.canvasContext)==null?void 0:o.getPixelSize())||[1,1];let n=1;const r=(c=(a=this.device)==null?void 0:a.canvasContext)==null?void 0:c.canvas;return r&&r.clientHeight?n=r.clientWidth/r.clientHeight:e>0&&t>0&&(n=e/t),{width:e,height:t,aspect:n}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,t;this.props.autoResizeDrawingBuffer&&((t=(e=this.device)==null?void 0:e.canvasContext)==null||t.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}class vc{constructor(e){p(this,"id");p(this,"userData",{});p(this,"topology");p(this,"bufferLayout",[]);p(this,"vertexCount");p(this,"indices");p(this,"attributes");this.id=e.id||zt("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&ee(this.indices.usage===se.INDEX)}destroy(){var e;(e=this.indices)==null||e.destroy();for(const t of Object.values(this.attributes))t.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices}_calculateVertexCount(e){return e.byteLength/12}}function GT(s,e){if(e instanceof vc)return e;const t=eb(s,e),{attributes:n,bufferLayout:r}=tb(s,e);return new vc({topology:e.topology||"triangle-list",bufferLayout:r,vertexCount:e.vertexCount,indices:t,attributes:n})}function eb(s,e){if(!e.indices)return;const t=e.indices.value;return s.createBuffer({usage:se.INDEX,data:t})}function tb(s,e){const t=[],n={};for(const[i,o]of Object.entries(e.attributes)){let a=i;switch(i){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}n[a]=s.createBuffer({data:o.value,id:`${i}-buffer`});const{value:c,size:l,normalized:u}=o;t.push({name:a,format:_g(c,l,u)})}const r=e._calculateVertexCount(e.attributes,e.indices);return{attributes:n,bufferLayout:t,vertexCount:r}}class sb{constructor(e){p(this,"modules");p(this,"moduleUniforms");p(this,"moduleBindings");p(this,"moduleUniformsChanged");const t=Cr(Object.values(e).filter(n=>n.dependencies));for(const n of t)e[n.name]=n;D.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[n,r]of Object.entries(e)){const i=n;this.moduleUniforms[i]=r.defaultUniforms||{},this.moduleBindings[i]={}}}destroy(){}setProps(e){var t;for(const n of Object.keys(e)){const r=n,i=e[r],o=this.modules[r];if(!o){D.warn(`Module ${n} not found`)();continue}const a=this.moduleUniforms[r],c=this.moduleBindings[r],l=((t=o.getUniforms)==null?void 0:t.call(o,i,a))||i,{uniforms:u,bindings:h}=wo(l);this.moduleUniforms[r]={...a,...u},this.moduleBindings[r]={...c,...h}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindings(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){var t;const e={};for(const[n,r]of Object.entries(this.moduleUniforms))for(const[i,o]of Object.entries(r))e[`${n}.${i}`]={type:(t=this.modules[n].uniformTypes)==null?void 0:t[i],value:String(o)};return e}}const Sr=class Sr{constructor(e){p(this,"device");p(this,"_hashCounter",0);p(this,"_hashes",{});p(this,"_renderPipelineCache",{});p(this,"_computePipelineCache",{});this.device=e}static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new Sr(e),e._lumaData.defaultPipelineFactory}createRenderPipeline(e){const t={...us.defaultProps,...e},n=this._hashRenderPipeline(t);if(!this._renderPipelineCache[n]){const r=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});r.hash=n,this._renderPipelineCache[n]={pipeline:r,useCount:0}}return this._renderPipelineCache[n].useCount++,this._renderPipelineCache[n].pipeline}createComputePipeline(e){const t={...Zn.defaultProps,...e},n=this._hashComputePipeline(t);if(!this._computePipelineCache[n]){const r=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});r.hash=n,this._computePipelineCache[n]={pipeline:r,useCount:0}}return this._computePipelineCache[n].useCount++,this._computePipelineCache[n].pipeline}release(e){const t=e.hash,n=e instanceof Zn?this._computePipelineCache:this._renderPipelineCache;n[t].useCount--,n[t].useCount===0&&(n[t].pipeline.destroy(),delete n[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=this._getHash(e.vs.source),n=e.fs?this._getHash(e.fs.source):0,r="-",i=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${t}/${n}V${r}BL${i}`;default:const o=this._getHash(JSON.stringify(e.parameters));return`${t}/${n}V${r}T${e.topology}P${o}BL${i}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}};p(Sr,"defaultProps",{...us.defaultProps});let Qi=Sr;const xr=class xr{constructor(e){p(this,"device");p(this,"_cache",{});this.device=e}static getDefaultShaderFactory(e){var t;return(t=e._lumaData).defaultShaderFactory||(t.defaultShaderFactory=new xr(e)),e._lumaData.defaultShaderFactory}createShader(e){const t=this._hashShader(e);let n=this._cache[t];if(!n){const r=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=n={shader:r,useCount:0}}return n.useCount++,n.shader}release(e){const t=this._hashShader(e),n=this._cache[t];n&&(n.useCount--,n.useCount===0&&(delete this._cache[t],n.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}};p(xr,"defaultProps",{...Yn.defaultProps});let Ji=xr;function nb(s,e){var r;const t={},n="Values";if(s.attributes.length===0&&!((r=s.varyings)!=null&&r.length))return{"No attributes or varyings":{[n]:"N/A"}};for(const i of s.attributes)if(i){const o=`${i.location} ${i.name}: ${i.type}`;t[`in ${o}`]={[n]:i.stepMode||"vertex"}}for(const i of s.varyings||[]){const o=`${i.location} ${i.name}`;t[`out ${o}`]={[n]:JSON.stringify(i.accessor)}}return t}let he=null,li=null;function rb(s,{id:e,minimap:t,opaque:n,top:r="0",left:i="0",rgbaScale:o=1}){he||(he=document.createElement("canvas"),he.id=e,he.title=e,he.style.zIndex="100",he.style.position="absolute",he.style.top=r,he.style.left=i,he.style.border="blue 1px solid",he.style.transform="scaleY(-1)",document.body.appendChild(he),li=he.getContext("2d")),(he.width!==s.width||he.height!==s.height)&&(he.width=s.width/2,he.height=s.height/2,he.style.width="400px",he.style.height="400px");const a=s.device.readPixelsToArrayWebGL(s),c=li.createImageData(s.width,s.height),l=0;for(let u=0;u<a.length;u+=4)c.data[l+u+0]=a[u+0]*o,c.data[l+u+1]=a[u+1]*o,c.data[l+u+2]=a[u+2]*o,c.data[l+u+3]=n?255:a[u+3]*o;li.putImageData(c,0,0)}const Kt=2,ib=1e4,Rr=class Rr{constructor(e,t){p(this,"device");p(this,"id");p(this,"source");p(this,"vs");p(this,"fs");p(this,"pipelineFactory");p(this,"shaderFactory");p(this,"userData",{});p(this,"parameters");p(this,"topology");p(this,"bufferLayout");p(this,"isInstanced");p(this,"instanceCount",0);p(this,"vertexCount");p(this,"indexBuffer",null);p(this,"bufferAttributes",{});p(this,"constantAttributes",{});p(this,"bindings",{});p(this,"uniforms",{});p(this,"vertexArray");p(this,"transformFeedback",null);p(this,"pipeline");p(this,"shaderInputs");p(this,"_uniformStore");p(this,"_attributeInfos",{});p(this,"_gpuGeometry",null);p(this,"_getModuleUniforms");p(this,"props");p(this,"_pipelineNeedsUpdate","newly created");p(this,"_needsRedraw","initializing");p(this,"_destroyed",!1);p(this,"_lastDrawTimestamp",-1);p(this,"_lastLogTime",0);p(this,"_logOpen",!1);p(this,"_drawCount",0);var a,c,l,u;this.props={...Rr.defaultProps,...t},t=this.props,this.id=t.id||zt("model"),this.device=e,Object.assign(this.userData,t.userData);const n=Object.fromEntries(((a=this.props.modules)==null?void 0:a.map(h=>[h.name,h]))||[]);this.setShaderInputs(t.shaderInputs||new sb(n));const r=ob(e),i=(((c=this.props.modules)==null?void 0:c.length)>0?this.props.modules:(l=this.shaderInputs)==null?void 0:l.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){(u=this.props).shaderLayout||(u.shaderLayout=Zg(this.props.source));const{source:h,getUniforms:f}=this.props.shaderAssembler.assembleShader({platformInfo:r,...this.props,modules:i});this.source=h,this._getModuleUniforms=f}else{const{vs:h,fs:f,getUniforms:_}=this.props.shaderAssembler.assembleShaderPair({platformInfo:r,...this.props,modules:i});this.vs=h,this.fs=f,this._getModuleUniforms=_}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||Qi.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||Ji.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniforms(t.uniforms),t.moduleSettings&&this.updateModuleSettings(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),(e=this._gpuGeometry)==null||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||(this._needsRedraw=e)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){this.predraw();let t;try{this._logDrawCallStart(),this.pipeline=this._updatePipeline(),this.pipeline.setBindings(this.bindings,{disableWarnings:this.props.disableWarnings}),jn(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:n}=this.vertexArray,r=n?n.byteLength/(n.indexType==="uint32"?4:2):void 0;t=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:r,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{this._logDrawCallEnd()}return this._logFramebuffer(e),t?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",t}setGeometry(e){var n;(n=this._gpuGeometry)==null||n.destroy();const t=e&&GT(this.device,e);t&&(this.setTopology(t.topology||"triangle-list"),this.bufferLayout=wc(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)),this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){this.bufferLayout=this._gpuGeometry?wc(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){Vi(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new pg(this.shaderInputs.modules);for(const t of Object.keys(this.shaderInputs.modules)){const n=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=n}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindings()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){e.indices&&D.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)();for(const[n,r]of Object.entries(e)){const i=this.bufferLayout.find(c=>Ac(c).includes(n));if(!i){D.warn(`Model(${this.id}): Missing layout for buffer "${n}".`)();continue}const o=Ac(i);let a=!1;for(const c of o){const l=this._attributeInfos[c];l&&(this.vertexArray.setBuffer(l.location,r),a=!0)}!a&&!((t==null?void 0:t.disableWarnings)??this.props.disableWarnings)&&D.warn(`Model(${this.id}): Ignoring buffer "${r.id}" for unknown attribute "${n}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[n,r]of Object.entries(e)){const i=this._attributeInfos[n];i?this.vertexArray.setConstantWebGL(i.location,r):((t==null?void 0:t.disableWarnings)??this.props.disableWarnings)||D.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${n}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){jn(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettings(e){const{bindings:t,uniforms:n}=wo(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,n),this.setNeedsRedraw("moduleSettings")}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof Xn?e=Math.max(e,t.texture.updateTimestamp):t instanceof se||t instanceof xe?e=Math.max(e,t.updateTimestamp):t instanceof qn||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[n]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(r=>r.name===n)&&n!=="positions"&&delete t[n];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=e),this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(D.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const n=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debug:this.props.debugShaders});let r=null;this.source?r=n:this.fs&&(r=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debug:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,vs:n,fs:r}),this._attributeInfos=Yl(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_logDrawCallStart(){const e=D.level>3?0:ib;D.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,D.group(Kt,`>>> DRAWING MODEL ${this.id}`,{collapsed:D.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=nb(this.pipeline.shaderLayout,this.id);D.table(Kt,e)();const t=this.shaderInputs.getDebugTable();for(const[r,i]of Object.entries(this.uniforms))t[r]={value:i};D.table(Kt,t)();const n=this._getAttributeDebugTable();D.table(Kt,this._attributeInfos)(),D.table(Kt,n)(),D.groupEnd(Kt)(),this._logOpen=!1}}_logFramebuffer(e){const t=D.get("framebuffer");if(this._drawCount++,!t||this._drawCount++>3&&this._drawCount%60)return;const n=e.props.framebuffer;n&&rb(n,{id:n.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,n]of Object.entries(this._attributeInfos))e[n.location]={name:t,type:n.shaderType,values:this._getBufferOrConstantValues(this.vertexArray.attributes[n.location],n.bufferDataType)};if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,n=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:n.toString()}}return e}_getBufferOrConstantValues(e,t){const n=Zl(t);return(e instanceof se?new n(e.debugData):e).toString()}};p(Rr,"defaultProps",{...us.defaultProps,source:null,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Hn.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});let lr=Rr;function wc(s,e){const t=[...s];for(const n of e){const r=t.findIndex(i=>i.name===n.name);r<0?t.push(n):t[r]=n}return t}function ob(s){return{type:s.type,shaderLanguage:s.info.shadingLanguage,shaderLanguageVersion:s.info.shadingLanguageVersion,gpu:s.info.gpu,features:s.features}}function Ac(s){var e;return s.attributes?(e=s.attributes)==null?void 0:e.map(t=>t.attribute):[s.name]}class Qs{constructor(e,t=lr.defaultProps){p(this,"device");p(this,"model");p(this,"transformFeedback");ee(Qs.isSupported(e),"BufferTransform not yet implemented on WebGPU"),this.device=e,this.model=new lr(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||g_(),topology:t.topology||"point-list",...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}static isSupported(e){var t;return((t=e==null?void 0:e.info)==null?void 0:t.type)==="webgl"}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}update(...e){console.warn("TextureTransform#update() not implemented")}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(t instanceof se)return t.readAsync();const{buffer:n,byteOffset:r=0,byteLength:i=n.byteLength}=t;return n.readAsync(r,i)}}class a3{constructor(e){p(this,"id");p(this,"topology");p(this,"vertexCount");p(this,"indices");p(this,"attributes");p(this,"userData",{});const{attributes:t={},indices:n=null,vertexCount:r=null}=e;this.id=e.id||zt("geometry"),this.topology=e.topology,n&&(this.indices=ArrayBuffer.isView(n)?{value:n,size:1}:n),this.attributes={};for(const[i,o]of Object.entries(t)){const a=ArrayBuffer.isView(o)?{value:o}:o;ee(ArrayBuffer.isView(a.value),`${this._print(i)}: must be typed array or object with value as typed array`),(i==="POSITION"||i==="positions")&&!a.size&&(a.size=3),i==="indices"?(ee(!this.indices),this.indices=a):this.attributes[i]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=r||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let n=1/0;for(const r of Object.values(e)){const{value:i,size:o,constant:a}=r;!a&&i&&o>=1&&(n=Math.min(n,i.length/o))}return ee(Number.isFinite(n)),n}}const ab={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class qu extends Uo{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:n,viewports:r,onViewportActive:i,pickingFBO:o,deviceRect:{x:a,y:c,width:l,height:u},cullRect:h,effects:f,pass:_="picking",pickZ:T,moduleParameters:v}){this.pickZ=T;const R=this._resetColorEncoder(T),C=[a,c,l,u],I=super.render({target:o,layers:e,layerFilter:t,views:n,viewports:r,onViewportActive:i,cullRect:h,effects:f==null?void 0:f.filter(N=>N.useInPicking),pass:_,isPicking:!0,moduleParameters:v,clearColor:[0,0,0,0],colorMask:15,scissorRect:C});return this._colorEncoderState=null,{decodePickingColor:R&&lb.bind(null,R),stats:I}}shouldDrawLayer(e){const{pickable:t,operation:n}=e.props;return t&&n.includes("draw")||n.includes("terrain")||n.includes("mask")}getModuleParameters(){return{picking:{isActive:1,isAttribute:this.pickZ},lightSources:{}}}getLayerParameters(e,t,n){const r={depthMask:!0,depthTest:!0,depthRange:[0,1],...e.props.parameters},{pickable:i,operation:o}=e.props;return!this._colorEncoderState||o.includes("terrain")?r.blend=!1:i&&o.includes("draw")&&(Object.assign(r,ab),r.blend=!0,r.blendColor=cb(this._colorEncoderState,e,n)),r}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function cb(s,e,t){const{byLayer:n,byAlpha:r}=s;let i,o=n.get(e);return o?(o.viewports.push(t),i=o.a):(i=n.size+1,i<=255?(o={a:i,layer:e,viewports:[t]},n.set(e,o),r[i]=o):(G.warn("Too many pickable layers, only picking the first 255")(),i=0)),[0,0,0,i/255]}function lb(s,e){const t=s.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const Qt={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},ur=Symbol.for("component"),_t=Symbol.for("propTypes"),ui=Symbol.for("deprecatedProps"),cs=Symbol.for("asyncPropDefaults"),Bt=Symbol.for("asyncPropOriginal"),ft=Symbol.for("asyncPropResolved");function Bo(s,e=()=>!0){return Array.isArray(s)?Ku(s,e,[]):e(s)?[s]:[]}function Ku(s,e,t){let n=-1;for(;++n<s.length;){const r=s[n];Array.isArray(r)?Ku(r,e,t):e(r)&&t.push(r)}return t}function ub({target:s,source:e,start:t=0,count:n=1}){const r=e.length,i=n*r;let o=0;for(let a=t;o<r;o++)s[a++]=e[o];for(;o<i;)o<i-o?(s.copyWithin(t+o,t,t+o),o*=2):(s.copyWithin(t+o,t,t+i-o),o=i);return s}class hb{constructor(e,t,n){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=n,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const n=++this._loadCount;let r=e;typeof e=="string"&&(r=Ri(e)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(i=>{this._loadCount===n&&(this.isLoaded=!0,this._error=void 0,this._content=i)}).catch(i=>{this._loadCount===n&&(this.isLoaded=!0,this._error=i||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const i of this._subscribers)i.onChange(this.getData())}}class fb{constructor(e){var t;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:(t=e.device)==null?void 0:t.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:n=!1,persistent:r=!0}){let i=this._resources[e];i?i.setData(t,n):(i=new hb(e,t,this._context),this._resources[e]=i),i.persistent=r}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const n in t){const r=t[n],i=this._resources[r.resourceId];i&&i.unsubscribe(r)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:n,requestId:r="default"}){const{_resources:i,protocol:o}=this;e.startsWith(o)&&(e=e.replace(o,""),i[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=i[e];if(this._track(n,r,a,t),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,n,r){const i=this._consumers,o=i[e]=i[e]||{};let a=o[t];const c=a&&a.resourceId&&this._resources[a.resourceId];c&&(c.unsubscribe(a),this.prune()),n&&(a?(a.onChange=r,a.resourceId=n.id):a={onChange:r,resourceId:n.id},o[t]=a,n.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const db="layerManager.setLayers",pb="layerManager.activateViewport";class _b{constructor(e,t){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=a=>{me(pb,this,a),a&&(this.context.viewport=a)};const{deck:n,stats:r,viewport:i,timeline:o}=t||{};this.layers=[],this.resourceManager=new fb({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e==null?void 0:e.gl,deck:n,shaderAssembler:AT(),defaultShaderModules:[],renderPass:void 0,stats:r||new en({id:"deck.gl"}),viewport:i||new ys({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Yu,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const n of this.layers){const r=n.getNeedsRedraw(e);t=t||r}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(n=>t.id.indexOf(n)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){me(db,this,t,e),this._lastRenderedLayers=e;const n=Bo(e,Boolean);for(const r of n)r.context=this.context;this._updateLayers(this.layers,n)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(n=>n.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,n=t.findIndex(r=>r.name===e.name);n>=0&&(t.splice(n,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,n){n.raiseError(t,`${e} of ${n}`)}_updateLayers(e,t){const n={};for(const o of e)n[o.id]?G.warn(`Multiple old layers with same id ${o.id}`)():n[o.id]=o;if(this._defaultShaderModulesChanged){for(const o of e)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const r=[];this._updateSublayersRecursively(t,n,r),this._finalizeOldLayers(n);let i=!1;for(const o of r)if(o.hasUniformTransition()){i=`Uniform transition in ${o}`;break}this._needsUpdate=i,this.layers=r}_updateSublayersRecursively(e,t,n){for(const r of e){r.context=this.context;const i=t[r.id];i===null&&G.warn(`Multiple new layers with same id ${r.id}`)(),t[r.id]=null;let o=null;try{this._debug&&i!==r&&r.validateProps(),i?(this._transferLayerState(i,r),this._updateLayer(r)):this._initializeLayer(r),n.push(r),o=r.isComposite?r.getSubLayers():null}catch(a){this._handleError("matching",a,r)}o&&this._updateSublayersRecursively(o,t,n)}}_finalizeOldLayers(e){for(const t in e){const n=e[t];n&&this._finalizeLayer(n)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=Qt.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=Qt.MATCHED,t!==e&&(e.lifecycle=Qt.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=Qt.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=Qt.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function Ne(s,e,t){if(s===e)return!0;if(!t||!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let n=0;n<s.length;n++)if(!Ne(s[n],e[n],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){const n=Object.keys(s),r=Object.keys(e);if(n.length!==r.length)return!1;for(const i of n)if(!e.hasOwnProperty(i)||!Ne(s[i],e[i],t-1))return!1;return!0}return!1}class gb{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,n=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(n):n}getViewport(e){return this._viewportMap[e]}unproject(e,t){const n=this.getViewports(),r={x:e[0],y:e[1]};for(let i=n.length-1;i>=0;--i){const o=n[i];if(o.containsPixel(r)){const a=e.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Bo(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!Ne(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):G.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const n=t.type;return new n({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:i=>{var o;return(o=this.getView(e.id))==null?void 0:o.makeViewport({viewState:i,width:this.width,height:this.height})}})}_updateController(e,t,n,r){const i=e.controller;if(i&&n){const o={...t,...i,id:e.id,x:n.x,y:n.y,width:n.width,height:n.height};return(!r||r.constructor!==i.type)&&(r=this._createController(e,o)),r&&r.setProps(o),r}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let n=!1;for(let r=e.length;r--;){const i=e[r],o=this.getViewState(i),a=i.makeViewport({viewState:o,width:this.width,height:this.height});let c=t[i.id];const l=!!i.controller;l&&!c&&(n=!0),(n||!l)&&c&&(c.finalize(),c=null),this.controllers[i.id]=this._updateController(i,o,a,c),a&&this._viewports.unshift(a)}for(const r in t){const i=t[r];i&&!this.controllers[r]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((n,r)=>!e[r].equals(t[r]))}}const mb=/([0-9]+\.?[0-9]*)(%|px)/;function st(s){switch(typeof s){case"number":return{position:s,relative:!1};case"string":const e=mb.exec(s);if(e&&e.length>=3){const t=e[2]==="%",n=parseFloat(e[1]);return{position:t?n/100:n,relative:t}}default:throw new Error(`Could not parse position string ${s}`)}}function nt(s,e){return s.relative?Math.round(s.position*e):s.position}class yb{constructor(e){const{id:t,x:n=0,y:r=0,width:i="100%",height:o="100%",padding:a=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=st(n),this._y=st(r),this._width=st(i),this._height=st(o),this._padding=a&&{left:st(a.left||0),right:st(a.right||0),top:st(a.top||0),bottom:st(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.ViewportType===e.ViewportType&&Ne(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:n}){n=this.filterViewState(n);const r=this.getDimensions({width:e,height:t});return!r.height||!r.width?null:new this.ViewportType({...n,...this.props,...r})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:(e==null?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const n in this.props.viewState)n!=="id"&&(t[n]=this.props.viewState[n]);return t}return e}getDimensions({width:e,height:t}){const n={x:nt(this._x,e),y:nt(this._y,t),width:nt(this._width,e),height:nt(this._height,t)};return this._padding&&(n.padding={left:nt(this._padding.left,e),top:nt(this._padding.top,t),right:nt(this._padding.right,e),bottom:nt(this._padding.bottom,t)}),n}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class Mr{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){var t,n;this.cancel(),this.settings=e,this._inProgress=!0,(n=(t=this.settings).onStart)==null||n.call(t,this)}end(){var e,t;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(t=(e=this.settings).onEnd)==null||t.call(e,this))}cancel(){var e,t;this._inProgress&&((t=(e=this.settings).onInterrupt)==null||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:n,settings:r}=this;this._handle=n.addChannel({delay:n.getTime(),duration:r.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(t=(e=this.settings).onUpdate)==null||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const Ec=()=>{},Gi={BREAK:1,SNAP_TO_END:2,IGNORE:3},Tb=s=>s,bb=Gi.BREAK;class vb{constructor(e){this._onTransitionUpdate=t=>{const{time:n,settings:{interpolator:r,startProps:i,endProps:o,duration:a,easing:c}}=t,l=c(n/a),u=r.interpolateProps(i,o,l);this.propsInTransition=this.getControllerState({...this.props,...u}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new Mr(e.timeline),this.onViewStateChange=e.onViewStateChange||Ec,this.onStateChange=e.onStateChange||Ec}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const n=this.props;if(this.props=e,!n||this._shouldIgnoreViewportChange(n,e))return!1;if(this._isTransitionEnabled(e)){let r=n;if(this.transition.inProgress){const{interruption:i,endProps:o}=this.transition.settings;r={...n,...i===Gi.SNAP_TO_END?o:this.propsInTransition||n}}this._triggerTransition(r,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:n}=e;return(t>0||t==="auto")&&!!n}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===Gi.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const n=this.getControllerState(e),r=this.getControllerState(t).shortestPathFrom(n),i=t.transitionInterpolator,o=i.getDuration?i.getDuration(e,t):t.transitionDuration;if(o===0)return;const a=i.initializeProps(e,r);this.propsInTransition={};const c={duration:o,easing:t.transitionEasing||Tb,interpolator:i,interruption:t.transitionInterruption||bb,startProps:a.start,endProps:a.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(c),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e==null||e(t)}}}function pe(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}class wb{constructor(e){const{compare:t,extract:n,required:r}=e;this._propsToCompare=t,this._propsToExtract=n||t,this._requiredProps=r}arePropsEqual(e,t){for(const n of this._propsToCompare)if(!(n in e)||!(n in t)||!Zs(e[n],t[n]))return!1;return!0}initializeProps(e,t){const n={},r={};for(const i of this._propsToExtract)(i in e||i in t)&&(n[i]=e[i],r[i]=t[i]);return this._checkRequiredProps(n),this._checkRequiredProps(r),{start:n,end:r}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const n=e[t];pe(Number.isFinite(n)||Array.isArray(n),`${t} is required for transition`)})}}const Ab=["longitude","latitude","zoom","bearing","pitch"],Eb=["longitude","latitude","zoom"];class Zu extends wb{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,n=Array.isArray(e)?{}:e;n.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:Ab,required:Eb},super(n.transitionProps),this.opts=n}initializeProps(e,t){const n=super.initializeProps(e,t),{makeViewport:r,around:i}=this.opts;if(r&&i){const o=r(e),a=r(t),c=o.unproject(i);n.start.around=i,Object.assign(n.end,{around:a.project(c),aroundPosition:c,width:t.width,height:t.height})}return n}interpolateProps(e,t,n){const r={};for(const i of this._propsToExtract)r[i]=rr(e[i]||0,t[i]||0,n);if(t.aroundPosition&&this.opts.makeViewport){const i=this.opts.makeViewport({...t,...r});Object.assign(r,i.panByPosition(t.aroundPosition,rr(e.around,t.around,n)))}return r}}const rt={transitionDuration:0},Sb=300,xn=s=>1-(1-s)*(1-s),Zt={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},Et={};class xb{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new vb({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const t in this._events)this._events[t]&&((e=this.eventManager)==null||e.off(t,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return t?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:n}=this.props,{offsetCenter:r}=e;return[r.x-t,r.y-n]}isPointInBounds(e,t){const{width:n,height:r}=this.props;if(t&&t.handled)return!1;const i=e[0]>=0&&e[0]<=n&&e[1]>=0&&e[1]<=r;return i&&t&&t.stopPropagation(),i}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?Sb:0;const{scrollZoom:n=!0,dragPan:r=!0,dragRotate:i=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:c=!1,keyboard:l=!0}=e,u=!!this.onViewStateChange;this.toggleEvents(Zt.WHEEL,u&&n),this.toggleEvents(Zt.PAN,u),this.toggleEvents(Zt.PINCH,u&&(a||c)),this.toggleEvents(Zt.TRIPLE_PAN,u&&c),this.toggleEvents(Zt.DOUBLE_TAP,u&&o),this.toggleEvents(Zt.KEYBOARD,u&&l),this.scrollZoom=n,this.dragPan=r,this.dragRotate=i,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=c,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(n=>{this._events[n]!==t&&(this._events[n]=t,t?this.eventManager.on(n,this.handleEvent):this.eventManager.off(n,this.handleEvent))})}updateViewport(e,t=null,n={}){const r={...e.getViewportProps(),...t},i=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(n),i){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let n=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(n=!n);const r=this.controllerState[n?"panStart":"rotateStart"]({pos:t});return this._panMove=n,this.updateViewport(r,rt,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),n=this.controllerState.pan({pos:t});return this.updateViewport(n,rt,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const n=this.getCenter(e),r=[n[0]+e.velocityX*t/2,n[1]+e.velocityY*t/2],i=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(i,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:xn},{isDragging:!1,isPanning:!0})}else{const n=this.controllerState.panEnd();this.updateViewport(n,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),n=this.controllerState.rotate({pos:t});return this.updateViewport(n,rt,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const n=this.getCenter(e),r=[n[0]+e.velocityX*t/2,n[1]+e.velocityY*t/2],i=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(i,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:xn},{isDragging:!1,isRotating:!0})}else{const n=this.controllerState.rotateEnd();this.updateViewport(n,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:n=.01,smooth:r=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:i}=e;let o=2/(1+Math.exp(-Math.abs(i*n)));i<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:t,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:t}),transitionDuration:r?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.controllerState.rotateStart({pos:t});return this.updateViewport(n,rt,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const n=this.controllerState.rotate({pos:t});return this.updateViewport(n,rt,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const n=this.getCenter(e),r=[n[0],n[1]+=e.velocityY*t/2],i=this.controllerState.rotate({pos:r});this.updateViewport(i,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:xn},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const n=this.controllerState.rotateEnd();this.updateViewport(n,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Et._startPinchRotation=e.rotation,Et._lastPinchEvent=e,this.updateViewport(n,rt,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:n}=e,r=this.getCenter(e);t=t.zoom({pos:r,scale:n})}if(this.touchRotate){const{rotation:n}=e;t=t.rotate({deltaAngleX:Et._startPinchRotation-n})}return this.updateViewport(t,rt,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Et._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:n}=Et;if(this.touchZoom&&t&&n&&e.scale!==n.scale){const r=this.getCenter(e);let i=this.controllerState.rotateEnd();const o=Math.log2(e.scale),a=(o-Math.log2(n.scale))/(e.deltaTime-n.deltaTime),c=Math.pow(2,o+a*t/2);i=i.zoom({pos:r,scale:c}).zoomEnd(),this.updateViewport(i,{...this._getTransitionProps({around:r}),transitionDuration:t,transitionEasing:xn},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const r=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Et._startPinchRotation=null,Et._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.isFunctionKeyPressed(e),r=this.controllerState.zoom({pos:t,scale:n?.5:2});return this.updateViewport(r,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:n,moveSpeed:r,rotateSpeedX:i,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let c;const l={};switch(e.srcEvent.code){case"Minus":c=t?a.zoomOut(n).zoomOut(n):a.zoomOut(n),l.isZooming=!0;break;case"Equal":c=t?a.zoomIn(n).zoomIn(n):a.zoomIn(n),l.isZooming=!0;break;case"ArrowLeft":t?(c=a.rotateLeft(i),l.isRotating=!0):(c=a.moveLeft(r),l.isPanning=!0);break;case"ArrowRight":t?(c=a.rotateRight(i),l.isRotating=!0):(c=a.moveRight(r),l.isPanning=!0);break;case"ArrowUp":t?(c=a.rotateUp(o),l.isRotating=!0):(c=a.moveUp(r),l.isPanning=!0);break;case"ArrowDown":t?(c=a.rotateDown(o),l.isRotating=!0):(c=a.moveDown(r),l.isPanning=!0);break;default:return!1}return this.updateViewport(c,this._getTransitionProps(),l),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?rt:e?{...t,transitionInterpolator:new Zu({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class Rb{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Sc=5,Ib=1.2;class Cb extends Rb{constructor(e){const{width:t,height:n,latitude:r,longitude:i,zoom:o,bearing:a=0,pitch:c=0,altitude:l=1.5,position:u=[0,0,0],maxZoom:h=20,minZoom:f=0,maxPitch:_=60,minPitch:T=0,startPanLngLat:v,startZoomLngLat:R,startRotatePos:C,startBearing:I,startPitch:M,startZoom:N,normalize:U=!0}=e;pe(Number.isFinite(i)),pe(Number.isFinite(r)),pe(Number.isFinite(o)),super({width:t,height:n,latitude:r,longitude:i,zoom:o,bearing:a,pitch:c,altitude:l,maxZoom:h,minZoom:f,maxPitch:_,minPitch:T,normalize:U,position:u},{startPanLngLat:v,startZoomLngLat:R,startRotatePos:C,startBearing:I,startPitch:M,startZoom:N}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const n=this.getState().startPanLngLat||this._unproject(t);if(!n)return this;const i=this.makeViewport(this.getViewportProps()).panByPosition(n,e);return this._getUpdatedState(i)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:n=0}){const{startRotatePos:r,startBearing:i,startPitch:o}=this.getState();if(!r||i===void 0||o===void 0)return this;let a;return e?a=this._getNewRotation(e,r,o,i):a={bearing:i+t,pitch:o+n},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:n}){let{startZoom:r,startZoomLngLat:i}=this.getState();if(i||(r=this.getViewportProps().zoom,i=this._unproject(t)||this._unproject(e)),!i)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let c=r+Math.log2(n);c=ht(c,a,o);const l=this.makeViewport({...this.getViewportProps(),zoom:c});return this._getUpdatedState({zoom:c,...l.panByPosition(i,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),n={...this.getViewportProps()},{bearing:r,longitude:i}=n;return Math.abs(r-t.bearing)>180&&(n.bearing=r<0?r+360:r-360),Math.abs(i-t.longitude)>180&&(n.longitude=i<0?i+360:i-360),n}applyConstraints(e){const{maxZoom:t,minZoom:n,zoom:r}=e;e.zoom=ht(r,n,t);const{maxPitch:i,minPitch:o,pitch:a}=e;e.pitch=ht(a,o,i);const{normalize:c=!0}=e;return c&&Object.assign(e,uT(e)),e}_zoomFromCenter(e){const{width:t,height:n}=this.getViewportProps();return this.zoom({pos:[t/2,n/2],scale:e})}_panFromCenter(e){const{width:t,height:n}=this.getViewportProps();return this.pan({startPos:[t/2,n/2],pos:[t/2+e[0],n/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,n,r){const i=e[0]-t[0],o=e[1]-t[1],a=e[1],c=t[1],{width:l,height:u}=this.getViewportProps(),h=i/l;let f=0;o>0?Math.abs(u-c)>Sc&&(f=o/(c-u)*Ib):o<0&&c>Sc&&(f=1-a/c),f=ht(f,-1,1);const{minPitch:_,maxPitch:T}=this.getViewportProps(),v=r+180*h;let R=n;return f>0?R=n+f*(T-n):f<0&&(R=n-f*(_-n)),{pitch:R,bearing:v}}}class Pb extends xb{constructor(){super(...arguments),this.ControllerState=Cb,this.transition={transitionDuration:300,transitionInterpolator:new Zu({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class Qu extends yb{constructor(e={}){super(e)}get ViewportType(){return _s}get ControllerType(){return Pb}}Qu.displayName="MapView";const Mb=new ju;function Ob(s,e){const t=s.order??1/0,n=e.order??1/0;return t-n}class Nb{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(n=>n.id===e.id)){const n=t.findIndex(r=>Ob(r,e)>0);n<0?t.push(e):t.splice(n,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(Ne(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const r of this.effects)t[r.id]=r;const n=[];for(const r of e){const i=t[r.id];let o=r;i&&i!==r?i.setProps?(i.setProps(r.props),o=i):i.cleanup(this._context):i||r.setup(this._context),n.push(o),delete t[r.id]}for(const r in t)t[r].cleanup(this._context);this.effects=n,this._resolvedEffects=n.concat(this._defaultEffects),e.some(r=>r instanceof ju)||this._resolvedEffects.push(Mb),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class kb extends Uo{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const Db="deckRenderer.renderLayers";class Fb{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new kb(e),this.pickLayersPass=new qu(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,n={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};n.effects&&this._preRender(n.effects,n);const r=this.lastPostProcessEffect?this.renderBuffers[0]:n.target;this.lastPostProcessEffect&&(n.clearColor=[0,0,0,0],n.clearCanvas=!0);const i=t.render({...n,target:r});n.effects&&this._postRender(n.effects,n),this.renderCount++,me(Db,this,i,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const n of e)t.preRenderStats[n.id]=n.preRender(t),n.postRender&&(this.lastPostProcessEffect=n.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(n=>{const r=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${n}`,colorAttachments:[r]}))});for(const n of e)n.resize(t)}_postRender(e,t){const{renderBuffers:n}=this,r={...t,inputBuffer:n[0],swapBuffer:n[1]};for(const i of e)if(i.postRender){r.target=i.id===this.lastPostProcessEffect?t.target:void 0;const o=i.postRender(r);r.inputBuffer=o,r.swapBuffer=o===n[0]?n[1]:n[0]}}}const Ub={pickedColor:null,pickedObjectIndex:-1};function Bb({pickedColors:s,decodePickingColor:e,deviceX:t,deviceY:n,deviceRadius:r,deviceRect:i}){const{x:o,y:a,width:c,height:l}=i;let u=r*r,h=-1,f=0;for(let _=0;_<l;_++){const T=_+a-n,v=T*T;if(v>u)f+=4*c;else for(let R=0;R<c;R++){if(s[f+3]-1>=0){const I=R+o-t,M=I*I+v;M<=u&&(u=M,h=f)}f+=4}}if(h>=0){const _=s.slice(h,h+4),T=e(_);if(T){const v=Math.floor(h/4/c),R=h/4-v*c;return{...T,pickedColor:_,pickedX:o+R,pickedY:a+v}}G.error("Picked non-existent layer. Is picking buffer corrupt?")()}return Ub}function Lb({pickedColors:s,decodePickingColor:e}){const t=new Map;if(s){for(let n=0;n<s.length;n+=4)if(s[n+3]-1>=0){const i=s.slice(n,n+4),o=i.join(",");if(!t.has(o)){const a=e(i);a?t.set(o,{...a,color:i}):G.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function Ju({pickInfo:s,viewports:e,pixelRatio:t,x:n,y:r,z:i}){let o=e[0];e.length>1&&(o=$b((s==null?void 0:s.pickedViewports)||e,{x:n,y:r}));let a;if(o){const c=[n-o.x,r-o.y];i!==void 0&&(c[2]=i),a=o.unproject(c)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:n,y:r,pixel:[n,r],coordinate:a,devicePixel:s&&"pickedX"in s?[s.pickedX,s.pickedY]:void 0,pixelRatio:t}}function Vb(s){const{pickInfo:e,lastPickedInfo:t,mode:n,layers:r}=s,{pickedColor:i,pickedLayer:o,pickedObjectIndex:a}=e,c=o?[o]:[];if(n==="hover"){const h=t.index,f=t.layerId,_=o?o.props.id:null;if(_!==f||a!==h){if(_!==f){const T=r.find(v=>v.props.id===f);T&&c.unshift(T)}t.layerId=_,t.index=a,t.info=null}}const l=Ju(s),u=new Map;return u.set(null,l),c.forEach(h=>{let f={...l};h===o&&(f.color=i,f.index=a,f.picked=!0),f=Gu({layer:h,info:f,mode:n});const _=f.layer;h===o&&n==="hover"&&(t.info=f),u.set(_.id,f),n==="hover"&&_.updateAutoHighlight(f)}),u}function Gu({layer:s,info:e,mode:t}){for(;s&&e;){const n=e.layer||null;e.sourceLayer=n,e.layer=s,e=s.getPickingInfo({info:e,mode:t,sourceLayer:n}),s=s.parent}return e}function $b(s,e){for(let t=s.length-1;t>=0;t--){const n=s[t];if(n.containsPixel(e))return n}return s[0]}class zb{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new qu(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:n,viewports:r},i=this.lastPickedInfo.info){const o=i&&i.layer&&i.layer.id,a=i&&i.viewport&&i.viewport.id,c=o?n.find(f=>f.id===o):null,l=a&&r.find(f=>f.id===a)||r[0],u=l&&l.unproject([e-l.x,t-l.y]);return{...i,...{x:e,y:t,viewport:l,coordinate:u,layer:c}}}_resizeBuffer(){var t,n;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const r=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=r}const{canvas:e}=this.device.getCanvasContext();(t=this.pickingFBO)==null||t.resize({width:e.width,height:e.height}),(n=this.depthFBO)==null||n.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(n=>this.pickLayersPass.shouldDrawLayer(n)&&!n.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:n,x:r,y:i,radius:o=0,depth:a=1,mode:c="query",unproject3D:l,onViewportActive:u,effects:h}){const f=this.device.canvasContext.cssToDeviceRatio(),_=this._getPickable(e);if(!_||n.length===0)return{result:[],emptyInfo:Ju({viewports:n,x:r,y:i,pixelRatio:f})};this._resizeBuffer();const T=this.device.canvasContext.cssToDevicePixels([r,i],!0),v=[T.x+Math.floor(T.width/2),T.y+Math.floor(T.height/2)],R=Math.round(o*f),{width:C,height:I}=this.pickingFBO,M=this._getPickingRect({deviceX:v[0],deviceY:v[1],deviceRadius:R,deviceWidth:C,deviceHeight:I}),N={x:r-o,y:i-o,width:o*2+1,height:o*2+1};let U;const B=[],$=new Set;for(let W=0;W<a;W++){let V;if(M){const H=this._drawAndSample({layers:_,views:t,viewports:n,onViewportActive:u,deviceRect:M,cullRect:N,effects:h,pass:`picking:${c}`});V=Bb({...H,deviceX:v[0],deviceY:v[1],deviceRadius:R,deviceRect:M})}else V={pickedColor:null,pickedObjectIndex:-1};let z;if(V.pickedLayer&&l&&this.depthFBO){const{pickedColors:H}=this._drawAndSample({layers:[V.pickedLayer],views:t,viewports:n,onViewportActive:u,deviceRect:{x:V.pickedX,y:V.pickedY,width:1,height:1},cullRect:N,effects:h,pass:`picking:${c}:z`},!0);H[3]&&(z=H[0])}V.pickedLayer&&W+1<a&&($.add(V.pickedLayer),V.pickedLayer.disablePickingIndex(V.pickedObjectIndex)),U=Vb({pickInfo:V,lastPickedInfo:this.lastPickedInfo,mode:c,layers:_,viewports:n,x:r,y:i,z,pixelRatio:f});for(const H of U.values())H.layer&&B.push(H);if(!V.pickedColor)break}for(const W of $)W.restorePickingColors();return{result:B,emptyInfo:U.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:n,x:r,y:i,width:o=1,height:a=1,mode:c="query",maxObjects:l=null,onViewportActive:u,effects:h}){const f=this._getPickable(e);if(!f||n.length===0)return[];this._resizeBuffer();const _=this.device.canvasContext.cssToDeviceRatio(),T=this.device.canvasContext.cssToDevicePixels([r,i],!0),v=T.x,R=T.y+T.height,C=this.device.canvasContext.cssToDevicePixels([r+o,i+a],!0),I=C.x+C.width,M=C.y,N={x:v,y:M,width:I-v,height:R-M},U=this._drawAndSample({layers:f,views:t,viewports:n,onViewportActive:u,deviceRect:N,cullRect:{x:r,y:i,width:o,height:a},effects:h,pass:`picking:${c}`}),B=Lb(U),$=new Map,W=[],V=Number.isFinite(l);for(let z=0;z<B.length&&!(V&&W.length>=l);z++){const H=B[z];let te={color:H.pickedColor,layer:null,index:H.pickedObjectIndex,picked:!0,x:r,y:i,pixelRatio:_};te=Gu({layer:H.pickedLayer,info:te,mode:c});const re=te.layer.id;$.has(re)||$.set(re,new Set);const X=$.get(re),Be=te.object??te.index;X.has(Be)||(X.add(Be),W.push(te))}return W}_drawAndSample({layers:e,views:t,viewports:n,onViewportActive:r,deviceRect:i,cullRect:o,effects:a,pass:c},l=!1){const u=l?this.depthFBO:this.pickingFBO,h={layers:e,layerFilter:this.layerFilter,views:t,viewports:n,onViewportActive:r,pickingFBO:u,deviceRect:i,cullRect:o,effects:a,pass:c,pickZ:l,preRenderStats:{}};for(const I of a)I.useInPicking&&(h.preRenderStats[I.id]=I.preRender(h));const{decodePickingColor:f}=this.pickLayersPass.render(h),{x:_,y:T,width:v,height:R}=i,C=new(l?Float32Array:Uint8Array)(v*R*4);return this.device.readPixelsToArrayWebGL(u,{sourceX:_,sourceY:T,sourceWidth:v,sourceHeight:R,target:C}),{pickedColors:C,decodePickingColor:f}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:n,deviceWidth:r,deviceHeight:i}){const o=Math.max(0,e-n),a=Math.max(0,t-n),c=Math.min(r,e+n+1)-o,l=Math.min(i,t+n+1)-a;return c<=0||l<=0?null:{x:o,y:a,width:c,height:l}}}const Wb={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},Hb="top-left",xc="__root";class jb{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!Ne(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const n of this.resolvedWidgets)t[n.id]=n;this.resolvedWidgets.length=0;for(const n of this.defaultWidgets)t[n.id]=null,this.resolvedWidgets.push(n);for(let n of e){const r=t[n.id];r?r.viewId!==n.viewId||r.placement!==n.placement?(this._remove(r),this._add(n)):n!==r&&(r.setProps(n.props),n=r):this._add(n),t[n.id]=null,this.resolvedWidgets.push(n)}for(const n in t){const r=t[n];r&&this._remove(r)}this.widgets=e}_add(e){const{viewId:t=null,placement:n=Hb}=e,r=e.onAdd({deck:this.deck,viewId:t});r&&this._getContainer(t,n).append(r),e._element=r}_remove(e){e.onRemove(),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){var o;const n=e||xc;let r=this.containers[n];r||(r=document.createElement("div"),r.style.pointerEvents="none",r.style.position="absolute",r.style.overflow="hidden",(o=this.parentElement)==null||o.append(r),this.containers[n]=r);let i=r.querySelector(`.${t}`);return i||(i=document.createElement("div"),i.className=t,i.style.position="absolute",i.style.zIndex="2",Object.assign(i.style,Wb[t]),r.append(i)),i}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const n in this.containers){const r=this.lastViewports[n]||null,i=n===xc||r,o=this.containers[n];i?(o.style.display="block",o.style.left=`${r?r.x:0}px`,o.style.top=`${r?r.y:0}px`,o.style.width=`${r?r.width:e}px`,o.style.height=`${r?r.height:t}px`):o.style.display="none"}}onRedraw({viewports:e,layers:t}){var i,o;const n=e.reduce((a,c)=>(a[c.id]=c,a),{}),{lastViewports:r}=this;for(const a of this.getWidgets()){const{viewId:c}=a;if(c){const l=n[c];l&&(a.onViewportChange&&!l.equals(r[c])&&a.onViewportChange(l),(i=a.onRedraw)==null||i.call(a,{viewports:[l],layers:t}))}else{if(a.onViewportChange)for(const l of e)l.equals(r[l.id])||a.onViewportChange(l);(o=a.onRedraw)==null||o.call(a,{viewports:e,layers:t})}}this.lastViewports=n,this._updateContainers()}onHover(e,t){var n,r;for(const i of this.getWidgets()){const{viewId:o}=i;(!o||o===((n=e.viewport)==null?void 0:n.id))&&((r=i.onHover)==null||r.call(i,e,t))}}onEvent(e,t){var r,i;const n=Yi[t.type];if(n)for(const o of this.getWidgets()){const{viewId:a}=o;(!a||a===((r=e.viewport)==null?void 0:r.id))&&((i=o[n.handler])==null||i.call(o,e,t))}}}const Xb={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class Yb{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,Xb),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var t;this.isVisible&&e.id===((t=this.lastViewport)==null?void 0:t.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,n=t&&t.props.getTooltip;if(!n)return;const r=n(e);this.lastViewport=e.viewport,this.setTooltip(r,e.x,e.y)}setTooltip(e,t,n){const r=this.element;if(r){if(typeof e=="string")r.innerText=e;else if(e)e.text&&(r.innerText=e.text),e.html&&(r.innerHTML=e.html),e.className&&(r.className=e.className);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform=`translate(${t}px, ${n}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(r.style,e.style)}}}var Gt;(function(s){s[s.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",s[s.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",s[s.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",s[s.POINTS=0]="POINTS",s[s.LINES=1]="LINES",s[s.LINE_LOOP=2]="LINE_LOOP",s[s.LINE_STRIP=3]="LINE_STRIP",s[s.TRIANGLES=4]="TRIANGLES",s[s.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",s[s.TRIANGLE_FAN=6]="TRIANGLE_FAN",s[s.ZERO=0]="ZERO",s[s.ONE=1]="ONE",s[s.SRC_COLOR=768]="SRC_COLOR",s[s.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",s[s.SRC_ALPHA=770]="SRC_ALPHA",s[s.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",s[s.DST_ALPHA=772]="DST_ALPHA",s[s.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",s[s.DST_COLOR=774]="DST_COLOR",s[s.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",s[s.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",s[s.CONSTANT_COLOR=32769]="CONSTANT_COLOR",s[s.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",s[s.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",s[s.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",s[s.FUNC_ADD=32774]="FUNC_ADD",s[s.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",s[s.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",s[s.BLEND_EQUATION=32777]="BLEND_EQUATION",s[s.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",s[s.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",s[s.BLEND_DST_RGB=32968]="BLEND_DST_RGB",s[s.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",s[s.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",s[s.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",s[s.BLEND_COLOR=32773]="BLEND_COLOR",s[s.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",s[s.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",s[s.LINE_WIDTH=2849]="LINE_WIDTH",s[s.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",s[s.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",s[s.CULL_FACE_MODE=2885]="CULL_FACE_MODE",s[s.FRONT_FACE=2886]="FRONT_FACE",s[s.DEPTH_RANGE=2928]="DEPTH_RANGE",s[s.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",s[s.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",s[s.DEPTH_FUNC=2932]="DEPTH_FUNC",s[s.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",s[s.STENCIL_FUNC=2962]="STENCIL_FUNC",s[s.STENCIL_FAIL=2964]="STENCIL_FAIL",s[s.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",s[s.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",s[s.STENCIL_REF=2967]="STENCIL_REF",s[s.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",s[s.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",s[s.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",s[s.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",s[s.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",s[s.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",s[s.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",s[s.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",s[s.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",s[s.VIEWPORT=2978]="VIEWPORT",s[s.SCISSOR_BOX=3088]="SCISSOR_BOX",s[s.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",s[s.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",s[s.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",s[s.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",s[s.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",s[s.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",s[s.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",s[s.RED_BITS=3410]="RED_BITS",s[s.GREEN_BITS=3411]="GREEN_BITS",s[s.BLUE_BITS=3412]="BLUE_BITS",s[s.ALPHA_BITS=3413]="ALPHA_BITS",s[s.DEPTH_BITS=3414]="DEPTH_BITS",s[s.STENCIL_BITS=3415]="STENCIL_BITS",s[s.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",s[s.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",s[s.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",s[s.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",s[s.SAMPLES=32937]="SAMPLES",s[s.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",s[s.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",s[s.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",s[s.VENDOR=7936]="VENDOR",s[s.RENDERER=7937]="RENDERER",s[s.VERSION=7938]="VERSION",s[s.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",s[s.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",s[s.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",s[s.STATIC_DRAW=35044]="STATIC_DRAW",s[s.STREAM_DRAW=35040]="STREAM_DRAW",s[s.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",s[s.ARRAY_BUFFER=34962]="ARRAY_BUFFER",s[s.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",s[s.BUFFER_SIZE=34660]="BUFFER_SIZE",s[s.BUFFER_USAGE=34661]="BUFFER_USAGE",s[s.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",s[s.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",s[s.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",s[s.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",s[s.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",s[s.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",s[s.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",s[s.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",s[s.CULL_FACE=2884]="CULL_FACE",s[s.FRONT=1028]="FRONT",s[s.BACK=1029]="BACK",s[s.FRONT_AND_BACK=1032]="FRONT_AND_BACK",s[s.BLEND=3042]="BLEND",s[s.DEPTH_TEST=2929]="DEPTH_TEST",s[s.DITHER=3024]="DITHER",s[s.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",s[s.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",s[s.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",s[s.SCISSOR_TEST=3089]="SCISSOR_TEST",s[s.STENCIL_TEST=2960]="STENCIL_TEST",s[s.NO_ERROR=0]="NO_ERROR",s[s.INVALID_ENUM=1280]="INVALID_ENUM",s[s.INVALID_VALUE=1281]="INVALID_VALUE",s[s.INVALID_OPERATION=1282]="INVALID_OPERATION",s[s.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",s[s.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",s[s.CW=2304]="CW",s[s.CCW=2305]="CCW",s[s.DONT_CARE=4352]="DONT_CARE",s[s.FASTEST=4353]="FASTEST",s[s.NICEST=4354]="NICEST",s[s.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",s[s.BYTE=5120]="BYTE",s[s.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",s[s.SHORT=5122]="SHORT",s[s.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",s[s.INT=5124]="INT",s[s.UNSIGNED_INT=5125]="UNSIGNED_INT",s[s.FLOAT=5126]="FLOAT",s[s.DOUBLE=5130]="DOUBLE",s[s.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",s[s.ALPHA=6406]="ALPHA",s[s.RGB=6407]="RGB",s[s.RGBA=6408]="RGBA",s[s.LUMINANCE=6409]="LUMINANCE",s[s.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",s[s.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",s[s.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",s[s.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",s[s.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",s[s.VERTEX_SHADER=35633]="VERTEX_SHADER",s[s.COMPILE_STATUS=35713]="COMPILE_STATUS",s[s.DELETE_STATUS=35712]="DELETE_STATUS",s[s.LINK_STATUS=35714]="LINK_STATUS",s[s.VALIDATE_STATUS=35715]="VALIDATE_STATUS",s[s.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",s[s.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",s[s.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",s[s.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",s[s.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",s[s.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",s[s.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",s[s.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",s[s.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",s[s.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",s[s.SHADER_TYPE=35663]="SHADER_TYPE",s[s.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",s[s.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",s[s.NEVER=512]="NEVER",s[s.LESS=513]="LESS",s[s.EQUAL=514]="EQUAL",s[s.LEQUAL=515]="LEQUAL",s[s.GREATER=516]="GREATER",s[s.NOTEQUAL=517]="NOTEQUAL",s[s.GEQUAL=518]="GEQUAL",s[s.ALWAYS=519]="ALWAYS",s[s.KEEP=7680]="KEEP",s[s.REPLACE=7681]="REPLACE",s[s.INCR=7682]="INCR",s[s.DECR=7683]="DECR",s[s.INVERT=5386]="INVERT",s[s.INCR_WRAP=34055]="INCR_WRAP",s[s.DECR_WRAP=34056]="DECR_WRAP",s[s.NEAREST=9728]="NEAREST",s[s.LINEAR=9729]="LINEAR",s[s.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",s[s.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",s[s.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",s[s.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",s[s.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",s[s.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",s[s.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",s[s.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",s[s.TEXTURE_2D=3553]="TEXTURE_2D",s[s.TEXTURE=5890]="TEXTURE",s[s.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",s[s.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",s[s.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",s[s.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",s[s.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",s[s.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",s[s.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",s[s.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",s[s.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",s[s.TEXTURE0=33984]="TEXTURE0",s[s.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",s[s.REPEAT=10497]="REPEAT",s[s.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",s[s.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",s[s.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",s[s.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_CUBE=35680]="SAMPLER_CUBE",s[s.LOW_FLOAT=36336]="LOW_FLOAT",s[s.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",s[s.HIGH_FLOAT=36338]="HIGH_FLOAT",s[s.LOW_INT=36339]="LOW_INT",s[s.MEDIUM_INT=36340]="MEDIUM_INT",s[s.HIGH_INT=36341]="HIGH_INT",s[s.FRAMEBUFFER=36160]="FRAMEBUFFER",s[s.RENDERBUFFER=36161]="RENDERBUFFER",s[s.RGBA4=32854]="RGBA4",s[s.RGB5_A1=32855]="RGB5_A1",s[s.RGB565=36194]="RGB565",s[s.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",s[s.STENCIL_INDEX=6401]="STENCIL_INDEX",s[s.STENCIL_INDEX8=36168]="STENCIL_INDEX8",s[s.DEPTH_STENCIL=34041]="DEPTH_STENCIL",s[s.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",s[s.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",s[s.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",s[s.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",s[s.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",s[s.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",s[s.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",s[s.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",s[s.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",s[s.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",s[s.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",s[s.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",s[s.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",s[s.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",s[s.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",s[s.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",s[s.NONE=0]="NONE",s[s.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",s[s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",s[s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",s[s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",s[s.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",s[s.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",s[s.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",s[s.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",s[s.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",s[s.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",s[s.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",s[s.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",s[s.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",s[s.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",s[s.READ_BUFFER=3074]="READ_BUFFER",s[s.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",s[s.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",s[s.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",s[s.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",s[s.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",s[s.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",s[s.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",s[s.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",s[s.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",s[s.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",s[s.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",s[s.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",s[s.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",s[s.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",s[s.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",s[s.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",s[s.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",s[s.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",s[s.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",s[s.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",s[s.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",s[s.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",s[s.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",s[s.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",s[s.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",s[s.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",s[s.RED=6403]="RED",s[s.RGB8=32849]="RGB8",s[s.RGBA8=32856]="RGBA8",s[s.RGB10_A2=32857]="RGB10_A2",s[s.TEXTURE_3D=32879]="TEXTURE_3D",s[s.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",s[s.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",s[s.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",s[s.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",s[s.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",s[s.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",s[s.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",s[s.SRGB=35904]="SRGB",s[s.SRGB8=35905]="SRGB8",s[s.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",s[s.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",s[s.RGBA32F=34836]="RGBA32F",s[s.RGB32F=34837]="RGB32F",s[s.RGBA16F=34842]="RGBA16F",s[s.RGB16F=34843]="RGB16F",s[s.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",s[s.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",s[s.R11F_G11F_B10F=35898]="R11F_G11F_B10F",s[s.RGB9_E5=35901]="RGB9_E5",s[s.RGBA32UI=36208]="RGBA32UI",s[s.RGB32UI=36209]="RGB32UI",s[s.RGBA16UI=36214]="RGBA16UI",s[s.RGB16UI=36215]="RGB16UI",s[s.RGBA8UI=36220]="RGBA8UI",s[s.RGB8UI=36221]="RGB8UI",s[s.RGBA32I=36226]="RGBA32I",s[s.RGB32I=36227]="RGB32I",s[s.RGBA16I=36232]="RGBA16I",s[s.RGB16I=36233]="RGB16I",s[s.RGBA8I=36238]="RGBA8I",s[s.RGB8I=36239]="RGB8I",s[s.RED_INTEGER=36244]="RED_INTEGER",s[s.RGB_INTEGER=36248]="RGB_INTEGER",s[s.RGBA_INTEGER=36249]="RGBA_INTEGER",s[s.R8=33321]="R8",s[s.RG8=33323]="RG8",s[s.R16F=33325]="R16F",s[s.R32F=33326]="R32F",s[s.RG16F=33327]="RG16F",s[s.RG32F=33328]="RG32F",s[s.R8I=33329]="R8I",s[s.R8UI=33330]="R8UI",s[s.R16I=33331]="R16I",s[s.R16UI=33332]="R16UI",s[s.R32I=33333]="R32I",s[s.R32UI=33334]="R32UI",s[s.RG8I=33335]="RG8I",s[s.RG8UI=33336]="RG8UI",s[s.RG16I=33337]="RG16I",s[s.RG16UI=33338]="RG16UI",s[s.RG32I=33339]="RG32I",s[s.RG32UI=33340]="RG32UI",s[s.R8_SNORM=36756]="R8_SNORM",s[s.RG8_SNORM=36757]="RG8_SNORM",s[s.RGB8_SNORM=36758]="RGB8_SNORM",s[s.RGBA8_SNORM=36759]="RGBA8_SNORM",s[s.RGB10_A2UI=36975]="RGB10_A2UI",s[s.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",s[s.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",s[s.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",s[s.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",s[s.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",s[s.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",s[s.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",s[s.HALF_FLOAT=5131]="HALF_FLOAT",s[s.RG=33319]="RG",s[s.RG_INTEGER=33320]="RG_INTEGER",s[s.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",s[s.CURRENT_QUERY=34917]="CURRENT_QUERY",s[s.QUERY_RESULT=34918]="QUERY_RESULT",s[s.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",s[s.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",s[s.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",s[s.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",s[s.DRAW_BUFFER0=34853]="DRAW_BUFFER0",s[s.DRAW_BUFFER1=34854]="DRAW_BUFFER1",s[s.DRAW_BUFFER2=34855]="DRAW_BUFFER2",s[s.DRAW_BUFFER3=34856]="DRAW_BUFFER3",s[s.DRAW_BUFFER4=34857]="DRAW_BUFFER4",s[s.DRAW_BUFFER5=34858]="DRAW_BUFFER5",s[s.DRAW_BUFFER6=34859]="DRAW_BUFFER6",s[s.DRAW_BUFFER7=34860]="DRAW_BUFFER7",s[s.DRAW_BUFFER8=34861]="DRAW_BUFFER8",s[s.DRAW_BUFFER9=34862]="DRAW_BUFFER9",s[s.DRAW_BUFFER10=34863]="DRAW_BUFFER10",s[s.DRAW_BUFFER11=34864]="DRAW_BUFFER11",s[s.DRAW_BUFFER12=34865]="DRAW_BUFFER12",s[s.DRAW_BUFFER13=34866]="DRAW_BUFFER13",s[s.DRAW_BUFFER14=34867]="DRAW_BUFFER14",s[s.DRAW_BUFFER15=34868]="DRAW_BUFFER15",s[s.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",s[s.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",s[s.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",s[s.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",s[s.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",s[s.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",s[s.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",s[s.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",s[s.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",s[s.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",s[s.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",s[s.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",s[s.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",s[s.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",s[s.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",s[s.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",s[s.SAMPLER_3D=35679]="SAMPLER_3D",s[s.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",s[s.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",s[s.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",s[s.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",s[s.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",s[s.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",s[s.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",s[s.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",s[s.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",s[s.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",s[s.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",s[s.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",s[s.MAX_SAMPLES=36183]="MAX_SAMPLES",s[s.SAMPLER_BINDING=35097]="SAMPLER_BINDING",s[s.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",s[s.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",s[s.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",s[s.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",s[s.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",s[s.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",s[s.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",s[s.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",s[s.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",s[s.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",s[s.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",s[s.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",s[s.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",s[s.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",s[s.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",s[s.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",s[s.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",s[s.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",s[s.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",s[s.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",s[s.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",s[s.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",s[s.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",s[s.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",s[s.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",s[s.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",s[s.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",s[s.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",s[s.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",s[s.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",s[s.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",s[s.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",s[s.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",s[s.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",s[s.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",s[s.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",s[s.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",s[s.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",s[s.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",s[s.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",s[s.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",s[s.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",s[s.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",s[s.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",s[s.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",s[s.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",s[s.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",s[s.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",s[s.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",s[s.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",s[s.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",s[s.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",s[s.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",s[s.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",s[s.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",s[s.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",s[s.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",s[s.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",s[s.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",s[s.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",s[s.UNIFORM_TYPE=35383]="UNIFORM_TYPE",s[s.UNIFORM_SIZE=35384]="UNIFORM_SIZE",s[s.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",s[s.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",s[s.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",s[s.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",s[s.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",s[s.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",s[s.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",s[s.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",s[s.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",s[s.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",s[s.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",s[s.OBJECT_TYPE=37138]="OBJECT_TYPE",s[s.SYNC_CONDITION=37139]="SYNC_CONDITION",s[s.SYNC_STATUS=37140]="SYNC_STATUS",s[s.SYNC_FLAGS=37141]="SYNC_FLAGS",s[s.SYNC_FENCE=37142]="SYNC_FENCE",s[s.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",s[s.UNSIGNALED=37144]="UNSIGNALED",s[s.SIGNALED=37145]="SIGNALED",s[s.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",s[s.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",s[s.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",s[s.WAIT_FAILED=37149]="WAIT_FAILED",s[s.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",s[s.COLOR=6144]="COLOR",s[s.DEPTH=6145]="DEPTH",s[s.STENCIL=6146]="STENCIL",s[s.MIN=32775]="MIN",s[s.MAX=32776]="MAX",s[s.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",s[s.STREAM_READ=35041]="STREAM_READ",s[s.STREAM_COPY=35042]="STREAM_COPY",s[s.STATIC_READ=35045]="STATIC_READ",s[s.STATIC_COPY=35046]="STATIC_COPY",s[s.DYNAMIC_READ=35049]="DYNAMIC_READ",s[s.DYNAMIC_COPY=35050]="DYNAMIC_COPY",s[s.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",s[s.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",s[s.INVALID_INDEX=4294967295]="INVALID_INDEX",s[s.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",s[s.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",s[s.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",s[s.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",s[s.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",s[s.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",s[s.R16_EXT=33322]="R16_EXT",s[s.RG16_EXT=33324]="RG16_EXT",s[s.RGB16_EXT=32852]="RGB16_EXT",s[s.RGBA16_EXT=32859]="RGBA16_EXT",s[s.R16_SNORM_EXT=36760]="R16_SNORM_EXT",s[s.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",s[s.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",s[s.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",s[s.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",s[s.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",s[s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",s[s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",s[s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",s[s.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",s[s.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",s[s.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",s[s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",s[s.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",s[s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",s[s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",s[s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",s[s.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",s[s.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",s[s.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",s[s.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",s[s.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",s[s.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",s[s.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",s[s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",s[s.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",s[s.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",s[s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",s[s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",s[s.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",s[s.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",s[s.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",s[s.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",s[s.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",s[s.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",s[s.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",s[s.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",s[s.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",s[s.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",s[s.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",s[s.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",s[s.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",s[s.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",s[s.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",s[s.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",s[s.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",s[s.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",s[s.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",s[s.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",s[s.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",s[s.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",s[s.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",s[s.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",s[s.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",s[s.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",s[s.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",s[s.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",s[s.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",s[s.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",s[s.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",s[s.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",s[s.LINE_WEBGL=6913]="LINE_WEBGL",s[s.FILL_WEBGL=6914]="FILL_WEBGL",s[s.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",s[s.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",s[s.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",s[s.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",s[s.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",s[s.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",s[s.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",s[s.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",s[s.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",s[s.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",s[s.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",s[s.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",s[s.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",s[s.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",s[s.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",s[s.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",s[s.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",s[s.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",s[s.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",s[s.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",s[s.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",s[s.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",s[s.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",s[s.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(Gt||(Gt={}));const Lo={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},le=(s,e,t)=>e?s.enable(t):s.disable(t),Rc=(s,e,t)=>s.hint(t,e),we=(s,e,t)=>s.pixelStorei(t,e),Ic=(s,e,t)=>{const n=t===36006?36009:36008;return s.bindFramebuffer(n,e)},Ps=(s,e,t)=>{const r={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];s.bindBuffer(r,e)};function hi(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}const qb={3042:le,32773:(s,e)=>s.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(s,e)=>s.clearColor(...e),3107:(s,e)=>s.colorMask(...e),2884:le,2885:(s,e)=>s.cullFace(e),2929:le,2931:(s,e)=>s.clearDepth(e),2932:(s,e)=>s.depthFunc(e),2928:(s,e)=>s.depthRange(...e),2930:(s,e)=>s.depthMask(e),3024:le,35723:Rc,35725:(s,e)=>s.useProgram(e),36007:(s,e)=>s.bindRenderbuffer(36161,e),36389:(s,e)=>{var t;return(t=s.bindTransformFeedback)==null?void 0:t.call(s,36386,e)},34229:(s,e)=>s.bindVertexArray(e),36006:Ic,36010:Ic,34964:Ps,36662:Ps,36663:Ps,35053:Ps,35055:Ps,2886:(s,e)=>s.frontFace(e),33170:Rc,2849:(s,e)=>s.lineWidth(e),32823:le,32824:"polygonOffset",10752:"polygonOffset",35977:le,32926:le,32928:le,32938:"sampleCoverage",32939:"sampleCoverage",3089:le,3088:(s,e)=>s.scissor(...e),2960:le,2961:(s,e)=>s.clearStencil(e),2968:(s,e)=>s.stencilMaskSeparate(1028,e),36005:(s,e)=>s.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(s,e)=>s.viewport(...e),34383:le,10754:le,12288:le,12289:le,12290:le,12291:le,12292:le,12293:le,12294:le,12295:le,3333:we,3317:we,37440:we,37441:we,37443:we,3330:we,3332:we,3331:we,3314:we,32878:we,3316:we,3315:we,32877:we,framebuffer:(s,e)=>{const t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{const t=typeof e=="number"?[e,e]:e;s.blendEquationSeparate(...t)},blendFunc:(s,e)=>{const t=(e==null?void 0:e.length)===2?[...e,...e]:e;s.blendFuncSeparate(...t)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=hi(e)?e:[e,e];const[t,n]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,n)},stencilFunc:(s,e)=>{e=hi(e)&&e.length===3?[...e,...e]:e;const[t,n,r,i,o,a]=e;s.stencilFuncSeparate(1028,t,n,r),s.stencilFuncSeparate(1029,i,o,a)},stencilOp:(s,e)=>{e=hi(e)&&e.length===3?[...e,...e]:e;const[t,n,r,i,o,a]=e;s.stencilOpSeparate(1028,t,n,r),s.stencilOpSeparate(1029,i,o,a)},viewport:(s,e)=>s.viewport(...e)};function ie(s,e,t){return e[s]!==void 0?e[s]:t[s]}const Kb={blendEquation:(s,e,t)=>s.blendEquationSeparate(ie(32777,e,t),ie(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(ie(32969,e,t),ie(32968,e,t),ie(32971,e,t),ie(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(ie(32824,e,t),ie(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(ie(32938,e,t),ie(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,ie(2962,e,t),ie(2967,e,t),ie(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,ie(34816,e,t),ie(36003,e,t),ie(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,ie(2964,e,t),ie(2965,e,t),ie(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,ie(34817,e,t),ie(34818,e,t),ie(34819,e,t))},Cc={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),useProgram:(s,e)=>s({35725:e}),bindRenderbuffer:(s,e,t)=>s({36007:t}),bindTransformFeedback:(s,e,t)=>s({36389:t}),bindVertexArray:(s,e)=>s({34229:e}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({36006:t,36010:t});case 36009:return s({36006:t});case 36008:return s({36010:t});default:return null}},bindBuffer:(s,e,t)=>{const n={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return n?s({[n]:t}):{valueChanged:!0}},blendColor:(s,e,t,n,r)=>s({32773:new Float32Array([e,t,n,r])}),blendEquation:(s,e)=>s({32777:e,34877:e}),blendEquationSeparate:(s,e,t)=>s({32777:e,34877:t}),blendFunc:(s,e,t)=>s({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(s,e,t,n,r)=>s({32969:e,32968:t,32971:n,32970:r}),clearColor:(s,e,t,n,r)=>s({3106:new Float32Array([e,t,n,r])}),clearDepth:(s,e)=>s({2931:e}),clearStencil:(s,e)=>s({2961:e}),colorMask:(s,e,t,n,r)=>s({3107:[e,t,n,r]}),cullFace:(s,e)=>s({2885:e}),depthFunc:(s,e)=>s({2932:e}),depthRange:(s,e,t)=>s({2928:new Float32Array([e,t])}),depthMask:(s,e)=>s({2930:e}),frontFace:(s,e)=>s({2886:e}),lineWidth:(s,e)=>s({2849:e}),polygonOffset:(s,e,t)=>s({32824:e,10752:t}),sampleCoverage:(s,e,t)=>s({32938:e,32939:t}),scissor:(s,e,t,n,r)=>s({3088:new Int32Array([e,t,n,r])}),stencilMask:(s,e)=>s({2968:e,36005:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,n)=>s({2962:e,2967:t,2963:n,34816:e,36003:t,36004:n}),stencilFuncSeparate:(s,e,t,n,r)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:n,[e===1028?2963:36004]:r}),stencilOp:(s,e,t,n)=>s({2964:e,2965:t,2966:n,34817:e,34818:t,34819:n}),stencilOpSeparate:(s,e,t,n,r)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:n,[e===1028?2966:34819]:r}),viewport:(s,e,t,n,r)=>s({2978:[e,t,n,r]})},ze=(s,e)=>s.isEnabled(e),Pc={3042:ze,2884:ze,2929:ze,3024:ze,32823:ze,32926:ze,32928:ze,3089:ze,2960:ze,35977:ze},Zb=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Ts(s,e){if(Jb(e))return;const t={};for(const r in e){const i=Number(r),o=qb[r];o&&(typeof o=="string"?t[o]=!0:o(s,e[r],i))}const n=s.state&&s.state.cache;if(n)for(const r in t){const i=Kb[r];i(s,e,n)}}function eh(s,e=Lo){if(typeof e=="number"){const r=e,i=Pc[r];return i?i(s,r):s.getParameter(r)}const t=Array.isArray(e)?e:Object.keys(e),n={};for(const r of t){const i=Pc[r];n[r]=i?i(s,Number(r)):s.getParameter(Number(r))}return n}function Qb(s){Ts(s,Lo)}function Jb(s){for(const e in s)return!1;return!0}function Gb(s,e){if(s===e)return!0;const t=Array.isArray(s)||ArrayBuffer.isView(s),n=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&n&&s.length===e.length){for(let r=0;r<s.length;++r)if(s[r]!==e[r])return!1;return!0}return!1}class ev{constructor(e,{copyState:t=!1,log:n=()=>{}}={}){p(this,"gl");p(this,"program",null);p(this,"stateStack",[]);p(this,"enable",!0);p(this,"cache");p(this,"log");this.gl=e,this.cache=t?eh(e):Object.assign({},Lo),this.log=n,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){ee(this.stateStack.length>0);const e=this.stateStack[this.stateStack.length-1];Ts(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,n;const r=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const i in e){ee(i!==void 0);const o=e[i],a=this.cache[i];Gb(o,a)||(t=!0,n=a,r&&!(i in r)&&(r[i]=a),this.cache[i]=o)}return{valueChanged:t,oldValue:n}}}function Lt(s){return s.state}function th(s,e){const{enable:t=!0,copyState:n}=e;if(ee(n!==void 0),!s.state){s.state=new ev(s,{copyState:n}),sv(s);for(const i in Cc){const o=Cc[i];tv(s,i,o)}Mc(s,"getParameter"),Mc(s,"isEnabled")}const r=Lt(s);return r.enable=t,s}function Or(s){let e=Lt(s);e||(th(s,{copyState:!1}),e=Lt(s)),e.push()}function Js(s){const e=Lt(s);ee(e),e.pop()}function Mc(s,e){const t=s[e].bind(s);s[e]=function(r){if(r===void 0||Zb.has(r))return t(r);const i=Lt(s);return r in i.cache||(i.cache[r]=t(r)),i.enable?i.cache[r]:t(r)},Object.defineProperty(s[e],"name",{value:`${e}-from-cache`,configurable:!1})}function tv(s,e,t){if(!s[e])return;const n=s[e].bind(s);s[e]=function(...i){const o=Lt(s),{valueChanged:a,oldValue:c}=t(o._updateCache,...i);return a&&n(...i),c},Object.defineProperty(s[e],"name",{value:`${e}-to-cache`,configurable:!1})}function sv(s){const e=s.useProgram.bind(s);s.useProgram=function(n){const r=Lt(s);r.program!==n&&(e(n),r.program=n)}}const nv={powerPreference:"high-performance",onContextLost:()=>console.error("WebGL context lost"),onContextRestored:()=>console.info("WebGL context restored")};function rv(s,e){e={...nv,...e};let t=null;const n=i=>t=i.statusMessage||t;s.addEventListener("webglcontextcreationerror",n,!1);let r=null;if(r||(r=s.getContext("webgl2",e)),s.removeEventListener("webglcontextcreationerror",n,!1),!r)throw new Error(`Failed to create WebGL context: ${t||"Unknown error"}`);if(e.onContextLost){const{onContextLost:i}=e;s.addEventListener("webglcontextlost",o=>i(o),!1)}if(e.onContextRestored){const{onContextRestored:i}=e;s.addEventListener("webglcontextrestored",o=>i(o),!1)}return r}function Tt(s,e,t){return t[e]===void 0&&(t[e]=s.getExtension(e)||null),t[e]}function iv(s,e){const t=s.getParameter(7936),n=s.getParameter(7937);Tt(s,"WEBGL_debug_renderer_info",e);const r=e.WEBGL_debug_renderer_info,i=s.getParameter(r?r.UNMASKED_VENDOR_WEBGL:7936),o=s.getParameter(r?r.UNMASKED_RENDERER_WEBGL:7937),a=i||t,c=o||n,l=s.getParameter(7938),u=sh(a,c),h=ov(a,c),f=av(a,c);return{type:"webgl",gpu:u,gpuType:f,gpuBackend:h,vendor:a,renderer:c,version:l,shadingLanguage:"glsl",shadingLanguageVersion:300}}function sh(s,e){return/NVIDIA/i.exec(s)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(s)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(s)||/Apple/i.exec(e)?"apple":/AMD/i.exec(s)||/AMD/i.exec(e)||/ATI/i.exec(s)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(s)||/SwiftShader/i.exec(e)?"software":"unknown"}function ov(s,e){return/Metal/i.exec(s)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(s)||/ANGLE/i.exec(e)?"opengl":"unknown"}function av(s,e){if(/SwiftShader/i.exec(s)||/SwiftShader/i.exec(e))return"cpu";switch(sh(s,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function nh(s){switch(s){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(s))}const _e="texture-compression-bc",K="texture-compression-astc",We="texture-compression-etc2",cv="texture-compression-etc1-webgl",Rn="texture-compression-pvrtc-webgl",fi="texture-compression-atc-webgl",Ms="float32-renderable-webgl",di="float16-renderable-webgl",lv="rgb9e5ufloat_renderable-webgl",pi="snorm8-renderable-webgl",Os="norm16-renderable-webgl",_i="snorm16-renderable-webgl",In="float32-filterable",Oc="float16-filterable-webgl",Bs="WEBGL_compressed_texture_s3tc",Ls="WEBGL_compressed_texture_s3tc_srgb",es="EXT_texture_compression_rgtc",ts="EXT_texture_compression_bptc",uv="WEBGL_compressed_texture_etc",hv="WEBGL_compressed_texture_astc",fv="WEBGL_compressed_texture_etc1",dv="WEBGL_compressed_texture_pvrtc",pv="WEBGL_compressed_texture_atc",Nc="EXT_texture_norm16",kc="EXT_render_snorm",_v="EXT_color_buffer_float",Vo={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat_renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[kc],"norm16-renderable-webgl":[Nc],"snorm16-renderable-webgl":[Nc,kc],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[Bs,Ls,es,ts],"texture-compression-bc5-webgl":[es],"texture-compression-bc7-webgl":[ts],"texture-compression-etc2":[uv],"texture-compression-astc":[hv],"texture-compression-etc1-webgl":[fv],"texture-compression-pvrtc-webgl":[dv],"texture-compression-atc-webgl":[pv]};function gv(s){return s in Vo}function mv(s,e,t){return(Vo[e]||[]).every(r=>Tt(s,r,t))}const Nr={"rgb8unorm-unsized":{gl:6407,b:4,c:2,bpp:4,dataFormat:6407,types:[5121,33635]},"rgba8unorm-unsized":{gl:6408,b:4,c:2,bpp:4,dataFormat:6408,types:[5121,32819,32820]},r8unorm:{gl:33321,b:1,c:1,rb:!0},r8snorm:{gl:36756,b:1,c:1,render:pi},r8uint:{gl:33330,b:1,c:1,rb:!0},r8sint:{gl:33329,b:1,c:1,rb:!0},rg8unorm:{gl:33323,b:2,c:2,rb:!0},rg8snorm:{gl:36757,b:2,c:2,render:pi},rg8uint:{gl:33336,b:2,c:2,rb:!0},rg8sint:{gl:33335,b:2,c:2,rb:!0},r16uint:{gl:33332,b:2,c:1,rb:!0},r16sint:{gl:33331,b:2,c:1,rb:!0},r16float:{gl:33325,b:2,c:1,render:di,filter:"float16-filterable-webgl",rb:!0},"r16unorm-webgl":{gl:33322,b:2,c:1,f:Os,rb:!0},"r16snorm-webgl":{gl:36760,b:2,c:1,f:_i},"rgba4unorm-webgl":{gl:32854,b:2,c:4,wgpu:!1,rb:!0},"rgb565unorm-webgl":{gl:36194,b:2,c:4,wgpu:!1,rb:!0},"rgb5a1unorm-webgl":{gl:32855,b:2,c:4,wgpu:!1,rb:!0},"rgb8unorm-webgl":{gl:32849,b:3,c:3,wgpu:!1},"rgb8snorm-webgl":{gl:36758,b:3,c:3,wgpu:!1},rgba8unorm:{gl:32856,b:4,c:2,bpp:4},"rgba8unorm-srgb":{gl:35907,b:4,c:4,bpp:4},rgba8snorm:{gl:36759,b:4,c:4,render:pi},rgba8uint:{gl:36220,b:4,c:4,bpp:4},rgba8sint:{gl:36238,b:4,c:4,bpp:4},bgra8unorm:{b:4,c:4},"bgra8unorm-srgb":{b:4,c:4},rg16uint:{gl:33338,b:4,c:1,bpp:4},rg16sint:{gl:33337,b:4,c:2,bpp:4},rg16float:{gl:33327,bpp:4,b:4,c:2,render:di,filter:Oc,rb:!0},"rg16unorm-webgl":{gl:33324,b:2,c:2,render:Os},"rg16snorm-webgl":{gl:36761,b:2,c:2,render:_i},r32uint:{gl:33334,b:4,c:1,bpp:4,rb:!0},r32sint:{gl:33333,b:4,c:1,bpp:4,rb:!0},r32float:{gl:33326,bpp:4,b:4,c:1,render:Ms,filter:In},rgb9e5ufloat:{gl:35901,b:4,c:3,p:1,render:lv},rg11b10ufloat:{gl:35898,b:4,c:3,p:1,render:Ms,rb:!0},rgb10a2unorm:{gl:32857,b:4,c:4,p:1,rb:!0},"rgb10a2uint-webgl":{b:4,c:4,gl:36975,p:1,wgpu:!1,bpp:4,rb:!0},"rgb16unorm-webgl":{gl:32852,b:2,c:3,f:Os},"rgb16snorm-webgl":{gl:36762,b:2,c:3,f:Os},rg32uint:{gl:33340,b:8,c:2,rb:!0},rg32sint:{gl:33339,b:8,c:2,rb:!0},rg32float:{gl:33328,b:8,c:2,render:Ms,filter:In,rb:!0},rgba16uint:{gl:36214,b:8,c:4,rb:!0},rgba16sint:{gl:36232,b:8,c:4,rb:!0},rgba16float:{gl:34842,b:8,c:4,render:di,filter:Oc},"rgba16unorm-webgl":{gl:32859,b:2,c:4,render:Os,rb:!0},"rgba16snorm-webgl":{gl:36763,b:2,c:4,render:_i},"rgb32float-webgl":{gl:34837,render:Ms,filter:In,gl2ext:_v,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,b:16,c:4,rb:!0},rgba32sint:{gl:36226,b:16,c:4,rb:!0},rgba32float:{gl:34836,b:16,c:4,render:Ms,filter:In,rb:!0},stencil8:{gl:36168,b:1,c:1,attachment:36128,rb:!0},depth16unorm:{gl:33189,b:2,c:1,attachment:36096,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,b:3,c:1,attachment:36096,dataFormat:6402,types:[5125]},depth32float:{gl:36012,b:4,c:1,attachment:36096,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,b:4,c:2,p:1,attachment:33306,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth24unorm-stencil8":{gl:35056,b:4,c:2,p:1,attachment:33306,dataFormat:34041,types:[34042],rb:!0},"depth32float-stencil8":{gl:36013,b:5,c:2,p:1,attachment:33306,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:Bs,f:_e},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:Ls,f:_e},"bc1-rgba-unorm":{gl:33777,x:Bs,f:_e},"bc1-rgba-unorm-srgb":{gl:35916,x:Ls,f:_e},"bc2-rgba-unorm":{gl:33778,x:Bs,f:_e},"bc2-rgba-unorm-srgb":{gl:35918,x:Ls,f:_e},"bc3-rgba-unorm":{gl:33779,x:Bs,f:_e},"bc3-rgba-unorm-srgb":{gl:35919,x:Ls,f:_e},"bc4-r-unorm":{gl:36283,x:es,f:_e},"bc4-r-snorm":{gl:36284,x:es,f:_e},"bc5-rg-unorm":{gl:36285,x:es,f:_e},"bc5-rg-snorm":{gl:36286,x:es,f:_e},"bc6h-rgb-ufloat":{gl:36495,x:ts,f:_e},"bc6h-rgb-float":{gl:36494,x:ts,f:_e},"bc7-rgba-unorm":{gl:36492,x:ts,f:_e},"bc7-rgba-unorm-srgb":{gl:36493,x:ts,f:_e},"etc2-rgb8unorm":{gl:37492,f:We},"etc2-rgb8unorm-srgb":{gl:37494,f:We},"etc2-rgb8a1unorm":{gl:37496,f:We},"etc2-rgb8a1unorm-srgb":{gl:37497,f:We},"etc2-rgba8unorm":{gl:37493,f:We},"etc2-rgba8unorm-srgb":{gl:37495,f:We},"eac-r11unorm":{gl:37488,f:We},"eac-r11snorm":{gl:37489,f:We},"eac-rg11unorm":{gl:37490,f:We},"eac-rg11snorm":{gl:37491,f:We},"astc-4x4-unorm":{gl:37808,f:K},"astc-4x4-unorm-srgb":{gl:37840,f:K},"astc-5x4-unorm":{gl:37809,f:K},"astc-5x4-unorm-srgb":{gl:37841,f:K},"astc-5x5-unorm":{gl:37810,f:K},"astc-5x5-unorm-srgb":{gl:37842,f:K},"astc-6x5-unorm":{gl:37811,f:K},"astc-6x5-unorm-srgb":{gl:37843,f:K},"astc-6x6-unorm":{gl:37812,f:K},"astc-6x6-unorm-srgb":{gl:37844,f:K},"astc-8x5-unorm":{gl:37813,f:K},"astc-8x5-unorm-srgb":{gl:37845,f:K},"astc-8x6-unorm":{gl:37814,f:K},"astc-8x6-unorm-srgb":{gl:37846,f:K},"astc-8x8-unorm":{gl:37815,f:K},"astc-8x8-unorm-srgb":{gl:37847,f:K},"astc-10x5-unorm":{gl:37819,f:K},"astc-10x5-unorm-srgb":{gl:37851,f:K},"astc-10x6-unorm":{gl:37817,f:K},"astc-10x6-unorm-srgb":{gl:37849,f:K},"astc-10x8-unorm":{gl:37818,f:K},"astc-10x8-unorm-srgb":{gl:37850,f:K},"astc-10x10-unorm":{gl:37819,f:K},"astc-10x10-unorm-srgb":{gl:37851,f:K},"astc-12x10-unorm":{gl:37820,f:K},"astc-12x10-unorm-srgb":{gl:37852,f:K},"astc-12x12-unorm":{gl:37821,f:K},"astc-12x12-unorm-srgb":{gl:37853,f:K},"pvrtc-rgb4unorm-webgl":{gl:35840,f:Rn},"pvrtc-rgba4unorm-webgl":{gl:35842,f:Rn},"pvrtc-rbg2unorm-webgl":{gl:35841,f:Rn},"pvrtc-rgba2unorm-webgl":{gl:35843,f:Rn},"etc1-rbg-unorm-webgl":{gl:36196,f:cv},"atc-rgb-unorm-webgl":{gl:35986,f:fi},"atc-rgba-unorm-webgl":{gl:35986,f:fi},"atc-rgbai-unorm-webgl":{gl:34798,f:fi}},yv={6403:1,36244:1,33319:2,33320:2,6407:3,36248:3,6408:4,36249:4,6402:1,34041:1,6406:1,6409:1,6410:2},Tv={5126:4,5125:4,5124:4,5123:2,5122:2,5131:2,5120:1,5121:1};function $o(s,e,t){const n=Nr[e];if(!n||n.gl===void 0)return!1;const r=n.x||n.gl2ext;return r?!!Tt(s,r,t):!0}function rh(s){const e=Nr[s],t=e==null?void 0:e.gl;if(t===void 0)throw new Error(`Unsupported texture format ${s}`);return t}function bv(s,e,t){if(!$o(s,e,t)||e.startsWith("depth")||e.startsWith("stencil"))return!1;try{if(Wl(e).signed)return!1}catch{return!1}return e.endsWith("32float")?!!Tt(s,"OES_texture_float_linear, extensions",t):e.endsWith("16float")?!!Tt(s,"OES_texture_half_float_linear, extensions",t):!0}function vv(s,e,t){return!(!$o(s,e,t)||typeof e=="number")}function hr(s){var r;const e=Nr[s],t=rh(s),n=Wl(s);return{format:t,dataFormat:(e==null?void 0:e.dataFormat)||Av(n.format,n.integer,n.normalized,t),type:n.dataType?nh(n.dataType):((r=e==null?void 0:e.types)==null?void 0:r[0])||5121,compressed:n.compressed}}function wv(s){const e=Nr[s];if(!(e!=null&&e.attachment))throw new Error(`${s} is not a depth stencil format`);return e.attachment}function Dc(s){const e=hr(s),t=yv[e.dataFormat]||4,n=Tv[e.type]||1;return t*n}function Av(s,e,t,n){if(n===6408||n===6407)return n;switch(s){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;default:return 6408}}const Fc={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class Ev extends O_{constructor(t,n,r){super([],r);p(this,"gl");p(this,"extensions");p(this,"testedFeatures",new Set);this.gl=t,this.extensions=n,Tt(t,"EXT_color_buffer_float",n)}*[Symbol.iterator](){const t=this.getFeatures();for(const n of t)this.has(n)&&(yield n);return[]}has(t){return this.disabledFeatures[t]?!1:(this.testedFeatures.has(t)||(this.testedFeatures.add(t),gv(t)&&mv(this.gl,t,this.extensions)&&this.features.add(t),this.getWebGLFeature(t)&&this.features.add(t)),this.features.has(t))}initializeFeatures(){const t=this.getFeatures().filter(n=>n!=="polygon-mode-webgl");for(const n of t)this.has(n)}getFeatures(){return[...Object.keys(Fc),...Object.keys(Vo)]}getWebGLFeature(t){const n=Fc[t];return typeof n=="string"?!!Tt(this.gl,n,this.extensions):!!n}}class Sv extends M_{constructor(t){super();p(this,"gl");p(this,"limits",{});this.gl=t}get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}getParameter(t){return this.limits[t]===void 0&&(this.limits[t]=this.gl.getParameter(t)),this.limits[t]}}function dt(s,e,t){if(xv(e))return t(s);const{nocatch:n=!0}=e;Or(s),Ts(s,e);let r;if(n)r=t(s),Js(s);else try{r=t(s)}finally{Js(s)}return r}function xv(s){for(const e in s)return!1;return!0}function Rv(s,e,t,n){if(jn(e))return n(s);const r=s;Or(r.gl);try{return Iv(s,e),Ts(r.gl,t),n(s)}finally{Js(r.gl)}}function Iv(s,e){const t=s,{gl:n}=t;if(e.cullMode)switch(e.cullMode){case"none":n.disable(2884);break;case"front":n.enable(2884),n.cullFace(1028);break;case"back":n.enable(2884),n.cullFace(1029);break}if(e.frontFace&&n.frontFace(kt("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&s.features.has("depth-clip-control")&&n.enable(34383),e.depthBias!==void 0&&(n.enable(32823),n.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&s.features.has("provoking-vertex-webgl")){const i=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,o=kt("provokingVertex",e.provokingVertex,{first:36429,last:36430});i==null||i.provokingVertexWEBGL(o)}if((e.polygonMode||e.polygonOffsetLine)&&s.features.has("polygon-mode-webgl")){if(e.polygonMode){const i=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,o=kt("polygonMode",e.polygonMode,{fill:6914,line:6913});i==null||i.polygonModeWEBGL(1028,o),i==null||i.polygonModeWEBGL(1029,o)}e.polygonOffsetLine&&n.enable(10754)}if(s.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&n.enable(12288),e.clipDistance1&&n.enable(12289),e.clipDistance2&&n.enable(12290),e.clipDistance3&&n.enable(12291),e.clipDistance4&&n.enable(12292),e.clipDistance5&&n.enable(12293),e.clipDistance6&&n.enable(12294),e.clipDistance7&&n.enable(12295)),e.depthWriteEnabled!==void 0&&n.depthMask(Pv("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?n.enable(2929):n.disable(2929),n.depthFunc(eo("depthCompare",e.depthCompare))),e.stencilWriteMask){const r=e.stencilWriteMask;n.stencilMaskSeparate(1028,r),n.stencilMaskSeparate(1029,r)}if(e.stencilReadMask&&D.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const r=e.stencilReadMask||4294967295,i=eo("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?n.enable(2960):n.disable(2960),n.stencilFuncSeparate(1028,i,0,r),n.stencilFuncSeparate(1029,i,0,r)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const r=gi("stencilPassOperation",e.stencilPassOperation),i=gi("stencilFailOperation",e.stencilFailOperation),o=gi("stencilDepthFailOperation",e.stencilDepthFailOperation);n.stencilOpSeparate(1028,i,o,r),n.stencilOpSeparate(1029,i,o,r)}if(e.blendColorOperation||e.blendAlphaOperation){n.enable(3042);const r=Uc("blendColorOperation",e.blendColorOperation||"add"),i=Uc("blendAlphaOperation",e.blendAlphaOperation||"add");n.blendEquationSeparate(r,i);const o=Cn("blendColorSrcFactor",e.blendColorSrcFactor||"one"),a=Cn("blendColorDstFactor",e.blendColorDstFactor||"zero"),c=Cn("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),l=Cn("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");n.blendFuncSeparate(o,a,c,l)}}function eo(s,e){return kt(s,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function gi(s,e){return kt(s,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function Uc(s,e){return kt(s,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function Cn(s,e){return kt(s,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function Cv(s,e){return`Illegal parameter ${e} for ${s}`}function kt(s,e,t){if(!(e in t))throw new Error(Cv(s,e));return t[e]}function Pv(s,e){return e}function ih(s){const e={};return s.addressModeU&&(e[10242]=mi(s.addressModeU)),s.addressModeV&&(e[10243]=mi(s.addressModeV)),s.addressModeW&&(e[32882]=mi(s.addressModeW)),s.magFilter&&(e[10240]=oh(s.magFilter)),(s.minFilter||s.mipmapFilter)&&(e[10241]=Mv(s.minFilter||"linear",s.mipmapFilter)),s.lodMinClamp!==void 0&&(e[33082]=s.lodMinClamp),s.lodMaxClamp!==void 0&&(e[33083]=s.lodMaxClamp),s.type==="comparison-sampler"&&(e[34892]=34894),s.compare&&(e[34893]=eo("compare",s.compare)),s.maxAnisotropy&&(e[34046]=s.maxAnisotropy),e}function mi(s){switch(s){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function oh(s){switch(s){case"nearest":return 9728;case"linear":return 9729}}function Mv(s,e){if(!e)return oh(s);switch(s){case"nearest":return e==="nearest"?9984:9986;case"linear":return e==="nearest"?9985:9987}}class gt extends se{constructor(t,n={}){super(t,n);p(this,"device");p(this,"gl");p(this,"handle");p(this,"glTarget");p(this,"glUsage");p(this,"glIndexType",5123);p(this,"byteLength");p(this,"bytesUsed");this.device=t,this.gl=this.device.gl;const r=typeof n=="object"?n.handle:void 0;this.handle=r||this.gl.createBuffer(),t.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=Ov(this.props.usage),this.glUsage=Nv(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,n.data?this._initWithData(n.data,n.byteOffset,n.byteLength):this._initWithByteLength(n.byteLength||0)}_initWithData(t,n=0,r=t.byteLength+n){const i=this.glTarget;this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,r,this.glUsage),this.gl.bufferSubData(i,n,t),this.gl.bindBuffer(i,null),this.bytesUsed=r,this.byteLength=r,this._setDebugData(t,n,r),this.trackAllocatedMemory(r)}_initWithByteLength(t){ee(t>=0);let n=t;t===0&&(n=new Float32Array(0));const r=this.glTarget;return this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,n,this.glUsage),this.gl.bindBuffer(r,null),this.bytesUsed=t,this.byteLength=t,this._setDebugData(null,0,t),this.trackAllocatedMemory(t),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(t,n=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,n,t),this.gl.bindBuffer(36663,null),this._setDebugData(t,n,t.byteLength)}async readAsync(t=0,n){return this.readSyncWebGL(t,n)}readSyncWebGL(t=0,n){n=n??this.byteLength-t;const r=new Uint8Array(n),i=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,r,i,n),this.gl.bindBuffer(36662,null),this._setDebugData(r,t,n),r}}function Ov(s){return s&se.INDEX?34963:s&se.VERTEX?34962:s&se.UNIFORM?35345:34962}function Nv(s){return s&se.INDEX||s&se.VERTEX?35044:s&se.UNIFORM?35048:35044}class to extends qn{constructor(t,n){super(t,n);p(this,"device");p(this,"handle");p(this,"parameters");this.device=t,this.parameters=ih(n),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(t){for(const[n,r]of Object.entries(t)){const i=Number(n);switch(i){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,i,r);break;default:this.device.gl.samplerParameteri(this.handle,i,r);break}}}}class ss extends Xn{constructor(t,n){super(t,{...xe.defaultProps,...n});p(this,"device");p(this,"gl");p(this,"handle");p(this,"texture");this.device=t,this.gl=this.device.gl,this.handle=null,this.texture=n.texture}}const kv={parameters:{},pixelStore:{},pixels:null,border:0,dataFormat:void 0,textureUnit:void 0,target:void 0},qs=class qs extends xe{constructor(t,n){var r;super(t,{...kv,format:"rgba8unorm",...n});p(this,"MAX_ATTRIBUTES");p(this,"device");p(this,"gl");p(this,"handle");p(this,"sampler");p(this,"view");p(this,"glFormat");p(this,"type");p(this,"dataFormat");p(this,"mipmaps");p(this,"target");p(this,"textureUnit");p(this,"loaded",!1);p(this,"_video");this.device=t,this.gl=this.device.gl,this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glFormat=6408,this.target=Dv(this.props),this.loaded=!1,typeof((r=this.props)==null?void 0:r.data)=="string"&&Object.assign(this.props,{data:Tg(this.props.data)}),this.initialize(this.props),Object.seal(this)}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}toString(){return`Texture(${this.id},${this.width}x${this.height})`}createView(t){return new ss(this.device,{...t,texture:this})}initialize(t={}){if(this.props.dimension==="cube")return this.initializeCube(t);let n=t.data;if(n instanceof Promise)return n.then(C=>this.initialize(Object.assign({},t,{pixels:C,data:C}))),this;const r=typeof HTMLVideoElement<"u"&&n instanceof HTMLVideoElement;if(r&&n.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,n.addEventListener("loadeddata",()=>this.initialize(t)),this;const{parameters:i={}}=t,{pixels:o=null,pixelStore:a={},textureUnit:c=void 0,mipmaps:l=!0}=t;n||(n=o);let{width:u,height:h,dataFormat:f,type:_,compressed:T=!1}=t;const{depth:v=0}=t,R=rh(t.format);return{width:u,height:h,compressed:T,dataFormat:f,type:_}=this._deduceParameters({format:t.format,type:_,dataFormat:f,compressed:T,data:n,width:u,height:h}),this.width=u,this.height=h,this.glFormat=R,this.type=_,this.dataFormat=f,this.textureUnit=c,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),this.mipmaps=l,this.setImageData({data:n,width:u,height:h,depth:v,format:t.format,type:_,dataFormat:f,parameters:a,compressed:T}),this.setSampler(t.sampler),this._setSamplerParameters(i),this.view=this.createView({...this.props,mipLevelCount:1,arrayLayerCount:1}),l&&this.device.isTextureFormatFilterable(t.format)&&this.generateMipmap(),r&&(this._video={video:n,parameters:i,lastTime:n.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?n.currentTime:-1}),this}initializeCube(t){const{mipmaps:n=!0,parameters:r={}}=t;return this.setCubeMapImageData(t).then(()=>{this.loaded=!0,n&&this.generateMipmap(t),this.setSampler(t.sampler),this._setSamplerParameters(r)}),this}setSampler(t={}){let n;t instanceof to?(this.sampler=t,n=t.props):(this.sampler=new to(this.device,t),n=t);const r=ih(n);return this._setSamplerParameters(r),this}resize(t){const{height:n,width:r,mipmaps:i=!1}=t;return r!==this.width||n!==this.height?this.initialize({width:r,height:n,format:this.format,type:this.type,dataFormat:this.dataFormat,mipmaps:i}):this}update(){if(this._video){const{video:t,parameters:n,lastTime:r}=this._video;if(r===t.currentTime||t.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:t,parameters:n}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=t.currentTime}}generateMipmap(t={}){return this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),dt(this.gl,t,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this}setImageData(t){if(this.props.dimension==="3d"||this.props.dimension==="2d-array")return this.setImageData3D(t);this.trackDeallocatedMemory("Texture");const{target:n=this.target,pixels:r=null,level:i=0,glFormat:o=this.glFormat,offset:a=0,parameters:c={}}=t;let{data:l=null,type:u=this.type,width:h=this.width,height:f=this.height,dataFormat:_=this.dataFormat,compressed:T=!1}=t;l||(l=r),{type:u,dataFormat:_,compressed:T,width:h,height:f}=this._deduceParameters({format:this.props.format,type:u,dataFormat:_,compressed:T,data:l,width:h,height:f});const{gl:v}=this;v.bindTexture(this.target,this.handle);let R=null;if({data:l,dataType:R}=this._getDataType({data:l,compressed:T}),dt(this.gl,c,()=>{switch(R){case"null":v.texImage2D(n,i,o,h,f,0,_,u,l);break;case"typed-array":v.texImage2D(n,i,o,h,f,0,_,u,l,a);break;case"buffer":this.device.gl.bindBuffer(35052,l.handle||l),this.device.gl.texImage2D(n,i,o,h,f,0,_,u,a),this.device.gl.bindBuffer(35052,null);break;case"browser-object":v.texImage2D(n,i,o,h,f,0,_,u,l);break;case"compressed":for(const[C,I]of l.entries())v.compressedTexImage2D(n,C,I.format,I.width,I.height,0,I.data);break;default:ee(!1,"Unknown image data type")}}),l&&l.byteLength)this.trackAllocatedMemory(l.byteLength,"Texture");else{const C=Dc(this.props.format);this.trackAllocatedMemory(this.width*this.height*C,"Texture")}return this.loaded=!0,this}setSubImageData({target:t=this.target,pixels:n=null,data:r=null,x:i=0,y:o=0,width:a=this.width,height:c=this.height,level:l=0,glFormat:u=this.glFormat,type:h=this.type,dataFormat:f=this.dataFormat,compressed:_=!1,offset:T=0,parameters:v={}}){if({type:h,dataFormat:f,compressed:_,width:a,height:c}=this._deduceParameters({format:this.props.format,type:h,dataFormat:f,compressed:_,data:r,width:a,height:c}),ee(this.depth===1,"texSubImage not supported for 3D textures"),r||(r=n),r&&r.data){const R=r;r=R.data,a=R.shape[0],c=R.shape[1]}r instanceof gt&&(r=r.handle),this.gl.bindTexture(this.target,this.handle),dt(this.gl,v,()=>{_?this.gl.compressedTexSubImage2D(t,l,i,o,a,c,u,r):r===null?this.gl.texSubImage2D(t,l,i,o,a,c,f,h,null):ArrayBuffer.isView(r)?this.gl.texSubImage2D(t,l,i,o,a,c,f,h,r,T):typeof WebGLBuffer<"u"&&r instanceof WebGLBuffer?(this.device.gl.bindBuffer(35052,r),this.device.gl.texSubImage2D(t,l,i,o,a,c,f,h,T),this.device.gl.bindBuffer(35052,null)):this.device.gl.texSubImage2D(t,l,i,o,a,c,f,h,r)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(t={}){return D.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(t=this.textureUnit){const{gl:n}=this;return t!==void 0&&(this.textureUnit=t,n.activeTexture(33984+t)),n.bindTexture(this.target,this.handle),t}unbind(t=this.textureUnit){const{gl:n}=this;return t!==void 0&&(this.textureUnit=t,n.activeTexture(33984+t)),n.bindTexture(this.target,null),t}_getDataType({data:t,compressed:n=!1}){return n?{data:t,dataType:"compressed"}:t===null?{data:t,dataType:"null"}:ArrayBuffer.isView(t)?{data:t,dataType:"typed-array"}:t instanceof gt?{data:t.handle,dataType:"buffer"}:typeof WebGLBuffer<"u"&&t instanceof WebGLBuffer?{data:t,dataType:"buffer"}:{data:t,dataType:"browser-object"}}_deduceParameters(t){const{format:n,data:r}=t;let{width:i,height:o,dataFormat:a,type:c,compressed:l}=t;const u=hr(n);return a=a||u.dataFormat,c=c||u.type,l=l||u.compressed,{width:i,height:o}=this._deduceImageSize(r,i,o),{dataFormat:a,type:c,compressed:l,width:i,height:o,format:n,data:r}}_deduceImageSize(t,n,r){let i;return typeof ImageData<"u"&&t instanceof ImageData?i={width:t.width,height:t.height}:typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement?i={width:t.naturalWidth,height:t.naturalHeight}:typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement?i={width:t.width,height:t.height}:typeof ImageBitmap<"u"&&t instanceof ImageBitmap?i={width:t.width,height:t.height}:typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement?i={width:t.videoWidth,height:t.videoHeight}:t?i={width:n,height:r}:i={width:n>=0?n:1,height:r>=0?r:1},ee(i,"Could not deduced texture size"),ee(n===void 0||i.width===n,"Deduced texture width does not match supplied width"),ee(r===void 0||i.height===r,"Deduced texture height does not match supplied height"),i}async setCubeMapImageData(t){const{gl:n}=this,{width:r,height:i,pixels:o,data:a,format:c=6408,type:l=5121}=t,u=o||a,h=await Promise.all(qs.FACES.map(f=>{const _=u[f];return Promise.all(Array.isArray(_)?_:[_])}));this.bind(),qs.FACES.forEach((f,_)=>{h[_].length>1&&this.props.mipmaps!==!1&&D.warn(`${this.id} has mipmap and multiple LODs.`)(),h[_].forEach((T,v)=>{r&&i?n.texImage2D(f,v,c,r,i,0,c,l,T):n.texImage2D(f,v,c,c,l,T)})}),this.unbind()}setImageDataForFace(t){const{face:n,width:r,height:i,pixels:o,data:a,format:c=6408,type:l=5121}=t,{gl:u}=this,h=o||a;return this.bind(),h instanceof Promise?h.then(f=>this.setImageDataForFace(Object.assign({},t,{face:n,data:f,pixels:f}))):this.width||this.height?u.texImage2D(n,0,c,r,i,0,c,l,h):u.texImage2D(n,0,c,c,l,h),this}setImageData3D(t){const{level:n=0,dataFormat:r,format:i,type:o,width:a,height:c,depth:l=1,offset:u=0,data:h,parameters:f={}}=t;this.trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle);const _=hr(i);if(dt(this.gl,f,()=>{ArrayBuffer.isView(h)&&this.gl.texImage3D(this.target,n,_.format,a,c,l,0,_.dataFormat,_.type,h),h instanceof gt&&(this.gl.bindBuffer(35052,h.handle),this.gl.texImage3D(this.target,n,r,a,c,l,0,i,o,u))}),h&&h.byteLength)this.trackAllocatedMemory(h.byteLength,"Texture");else{const T=Dc(this.props.format);this.trackAllocatedMemory(this.width*this.height*this.depth*T,"Texture")}return this.loaded=!0,this}_setSamplerParameters(t){if(!jn(t)){Fv(t),this.gl.bindTexture(this.target,this.handle);for(const[n,r]of Object.entries(t)){const i=Number(n),o=r;switch(i){case 33082:case 33083:this.gl.texParameterf(this.target,i,o);break;default:this.gl.texParameteri(this.target,i,o);break}}this.gl.bindTexture(this.target,null)}}};p(qs,"FACES",[34069,34070,34071,34072,34073,34074]);let qe=qs;function Dv(s){switch(s.dimension){case"2d":return 3553;case"cube":return 34067;case"2d-array":return 35866;case"3d":return 32879;case"1d":case"cube-array":default:throw new Error(s.dimension)}}function Fv(s){D.log(1,"texture sampler parameters",s)()}class Hs extends Kn{constructor(t,n){super(t,n);p(this,"device");p(this,"gl");p(this,"handle");const r=n.handle===null;if(this.device=t,this.gl=t.gl,this.handle=this.props.handle||r?this.props.handle:this.gl.createFramebuffer(),!r){t.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures();const i=this.gl.bindFramebuffer(36160,this.handle);for(let o=0;o<this.colorAttachments.length;++o){const a=this.colorAttachments[o],c=36064+o;a&&this._attachOne(c,a)}if(this.depthStencilAttachment&&this._attachOne(wv(this.depthStencilAttachment.props.format),this.depthStencilAttachment),n.check!==!1){const o=this.gl.checkFramebufferStatus(36160);if(o!==36053)throw new Error(`Framebuffer ${Bv(o)}`)}this.gl.bindFramebuffer(36160,i)}}get texture(){return this.colorAttachments[0]}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}createDepthStencilTexture(t){return new qe(this.device,{id:`${this.id}-depth-stencil`,format:t,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(t,n){if(this.handle===null)return this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),n===void 0&&(n=this.gl.drawingBufferHeight);for(const r of this.colorAttachments)r.texture.resize({width:t,height:n});return this.depthStencilAttachment&&this.depthStencilAttachment.texture.resize({width:t,height:n}),this}_attachOne(t,n){if(Array.isArray(n)){const[r,i=0,o=0]=n;return this._attachTexture(t,r,i,o),r}if(n instanceof qe)return this._attachTexture(t,n,0,0),n;if(n instanceof ss){const r=n;return this._attachTexture(t,r.texture,r.props.baseMipLevel,r.props.baseArrayLayer),n.texture}throw new Error("attach")}_attachTexture(t,n,r,i){const{gl:o}=this.device;switch(o.bindTexture(n.target,n.handle),n.target){case 35866:case 32879:o.framebufferTextureLayer(36160,t,n.target,i,r);break;case 34067:const a=Uv(r);o.framebufferTexture2D(36160,t,a,n.handle,i);break;case 3553:o.framebufferTexture2D(36160,t,3553,n.handle,i);break;default:ee(!1,"Illegal texture type")}o.bindTexture(n.target,null)}}function Uv(s){return s<34069?s+34069:s}function Bv(s){switch(s){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${s}`}}class Lv extends vo{constructor(t,n){super(n);p(this,"device");p(this,"presentationSize");p(this,"_framebuffer",null);this.device=t,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new Hs(this.device,{handle:null}),this._framebuffer}update(){const t=this.getPixelSize();(t[0]!==this.presentationSize[0]||t[1]!==this.presentationSize[1])&&(this.presentationSize=t,this.resize())}resize(t){if(this.device.gl&&this.canvas){const n=this.getDevicePixelRatio(t==null?void 0:t.useDevicePixels);this.setDevicePixelRatio(n,t);return}}commit(){}}const Vv={spector:D.get("spector")||D.get("spectorjs")},$v="https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",zv=1;let Z=null,Bc=!1;async function Wv(s){if(!globalThis.SPECTOR)try{await Ql($v)}catch(e){D.warn(String(e))}}function Hv(s){if(s={...Vv,...s},!(s!=null&&s.spector)||(!Z&&globalThis.SPECTOR&&(D.probe(zv,"SPECTOR found and initialized")(),Z=new globalThis.SPECTOR.Spector,globalThis.luma&&(globalThis.luma.spector=Z)),!Z))return null;if(Bc||(Bc=!0,Z.spyCanvases(),Z==null||Z.onCaptureStarted.add(e=>D.info("Spector capture started:",e)()),Z==null||Z.onCapture.add(e=>{D.info("Spector capture complete:",e)(),Z==null||Z.getResultUI(),Z==null||Z.resultView.display(),Z==null||Z.resultView.addCapture(e)})),s!=null&&s.canvas){if(typeof s.spector=="string"&&s.spector!==s.canvas.id)return Z;Z==null||Z.startCapture(s==null?void 0:s.canvas,500),new Promise(e=>setTimeout(e,2e3)).then(e=>{D.info("Spector capture stopped after 2 seconds")(),Z==null||Z.stopCapture()})}return Z}const jv="https://unpkg.com/webgl-debug@2.0.1/index.js";function ah(s){return s.luma=s.luma||{},s.luma}async function Xv(){bt()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await Ql(jv))}function Yv(s,e={}){return s?e.debug?Kv(s,e):qv(s):null}function qv(s){const e=ah(s);return e.realContext?e.realContext:s}function Kv(s,e){if(!globalThis.WebGLDebugUtils)return D.warn("webgl-debug not loaded")(),s;const t=ah(s);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...Gt,...s});const n=globalThis.WebGLDebugUtils.makeDebugContext(s,Zv.bind(null,e),Qv.bind(null,e));for(const o in Gt)!(o in n)&&typeof Gt[o]=="number"&&(n[o]=Gt[o]);class r{}Object.setPrototypeOf(n,Object.getPrototypeOf(s)),Object.setPrototypeOf(r,n);const i=Object.create(r);return t.realContext=s,t.debugContext=i,i.debug=!0,i}function yi(s,e){e=Array.from(e).map(n=>n===void 0?"undefined":n);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(s,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${s}(${t})`}function Zv(s,e,t,n){n=Array.from(n).map(a=>a===void 0?"undefined":a);const r=globalThis.WebGLDebugUtils.glEnumToString(e),i=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,n),o=`${r} in gl.${t}(${i})`;D.error(o)();debugger;if(s.throwOnError)throw new Error(o)}function Qv(s,e,t){let n="";if(D.level>=1&&(n=yi(e,t),D.log(1,n)()),s.break&&s.break.length>0&&(n=n||yi(e,t),s.break.every(i=>n.indexOf(i)!==-1)))debugger;for(const r of t)if(r===void 0){if(n=n||yi(e,t),s.throwOnError)throw new Error(`Undefined argument: ${n}`);D.error(`Undefined argument: ${n}`)();debugger}}function Jv(s){const e=s.split(/\r?\n/),t=[];for(const n of e){if(n.length<=1)continue;const r=n.split(":");if(r.length===2){const[h,f]=r;t.push({message:f.trim(),type:Lc(h),lineNum:0,linePos:0});continue}const[i,o,a,...c]=r;let l=parseInt(a,10);isNaN(l)&&(l=0);let u=parseInt(o,10);isNaN(u)&&(u=0),t.push({message:c.join(":").trim(),type:Lc(i),lineNum:l,linePos:u})}return t}function Lc(s){const e=["warning","error","info"],t=s.toLowerCase();return e.includes(t)?t:"info"}class Gv extends Yn{constructor(t,n){super(t,n);p(this,"device");p(this,"handle");switch(this.device=t,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const t=this.device.gl.getShaderInfoLog(this.handle);return Jv(t)}getTranslatedSource(){const n=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return n==null?void 0:n.getTranslatedShaderSource(this.handle)}async _compile(t){t=(i=>i.startsWith("#version ")?i:`#version 100
${i}`)(t);const{gl:r}=this.device;if(r.shaderSource(this.handle,t),r.compileShader(this.handle),D.level===0){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}D.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),D.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const t=async i=>await new Promise(o=>setTimeout(o,i));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:r}=this.device;for(;;){if(r.getShaderParameter(this.handle,37297))return;await t(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}const e0=256,t0=1024,s0=16384,Ti=6144,n0=[1,2,4,8];class r0 extends ki{constructor(t,n){super(t,n);p(this,"device");p(this,"glParameters");this.device=t,Or(this.device.gl),this.setParameters(this.props.parameters),this.clear()}end(){Js(this.device.gl)}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}setParameters(t={}){const n={...this.glParameters};this.props.framebuffer&&(n.framebuffer=this.props.framebuffer),this.props.depthReadOnly&&(n.depthMask=!this.props.depthReadOnly),n.stencilMask=this.props.stencilReadOnly?0:1,n[35977]=this.props.discard,t.viewport&&(t.viewport.length>=6?(n.viewport=t.viewport.slice(0,4),n.depthRange=[t.viewport[4],t.viewport[5]]):n.viewport=t.viewport),t.scissorRect&&(n.scissorTest=!0,n.scissor=t.scissorRect),t.blendConstant&&(n.blendColor=t.blendConstant),t.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),t[2967]=t.stencilReference),t.colorMask&&(n.colorMask=n0.map(r=>!!(r&t.colorMask))),this.glParameters=n,Ts(this.device.gl,n)}beginOcclusionQuery(t){const n=this.props.occlusionQuerySet;n==null||n.beginOcclusionQuery()}endOcclusionQuery(){const t=this.props.occlusionQuerySet;t==null||t.endOcclusionQuery()}clear(){const t={...this.glParameters};let n=0;this.props.clearColor!==!1&&(n|=s0,t.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(n|=e0,t.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(n|=t0,t.clearStencil=this.props.clearStencil),n!==0&&dt(this.device.gl,t,()=>{this.device.gl.clear(n)})}clearColorBuffer(t=0,n=[0,0,0,0]){dt(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(n.constructor){case Int32Array:this.device.gl.clearBufferiv(Ti,t,n);break;case Uint32Array:this.device.gl.clearBufferuiv(Ti,t,n);break;case Float32Array:default:this.device.gl.clearBufferfv(Ti,t,n);break}})}}const i0="Failed to deduce GL constant from typed array";function o0(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(i0)}}function so(s,e){const{clamped:t=!0}=e||{};switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}const a0={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},c0={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class js{constructor(...e){p(this,"offset");p(this,"stride");p(this,"type");p(this,"size");p(this,"divisor");p(this,"normalized");p(this,"integer");p(this,"buffer");p(this,"index");e.forEach(t=>this._assign(t)),Object.freeze(this)}static getBytesPerElement(e){return so(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return ee(e.size),so(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(...e){return new js(a0,...e)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return js.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return js.getBytesPerVertex(this)}_assign(e={}){return e=mg("Accessor",e,c0),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalize!==void 0&&(this.normalized=e.normalize),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this.offset===void 0&&delete this.offset,this.stride===void 0&&delete this.stride,this.type===void 0&&delete this.type,this.size===void 0&&delete this.size,this.divisor===void 0&&delete this.divisor,this.normalized===void 0&&delete this.normalized,this.integer===void 0&&delete this.integer,this.buffer===void 0&&delete this.buffer,this.index===void 0&&delete this.index,this}}function l0(s){return u0.includes(s)}const u0=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],ch={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function lh(s){const e=ch[s];if(!e)throw new Error("uniform");const[t,n,,r]=e;return{format:r,components:n,glType:t}}function h0(s){const e=ch[s];if(!e)throw new Error("attribute");const[,t,,n,r]=e;return{attributeType:n,vertexFormat:r,components:t}}function f0(s,e){const t={attributes:[],bindings:[]};t.attributes=d0(s,e);const n=g0(s,e);for(const a of n){const c=a.uniforms.map(l=>({name:l.name,format:l.format,byteOffset:l.byteOffset,byteStride:l.byteStride,arrayLength:l.arrayLength}));t.bindings.push({type:"uniform",name:a.name,location:a.location,visibility:(a.vertex?1:0)&(a.fragment?2:0),minBindingSize:a.byteLength,uniforms:c})}const r=_0(s,e);let i=0;for(const a of r)if(l0(a.type)){const{viewDimension:c,sampleType:l}=y0(a.type);t.bindings.push({type:"texture",name:a.name,location:i,viewDimension:c,sampleType:l}),a.textureUnit=i,i+=1}r.length&&(t.uniforms=r);const o=p0(s,e);return o!=null&&o.length&&(t.varyings=o),t}function d0(s,e){const t=[],n=s.getProgramParameter(e,35721);for(let r=0;r<n;r++){const i=s.getActiveAttrib(e,r);if(!i)throw new Error("activeInfo");const{name:o,type:a}=i,c=s.getAttribLocation(e,o);if(c>=0){const{attributeType:l}=h0(a),u=/instance/i.test(o)?"instance":"vertex";t.push({name:o,location:c,stepMode:u,type:l})}}return t.sort((r,i)=>r.location-i.location),t}function p0(s,e){const t=[],n=s.getProgramParameter(e,35971);for(let r=0;r<n;r++){const i=s.getTransformFeedbackVarying(e,r);if(!i)throw new Error("activeInfo");const{name:o,type:a,size:c}=i,{glType:l,components:u}=lh(a),h=new js({type:l,size:c*u}),f={location:r,name:o,accessor:h};t.push(f)}return t.sort((r,i)=>r.location-i.location),t}function _0(s,e){const t=[],n=s.getProgramParameter(e,35718);for(let r=0;r<n;r++){const i=s.getActiveUniform(e,r);if(!i)throw new Error("activeInfo");const{name:o,size:a,type:c}=i,{name:l,isArray:u}=T0(o);let h=s.getUniformLocation(e,l);const f={location:h,name:l,size:a,type:c,isArray:u};if(t.push(f),f.size>1)for(let _=0;_<f.size;_++){const T=`${l}[${_}]`;h=s.getUniformLocation(e,T);const v={...f,name:T,location:h};t.push(v)}}return t}function g0(s,e){const t=(i,o)=>s.getActiveUniformBlockParameter(e,i,o),n=[],r=s.getProgramParameter(e,35382);for(let i=0;i<r;i++){const o={name:s.getActiveUniformBlockName(e,i)||"",location:t(i,35391),byteLength:t(i,35392),vertex:t(i,35396),fragment:t(i,35398),uniformCount:t(i,35394),uniforms:[]},a=t(i,35395)||[],c=s.getActiveUniforms(e,a,35383),l=s.getActiveUniforms(e,a,35384),u=s.getActiveUniforms(e,a,35387),h=s.getActiveUniforms(e,a,35388);for(let f=0;f<o.uniformCount;++f){const _=s.getActiveUniform(e,a[f]);if(!_)throw new Error("activeInfo");o.uniforms.push({name:_.name,format:lh(c[f]).format,type:c[f],arrayLength:l[f],byteOffset:u[f],byteStride:h[f]})}n.push(o)}return n.sort((i,o)=>i.location-o.location),n}const m0={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function y0(s){const e=m0[s];if(!e)throw new Error("sampler");const[t,n]=e;return{viewDimension:t,sampleType:n}}function T0(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(s);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${s}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function b0(s,e,t,n){const r=s;let i=n;i===!0&&(i=1),i===!1&&(i=0);const o=typeof i=="number"?[i]:i;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof n!="number")throw new Error("samplers must be set to integers");return s.uniform1i(e,n);case 5126:return s.uniform1fv(e,o);case 35664:return s.uniform2fv(e,o);case 35665:return s.uniform3fv(e,o);case 35666:return s.uniform4fv(e,o);case 5124:return s.uniform1iv(e,o);case 35667:return s.uniform2iv(e,o);case 35668:return s.uniform3iv(e,o);case 35669:return s.uniform4iv(e,o);case 35670:return s.uniform1iv(e,o);case 35671:return s.uniform2iv(e,o);case 35672:return s.uniform3iv(e,o);case 35673:return s.uniform4iv(e,o);case 5125:return r.uniform1uiv(e,o,1);case 36294:return r.uniform2uiv(e,o,2);case 36295:return r.uniform3uiv(e,o,3);case 36296:return r.uniform4uiv(e,o,4);case 35674:return s.uniformMatrix2fv(e,!1,o);case 35675:return s.uniformMatrix3fv(e,!1,o);case 35676:return s.uniformMatrix4fv(e,!1,o);case 35685:return r.uniformMatrix2x3fv(e,!1,o);case 35686:return r.uniformMatrix2x4fv(e,!1,o);case 35687:return r.uniformMatrix3x2fv(e,!1,o);case 35688:return r.uniformMatrix3x4fv(e,!1,o);case 35689:return r.uniformMatrix4x2fv(e,!1,o);case 35690:return r.uniformMatrix4x3fv(e,!1,o)}throw new Error("Illegal uniform")}function v0(s){switch(s){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"line-loop-webgl":return 2;case"triangle-list":return 4;case"triangle-strip":return 5;case"triangle-fan-webgl":return 6;default:throw new Error(s)}}function w0(s){switch(s){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"line-loop-webgl":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;case"triangle-fan-webgl":return 4;default:throw new Error(s)}}const Vc=4;class A0 extends us{constructor(t,n){super(t,n);p(this,"device");p(this,"handle");p(this,"vs");p(this,"fs");p(this,"introspectedLayout");p(this,"uniforms",{});p(this,"bindings",{});p(this,"varyings",null);p(this,"_uniformCount",0);p(this,"_uniformSetters",{});this.device=t,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=n.vs,this.fs=n.fs;const{varyings:r,bufferMode:i=35981}=n;switch(r&&r.length>0&&(this.varyings=r,this.device.gl.transformFeedbackVaryings(this.handle,r,i)),this._linkShaders(),D.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=f0(this.device.gl,this.handle),D.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=rg(this.introspectedLayout,n.shaderLayout),this.props.topology){case"triangle-fan-webgl":case"line-loop-webgl":D.warn(`Primitive topology ${this.props.topology} is deprecated and will be removed in v9.1`);break}}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(t,n){for(const[r,i]of Object.entries(t)){const o=this.shaderLayout.bindings.find(a=>a.name===r)||this.shaderLayout.bindings.find(a=>a.name===`${r}Uniforms`);if(!o){const a=this.shaderLayout.bindings.map(c=>`"${c.name}"`).join(", ");n!=null&&n.disableWarnings||D.warn(`Unknown binding "${r}" in render pipeline "${this.id}", expected one of ${a}`)();continue}switch(i||D.warn(`Unsetting binding "${r}" in render pipeline "${this.id}"`)(),o.type){case"uniform":if(!(i instanceof gt)&&!(i.buffer instanceof gt))throw new Error("buffer value");break;case"texture":if(!(i instanceof ss||i instanceof qe||i instanceof Hs))throw new Error("texture value");break;case"sampler":D.warn(`Ignoring sampler ${r}`)();break;default:throw new Error(o.type)}this.bindings[r]=i}}draw(t){var R;const{renderPass:n,parameters:r=this.props.parameters,topology:i=this.props.topology,vertexArray:o,vertexCount:a,instanceCount:c,isInstanced:l=!1,firstVertex:u=0,transformFeedback:h}=t,f=v0(i),_=!!o.indexBuffer,T=(R=o.indexBuffer)==null?void 0:R.glIndexType;if(this.linkStatus!=="success")return D.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable()||a===0)return D.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;if(a===0)return D.info(2,`RenderPipeline:${this.id}.draw() aborted - no vertices to draw`)(),!0;this.device.gl.useProgram(this.handle),o.bindBeforeRender(n),h&&h.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const v=n;return Rv(this.device,r,v.glParameters,()=>{_&&l?this.device.gl.drawElementsInstanced(f,a||0,T,u,c||0):_?this.device.gl.drawElements(f,a||0,T,u):l?this.device.gl.drawArraysInstanced(f,u,a||0,c||0):this.device.gl.drawArrays(f,u,a||0),h&&h.end()}),o.unbindAfterRender(n),!0}setUniformsWebGL(t){const{bindings:n}=wo(t);Object.keys(n).forEach(r=>{D.warn(`Unsupported value "${JSON.stringify(n[r])}" used in setUniforms() for key ${r}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,t)}async _linkShaders(){const{gl:t}=this.device;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),D.time(Vc,`linkProgram for ${this.id}`)(),t.linkProgram(this.handle),D.timeEnd(Vc,`linkProgram for ${this.id}`)(),D.level,!this.device.features.has("compilation-status-async-webgl")){const r=this._getLinkStatus();this._reportLinkStatus(r);return}D.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),D.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const n=this._getLinkStatus();this._reportLinkStatus(n)}_reportLinkStatus(t){var n;switch(t){case"success":return;default:throw this.vs.compilationStatus==="error"?(this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`)):((n=this.fs)==null?void 0:n.compilationStatus)==="error"?(this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`)):new Error(`Error during ${t}: ${this.device.gl.getProgramInfoLog(this.handle)}`)}}_getLinkStatus(){const{gl:t}=this.device;return t.getProgramParameter(this.handle,35714)?(t.validateProgram(this.handle),t.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const t=async i=>await new Promise(o=>setTimeout(o,i));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:r}=this.device;for(;;){if(r.getProgramParameter(this.handle,37297))return;await t(10)}}_areTexturesRenderable(){let t=!0;for(const[,n]of Object.entries(this.bindings))n instanceof qe&&(n.update(),t=t&&n.loaded);return t}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:t}=this.device;t.useProgram(this.handle);let n=0,r=0;for(const i of this.shaderLayout.bindings){const o=this.bindings[i.name]||this.bindings[i.name.replace(/Uniforms$/,"")];if(!o)throw new Error(`No value for binding ${i.name} in ${this.id}`);switch(i.type){case"uniform":const{name:a}=i,c=t.getUniformBlockIndex(this.handle,a);if(c===4294967295)throw new Error(`Invalid uniform block name ${a}`);t.uniformBlockBinding(this.handle,r,c),o instanceof gt?t.bindBufferBase(35345,r,o.handle):t.bindBufferRange(35345,r,o.buffer.handle,o.offset||0,o.size||o.buffer.byteLength-o.offset),r+=1;break;case"texture":if(!(o instanceof ss||o instanceof qe||o instanceof Hs))throw new Error("texture");let l;if(o instanceof ss)l=o.texture;else if(o instanceof qe)l=o;else if(o instanceof Hs&&o.colorAttachments[0]instanceof ss)D.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),l=o.colorAttachments[0].texture;else throw new Error("No texture");t.activeTexture(33984+n),t.bindTexture(l.target,l.handle),n+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${i.type}' not supported in WebGL`)}}}_applyUniforms(){for(const t of this.shaderLayout.uniforms||[]){const{name:n,location:r,type:i,textureUnit:o}=t,a=this.uniforms[n]??o;a!==void 0&&b0(this.device.gl,r,i,a)}}}class E0 extends Fi{constructor(t){super(t,{});p(this,"device");p(this,"commands",[]);this.device=t}submitCommands(t=this.commands){for(const n of t)switch(n.name){case"copy-buffer-to-buffer":S0(this.device,n.options);break;case"copy-buffer-to-texture":x0(this.device,n.options);break;case"copy-texture-to-buffer":R0(this.device,n.options);break;case"copy-texture-to-texture":I0(this.device,n.options);break}}}function S0(s,e){const t=e.source,n=e.destination;s.gl.bindBuffer(36662,t.handle),s.gl.bindBuffer(36663,n.handle),s.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),s.gl.bindBuffer(36662,null),s.gl.bindBuffer(36663,null)}function x0(s,e){throw new Error("Not implemented")}function R0(s,e){const{source:t,mipLevel:n=0,aspect:r="all",width:i=e.source.width,height:o=e.source.height,depthOrArrayLayers:a=0,origin:c=[0,0],destination:l,byteOffset:u=0,bytesPerRow:h,rowsPerImage:f}=e;if(r!=="all")throw new Error("not supported");if(n!==0||a!==0||h||f)throw new Error("not implemented");const{framebuffer:_,destroyFramebuffer:T}=uh(t);let v;try{const R=l,C=i||_.width,I=o||_.height,M=hr(_.texture.props.format),N=M.dataFormat,U=M.type;s.gl.bindBuffer(35051,R.handle),v=s.gl.bindFramebuffer(36160,_.handle),s.gl.readPixels(c[0],c[1],C,I,N,U,u)}finally{s.gl.bindBuffer(35051,null),v!==void 0&&s.gl.bindFramebuffer(36160,v),T&&_.destroy()}}function I0(s,e){const{source:t,destinationMipLevel:n=0,origin:r=[0,0],destinationOrigin:i=[0,0],destination:o}=e;let{width:a=e.destination.width,height:c=e.destination.height}=e;const{framebuffer:l,destroyFramebuffer:u}=uh(t),[h,f]=r,[_,T,v]=i,R=s.gl.bindFramebuffer(36160,l.handle);let C=null,I;if(o instanceof qe)C=o,a=Number.isFinite(a)?a:C.width,c=Number.isFinite(c)?c:C.height,C.bind(0),I=C.target;else throw new Error("invalid destination");switch(I){case 3553:case 34067:s.gl.copyTexSubImage2D(I,n,_,T,h,f,a,c);break;case 35866:case 32879:s.gl.copyTexSubImage3D(I,n,_,T,v,h,f,a,c);break}C&&C.unbind(),s.gl.bindFramebuffer(36160,R),u&&l.destroy()}function uh(s){if(s instanceof xe){const{width:e,height:t,id:n}=s;return{framebuffer:s.device.createFramebuffer({id:`framebuffer-for-${n}`,width:e,height:t,colorAttachments:[s]}),destroyFramebuffer:!0}}return{framebuffer:s,destroyFramebuffer:!1}}class C0 extends Di{constructor(t,n){super(t,n);p(this,"device");p(this,"commandBuffer");this.device=t,this.commandBuffer=new E0(t)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(t){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:t})}copyBufferToTexture(t){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:t})}copyTextureToBuffer(t){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:t})}copyTextureToTexture(t){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:t})}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}resolveQuerySet(t,n,r){}}class zo extends Ui{constructor(t,n){super(t,n);p(this,"device");p(this,"handle");p(this,"buffer",null);p(this,"bufferValue",null);this.device=t,this.handle=this.device.gl.createVertexArray()}get[Symbol.toStringTag](){return"VertexArray"}static isConstantAttributeZeroSupported(t){return mf()==="Chrome"}destroy(){var t;super.destroy(),this.buffer&&((t=this.buffer)==null||t.destroy()),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(t){const n=t;if(n&&n.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,n?n.handle:null),this.indexBuffer=n,this.device.gl.bindVertexArray(null)}setBuffer(t,n){const r=n;if(r.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:i,type:o,stride:a,offset:c,normalized:l,integer:u,divisor:h}=this._getAccessor(t);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,r.handle),u?this.device.gl.vertexAttribIPointer(t,i,o,a,c):this.device.gl.vertexAttribPointer(t,i,o,l,a,c),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(t),this.device.gl.vertexAttribDivisor(t,h||0),this.attributes[t]=r,this.device.gl.bindVertexArray(null)}setConstantWebGL(t,n){this._enable(t,!1),this.attributes[t]=n}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let t=0;t<this.maxVertexAttributes;++t){const n=this.attributes[t];ArrayBuffer.isView(n)&&this.device.setConstantAttributeWebGL(t,n)}}_getAccessor(t){const n=this.attributeInfos[t];if(!n)throw new Error(`Unknown attribute location ${t}`);const r=nh(n.bufferDataType);return{size:n.bufferComponents,type:r,stride:n.byteStride,offset:n.byteOffset,normalized:n.normalized,integer:n.integer,divisor:n.stepMode==="instance"?1:0}}_enable(t,n=!0){const i=zo.isConstantAttributeZeroSupported(this.device)||t!==0;(n||i)&&(t=Number(t),this.device.gl.bindVertexArray(this.handle),n?this.device.gl.enableVertexAttribArray(t):this.device.gl.disableVertexAttribArray(t),this.device.gl.bindVertexArray(null))}getConstantBuffer(t,n){const r=P0(n),i=r.byteLength*t,o=r.length*t;if(this.buffer&&i!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${i} !== ${this.buffer.byteLength}.`);let a=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:i}),a=a||!M0(r,this.bufferValue),a){const c=cg(n.constructor,o);lg({target:c,source:r,start:0,count:o}),this.buffer.write(c),this.bufferValue=n}return this.buffer}}function P0(s){return Array.isArray(s)?new Float32Array(s):s}function M0(s,e){if(!s||!e||s.length!==e.length||s.constructor!==e.constructor)return!1;for(let t=0;t<s.length;++t)if(s[t]!==e[t])return!1;return!0}class O0 extends Bi{constructor(t,n){super(t,n);p(this,"device");p(this,"gl");p(this,"handle");p(this,"layout");p(this,"buffers",{});p(this,"unusedBuffers",{});p(this,"bindOnUse",!0);p(this,"_bound",!1);this.device=t,this.gl=t.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,n.buffers&&this.setBuffers(n.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(t="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(w0(t))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(t){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const n in t)this.setBuffer(n,t[n])})}setBuffer(t,n){const r=this._getVaryingIndex(t),{buffer:i,byteLength:o,byteOffset:a}=this._getBufferRange(n);if(r<0){this.unusedBuffers[t]=i,D.warn(`${this.id} unusedBuffers varying buffer ${t}`)();return}this.buffers[r]={buffer:i,byteLength:o,byteOffset:a},this.bindOnUse||this._bindBuffer(r,i,a,o)}getBuffer(t){if($c(t))return this.buffers[t]||null;const n=this._getVaryingIndex(t);return n>=0?this.buffers[n]:null}bind(t=this.handle){if(typeof t!="function")return this.gl.bindTransformFeedback(36386,t),this;let n;return this._bound?n=t():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,n=t(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),n}unbind(){this.bind(null)}_getBufferRange(t){if(t instanceof gt)return{buffer:t,byteOffset:0,byteLength:t.byteLength};const{buffer:n,byteOffset:r=0,byteLength:i=t.buffer.byteLength}=t;return{buffer:n,byteOffset:r,byteLength:i}}_getVaryingIndex(t){if($c(t))return Number(t);for(const n of this.layout.varyings)if(t===n.name)return n.location;return-1}_bindBuffers(){for(const t in this.buffers){const{buffer:n,byteLength:r,byteOffset:i}=this._getBufferRange(this.buffers[t]);this._bindBuffer(Number(t),n,i,r)}}_unbindBuffers(){for(const t in this.buffers)this.gl.bindBufferBase(35982,Number(t),null)}_bindBuffer(t,n,r=0,i){const o=n&&n.handle;!o||i===void 0?this.gl.bindBufferBase(35982,t,o):this.gl.bindBufferRange(35982,t,o,r,i)}}function $c(s){return typeof s=="number"?Number.isInteger(s):/^\d+$/.test(s)}class N0 extends Li{constructor(t,n){super(t,n);p(this,"device");p(this,"handle");p(this,"target",null);p(this,"_queryPending",!1);p(this,"_pollingPromise",null);if(this.device=t,n.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}get[Symbol.toStringTag](){return"Query"}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(t){return this._begin(t!=null&&t.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(t){this._queryPending||(this.target=t,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const t=this.device.gl.getQueryParameter(this.handle,34919);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(t=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let n=0;return this._pollingPromise=new Promise((r,i)=>{const o=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):n++>t?(i("Timed out"),this._pollingPromise=null):requestAnimationFrame(o)};requestAnimationFrame(o)}),this._pollingPromise}}function hh(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return ee(!1),0}}function k0(s){switch(s){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return ee(!1),0}}function D0(s,e){var R,C;const{sourceX:t=0,sourceY:n=0,sourceFormat:r=6408,sourceAttachment:i=36064}=e||{};let{target:o=null,sourceWidth:a,sourceHeight:c,sourceType:l}=e||{};const{framebuffer:u,deleteFramebuffer:h}=fh(s);ee(u);const{gl:f,handle:_}=u;a=a||u.width,c=c||u.height;const T=i-36064;l=l||((C=(R=u.colorAttachments[T])==null?void 0:R.texture)==null?void 0:C.type)||5121,o=B0(o,l,r,a,c),l=l||o0(o);const v=f.bindFramebuffer(36160,_);return f.readPixels(t,n,a,c,r,l,o),f.bindFramebuffer(36160,v||null),h&&u.destroy(),o}function F0(s,e){const{target:t,sourceX:n=0,sourceY:r=0,sourceFormat:i=6408,targetByteOffset:o=0}=e||{};let{sourceWidth:a,sourceHeight:c,sourceType:l}=e||{};const{framebuffer:u,deleteFramebuffer:h}=fh(s);ee(u),a=a||u.width,c=c||u.height;const f=u;l=l||5121;let _=t;if(!_){const v=hh(i),R=k0(l),C=o+a*c*v*R;_=f.device.createBuffer({byteLength:C})}const T=s.device.createCommandEncoder();return T.copyTextureToBuffer({source:s,width:a,height:c,origin:[n,r],destination:_,byteOffset:o}),T.destroy(),h&&u.destroy(),_}function fh(s){return s instanceof Kn?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:U0(s),deleteFramebuffer:!0}}function U0(s,e){const{device:t,width:n,height:r,id:i}=s;return t.createFramebuffer({...e,id:`framebuffer-for-${i}`,width:n,height:r,colorAttachments:[s]})}function B0(s,e,t,n,r){if(s)return s;e=e||5121;const i=so(e,{clamped:!1}),o=hh(t);return new i(n*r*o)}const L0=256,V0=1024,$0=16384,z0="clear: bad arguments";function W0(s,e){const{framebuffer:t=null,color:n=null,depth:r=null,stencil:i=null}=e||{},o={};t&&(o.framebuffer=t);let a=0;n&&(a|=$0,n!==!0&&(o.clearColor=n)),r&&(a|=L0,r!==!0&&(o.clearDepth=r)),i&&(a|=V0,r!==!0&&(o.clearStencil=r)),ee(a!==0,z0);const c=s.gl;dt(c,o,()=>{c.clear(a)})}const Ns=1,xt=class xt extends ls{constructor(t){var l,u;super({...t,id:t.id||zt("webgl-device")});p(this,"type","webgl");p(this,"handle");p(this,"features");p(this,"limits");p(this,"info");p(this,"canvasContext");p(this,"lost");p(this,"_resolveContextLost");p(this,"renderPass",null);p(this,"gl");p(this,"debug",!1);p(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});p(this,"_extensions",{});p(this,"_polyfilled",!1);p(this,"spectorJS");p(this,"_constants");const n=(l=t.gl)==null?void 0:l.device;if(n)throw new Error(`WebGL context already attached to device ${n.id}`);const r=((u=t.gl)==null?void 0:u.canvas)||t.canvas,i=!t.gl;this.canvasContext=new Lv(this,{...t,autoResize:i,canvas:r}),this.lost=new Promise(h=>{this._resolveContextLost=h});let o=t.gl||null;if(o||(o=rv(this.canvasContext.canvas,{...t,onContextLost:h=>{var f;return(f=this._resolveContextLost)==null?void 0:f.call(this,{reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})}})),!o)throw new Error("WebGL context creation failed");this.handle=o,this.gl=o,this.gl.device=this,this.gl._version=2,t.spector&&(this.spectorJS=Hv({...this.props,canvas:this.handle.canvas})),this.info=iv(this.gl,this._extensions),this.limits=new Sv(this.gl),this.features=new Ev(this.gl,this._extensions,this.props.disabledFeatures),this.props.initalizeFeatures&&this.features.initializeFeatures(),i&&this.canvasContext.resize();const{enable:a=!0,copyState:c=!1}=t;th(this.gl,{enable:a,copyState:c}),t.debug&&(this.gl=Yv(this.gl,{...t,throwOnError:!0}),this.debug=!0,D.level=Math.max(D.level,1),D.warn("WebGL debug mode activated. Performance reduced.")())}static isSupported(){return typeof WebGL2RenderingContext<"u"}static attach(t){if(t instanceof xt)return t;if((t==null?void 0:t.device)instanceof ls)return t.device;if(!H0(t))throw new Error("Invalid WebGL2RenderingContext");return new xt({gl:t})}static async create(t={}){var a;D.groupCollapsed(Ns,"WebGLDevice created")();const n=[];t.debug&&n.push(Xv()),t.spector&&n.push(Wv()),typeof t.canvas=="string"&&n.push(vo.pageLoaded);const r=await Promise.allSettled(n);for(const c of r)c.status==="rejected"&&D.error(`Failed to initialize debug libraries ${c.reason}`)();if(D.probe(Ns+1,"DOM is loaded")(),(a=t.gl)!=null&&a.device)return D.warn("reattaching existing device")(),xt.attach(t.gl);const i=new xt(t),o=`Created ${i.type}${i.debug?" debug":""} context: ${i.info.vendor}, ${i.info.renderer} for canvas: ${i.canvasContext.id}`;return D.probe(Ns,o)(),D.table(Ns,i.info)(),D.groupEnd(Ns)(),i}destroy(){}get isLost(){return this.gl.isContextLost()}getSize(){return[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight]}isTextureFormatSupported(t){return $o(this.gl,t,this._extensions)}isTextureFormatFilterable(t){return bv(this.gl,t,this._extensions)}isTextureFormatRenderable(t){return vv(this.gl,t,this._extensions)}createCanvasContext(t){throw new Error("WebGL only supports a single canvas")}createBuffer(t){const n=this._getBufferProps(t);return new gt(this,n)}_createTexture(t){return new qe(this,t)}createExternalTexture(t){throw new Error("createExternalTexture() not implemented")}createSampler(t){return new to(this,t)}createShader(t){return new Gv(this,t)}createFramebuffer(t){return new Hs(this,t)}createVertexArray(t){return new zo(this,t)}createTransformFeedback(t){return new O0(this,t)}createQuerySet(t){return new N0(this,t)}createRenderPipeline(t){return new A0(this,t)}beginRenderPass(t){return new r0(this,t)}createComputePipeline(t){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(t){throw new Error("ComputePass not supported in WebGL")}createCommandEncoder(t){return new C0(this,t)}submit(){var t;(t=this.renderPass)==null||t.end(),this.renderPass=null}readPixelsToArrayWebGL(t,n){return D0(t,n)}readPixelsToBufferWebGL(t,n){return F0(t,n)}setParametersWebGL(t){Ts(this.gl,t)}getParametersWebGL(t){return eh(this.gl,t)}withParametersWebGL(t,n){return dt(this.gl,t,n)}clearWebGL(t){W0(this,t)}resetWebGL(){D.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),Qb(this.gl)}loseDevice(){var i;let t=!1;const r=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return r&&(t=!0,r.loseContext()),(i=this._resolveContextLost)==null||i.call(this,{reason:"destroyed",message:"Application triggered context loss"}),t}pushState(){Or(this.gl)}popState(){Js(this.gl)}setSpectorMetadata(t,n){t.__SPECTOR_Metadata=n}getGLKey(t,n){n=n||this.gl2||this.gl;const r=Number(t);for(const i in n)if(n[i]===r)return`GL.${i}`;return String(t)}setConstantAttributeWebGL(t,n){const r=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(r).fill(null);const i=this._constants[t];switch(i&&q0(i,n)&&D.info(1,`setConstantAttributeWebGL(${t}) could have been skipped, value unchanged`)(),this._constants[t]=n,n.constructor){case Float32Array:j0(this,t,n);break;case Int32Array:X0(this,t,n);break;case Uint32Array:Y0(this,t,n);break;default:ee(!1)}}getExtension(t){return Tt(this.gl,t,this._extensions),this._extensions}};p(xt,"type","webgl");let Xs=xt;function H0(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:!!(s&&Number.isFinite(s._version))}function j0(s,e,t){switch(t.length){case 1:s.gl.vertexAttrib1fv(e,t);break;case 2:s.gl.vertexAttrib2fv(e,t);break;case 3:s.gl.vertexAttrib3fv(e,t);break;case 4:s.gl.vertexAttrib4fv(e,t);break;default:ee(!1)}}function X0(s,e,t){s.gl.vertexAttribI4iv(e,t)}function Y0(s,e,t){s.gl.vertexAttribI4uiv(e,t)}function q0(s,e){if(!s||!e||s.length!==e.length||s.constructor!==e.constructor)return!1;for(let t=0;t<s.length;++t)if(s[t]!==e[t])return!1;return!0}var bi={exports:{}};/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */var zc;function K0(){return zc||(zc=1,function(s){(function(e,t,n,r){var i=["","webkit","Moz","MS","ms","o"],o=t.createElement("div"),a="function",c=Math.round,l=Math.abs,u=Date.now;function h(d,m,b){return setTimeout(M(d,b),m)}function f(d,m,b){return Array.isArray(d)?(_(d,b[m],b),!0):!1}function _(d,m,b){var x;if(d)if(d.forEach)d.forEach(m,b);else if(d.length!==r)for(x=0;x<d.length;)m.call(b,d[x],x,d),x++;else for(x in d)d.hasOwnProperty(x)&&m.call(b,d[x],x,d)}function T(d,m,b){var x="DEPRECATED METHOD: "+m+`
`+b+` AT 
`;return function(){var O=new Error("get-stack-trace"),L=O&&O.stack?O.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",j=e.console&&(e.console.warn||e.console.log);return j&&j.call(e.console,x,L),d.apply(this,arguments)}}var v;typeof Object.assign!="function"?v=function(m){if(m===r||m===null)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(m),x=1;x<arguments.length;x++){var O=arguments[x];if(O!==r&&O!==null)for(var L in O)O.hasOwnProperty(L)&&(b[L]=O[L])}return b}:v=Object.assign;var R=T(function(m,b,x){for(var O=Object.keys(b),L=0;L<O.length;)(!x||x&&m[O[L]]===r)&&(m[O[L]]=b[O[L]]),L++;return m},"extend","Use `assign`."),C=T(function(m,b){return R(m,b,!0)},"merge","Use `assign`.");function I(d,m,b){var x=m.prototype,O;O=d.prototype=Object.create(x),O.constructor=d,O._super=x,b&&v(O,b)}function M(d,m){return function(){return d.apply(m,arguments)}}function N(d,m){return typeof d==a?d.apply(m&&m[0]||r,m):d}function U(d,m){return d===r?m:d}function B(d,m,b){_(z(m),function(x){d.addEventListener(x,b,!1)})}function $(d,m,b){_(z(m),function(x){d.removeEventListener(x,b,!1)})}function W(d,m){for(;d;){if(d==m)return!0;d=d.parentNode}return!1}function V(d,m){return d.indexOf(m)>-1}function z(d){return d.trim().split(/\s+/g)}function H(d,m,b){if(d.indexOf&&!b)return d.indexOf(m);for(var x=0;x<d.length;){if(b&&d[x][b]==m||!b&&d[x]===m)return x;x++}return-1}function te(d){return Array.prototype.slice.call(d,0)}function re(d,m,b){for(var x=[],O=[],L=0;L<d.length;){var j=d[L][m];H(O,j)<0&&x.push(d[L]),O[L]=j,L++}return x=x.sort(function(fe,Te){return fe[m]>Te[m]}),x}function X(d,m){for(var b,x,O=m[0].toUpperCase()+m.slice(1),L=0;L<i.length;){if(b=i[L],x=b?b+O:m,x in d)return x;L++}return r}var Be=1;function Mh(){return Be++}function Xo(d){var m=d.ownerDocument||d;return m.defaultView||m.parentWindow||e}var Oh=/mobile|tablet|ip(ad|hone|od)|android/i,Yo="ontouchstart"in e,Nh=X(e,"PointerEvent")!==r,kh=Yo&&Oh.test(navigator.userAgent),bs="touch",Dh="pen",Fr="mouse",Fh="kinect",Uh=25,ye=1,vt=2,ce=4,be=8,on=1,vs=2,ws=4,As=8,Es=16,Le=vs|ws,wt=As|Es,qo=Le|wt,Ko=["x","y"],an=["clientX","clientY"];function Ee(d,m){var b=this;this.manager=d,this.callback=m,this.element=d.element,this.target=d.options.inputTarget,this.domHandler=function(x){N(d.options.enable,[d])&&b.handler(x)},this.init()}Ee.prototype={handler:function(){},init:function(){this.evEl&&B(this.element,this.evEl,this.domHandler),this.evTarget&&B(this.target,this.evTarget,this.domHandler),this.evWin&&B(Xo(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&$(this.element,this.evEl,this.domHandler),this.evTarget&&$(this.target,this.evTarget,this.domHandler),this.evWin&&$(Xo(this.element),this.evWin,this.domHandler)}};function Bh(d){var m,b=d.options.inputClass;return b?m=b:Nh?m=Br:kh?m=un:Yo?m=Lr:m=ln,new m(d,Lh)}function Lh(d,m,b){var x=b.pointers.length,O=b.changedPointers.length,L=m&ye&&x-O===0,j=m&(ce|be)&&x-O===0;b.isFirst=!!L,b.isFinal=!!j,L&&(d.session={}),b.eventType=m,Vh(d,b),d.emit("hammer.input",b),d.recognize(b),d.session.prevInput=b}function Vh(d,m){var b=d.session,x=m.pointers,O=x.length;b.firstInput||(b.firstInput=Zo(m)),O>1&&!b.firstMultiple?b.firstMultiple=Zo(m):O===1&&(b.firstMultiple=!1);var L=b.firstInput,j=b.firstMultiple,ue=j?j.center:L.center,fe=m.center=Qo(x);m.timeStamp=u(),m.deltaTime=m.timeStamp-L.timeStamp,m.angle=Ur(ue,fe),m.distance=cn(ue,fe),$h(b,m),m.offsetDirection=Go(m.deltaX,m.deltaY);var Te=Jo(m.deltaTime,m.deltaX,m.deltaY);m.overallVelocityX=Te.x,m.overallVelocityY=Te.y,m.overallVelocity=l(Te.x)>l(Te.y)?Te.x:Te.y,m.scale=j?Hh(j.pointers,x):1,m.rotation=j?Wh(j.pointers,x):0,m.maxPointers=b.prevInput?m.pointers.length>b.prevInput.maxPointers?m.pointers.length:b.prevInput.maxPointers:m.pointers.length,zh(b,m);var $e=d.element;W(m.srcEvent.target,$e)&&($e=m.srcEvent.target),m.target=$e}function $h(d,m){var b=m.center,x=d.offsetDelta||{},O=d.prevDelta||{},L=d.prevInput||{};(m.eventType===ye||L.eventType===ce)&&(O=d.prevDelta={x:L.deltaX||0,y:L.deltaY||0},x=d.offsetDelta={x:b.x,y:b.y}),m.deltaX=O.x+(b.x-x.x),m.deltaY=O.y+(b.y-x.y)}function zh(d,m){var b=d.lastInterval||m,x=m.timeStamp-b.timeStamp,O,L,j,ue;if(m.eventType!=be&&(x>Uh||b.velocity===r)){var fe=m.deltaX-b.deltaX,Te=m.deltaY-b.deltaY,$e=Jo(x,fe,Te);L=$e.x,j=$e.y,O=l($e.x)>l($e.y)?$e.x:$e.y,ue=Go(fe,Te),d.lastInterval=m}else O=b.velocity,L=b.velocityX,j=b.velocityY,ue=b.direction;m.velocity=O,m.velocityX=L,m.velocityY=j,m.direction=ue}function Zo(d){for(var m=[],b=0;b<d.pointers.length;)m[b]={clientX:c(d.pointers[b].clientX),clientY:c(d.pointers[b].clientY)},b++;return{timeStamp:u(),pointers:m,center:Qo(m),deltaX:d.deltaX,deltaY:d.deltaY}}function Qo(d){var m=d.length;if(m===1)return{x:c(d[0].clientX),y:c(d[0].clientY)};for(var b=0,x=0,O=0;O<m;)b+=d[O].clientX,x+=d[O].clientY,O++;return{x:c(b/m),y:c(x/m)}}function Jo(d,m,b){return{x:m/d||0,y:b/d||0}}function Go(d,m){return d===m?on:l(d)>=l(m)?d<0?vs:ws:m<0?As:Es}function cn(d,m,b){b||(b=Ko);var x=m[b[0]]-d[b[0]],O=m[b[1]]-d[b[1]];return Math.sqrt(x*x+O*O)}function Ur(d,m,b){b||(b=Ko);var x=m[b[0]]-d[b[0]],O=m[b[1]]-d[b[1]];return Math.atan2(O,x)*180/Math.PI}function Wh(d,m){return Ur(m[1],m[0],an)+Ur(d[1],d[0],an)}function Hh(d,m){return cn(m[0],m[1],an)/cn(d[0],d[1],an)}var jh={mousedown:ye,mousemove:vt,mouseup:ce},Xh="mousedown",Yh="mousemove mouseup";function ln(){this.evEl=Xh,this.evWin=Yh,this.pressed=!1,Ee.apply(this,arguments)}I(ln,Ee,{handler:function(m){var b=jh[m.type];b&ye&&m.button===0&&(this.pressed=!0),b&vt&&m.which!==1&&(b=ce),this.pressed&&(b&ce&&(this.pressed=!1),this.callback(this.manager,b,{pointers:[m],changedPointers:[m],pointerType:Fr,srcEvent:m}))}});var qh={pointerdown:ye,pointermove:vt,pointerup:ce,pointercancel:be,pointerout:be},Kh={2:bs,3:Dh,4:Fr,5:Fh},ea="pointerdown",ta="pointermove pointerup pointercancel";e.MSPointerEvent&&!e.PointerEvent&&(ea="MSPointerDown",ta="MSPointerMove MSPointerUp MSPointerCancel");function Br(){this.evEl=ea,this.evWin=ta,Ee.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}I(Br,Ee,{handler:function(m){var b=this.store,x=!1,O=m.type.toLowerCase().replace("ms",""),L=qh[O],j=Kh[m.pointerType]||m.pointerType,ue=j==bs,fe=H(b,m.pointerId,"pointerId");L&ye&&(m.button===0||ue)?fe<0&&(b.push(m),fe=b.length-1):L&(ce|be)&&(x=!0),!(fe<0)&&(b[fe]=m,this.callback(this.manager,L,{pointers:b,changedPointers:[m],pointerType:j,srcEvent:m}),x&&b.splice(fe,1))}});var Zh={touchstart:ye,touchmove:vt,touchend:ce,touchcancel:be},Qh="touchstart",Jh="touchstart touchmove touchend touchcancel";function sa(){this.evTarget=Qh,this.evWin=Jh,this.started=!1,Ee.apply(this,arguments)}I(sa,Ee,{handler:function(m){var b=Zh[m.type];if(b===ye&&(this.started=!0),!!this.started){var x=Gh.call(this,m,b);b&(ce|be)&&x[0].length-x[1].length===0&&(this.started=!1),this.callback(this.manager,b,{pointers:x[0],changedPointers:x[1],pointerType:bs,srcEvent:m})}}});function Gh(d,m){var b=te(d.touches),x=te(d.changedTouches);return m&(ce|be)&&(b=re(b.concat(x),"identifier")),[b,x]}var ef={touchstart:ye,touchmove:vt,touchend:ce,touchcancel:be},tf="touchstart touchmove touchend touchcancel";function un(){this.evTarget=tf,this.targetIds={},Ee.apply(this,arguments)}I(un,Ee,{handler:function(m){var b=ef[m.type],x=sf.call(this,m,b);x&&this.callback(this.manager,b,{pointers:x[0],changedPointers:x[1],pointerType:bs,srcEvent:m})}});function sf(d,m){var b=te(d.touches),x=this.targetIds;if(m&(ye|vt)&&b.length===1)return x[b[0].identifier]=!0,[b,b];var O,L,j=te(d.changedTouches),ue=[],fe=this.target;if(L=b.filter(function(Te){return W(Te.target,fe)}),m===ye)for(O=0;O<L.length;)x[L[O].identifier]=!0,O++;for(O=0;O<j.length;)x[j[O].identifier]&&ue.push(j[O]),m&(ce|be)&&delete x[j[O].identifier],O++;if(ue.length)return[re(L.concat(ue),"identifier"),ue]}var nf=2500,na=25;function Lr(){Ee.apply(this,arguments);var d=M(this.handler,this);this.touch=new un(this.manager,d),this.mouse=new ln(this.manager,d),this.primaryTouch=null,this.lastTouches=[]}I(Lr,Ee,{handler:function(m,b,x){var O=x.pointerType==bs,L=x.pointerType==Fr;if(!(L&&x.sourceCapabilities&&x.sourceCapabilities.firesTouchEvents)){if(O)rf.call(this,b,x);else if(L&&of.call(this,x))return;this.callback(m,b,x)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function rf(d,m){d&ye?(this.primaryTouch=m.changedPointers[0].identifier,ra.call(this,m)):d&(ce|be)&&ra.call(this,m)}function ra(d){var m=d.changedPointers[0];if(m.identifier===this.primaryTouch){var b={x:m.clientX,y:m.clientY};this.lastTouches.push(b);var x=this.lastTouches,O=function(){var L=x.indexOf(b);L>-1&&x.splice(L,1)};setTimeout(O,nf)}}function of(d){for(var m=d.srcEvent.clientX,b=d.srcEvent.clientY,x=0;x<this.lastTouches.length;x++){var O=this.lastTouches[x],L=Math.abs(m-O.x),j=Math.abs(b-O.y);if(L<=na&&j<=na)return!0}return!1}var ia=X(o.style,"touchAction"),oa=ia!==r,aa="compute",ca="auto",Vr="manipulation",At="none",Ss="pan-x",xs="pan-y",hn=cf();function $r(d,m){this.manager=d,this.set(m)}$r.prototype={set:function(d){d==aa&&(d=this.compute()),oa&&this.manager.element.style&&hn[d]&&(this.manager.element.style[ia]=d),this.actions=d.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var d=[];return _(this.manager.recognizers,function(m){N(m.options.enable,[m])&&(d=d.concat(m.getTouchAction()))}),af(d.join(" "))},preventDefaults:function(d){var m=d.srcEvent,b=d.offsetDirection;if(this.manager.session.prevented){m.preventDefault();return}var x=this.actions,O=V(x,At)&&!hn[At],L=V(x,xs)&&!hn[xs],j=V(x,Ss)&&!hn[Ss];if(O){var ue=d.pointers.length===1,fe=d.distance<2,Te=d.deltaTime<250;if(ue&&fe&&Te)return}if(!(j&&L)&&(O||L&&b&Le||j&&b&wt))return this.preventSrc(m)},preventSrc:function(d){this.manager.session.prevented=!0,d.preventDefault()}};function af(d){if(V(d,At))return At;var m=V(d,Ss),b=V(d,xs);return m&&b?At:m||b?m?Ss:xs:V(d,Vr)?Vr:ca}function cf(){if(!oa)return!1;var d={},m=e.CSS&&e.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(b){d[b]=m?e.CSS.supports("touch-action",b):!0}),d}var fn=1,Se=2,Wt=4,et=8,Ze=et,Rs=16,Ve=32;function Qe(d){this.options=v({},this.defaults,d||{}),this.id=Mh(),this.manager=null,this.options.enable=U(this.options.enable,!0),this.state=fn,this.simultaneous={},this.requireFail=[]}Qe.prototype={defaults:{},set:function(d){return v(this.options,d),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(d){if(f(d,"recognizeWith",this))return this;var m=this.simultaneous;return d=dn(d,this),m[d.id]||(m[d.id]=d,d.recognizeWith(this)),this},dropRecognizeWith:function(d){return f(d,"dropRecognizeWith",this)?this:(d=dn(d,this),delete this.simultaneous[d.id],this)},requireFailure:function(d){if(f(d,"requireFailure",this))return this;var m=this.requireFail;return d=dn(d,this),H(m,d)===-1&&(m.push(d),d.requireFailure(this)),this},dropRequireFailure:function(d){if(f(d,"dropRequireFailure",this))return this;d=dn(d,this);var m=H(this.requireFail,d);return m>-1&&this.requireFail.splice(m,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(d){return!!this.simultaneous[d.id]},emit:function(d){var m=this,b=this.state;function x(O){m.manager.emit(O,d)}b<et&&x(m.options.event+la(b)),x(m.options.event),d.additionalEvent&&x(d.additionalEvent),b>=et&&x(m.options.event+la(b))},tryEmit:function(d){if(this.canEmit())return this.emit(d);this.state=Ve},canEmit:function(){for(var d=0;d<this.requireFail.length;){if(!(this.requireFail[d].state&(Ve|fn)))return!1;d++}return!0},recognize:function(d){var m=v({},d);if(!N(this.options.enable,[this,m])){this.reset(),this.state=Ve;return}this.state&(Ze|Rs|Ve)&&(this.state=fn),this.state=this.process(m),this.state&(Se|Wt|et|Rs)&&this.tryEmit(m)},process:function(d){},getTouchAction:function(){},reset:function(){}};function la(d){return d&Rs?"cancel":d&et?"end":d&Wt?"move":d&Se?"start":""}function ua(d){return d==Es?"down":d==As?"up":d==vs?"left":d==ws?"right":""}function dn(d,m){var b=m.manager;return b?b.get(d):d}function Ce(){Qe.apply(this,arguments)}I(Ce,Qe,{defaults:{pointers:1},attrTest:function(d){var m=this.options.pointers;return m===0||d.pointers.length===m},process:function(d){var m=this.state,b=d.eventType,x=m&(Se|Wt),O=this.attrTest(d);return x&&(b&be||!O)?m|Rs:x||O?b&ce?m|et:m&Se?m|Wt:Se:Ve}});function pn(){Ce.apply(this,arguments),this.pX=null,this.pY=null}I(pn,Ce,{defaults:{event:"pan",threshold:10,pointers:1,direction:qo},getTouchAction:function(){var d=this.options.direction,m=[];return d&Le&&m.push(xs),d&wt&&m.push(Ss),m},directionTest:function(d){var m=this.options,b=!0,x=d.distance,O=d.direction,L=d.deltaX,j=d.deltaY;return O&m.direction||(m.direction&Le?(O=L===0?on:L<0?vs:ws,b=L!=this.pX,x=Math.abs(d.deltaX)):(O=j===0?on:j<0?As:Es,b=j!=this.pY,x=Math.abs(d.deltaY))),d.direction=O,b&&x>m.threshold&&O&m.direction},attrTest:function(d){return Ce.prototype.attrTest.call(this,d)&&(this.state&Se||!(this.state&Se)&&this.directionTest(d))},emit:function(d){this.pX=d.deltaX,this.pY=d.deltaY;var m=ua(d.direction);m&&(d.additionalEvent=this.options.event+m),this._super.emit.call(this,d)}});function zr(){Ce.apply(this,arguments)}I(zr,Ce,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[At]},attrTest:function(d){return this._super.attrTest.call(this,d)&&(Math.abs(d.scale-1)>this.options.threshold||this.state&Se)},emit:function(d){if(d.scale!==1){var m=d.scale<1?"in":"out";d.additionalEvent=this.options.event+m}this._super.emit.call(this,d)}});function Wr(){Qe.apply(this,arguments),this._timer=null,this._input=null}I(Wr,Qe,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[ca]},process:function(d){var m=this.options,b=d.pointers.length===m.pointers,x=d.distance<m.threshold,O=d.deltaTime>m.time;if(this._input=d,!x||!b||d.eventType&(ce|be)&&!O)this.reset();else if(d.eventType&ye)this.reset(),this._timer=h(function(){this.state=Ze,this.tryEmit()},m.time,this);else if(d.eventType&ce)return Ze;return Ve},reset:function(){clearTimeout(this._timer)},emit:function(d){this.state===Ze&&(d&&d.eventType&ce?this.manager.emit(this.options.event+"up",d):(this._input.timeStamp=u(),this.manager.emit(this.options.event,this._input)))}});function Hr(){Ce.apply(this,arguments)}I(Hr,Ce,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[At]},attrTest:function(d){return this._super.attrTest.call(this,d)&&(Math.abs(d.rotation)>this.options.threshold||this.state&Se)}});function jr(){Ce.apply(this,arguments)}I(jr,Ce,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Le|wt,pointers:1},getTouchAction:function(){return pn.prototype.getTouchAction.call(this)},attrTest:function(d){var m=this.options.direction,b;return m&(Le|wt)?b=d.overallVelocity:m&Le?b=d.overallVelocityX:m&wt&&(b=d.overallVelocityY),this._super.attrTest.call(this,d)&&m&d.offsetDirection&&d.distance>this.options.threshold&&d.maxPointers==this.options.pointers&&l(b)>this.options.velocity&&d.eventType&ce},emit:function(d){var m=ua(d.offsetDirection);m&&this.manager.emit(this.options.event+m,d),this.manager.emit(this.options.event,d)}});function _n(){Qe.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}I(_n,Qe,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[Vr]},process:function(d){var m=this.options,b=d.pointers.length===m.pointers,x=d.distance<m.threshold,O=d.deltaTime<m.time;if(this.reset(),d.eventType&ye&&this.count===0)return this.failTimeout();if(x&&O&&b){if(d.eventType!=ce)return this.failTimeout();var L=this.pTime?d.timeStamp-this.pTime<m.interval:!0,j=!this.pCenter||cn(this.pCenter,d.center)<m.posThreshold;this.pTime=d.timeStamp,this.pCenter=d.center,!j||!L?this.count=1:this.count+=1,this._input=d;var ue=this.count%m.taps;if(ue===0)return this.hasRequireFailures()?(this._timer=h(function(){this.state=Ze,this.tryEmit()},m.interval,this),Se):Ze}return Ve},failTimeout:function(){return this._timer=h(function(){this.state=Ve},this.options.interval,this),Ve},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==Ze&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function tt(d,m){return m=m||{},m.recognizers=U(m.recognizers,tt.defaults.preset),new Xr(d,m)}tt.VERSION="2.0.7",tt.defaults={domEvents:!1,touchAction:aa,enable:!0,inputTarget:null,inputClass:null,preset:[[Hr,{enable:!1}],[zr,{enable:!1},["rotate"]],[jr,{direction:Le}],[pn,{direction:Le},["swipe"]],[_n],[_n,{event:"doubletap",taps:2},["tap"]],[Wr]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var lf=1,ha=2;function Xr(d,m){this.options=v({},tt.defaults,m||{}),this.options.inputTarget=this.options.inputTarget||d,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=d,this.input=Bh(this),this.touchAction=new $r(this,this.options.touchAction),fa(this,!0),_(this.options.recognizers,function(b){var x=this.add(new b[0](b[1]));b[2]&&x.recognizeWith(b[2]),b[3]&&x.requireFailure(b[3])},this)}Xr.prototype={set:function(d){return v(this.options,d),d.touchAction&&this.touchAction.update(),d.inputTarget&&(this.input.destroy(),this.input.target=d.inputTarget,this.input.init()),this},stop:function(d){this.session.stopped=d?ha:lf},recognize:function(d){var m=this.session;if(!m.stopped){this.touchAction.preventDefaults(d);var b,x=this.recognizers,O=m.curRecognizer;(!O||O&&O.state&Ze)&&(O=m.curRecognizer=null);for(var L=0;L<x.length;)b=x[L],m.stopped!==ha&&(!O||b==O||b.canRecognizeWith(O))?b.recognize(d):b.reset(),!O&&b.state&(Se|Wt|et)&&(O=m.curRecognizer=b),L++}},get:function(d){if(d instanceof Qe)return d;for(var m=this.recognizers,b=0;b<m.length;b++)if(m[b].options.event==d)return m[b];return null},add:function(d){if(f(d,"add",this))return this;var m=this.get(d.options.event);return m&&this.remove(m),this.recognizers.push(d),d.manager=this,this.touchAction.update(),d},remove:function(d){if(f(d,"remove",this))return this;if(d=this.get(d),d){var m=this.recognizers,b=H(m,d);b!==-1&&(m.splice(b,1),this.touchAction.update())}return this},on:function(d,m){if(d!==r&&m!==r){var b=this.handlers;return _(z(d),function(x){b[x]=b[x]||[],b[x].push(m)}),this}},off:function(d,m){if(d!==r){var b=this.handlers;return _(z(d),function(x){m?b[x]&&b[x].splice(H(b[x],m),1):delete b[x]}),this}},emit:function(d,m){this.options.domEvents&&uf(d,m);var b=this.handlers[d]&&this.handlers[d].slice();if(!(!b||!b.length)){m.type=d,m.preventDefault=function(){m.srcEvent.preventDefault()};for(var x=0;x<b.length;)b[x](m),x++}},destroy:function(){this.element&&fa(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function fa(d,m){var b=d.element;if(b.style){var x;_(d.options.cssProps,function(O,L){x=X(b.style,L),m?(d.oldCssProps[x]=b.style[x],b.style[x]=O):b.style[x]=d.oldCssProps[x]||""}),m||(d.oldCssProps={})}}function uf(d,m){var b=t.createEvent("Event");b.initEvent(d,!0,!0),b.gesture=m,m.target.dispatchEvent(b)}v(tt,{INPUT_START:ye,INPUT_MOVE:vt,INPUT_END:ce,INPUT_CANCEL:be,STATE_POSSIBLE:fn,STATE_BEGAN:Se,STATE_CHANGED:Wt,STATE_ENDED:et,STATE_RECOGNIZED:Ze,STATE_CANCELLED:Rs,STATE_FAILED:Ve,DIRECTION_NONE:on,DIRECTION_LEFT:vs,DIRECTION_RIGHT:ws,DIRECTION_UP:As,DIRECTION_DOWN:Es,DIRECTION_HORIZONTAL:Le,DIRECTION_VERTICAL:wt,DIRECTION_ALL:qo,Manager:Xr,Input:Ee,TouchAction:$r,TouchInput:un,MouseInput:ln,PointerEventInput:Br,TouchMouseInput:Lr,SingleTouchInput:sa,Recognizer:Qe,AttrRecognizer:Ce,Tap:_n,Pan:pn,Swipe:jr,Pinch:zr,Rotate:Hr,Press:Wr,on:B,off:$,each:_,merge:C,extend:R,assign:v,inherit:I,bindFn:M,prefixed:X});var hf=typeof e<"u"?e:typeof self<"u"?self:{};hf.Hammer=tt,s.exports?s.exports=tt:e[n]=tt})(window,document,"Hammer")}(bi)),bi.exports}var rn=K0();const Z0=_f(rn),He=pf({__proto__:null,default:Z0},[rn]),dh=1,ph=2,no=4,Q0={mousedown:dh,mousemove:ph,mouseup:no};function J0(s,e){for(let t=0;t<s.length;t++)if(e(s[t]))return!0;return!1}function G0(s){const e=s.prototype.handler;s.prototype.handler=function(n){const r=this.store;n.button>0&&n.type==="pointerdown"&&(J0(r,i=>i.pointerId===n.pointerId)||r.push(n)),e.call(this,n)}}function ew(s){s.prototype.handler=function(t){let n=Q0[t.type];n&dh&&t.button>=0&&(this.pressed=!0),n&ph&&t.buttons===0&&(n=no),this.pressed&&(n&no&&(this.pressed=!1),this.callback(this.manager,n,{pointers:[t],changedPointers:[t],pointerType:"mouse",srcEvent:t}))}}G0(rn.PointerEventInput);ew(rn.MouseInput);const tw=rn.Manager;class kr{constructor(e,t,n){this.element=e,this.callback=t,this.options={enable:!0,...n}}}const sw=He?[[He.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[He.Rotate,{enable:!1}],[He.Pinch,{enable:!1}],[He.Swipe,{enable:!1}],[He.Pan,{threshold:0,enable:!1}],[He.Press,{enable:!1}],[He.Tap,{event:"doubletap",taps:2,enable:!1}],[He.Tap,{event:"anytap",enable:!1}],[He.Tap,{enable:!1}]]:null,Wc={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},nw={doubletap:["tap"]},rw={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},Wo={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},iw={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},Hc={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"},ow=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",ns=typeof window<"u"?window:global;let ro=!1;try{const s={get passive(){return ro=!0,!0}};ns.addEventListener("test",null,s),ns.removeEventListener("test",null)}catch{ro=!1}const aw=ow.indexOf("firefox")!==-1,{WHEEL_EVENTS:cw}=Wo,jc="wheel",Xc=4.000244140625,lw=40,uw=.25;class hw extends kr{constructor(e,t,n){super(e,t,n),this.handleEvent=r=>{if(!this.options.enable)return;let i=r.deltaY;ns.WheelEvent&&(aw&&r.deltaMode===ns.WheelEvent.DOM_DELTA_PIXEL&&(i/=ns.devicePixelRatio),r.deltaMode===ns.WheelEvent.DOM_DELTA_LINE&&(i*=lw)),i!==0&&i%Xc===0&&(i=Math.floor(i/Xc)),r.shiftKey&&i&&(i=i*uw),this.callback({type:jc,center:{x:r.clientX,y:r.clientY},delta:-i,srcEvent:r,pointerType:"mouse",target:r.target})},this.events=(this.options.events||[]).concat(cw),this.events.forEach(r=>e.addEventListener(r,this.handleEvent,ro?{passive:!1}:!1))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===jc&&(this.options.enable=t)}}const{MOUSE_EVENTS:fw}=Wo,Yc="pointermove",qc="pointerover",Kc="pointerout",Zc="pointerenter",Qc="pointerleave";class dw extends kr{constructor(e,t,n){super(e,t,n),this.handleEvent=i=>{this.handleOverEvent(i),this.handleOutEvent(i),this.handleEnterEvent(i),this.handleLeaveEvent(i),this.handleMoveEvent(i)},this.pressed=!1;const{enable:r}=this.options;this.enableMoveEvent=r,this.enableLeaveEvent=r,this.enableEnterEvent=r,this.enableOutEvent=r,this.enableOverEvent=r,this.events=(this.options.events||[]).concat(fw),this.events.forEach(i=>e.addEventListener(i,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===Yc&&(this.enableMoveEvent=t),e===qc&&(this.enableOverEvent=t),e===Kc&&(this.enableOutEvent=t),e===Zc&&(this.enableEnterEvent=t),e===Qc&&(this.enableLeaveEvent=t)}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit(qc,e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit(Kc,e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit(Zc,e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit(Qc,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit(Yc,e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const{KEY_EVENTS:pw}=Wo,Jc="keydown",Gc="keyup";class _w extends kr{constructor(e,t,n){super(e,t,n),this.handleEvent=r=>{const i=r.target||r.srcElement;i.tagName==="INPUT"&&i.type==="text"||i.tagName==="TEXTAREA"||(this.enableDownEvent&&r.type==="keydown"&&this.callback({type:Jc,srcEvent:r,key:r.key,target:r.target}),this.enableUpEvent&&r.type==="keyup"&&this.callback({type:Gc,srcEvent:r,key:r.key,target:r.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(pw),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach(r=>e.addEventListener(r,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===Jc&&(this.enableDownEvent=t),e===Gc&&(this.enableUpEvent=t)}}const el="contextmenu";class gw extends kr{constructor(e,t,n){super(e,t,n),this.handleEvent=r=>{this.options.enable&&this.callback({type:el,center:{x:r.clientX,y:r.clientY},srcEvent:r,pointerType:"mouse",target:r.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e===el&&(this.options.enable=t)}}const tl=1,io=2,sl=4,mw={pointerdown:tl,pointermove:io,pointerup:sl,mousedown:tl,mousemove:io,mouseup:sl},yw=0,Tw=1,bw=2,vw=1,ww=2,Aw=4;function Ew(s){const e=mw[s.srcEvent.type];if(!e)return null;const{buttons:t,button:n}=s.srcEvent;let r=!1,i=!1,o=!1;return e===io?(r=!!(t&vw),i=!!(t&Aw),o=!!(t&ww)):(r=n===yw,i=n===Tw,o=n===bw),{leftButton:r,middleButton:i,rightButton:o}}function Sw(s,e){const t=s.center;if(!t)return null;const n=e.getBoundingClientRect(),r=n.width/e.offsetWidth||1,i=n.height/e.offsetHeight||1,o={x:(t.x-n.left-e.clientLeft)/r,y:(t.y-n.top-e.clientTop)/i};return{center:t,offsetCenter:o}}const vi={srcElement:"root",priority:0};class xw{constructor(e){this.handleEvent=t=>{if(this.isEmpty())return;const n=this._normalizeEvent(t);let r=t.srcEvent.target;for(;r&&r!==n.rootElement;){if(this._emit(n,r),n.handled)return;r=r.parentNode}this._emit(n,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,n,r=!1,i=!1){const{handlers:o,handlersByElement:a}=this;let c=vi;typeof n=="string"||n&&n.addEventListener?c={...vi,srcElement:n}:n&&(c={...vi,...n});let l=a.get(c.srcElement);l||(l=[],a.set(c.srcElement,l));const u={type:e,handler:t,srcElement:c.srcElement,priority:c.priority};r&&(u.once=!0),i&&(u.passive=!0),o.push(u),this._active=this._active||!u.passive;let h=l.length-1;for(;h>=0&&!(l[h].priority>=u.priority);)h--;l.splice(h+1,0,u)}remove(e,t){const{handlers:n,handlersByElement:r}=this;for(let i=n.length-1;i>=0;i--){const o=n[i];if(o.type===e&&o.handler===t){n.splice(i,1);const a=r.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&r.delete(o.srcElement)}}this._active=n.some(i=>!i.passive)}_emit(e,t){const n=this.handlersByElement.get(t);if(n){let r=!1;const i=()=>{e.handled=!0},o=()=>{e.handled=!0,r=!0},a=[];for(let c=0;c<n.length;c++){const{type:l,handler:u,once:h}=n[c];if(u({...e,type:l,stopPropagation:i,stopImmediatePropagation:o}),h&&a.push(n[c]),r)break}for(let c=0;c<a.length;c++){const{type:l,handler:u}=a[c];this.remove(l,u)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...Ew(e),...Sw(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}const Rw={events:null,recognizers:null,recognizerOptions:{},Manager:tw,touchAction:"none",tabIndex:0};class Iw{constructor(e=null,t){this._onBasicInput=r=>{const{srcEvent:i}=r,o=rw[i.type];o&&this.manager.emit(o,r)},this._onOtherEvent=r=>{this.manager.emit(r.type,r)},this.options={...Rw,...t},this.events=new Map,this.setElement(e);const{events:n}=this.options;n&&this.on(n)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;const{options:t}=this,n=t.Manager;this.manager=new n(e,{touchAction:t.touchAction,recognizers:t.recognizers||sw}).on("hammer.input",this._onBasicInput),t.recognizers||Object.keys(Wc).forEach(r=>{const i=this.manager.get(r);i&&Wc[r].forEach(o=>{i.recognizeWith(o)})});for(const r in t.recognizerOptions){const i=this.manager.get(r);if(i){const o=t.recognizerOptions[r];delete o.enable,i.set(o)}}this.wheelInput=new hw(e,this._onOtherEvent,{enable:!1}),this.moveInput=new dw(e,this._onOtherEvent,{enable:!1}),this.keyInput=new _w(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new gw(e,this._onOtherEvent,{enable:!1});for(const[r,i]of this.events)i.isEmpty()||(this._toggleRecognizer(i.recognizerName,!0),this.manager.on(r,i.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,t,n){this._addEventHandler(e,t,n,!1)}once(e,t,n){this._addEventHandler(e,t,n,!0)}watch(e,t,n){this._addEventHandler(e,t,n,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){const{manager:n}=this;if(!n)return;const r=n.get(e);if(r&&r.options.enable!==t){r.set({enable:t});const i=nw[e];i&&!this.options.recognizers&&i.forEach(o=>{const a=n.get(o);t?(a.requireFailure(e),r.dropRequireFailure(o)):a.dropRequireFailure(e)})}this.wheelInput.enableEventType(e,t),this.moveInput.enableEventType(e,t),this.keyInput.enableEventType(e,t),this.contextmenuInput.enableEventType(e,t)}_addEventHandler(e,t,n,r,i){if(typeof e!="string"){n=t;for(const u in e)this._addEventHandler(u,e[u],n,r,i);return}const{manager:o,events:a}=this,c=Hc[e]||e;let l=a.get(c);l||(l=new xw(this),a.set(c,l),l.recognizerName=iw[c]||c,o&&o.on(c,l.handleEvent)),l.add(e,t,n,r,i),l.isEmpty()||this._toggleRecognizer(l.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const o in e)this._removeEventHandler(o,e[o]);return}const{events:n}=this,r=Hc[e]||e,i=n.get(r);if(i&&(i.remove(e,t),i.isEmpty())){const{recognizerName:o}=i;let a=!1;for(const c of n.values())if(c.recognizerName===o&&!c.isEmpty()){a=!0;break}a||this._toggleRecognizer(o,!1)}}}function it(){}const Cw=({isDragging:s})=>s?"grabbing":"grab",_h={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{type:"webgl"},gl:null,glOptions:{},canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:it,onWebGLInitialized:it,onResize:it,onViewStateChange:it,onInteractionStateChange:it,onBeforeRender:it,onAfterRender:it,onLoad:it,onError:s=>G.error(s.message,s.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:Cw,getTooltip:null,debug:!1,drawPickingColors:!1};class gh{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new en({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=n=>{const{_pickRequest:r}=this;if(n.type==="pointerleave")r.x=-1,r.y=-1,r.radius=0;else{if(n.leftButton||n.rightButton)return;{const i=n.offsetCenter;if(!i)return;r.x=i.x,r.y=i.y,r.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:r.x,y:r.y}),r.event=n},this._onEvent=n=>{const r=Yi[n.type],i=n.offsetCenter;if(!r||!i||!this.layerManager)return;const o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:o,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:c}=a,l=c&&(c[r.handler]||c.props[r.handler]),u=this.props[r.handler];let h=!1;l&&(h=l.call(c,a,n)),h||(u==null||u(a,n),this.widgetManager.onEvent(a,n))},this._onPointerDown=n=>{const r=n.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:r.x,y:r.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo},this.props={..._h,...e},e=this.props,e.viewState&&e.initialViewState&&G.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device?this.device=e.device:e.gl&&(e.gl instanceof WebGLRenderingContext&&G.error("WebGL1 context not supported.")(),this.device=Xs.attach(e.gl));let t=this.device;t||(os.registerDevices([Xs]),t=os.createDevice({...e.deviceProps,canvas:this._createCanvas(e)})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&ps.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,n,r,i,o,a,c,l,u;(e=this.animationLoop)==null||e.stop(),(t=this.animationLoop)==null||t.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,(n=this.layerManager)==null||n.finalize(),this.layerManager=null,(r=this.viewManager)==null||r.finalize(),this.viewManager=null,(i=this.effectManager)==null||i.finalize(),this.effectManager=null,(o=this.deckRenderer)==null||o.finalize(),this.deckRenderer=null,(a=this.deckPicker)==null||a.finalize(),this.deckPicker=null,(c=this.eventManager)==null||c.destroy(),this.eventManager=null,(l=this.widgetManager)==null||l.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&((u=this.canvas.parentElement)==null||u.removeChild(this.canvas),this.canvas=null)}setProps(e){var n;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&G.removed("onLayerHover","onHover")(),"onLayerClick"in e&&G.removed("onLayerClick","onClick")(),e.initialViewState&&!Ne(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),(n=this.animationLoop)==null||n.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const n=this.viewManager.needsRedraw(e),r=this.layerManager.needsRedraw(e),i=this.effectManager.needsRedraw(e),o=this.deckRenderer.needsRedraw(e);return t=t||n||r||i||o,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return pe(this.viewManager),this.viewManager.views}getViewports(e){return pe(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const n in e)this.layerManager.resourceManager.add({resourceId:n,data:e[n],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var t;(t=this.layerManager)==null||t.removeDefaultShaderModule(e)}_pick(e,t,n){pe(this.deckPicker);const{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(t).timeStart();const i=this.deckPicker[e]({layers:this.layerManager.getLayers(n),views:this.viewManager.getViews(),viewports:this.getViewports(n),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...n});return r.get(t).timeEnd(),i}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),pe(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){var r;if(!this.canvas)return;const{width:t,height:n}=e;if(t||t===0){const i=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=i}if(n||n===0){const i=Number.isFinite(n)?`${n}px`:n;this.canvas.style.position=((r=e.style)==null?void 0:r.position)||"absolute",this.canvas.style.height=i}}_updateCanvasSize(){var r,i;const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,n=e.clientHeight??e.height;(t!==this.width||n!==this.height)&&(this.width=t,this.height=n,(r=this.viewManager)==null||r.setProps({width:t,height:n}),(i=this.layerManager)==null||i.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:n}))}_createAnimationLoop(e,t){const{gl:n,onError:r,useDevicePixels:i}=t;return new JT({device:e,useDevicePixels:i,autoResizeDrawingBuffer:!n,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:r})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new Qu({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var t,n,r;const{_pickRequest:e}=this;if(e.event){const{result:i,emptyInfo:o}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=i.length>0;let a=o,c=!1;for(const l of i)a=l,c=((t=l.layer)==null?void 0:t.onHover(l,e.event))||c;c||((r=(n=this.props).onHover)==null||r.call(n,a,e.event),this.widgetManager.onHover(a,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var r,i;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=(r=this.device.canvasContext)==null?void 0:r.canvas),this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device instanceof Xs&&this.props.onWebGLInitialized(this.device.gl);const t=new Yu;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new Iw(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const o in Yi)this.eventManager.on(o,this._onEvent);this.viewManager=new gb({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const n=this.viewManager.getViewports()[0];this.layerManager=new _b(this.device,{deck:this,stats:this.stats,viewport:n,timeline:t}),this.effectManager=new Nb({deck:this,device:this.device}),this.deckRenderer=new Fb(this.device),this.deckPicker=new zb(this.device),this.widgetManager=new jb({deck:this,parentElement:(i=this.canvas)==null?void 0:i.parentElement}),this.widgetManager.addDefault(new Yb),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){var o;const{device:n,gl:r}=this.layerManager.context;this.props.onBeforeRender({device:n,gl:r});const i={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};(o=this.deckRenderer)==null||o.renderLayers(i),i.pass==="screen"&&this.widgetManager.onRedraw({viewports:i.viewports,layers:i.layers}),this.props.onAfterRender({device:n,gl:r})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),G.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const n=os.stats.get("Memory Usage");e.bufferMemory=n.get("Buffer Memory").count,e.textureMemory=n.get("Texture Memory").count,e.renderbufferMemory=n.get("Renderbuffer Memory").count,e.gpuMemory=n.get("GPU Memory").count}}gh.defaultProps=_h;gh.VERSION=Hp;function Pw(s){switch(s){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return Zl(s)}}const Mw=Kl;function Pn(s,e){return{attribute:s,format:e.size>1?`${e.type}x${e.size}`:e.type,byteOffset:e.offset||0}}function Ct(s){return s.stride||s.size*s.bytesPerElement}function Ow(s,e){return s.type===e.type&&s.size===e.size&&Ct(s)===Ct(e)&&(s.offset||0)===(e.offset||0)}function oo(s,e){e.offset&&G.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=Ct(s),n=e.vertexOffset!==void 0?e.vertexOffset:s.vertexOffset||0,r=e.elementOffset||0,i=n*t+r*s.bytesPerElement+(s.offset||0);return{...e,offset:i,stride:t}}function Nw(s,e){const t=oo(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}class kw{constructor(e,t,n){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const r=t.logicalType||t.type,i=r==="float64";let{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0);let a;i?a="float32":!r&&t.isIndexed?a="uint32":a=r||"float32";let c=Pw(r||a);this.doublePrecision=i,i&&t.fp64===!1&&(c=Float32Array),this.value=null,this.settings={...t,defaultType:c,defaultValue:o,logicalType:r,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:c.BYTES_PER_ELEMENT},this.state={...n,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*Ct(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),ps.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const n={};if(this.state.constant){const r=this.value;if(t){const i=oo(this.getAccessor(),t),o=i.offset/r.BYTES_PER_ELEMENT,a=i.size||this.size;n[e]=r.subarray(o,o+a)}else n[e]=r}else n[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?n[`${e}64Low`]=n[e]:n[`${e}64Low`]=new Float32Array(this.size)),n}_getBufferLayout(e=this.id,t=null){const n=this.getAccessor(),r=[],i={name:this.id,byteStride:Ct(n),attributes:r};if(this.doublePrecision){const o=Nw(n,t||{});r.push(Pn(e,{...n,...o.high}),Pn(`${e}64Low`,{...n,...o.low}))}else if(t){const o=oo(n,t);r.push(Pn(e,{...n,...o}))}else r.push(Pn(e,n));return i}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:n,size:r}=this,i=n*r;if(t&&i&&t.length>=i){const o=new Array(r).fill(1/0),a=new Array(r).fill(-1/0);for(let c=0;c<i;)for(let l=0;l<r;l++){const u=t[c++];u<o[l]&&(o[l]=u),u>a[l]&&(a[l]=u)}e=[o,a]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let n;ArrayBuffer.isView(e)?n={value:e}:e instanceof se?n={buffer:e}:n=e;const r={...this.settings,...n};if(ArrayBuffer.isView(n.value)){if(!n.type)if(this.doublePrecision&&n.value instanceof Float64Array)r.type="float32";else{const o=Mw(n.value);r.type=r.normalized?o.replace("int","norm"):o}r.bytesPerElement=n.value.BYTES_PER_ELEMENT,r.stride=Ct(r)}if(t.bounds=null,n.constant){let i=n.value;if(i=this._normalizeValue(i,[],0),this.settings.normalized&&(i=this.normalizeConstant(i)),!(!t.constant||!this._areValuesEqual(i,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(i)?i:new Float32Array(i)}else if(n.buffer){const i=n.buffer;t.externalBuffer=i,t.constant=!1,this.value=n.value||null}else if(n.value){this._checkExternalBuffer(n);let i=n.value;t.externalBuffer=null,t.constant=!1,this.value=i;let{buffer:o}=this;const a=Ct(r),c=(r.vertexOffset||0)*a;if(this.doublePrecision&&i instanceof Float64Array&&(i=ai(i,r)),this.settings.isIndexed){const u=this.settings.defaultType;i.constructor!==u&&(i=new u(i))}const l=i.byteLength+c+a*2;(!o||o.byteLength<l)&&(o=this._createBuffer(l)),o.write(i,c)}return this.setAccessor(r),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:n=0,endOffset:r}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?ai(t,{size:this.size,startIndex:n,endIndex:r}):t.subarray(n,r),n*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:n}=this,r=n.allocatedValue,i=ps.allocate(r,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=i;const{byteOffset:o}=this;let{buffer:a}=this;return(!a||a.byteLength<i.byteLength+o)&&(a=this._createBuffer(i.byteLength+o),t&&r&&a.write(r instanceof Float64Array?ai(r,this):r,o)),n.allocatedValue=i,n.constant=!1,n.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const n=this.settings.defaultType;let r=!1;if(this.doublePrecision&&(r=t.BYTES_PER_ELEMENT<4),r)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof n)&&this.settings.normalized&&!("normalized"in e)&&G.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,n){const{defaultValue:r,size:i}=this.settings;if(Number.isFinite(e))return t[n]=e,t;if(!e){let o=i;for(;--o>=0;)t[n+o]=r[o];return t}switch(i){case 4:t[n+3]=Number.isFinite(e[3])?e[3]:r[3];case 3:t[n+2]=Number.isFinite(e[2])?e[2]:r[2];case 2:t[n+1]=Number.isFinite(e[1])?e[1]:r[1];case 1:t[n+0]=Number.isFinite(e[0])?e[0]:r[0];break;default:let o=i;for(;--o>=0;)t[n+o]=Number.isFinite(e[o])?e[o]:r[o]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:n}=this;for(let r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}_createBuffer(e){var r;this._buffer&&this._buffer.destroy();const{isIndexed:t,type:n}=this.settings;return this._buffer=this.device.createBuffer({...(r=this._buffer)==null?void 0:r.props,id:this.id,usage:t?se.INDEX:se.VERTEX,indexType:t?n:void 0,byteLength:e}),this._buffer}}const nl=[],rl=[];function mh(s,e=0,t=1/0){let n=nl;const r={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?n=s:s.length>0&&(rl.length=s.length,n=rl):n=nl,(e>0||Number.isFinite(t))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(e,t),r.index=e-1),{iterable:n,objectInfo:r}}function yh(s){return s&&s[Symbol.asyncIterator]}function Th(s,e){const{size:t,stride:n,offset:r,startIndices:i,nested:o}=e,a=s.BYTES_PER_ELEMENT,c=n?n/a:t,l=r?r/a:0,u=Math.floor((s.length-l)/c);return(h,{index:f,target:_})=>{if(!i){const C=f*c+l;for(let I=0;I<t;I++)_[I]=s[C+I];return _}const T=i[f],v=i[f+1]||u;let R;if(o){R=new Array(v-T);for(let C=T;C<v;C++){const I=C*c+l;_=new Array(t);for(let M=0;M<t;M++)_[M]=s[I+M];R[C-T]=_}}else if(c===t)R=s.subarray(T*t+l,v*t+l);else{R=new s.constructor((v-T)*t);let C=0;for(let I=T;I<v;I++){const M=I*c+l;for(let N=0;N<t;N++)R[C++]=s[M+N]}}return R}}const Dw=[],Un=[[0,1/0]];function Fw(s,e){if(s===Un||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;const t=[],n=s.length;let r=0;for(let i=0;i<n;i++){const o=s[i];o[1]<e[0]?(t.push(o),r=i+1):o[0]>e[1]?t.push(o):e=[Math.min(o[0],e[0]),Math.max(o[1],e[1])]}return t.splice(r,0,e),t}const Uw={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function bh(s,e){if(!s)return null;Number.isFinite(s)&&(s={type:"interpolation",duration:s});const t=s.type||"interpolation";return{...Uw[t],...e,...s,type:t}}class vh extends kw{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Un}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!Ow(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,n=this.settings.transition,r=Array.isArray(t)?e[t.find(i=>e[i])]:e[t];return bh(r,n)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:n=0,endRow:r=1/0}=t;this.state.updateRanges=Fw(this.state.updateRanges,[n,r])}else this.state.updateRanges=Un}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=Dw}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:n}=this;return n.noAlloc?!1:n.update?(super.allocate(e,t.updateRanges!==Un),!0):!1}updateBuffer({numInstances:e,data:t,props:n,context:r}){if(!this.needsUpdate())return!1;const{state:{updateRanges:i},settings:{update:o,noAlloc:a}}=this;let c=!0;if(o){for(const[l,u]of i)o.call(r,this,{data:t,startRow:l,endRow:u,props:n,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[l,u]of i){const h=Number.isFinite(l)?this.getVertexOffset(l):0,f=Number.isFinite(u)?this.getVertexOffset(u):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:h,endOffset:f})}this._checkAttributeArray()}else c=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),c}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:n,settings:r}=this;if(!e)return n.binaryValue=null,n.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(n.binaryValue===e)return this.clearNeedsUpdate(),!0;if(n.binaryValue=e,this.setNeedsRedraw(),r.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const o=e;pe(ArrayBuffer.isView(o.value),`invalid ${r.accessor}`);const a=!!o.size&&o.size!==this.size;return n.binaryAccessor=Th(o.value,{size:o.size||this.size,stride:o.stride,offset:o.offset,startIndices:t,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const n in e)Object.assign(t,super.getValue(n,e[n]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,n=super._getBufferLayout(),{stepMode:r}=this.settings;if(r==="dynamic"?n.stepMode=e?e.isInstanced?"instance":"vertex":"instance":n.stepMode=r??"vertex",!t)return n;for(const i in t){const o=super._getBufferLayout(i,t[i]);n.attributes.push(...o.attributes)}return n}_autoUpdater(e,{data:t,startRow:n,endRow:r,props:i,numInstances:o}){if(e.constant)return;const{settings:a,state:c,value:l,size:u,startIndices:h}=e,{accessor:f,transform:_}=a,T=c.binaryAccessor||(typeof f=="function"?f:i[f]);pe(typeof T=="function",`accessor "${f}" is not a function`);let v=e.getVertexOffset(n);const{iterable:R,objectInfo:C}=mh(t,n,r);for(const I of R){C.index++;let M=T(I,C);if(_&&(M=_.call(this,M)),h){const N=(C.index<h.length-1?h[C.index+1]:o)-h[C.index];if(M&&Array.isArray(M[0])){let U=v;for(const B of M)e._normalizeValue(B,l,U),U+=u}else M&&M.length>u?l.set(M,v):(e._normalizeValue(M,C.target,0),ub({target:l,source:C.target,start:v,count:N}));v+=N*u}else e._normalizeValue(M,l,v),v+=u}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let n=!0;switch(t){case 4:n=n&&Number.isFinite(e[3]);case 3:n=n&&Number.isFinite(e[2]);case 2:n=n&&Number.isFinite(e[1]);case 1:n=n&&Number.isFinite(e[0]);break;default:n=!1}if(!n)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function wi(s){const{source:e,target:t,start:n=0,size:r,getData:i}=s,o=s.end||t.length,a=e.length,c=o-n;if(a>c){t.set(e.subarray(0,c),n);return}if(t.set(e,n),!i)return;let l=a;for(;l<c;){const u=i(l,e);for(let h=0;h<r;h++)t[n+l]=u[h]||0,l++}}function Bw({source:s,target:e,size:t,getData:n,sourceStartIndices:r,targetStartIndices:i}){if(!r||!i)return wi({source:s,target:e,size:t,getData:n}),e;let o=0,a=0;const c=n&&((u,h)=>n(u+a,h)),l=Math.min(r.length,i.length);for(let u=1;u<l;u++){const h=r[u]*t,f=i[u]*t;wi({source:s.subarray(o,h),target:e,start:a,end:f,size:t,getData:c}),o=h,a=f}return a<e.length&&wi({source:[],target:e,start:a,size:t,getData:c}),e}function Lw(s){const{device:e,settings:t,value:n}=s,r=new vh(e,t);return r.setData({value:n instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),r}function wh(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${s}"`)}}function Ah(s){switch(s){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function Eh(s){s.push(s.shift())}function Vw(s,e){const{doublePrecision:t,settings:n,value:r,size:i}=s,o=t&&r instanceof Float64Array?2:1;let a=0;const{shaderAttributes:c}=s.settings;if(c)for(const l of Object.values(c))a=Math.max(a,l.vertexOffset??0);return(n.noAlloc?r.length:(e+a)*i)*o}function Sh({device:s,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t==null||t.destroy(),t=s.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function xh({device:s,buffer:e,attribute:t,fromLength:n,toLength:r,fromStartIndices:i,getData:o=a=>a}){const a=t.doublePrecision&&t.value instanceof Float64Array?2:1,c=t.size*a,l=t.byteOffset,u=t.settings.bytesPerElement<4?l/t.settings.bytesPerElement*4:l,h=t.startIndices,f=i&&h,_=t.isConstant;if(!f&&e&&n>=r)return e;const T=t.value instanceof Float64Array?Float32Array:t.value.constructor,v=_?t.value:new T(t.getBuffer().readSyncWebGL(l,r*T.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!_){const M=o;o=(N,U)=>t.normalizeConstant(M(N,U))}const R=_?(M,N)=>o(v,N):(M,N)=>o(v.subarray(M+l,M+l+c),N),C=e?new Float32Array(e.readSyncWebGL(u,n*4).buffer):new Float32Array(0),I=new Float32Array(r);return Bw({source:C,target:I,sourceStartIndices:i,targetStartIndices:h,size:c,getData:R}),(!e||e.byteLength<I.byteLength+u)&&(e==null||e.destroy(),e=s.createBuffer({byteLength:I.byteLength+u,usage:35050})),e.write(I,u),e}class Rh{constructor({device:e,attribute:t,timeline:n}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new Mr(n),this.attribute=t,this.attributeInTransition=Lw(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,n=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=Vw(this.attribute,t),this.transition.start({...e,duration:n})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class $w extends Rh{constructor({device:e,attribute:t,timeline:n}){super({device:e,attribute:t,timeline:n}),this.type="interpolation",this.transform=Hw(e,t)}start(e,t){const n=this.currentLength,r=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:i,attribute:o}=this;Eh(i),i[0]=xh({device:this.device,buffer:i[0],attribute:o,fromLength:n,toLength:this.currentLength,fromStartIndices:r,getData:e.enter}),i[1]=Sh({device:this.device,source:i[0],target:i[1]}),this.setBuffer(i[1]);const{transform:a}=this,c=a.model;let l=Math.floor(this.currentLength/o.size);Ih(o)&&(l/=2),c.setVertexCount(l),o.isConstant?(c.setAttributes({aFrom:i[0]}),c.setConstantAttributes({aTo:o.value})):c.setAttributes({aFrom:i[0],aTo:o.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:i[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:n}=this.transition;let r=n/e;t&&(r=t(r));const{model:i}=this.transform;i.setUniforms({time:r}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const zw=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`,Ww=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function Ih(s){return s.doublePrecision&&s.value instanceof Float64Array}function Hw(s,e){const t=e.size,n=wh(t),r=Ah(t),i=e.getBufferLayout();return Ih(e)?new Qs(s,{vs:Ww,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:r,byteOffset:0},{attribute:"aFrom64Low",format:r,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:r,byteOffset:0},{attribute:"aTo64Low",format:r,byteOffset:4*t}]}],modules:[lm],defines:{ATTRIBUTE_TYPE:n,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new Qs(s,{vs:zw,bufferLayout:[{name:"aFrom",format:r},{name:"aTo",format:i.attributes[0].format}],defines:{ATTRIBUTE_TYPE:n},varyings:["vCurrent"],disableWarnings:!0})}class jw extends Rh{constructor({device:e,attribute:t,timeline:n}){super({device:e,attribute:t,timeline:n}),this.type="spring",this.texture=Kw(e),this.framebuffer=Zw(e,this.texture),this.transform=qw(e,t)}start(e,t){const n=this.currentLength,r=this.currentStartIndices;super.start(e,t);const{buffers:i,attribute:o}=this;for(let c=0;c<2;c++)i[c]=xh({device:this.device,buffer:i[c],attribute:o,fromLength:n,toLength:this.currentLength,fromStartIndices:r,getData:e.enter});i[2]=Sh({device:this.device,source:i[0],target:i[2]}),this.setBuffer(i[1]);const{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/o.size)),o.isConstant?a.setConstantAttributes({aTo:o.value}):a.setAttributes({aTo:o.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:n,transition:r}=this,i=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]}),t.model.setUniforms({stiffness:i.stiffness,damping:i.damping}),t.run({framebuffer:n,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),Eh(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(n)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const Xw=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,Yw=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function qw(s,e){const t=wh(e.size),n=Ah(e.size);return new Qs(s,{vs:Xw,fs:Yw,bufferLayout:[{name:"aPrev",format:n},{name:"aCur",format:n},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function Kw(s){return s.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function Zw(s,e){return s.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const Qw={interpolation:$w,spring:jw};class Jw{constructor(e,{id:t,timeline:n}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=n,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:n}){this.numInstances=n||1;for(const r in e){const i=e[r],o=i.getTransitionSetting(t);o&&this._updateAttribute(r,i,o)}for(const r in this.transitions){const i=e[r];(!i||!i.getTransitionSetting(t))&&this._removeTransition(r)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const n=this.transitions[t];n.inProgress&&(e[t]=n.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,n){const r=this.transitions[e];let i=!r||r.type!==n.type;if(i){r&&this._removeTransition(e);const o=Qw[n.type];o?this.transitions[e]=new o({attribute:t,timeline:this.timeline,device:this.device}):(G.error(`unsupported transition type '${n.type}'`)(),i=!1)}(i||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(n,this.numInstances))}}const il="attributeManager.invalidate",Gw="attributeManager.updateStart",eA="attributeManager.updateEnd",tA="attribute.updateStart",sA="attribute.allocate",nA="attribute.updateEnd";class rA{constructor(e,{id:t="attribute-manager",stats:n,timeline:r}={}){this.mergeBoundsMemoized=nn($T),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=n,this.attributeTransitionManager=new Jw(e,{id:`${t}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const n=this._invalidateTrigger(e,t);me(il,this,e,n)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);me(il,this,"all")}update({data:e,numInstances:t,startIndices:n=null,transitions:r,props:i={},buffers:o={},context:a={}}){let c=!1;me(Gw,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const l in this.attributes){const u=this.attributes[l],h=u.settings.accessor;u.startIndices=n,u.numInstances=t,i[l]&&G.removed(`props.${l}`,`data.attributes.${l}`)(),u.setExternalBuffer(o[l])||u.setBinaryValue(typeof h=="string"?o[h]:void 0,e.startIndices)||typeof h=="string"&&!o[h]&&u.setConstantValue(i[h])||u.needsUpdate()&&(c=!0,this._updateAttribute({attribute:u,numInstances:t,data:e,props:i,context:a})),this.needsRedraw=this.needsRedraw||u.needsRedraw()}c&&me(eA,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:r})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(n=>{var r;return(r=this.attributes[n])==null?void 0:r.getBounds()});return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:n}=this,r={...n.getAttributes()};for(const i in t){const o=t[i];o.needsRedraw(e)&&!n.hasAttribute(i)&&(r[i]=o)}return r}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const n in e){const r=e[n],i={...r,id:n,size:r.isIndexed&&1||r.size||1,...t};this.attributes[n]=new vh(this.device,i)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(r=>{e[r]||(e[r]=[]),e[r].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:n,updateTriggers:r}=this,i=r[e];return i&&i.forEach(o=>{const a=n[o];a&&a.setNeedsUpdate(a.id,t)}),i}_updateAttribute(e){const{attribute:t,numInstances:n}=e;if(me(tA,t),t.constant){t.setConstantValue(t.value);return}t.allocate(n)&&me(sA,t,n),t.updateBuffer(e)&&(this.needsRedraw=!0,me(nA,t,n))}}class iA extends Mr{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:n,duration:r,easing:i}}=this,o=i(e/r);this._value=rr(t,n,o)}}const ol=1e-5;function al(s,e,t,n,r){const i=e-s,a=(t-e)*r,c=-i*n;return a+c+i+e}function oA(s,e,t,n,r){if(Array.isArray(t)){const i=[];for(let o=0;o<t.length;o++)i[o]=al(s[o],e[o],t[o],n,r);return i}return al(s,e,t,n,r)}function cl(s,e){if(Array.isArray(s)){let t=0;for(let n=0;n<s.length;n++){const r=s[n]-e[n];t+=r*r}return Math.sqrt(t)}return Math.abs(s-e)}class aA extends Mr{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:n,stiffness:r}=this.settings,{_prevValue:i=e,_currValue:o=e}=this;let a=oA(i,o,t,n,r);const c=cl(a,t),l=cl(a,o);c<ol&&l<ol&&(a=t,this.end()),this._prevValue=o,this._currValue=a}}const cA={interpolation:iA,spring:aA};class lA{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,n,r){const{transitions:i}=this;if(i.has(e)){const c=i.get(e),{value:l=c.settings.fromValue}=c;t=l,this.remove(e)}if(r=bh(r),!r)return;const o=cA[r.type];if(!o){G.error(`unsupported transition type '${r.type}'`)();return}const a=new o(this.timeline);a.start({...r,fromValue:t,toValue:n}),i.set(e,a)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,n]of this.transitions)n.update(),e[t]=n.value,n.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function uA(s){const e=s[_t];for(const t in e){const n=e[t],{validate:r}=n;if(r&&!r(s[t],n))throw new Error(`Invalid prop ${t}: ${s[t]}`)}}function hA(s,e){const t=Ch({newProps:s,oldProps:e,propTypes:s[_t],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=dA(s,e);let r=!1;return n||(r=pA(s,e)),{dataChanged:n,propsChanged:t,updateTriggersChanged:r,extensionsChanged:_A(s,e),transitionsChanged:fA(s,e)}}function fA(s,e){if(!s.transitions)return!1;const t={},n=s[_t];let r=!1;for(const i in s.transitions){const o=n[i],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&ao(s[i],e[i],o)&&(t[i]=!0,r=!0)}return r?t:!1}function Ch({newProps:s,oldProps:e,ignoreProps:t={},propTypes:n={},triggerName:r="props"}){if(e===s)return!1;if(typeof s!="object"||s===null)return`${r} changed shallowly`;if(typeof e!="object"||e===null)return`${r} changed shallowly`;for(const i of Object.keys(s))if(!(i in t)){if(!(i in e))return`${r}.${i} added`;const o=ao(s[i],e[i],n[i]);if(o)return`${r}.${i} ${o}`}for(const i of Object.keys(e))if(!(i in t)){if(!(i in s))return`${r}.${i} dropped`;if(!Object.hasOwnProperty.call(s,i)){const o=ao(s[i],e[i],n[i]);if(o)return`${r}.${i} ${o}`}}return!1}function ao(s,e,t){let n=t&&t.equal;return n&&!n(s,e,t)||!n&&(n=s&&e&&s.equals,n&&!n.call(s,e))?"changed deeply":!n&&e!==s?"changed shallowly":null}function dA(s,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:n,_dataDiff:r}=s;return n?n(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&r&&(t=r(s.data,e.data)||t),t}function pA(s,e){if(e===null)return{all:!0};if("all"in s.updateTriggers&&ll(s,e,"all"))return{all:!0};const t={};let n=!1;for(const r in s.updateTriggers)r!=="all"&&ll(s,e,r)&&(t[r]=!0,n=!0);return n?t:!1}function _A(s,e){if(e===null)return!0;const t=e.extensions,{extensions:n}=s;if(n===t)return!1;if(!t||!n||n.length!==t.length)return!0;for(let r=0;r<n.length;r++)if(!n[r].equals(t[r]))return!0;return!1}function ll(s,e,t){let n=s.updateTriggers[t];n=n??{};let r=e.updateTriggers[t];return r=r??{},Ch({oldProps:r,newProps:n,triggerName:t})}const gA="count(): argument not an object",mA="count(): argument not a container";function yA(s){if(!bA(s))throw new Error(gA);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(TA(s))return Object.keys(s).length;throw new Error(mA)}function TA(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function bA(s){return s!==null&&typeof s=="object"}function ul(s,e){if(!e)return s;const t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(n=>n.name==="project64"))){const n=t.modules.findIndex(r=>r.name==="project32");n>=0&&t.modules.splice(n,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{const n={...s.inject};for(const r in e.inject)n[r]=(n[r]||"")+e.inject[r];t.inject=n}return t}const vA={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},co={};function wA(s,e,t,n){if(t instanceof xe)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let r=null;t.compressed&&(r={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const i=e.createTexture({...t,sampler:{...vA,...r,...n}});return co[i.id]=s,i}function AA(s,e){!e||!(e instanceof xe)||co[e.id]===s&&(e.delete(),delete co[e.id])}const EA={boolean:{validate(s,e){return!0},equal(s,e,t){return!!s==!!e}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||lo(s)&&(s.length===3||s.length===4)},equal(s,e,t){return Ne(s,e,1)}},accessor:{validate(s,e){const t=fr(s);return t==="function"||t===fr(e.value)},equal(s,e,t){return typeof e=="function"?!0:Ne(s,e,1)}},array:{validate(s,e){return e.optional&&!s||lo(s)},equal(s,e,t){const{compare:n}=t,r=Number.isInteger(n)?n:n?1:0;return n?Ne(s,e,r):s===e}},object:{equal(s,e,t){if(t.ignore)return!0;const{compare:n}=t,r=Number.isInteger(n)?n:n?1:0;return n?Ne(s,e,r):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare&&t.ignore!==!1||s===e}},data:{transform:(s,e,t)=>{if(!s)return s;const{dataTransform:n}=t.props;return n?n(s):typeof s.shape=="string"&&s.shape.endsWith("-table")&&Array.isArray(s.data)?s.data:s}},image:{transform:(s,e,t)=>{const n=t.context;return!n||!n.device?null:wA(t.id,n.device,s,{...e.parameters,...t.props.textureParameters})},release:(s,e,t)=>{AA(t.id,s)}}};function SA(s){const e={},t={},n={};for(const[r,i]of Object.entries(s)){const o=i==null?void 0:i.deprecatedFor;if(o)n[r]=Array.isArray(o)?o:[o];else{const a=xA(r,i);e[r]=a,t[r]=a.value}}return{propTypes:e,defaultProps:t,deprecatedProps:n}}function xA(s,e){switch(fr(e)){case"object":return ks(s,e);case"array":return ks(s,{type:"array",value:e,compare:!1});case"boolean":return ks(s,{type:"boolean",value:e});case"number":return ks(s,{type:"number",value:e});case"function":return ks(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function ks(s,e){return"type"in e?{name:s,...EA[e.type],...e}:"value"in e?{name:s,type:fr(e.value),...e}:{name:s,type:"object",value:e}}function lo(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function fr(s){return lo(s)?"array":s===null?"null":typeof s}function RA(s,e){let t;for(let i=e.length-1;i>=0;i--){const o=e[i];"extensions"in o&&(t=o.extensions)}const n=uo(s.constructor,t),r=Object.create(n);r[ur]=s,r[Bt]={},r[ft]={};for(let i=0;i<e.length;++i){const o=e[i];for(const a in o)r[a]=o[a]}return Object.freeze(r),r}const IA="_mergedDefaultProps";function uo(s,e){if(!(s instanceof Dr.constructor))return{};let t=IA;if(e)for(const r of e){const i=r.constructor;i&&(t+=`:${i.extensionName||i.name}`)}const n=Ph(s,t);return n||(s[t]=CA(s,e||[]))}function CA(s,e){if(!s.prototype)return null;const n=Object.getPrototypeOf(s),r=uo(n),i=Ph(s,"defaultProps")||{},o=SA(i),a=Object.assign(Object.create(null),r,o.defaultProps),c=Object.assign(Object.create(null),r==null?void 0:r[_t],o.propTypes),l=Object.assign(Object.create(null),r==null?void 0:r[ui],o.deprecatedProps);for(const u of e){const h=uo(u.constructor);h&&(Object.assign(a,h),Object.assign(c,h[_t]),Object.assign(l,h[ui]))}return PA(a,s),OA(a,c),MA(a,l),a[_t]=c,a[ui]=l,e.length===0&&!Ho(s,"_propTypes")&&(s._propTypes=c),a}function PA(s,e){const t=kA(e);Object.defineProperties(s,{id:{writable:!0,value:t}})}function MA(s,e){for(const t in e)Object.defineProperty(s,t,{enumerable:!1,set(n){const r=`${this.id}: ${t}`;for(const i of e[t])Ho(this,i)||(this[i]=n);G.deprecated(r,e[t].join("/"))()}})}function OA(s,e){const t={},n={};for(const r in e){const i=e[r],{name:o,value:a}=i;i.async&&(t[o]=a,n[o]=NA(o))}s[cs]=t,s[Bt]={},Object.defineProperties(s,n)}function NA(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||yh(e)?this[Bt][s]=e:this[ft][s]=e},get(){if(this[ft]){if(s in this[ft])return this[ft][s]||this[cs][s];if(s in this[Bt]){const e=this[ur]&&this[ur].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[cs][s]}}return this[cs][s]}}}function Ho(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Ph(s,e){return Ho(s,e)&&s[e]}function kA(s){const e=s.componentName;return e||G.warn(`${s.name}.componentName not specified`)(),e||s.name}let DA=0;class Dr{constructor(...e){this.props=RA(this,e),this.id=this.props.id,this.count=DA++}clone(e){const{props:t}=this,n={};for(const r in t[cs])r in t[ft]?n[r]=t[ft][r]:r in t[Bt]&&(n[r]=t[Bt][r]);return new this.constructor({...t,...n,...e})}}Dr.componentName="Component";Dr.defaultProps={};const FA=Object.freeze({});class UA{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||FA}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[ur]||this.component;const t=e[ft]||{},n=e[Bt]||e,r=e[cs]||{};for(const i in t){const o=t[i];this._createAsyncPropData(i,r[i]),this._updateAsyncProp(i,o),t[i]=this.getAsyncProp(i)}for(const i in n){const o=n[i];this._createAsyncPropData(i,r[i]),this._updateAsyncProp(i,o)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(yh(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const n=this.asyncProps[e];return t===n.resolvedValue||t===n.lastValue?!1:(n.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const n=this.asyncProps[e];n&&(t=this._postProcessValue(n,t),n.resolvedValue=t,n.pendingLoadCount++,n.resolvedLoadCount=n.pendingLoadCount)}_setAsyncPropValue(e,t,n){const r=this.asyncProps[e];r&&n>=r.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),r.resolvedValue=t,r.resolvedLoadCount=n,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const n=this.asyncProps[e];if(n){n.pendingLoadCount++;const r=n.pendingLoadCount;t.then(i=>{this.component&&(i=this._postProcessValue(n,i),this._setAsyncPropValue(e,i,r),this._onResolve(e,i))}).catch(i=>{this._onError(e,i)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const n=this.asyncProps[e];if(!n)return;n.pendingLoadCount++;const r=n.pendingLoadCount;let i=[],o=0;for await(const a of t){if(!this.component)return;const{dataTransform:c}=this.component.props;c?i=c(a,i):i=i.concat(a),Object.defineProperty(i,"__diff",{enumerable:!1,value:[{startRow:o,endRow:i.length}]}),o=i.length,this._setAsyncPropValue(e,i,r)}this._onResolve(e,i)}_postProcessValue(e,t){const n=e.type;return n&&this.component&&(n.release&&n.release(e.resolvedValue,n,this.component),n.transform)?n.transform(t,n,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const r=this.component&&this.component.props[_t];this.asyncProps[e]={type:r&&r[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class BA extends UA{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const n=this.layer,r=n==null?void 0:n.props.fetch;return r?r(t,{propName:e,layer:n}):super._fetch(e,t)}_onResolve(e,t){const n=this.layer;if(n){const r=n.props.onDataLoad;e==="data"&&r&&r(t,{propName:e,layer:n})}}_onError(e,t){const n=this.layer;n&&n.raiseError(t,`loading ${e} of ${this.layer}`)}}const LA="layer.changeFlag",VA="layer.initialize",$A="layer.update",zA="layer.finalize",WA="layer.matched",hl=2**24-1,HA=Object.freeze([]),jA=nn(({oldViewport:s,viewport:e})=>s.equals(e));let je=new Uint8ClampedArray(0);const XA={data:{type:"data",value:HA,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:n,loadOptions:r,signal:i})=>{const{resourceManager:o}=t.context;r=r||t.getLoadOptions(),n=n||t.props.loaders,i&&(r={...r,fetch:{...r==null?void 0:r.fetch,signal:i}});let a=o.contains(s);return!a&&!r&&(o.add({resourceId:s,data:Ri(s,n),persistent:!1}),a=!0),a?o.subscribe({resourceId:s,onChange:c=>{var l;return(l=t.internalState)==null?void 0:l.reloadAsyncProp(e,c)},consumerId:t.id,requestId:e}):Ri(s,n,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:q.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class jo extends Dr{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Qt.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){pe(this.internalState);const t=this.internalState.viewport||this.context.viewport,n=Xu(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[r,i,o]=Wu(n,t.pixelProjectionMatrix);return e.length===2?[r,i]:[r,i,o]}unproject(e){return pe(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){pe(this.internalState);const n=this.internalState.viewport||this.context.viewport;return YT(e,{viewport:n,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setModuleParameters(e){for(const t of this.getModels())t.updateModuleSettings(e)}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===q.DEFAULT||e===q.LNGLAT||e===q.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){pe(e instanceof Uint8Array);const[t,n,r]=e;return t+n*256+r*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:yA(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){e=ul(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=ul(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:n}=e.changeFlags;if(n&&t)if(Array.isArray(n))for(const r of n)t.invalidateAll(r);else t.invalidateAll();if(t){const{props:r}=e,i=this.internalState.hasPickingBuffer,o=Number.isInteger(r.highlightedObjectIndex)||r.pickable||r.extensions.some(a=>a.getNeedsPickingBuffer.call(this,a));if(i!==o){this.internalState.hasPickingBuffer=o;const{pickingColors:a,instancePickingColors:c}=t.attributes,l=a||c;l&&(o&&l.constant&&(l.constant=!1,t.invalidate(l.id)),!l.value&&!o&&(l.constant=!0,l.value=[0,0,0]))}}}finalizeState(e){for(const n of this.getModels())n.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t,sourceLayer:n}){const{index:r}=e;return r>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[r]),e}raiseError(e,t){var n,r,i,o;t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),(r=(n=this.props).onError)!=null&&r.call(n,e)||(o=(i=this.context)==null?void 0:i.onError)==null||o.call(i,e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)==null?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!jA({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const n in e)e[n].layoutChanged()&&(t=!0);for(const n of this.getModels())this._setModelAttributes(n,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,n=this.getNumInstances(),r=this.getStartIndices();e.update({data:t.data,numInstances:n,startIndices:r,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const i=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(i)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),n=Object.create(this.props);for(const r in t)Object.defineProperty(n,r,{value:t[r]});return n}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const n=Math.floor(je.length/4);if(this.internalState.usesPickingColorCache=!0,n<t){t>hl&&G.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),je=ps.allocate(je,t,{size:4,copy:!0,maxCount:Math.max(t,hl)});const r=Math.floor(je.length/4),i=[];for(let o=n;o<r;o++)this.encodePickingColor(o,i),je[o*4+0]=i[0],je[o*4+1]=i[1],je[o*4+2]=i[2]}e.value=je.subarray(0,t*4)}_setModelAttributes(e,t,n=!1){var a;if(!Object.keys(t).length)return;if(n){const c=this.getAttributeManager();e.setBufferLayout(c.getBufferLayouts(e)),t=c.getAttributes()}const r=((a=e.userData)==null?void 0:a.excludeAttributes)||{},i={},o={};for(const c in t){if(r[c])continue;const l=t[c].getValue();for(const u in l){const h=l[u];h instanceof se?t[c].settings.isIndexed?e.setIndexBuffer(h):i[u]=h:h&&(o[u]=h)}}e.setAttributes(i),e.setConstantAttributes(o)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:n,instancePickingColors:r}=this.getAttributeManager().attributes,i=n||r,o=i&&t.attributes&&t.attributes[i.id];if(o&&o.value){const a=o.value,c=this.encodePickingColor(e);for(let l=0;l<t.length;l++){const u=i.getVertexOffset(l);a[u]===c[0]&&a[u+1]===c[1]&&a[u+2]===c[2]&&this._disablePickingIndex(l)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:n}=this.getAttributeManager().attributes,r=t||n;if(!r)return;const i=r.getVertexOffset(e),o=r.getVertexOffset(e+1);r.buffer.write(new Uint8Array(o-i),i)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,n=e||t;n&&(this.internalState.usesPickingColorCache&&n.value.buffer!==je.buffer&&(n.value=je.subarray(0,n.value.length)),n.updateSubBuffer({startOffset:0}))}_initialize(){pe(!this.internalState),pe(Number.isFinite(this.props.coordinateSystem)),me(VA,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new BA({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(G.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new lA(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){me(WA,this,this===e);const{state:t,internalState:n}=e;this!==e&&(this.internalState=n,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(me($A,this,e),!e)return;const t=this.props,n=this.context,r=this.internalState,i=n.viewport,o=this._updateUniformTransition();r.propsInTransition=o,n.viewport=r.viewport||i,this.props=o;try{const a=this._getUpdateParams(),c=this.getModels();if(n.device)this.updateState(a);else try{this.updateState(a)}catch{}for(const u of this.props.extensions)u.updateState.call(this,a,u);const l=this.getModels()[0]!==c[0];this._postUpdate(a,l)}finally{n.viewport=i,this.props=t,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){me(zA,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,moduleParameters:t=null,uniforms:n={},parameters:r={}}){this._updateAttributeTransition();const i=this.props,o=this.context;this.props=this.internalState.propsInTransition||i;const a=this.props.opacity;n.opacity=Math.pow(a,1/2.2);try{if(t){const{isActive:u,isAttribute:h}=t.picking;this.setModuleParameters(t),this.setShaderModuleProps({picking:{isActive:u,isAttribute:h}})}const{getPolygonOffset:c}=this.props,l=c&&c(n)||[0,0];o.device.setParametersWebGL({polygonOffset:l});for(const u of this.getModels())u.setParameters(r);o.device.withParametersWebGL(r,()=>{const u={renderPass:e,moduleParameters:t,uniforms:n,parameters:r,context:o};for(const h of this.props.extensions)h.draw.call(this,u,h);this.draw(u)})}finally{this.props=i}}getChangeFlags(){var e;return(e=this.internalState)==null?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const r in e)if(e[r]){let i=!1;switch(r){case"dataChanged":const o=e[r],a=t[r];o&&Array.isArray(a)&&(t.dataChanged=Array.isArray(o)?a.concat(o):o,i=!0);default:t[r]||(t[r]=e[r],i=!0)}i&&me(LA,this,r,e)}const n=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=n,t.somethingChanged=n||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){var r;const n=hA(e,t);if(n.updateTriggersChanged)for(const i in n.updateTriggersChanged)n.updateTriggersChanged[i]&&this.invalidateAttribute(i);if(n.transitionsChanged)for(const i in n.transitionsChanged)this.internalState.uniformTransitions.add(i,t[i],e[i],(r=e.transitions)==null?void 0:r[i]);return this.setChangeFlags(n)}validateProps(){uA(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:n}=this.props;e.picked&&typeof n=="function"&&(t.highlightColor=n(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new rA(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:n,oldProps:r}=e;this.setNeedsRedraw(),this._updateAttributes();const i=this.state.model;i!=null&&i.isInstanced&&i.setInstanceCount(this.getNumInstances());const{autoHighlight:o,highlightedObjectIndex:a,highlightColor:c}=n;if(t||r.autoHighlight!==o||r.highlightedObjectIndex!==a||r.highlightColor!==c){const l={};Array.isArray(c)&&(l.highlightColor=c),(t||r.autoHighlight!==o||a!==r.highlightedObjectIndex)&&(l.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:l})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const n=this.getAttributeManager(),r=n?n.getNeedsRedraw(e):!1;if(t=t||r,t)for(const i of this.props.extensions)i.onNeedsRedraw.call(this,i);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}jo.defaultProps=XA;jo.layerName="Layer";const YA="compositeLayer.renderLayers";class qA extends jo{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){const{_subLayerProps:n}=this.props;return n&&n[e]&&n[e].type||t}getSubLayerRow(e,t,n){return e.__source={parent:this,object:t,index:n},e}getSubLayerAccessor(e){if(typeof e=="function"){const t={index:-1,data:this.props.data,target:[]};return(n,r)=>n&&n.__source?(t.index=n.__source.index,e(n.__source.object,t)):e(n,r)}return e}getSubLayerProps(e={}){var $;const{opacity:t,pickable:n,visible:r,parameters:i,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:f,positionFormat:_,modelMatrix:T,extensions:v,fetch:R,operation:C,_subLayerProps:I}=this.props,M={id:"",updateTriggers:{},opacity:t,pickable:n,visible:r,parameters:i,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:f,positionFormat:_,modelMatrix:T,extensions:v,fetch:R,operation:C},N=I&&e.id&&I[e.id],U=N&&N.updateTriggers,B=e.id||"sublayer";if(N){const W=this.props[_t],V=e.type?e.type._propTypes:{};for(const z in N){const H=V[z]||W[z];H&&H.type==="accessor"&&(N[z]=this.getSubLayerAccessor(N[z]))}}Object.assign(M,e,N),M.id=`${this.props.id}-${B}`,M.updateTriggers={all:($=this.props.updateTriggers)==null?void 0:$.all,...e.updateTriggers,...U};for(const W of v){const V=W.getSubLayerProps.call(this,W);V&&Object.assign(M,V,{updateTriggers:Object.assign(M.updateTriggers,V.updateTriggers)})}return M}_updateAutoHighlight(e){for(const t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let n=this.internalState.subLayers;const r=!n||this.needsUpdate();if(r){const i=this.renderLayers();n=Bo(i,Boolean),this.internalState.subLayers=n}me(YA,this,r,n);for(const i of n)i.parent=this}}qA.layerName="CompositeLayer";const Mn=Math.PI/180,fl=180/Math.PI,Bn=6370972,rs=256;function KA(){const s=rs/Bn,e=Math.PI/180*rs;return{unitsPerMeter:[s,s,s],unitsPerMeter2:[0,0,0],metersPerUnit:[1/s,1/s,1/s],unitsPerDegree:[e,e,s],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/s]}}class c3 extends ys{constructor(e={}){const{latitude:t=0,longitude:n=0,zoom:r=0,nearZMultiplier:i=.1,farZMultiplier:o=2,resolution:a=10}=e;let{height:c,altitude:l=1.5}=e;c=c||1,l=Math.max(.75,l);const u=new Fe().lookAt({eye:[0,-l,0],up:[0,0,1]}),h=Math.pow(2,r);u.rotateX(t*Mn),u.rotateZ(-n*Mn),u.scale(h/c);const f=Math.atan(.5/l),_=rs*2*h/c;super({...e,height:c,viewMatrix:u,longitude:n,latitude:t,zoom:r,distanceScales:KA(),fovyRadians:f*2,focalDistance:l,near:i,far:Math.min(2,1/_+1)*l*o}),this.latitude=t,this.longitude=n,this.resolution=a}get projectionMode(){return Me.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){const t={targetZ:e.z||0},n=this.unproject([0,this.height/2],t),r=this.unproject([this.width/2,0],t),i=this.unproject([this.width,this.height/2],t),o=this.unproject([this.width/2,this.height],t);return i[0]<this.longitude&&(i[0]+=360),n[0]>this.longitude&&(n[0]-=360),[Math.min(n[0],i[0],r[0],o[0]),Math.min(n[1],i[1],r[1],o[1]),Math.max(n[0],i[0],r[0],o[0]),Math.max(n[1],i[1],r[1],o[1])]}unproject(e,{topLeft:t=!0,targetZ:n}={}){const[r,i,o]=e,a=t?i:this.height-i,{pixelUnprojectionMatrix:c}=this;let l;if(Number.isFinite(o))l=Ai(c,[r,a,o,1]);else{const _=Ai(c,[r,a,-1,1]),T=Ai(c,[r,a,1,1]),v=((n||0)/Bn+1)*rs,R=ti(xu([],_,T)),C=ti(_),I=ti(T),N=4*((4*C*I-(R-C-I)**2)/16)/R,U=Math.sqrt(C-N),B=Math.sqrt(Math.max(0,v*v-N)),$=(U-B)/Math.sqrt(R);l=Im([],_,T,$)}const[u,h,f]=this.unprojectPosition(l);return Number.isFinite(o)?[u,h,f]:Number.isFinite(n)?[u,h,n]:[u,h]}projectPosition(e){const[t,n,r=0]=e,i=t*Mn,o=n*Mn,a=Math.cos(o),c=(r/Bn+1)*rs;return[Math.sin(i)*a*c,-Math.cos(i)*a*c,Math.sin(o)*c]}unprojectPosition(e){const[t,n,r]=e,i=Ru(e),o=Math.asin(r/i),c=Math.atan2(t,-n)*fl,l=o*fl,u=(i/rs-1)*Bn;return[c,l,u]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){const n=this.unproject(t);return{longitude:e[0]-n[0]+this.longitude,latitude:e[1]-n[1]+this.latitude}}}function Ai(s,e){const t=ms([],e,s);return No(t,t,1/t[3]),t}class l3{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:t={}}=e;this.typedArrayManager=ps,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:t,buffers:n={},getGeometry:r,geometryBuffer:i,positionFormat:o,dataChanged:a,normalize:c=!0}=this.opts;if(this.data=t,this.getGeometry=r,this.positionSize=i&&i.size||(o==="XY"?2:3),this.buffers=n,this.normalize=c,i&&(pe(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(i),c||(n.vertexPositions=i)),this.geometryBuffer=n.vertexPositions,Array.isArray(a))for(const l of a)this._rebuildGeometry(l);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){const t=e.value||e;return ArrayBuffer.isView(t)?Th(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){const{attributes:n,buffers:r,_attributeDefs:i,typedArrayManager:o}=this;for(const a in i)if(a in r)o.release(n[a]),n[a]=null;else{const c=i[a];c.copy=t,n[a]=o.allocate(n[a],e,c)}}_forEachGeometry(e,t,n){const{data:r,getGeometry:i}=this,{iterable:o,objectInfo:a}=mh(r,t,n);for(const c of o){a.index++;const l=i?i(c,a):null;e(l,a.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:n,instanceCount:r}=this;const{data:i,geometryBuffer:o}=this,{startRow:a=0,endRow:c=1/0}=e||{},l={};if(e||(t=[0],n=[0]),this.normalize||!o)this._forEachGeometry((h,f)=>{const _=h&&this.normalizeGeometry(h);l[f]=_,n[f+1]=n[f]+(_?this.getGeometrySize(_):0)},a,c),r=n[n.length-1];else if(n=i.startIndices,r=n[i.length]||0,ArrayBuffer.isView(o))r=r||o.length/this.positionSize;else if(o instanceof se){const h=this.positionSize*4;r=r||o.byteLength/h}else if(o.buffer){const h=o.stride||this.positionSize*4;r=r||o.buffer.byteLength/h}else if(o.value){const h=o.value,f=o.stride/h.BYTES_PER_ELEMENT||this.positionSize;r=r||h.length/f}this._allocate(r,!!e),this.indexStarts=t,this.vertexStarts=n,this.instanceCount=r;const u={};this._forEachGeometry((h,f)=>{const _=l[f]||h;u.vertexStart=n[f],u.indexStart=t[f];const T=f<n.length-1?n[f+1]:r;u.geometrySize=T-n[f],u.geometryIndex=f,this.updateGeometryAttributes(_,u)},a,c),this.vertexCount=t[t.length-1]}}export{q as C,gh as D,n3 as E,a3 as G,jo as L,lr as M,t3 as Q,JA as R,l3 as T,cc as U,yb as V,_s as W,o3 as a,ar as b,Ri as c,mh as d,G as e,r3 as f,_f as g,qA as h,Ke as i,e3 as j,Cu as k,rr as l,Ga as m,Zs as n,s3 as o,i3 as p,c3 as q,Fe as r,Bo as s,QA as t};
